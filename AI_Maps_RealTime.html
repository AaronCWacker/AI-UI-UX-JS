<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Satellite Map with ZIP Code Search</title>
    <!-- Leaflet CSS: The stylesheet for the mapping library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Esri Leaflet Geocoder CSS: For search bar styling -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.css"
          crossorigin="">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS: To style the map and search input -->
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #map p {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #555;
        }
        #search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #zip-input {
            padding: 8px;
            font-size: 1rem;
            width: 250px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
    <!-- Google Fonts for a cleaner look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- Search input container -->
    <div id="search-container">
        <input id="zip-input" type="text" placeholder="Enter ZIP code prefix (e.g., 55)">
    </div>
    <!-- Map container -->
    <div id="map">
        <p>Attempting to locate you...</p>
    </div>
    <!-- Leaflet JavaScript: The core mapping library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Esri Leaflet JavaScript: Plugin for satellite basemaps -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <!-- Esri Leaflet Geocoder JavaScript: For ZIP code search -->
    <script src="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.js"></script>
    <!-- Main application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mapContainer = document.getElementById('map');
            const zipInput = document.getElementById('zip-input');
            let map, userMarker;

            // Initialize the map with a default view of the US
            function initializeMap(lat, lng) {
                // Clear any previous map instance
                if (map) {
                    map.remove();
                }
                // Create a new map instance
                map = L.map('map').setView([lat, lng], 10);
                L.esri.basemapLayer('Imagery').addTo(map);
                L.esri.basemapLayer('ImageryLabels').addTo(map);
                return map;
            }

            // Geolocation handling
            if (!navigator.geolocation) {
                mapContainer.innerHTML = '<p>Sorry, Geolocation is not supported by your browser.</p>';
                return;
            }

            navigator.geolocation.getCurrentPosition(onSuccess, onError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });

            function onSuccess(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                mapContainer.innerHTML = "";
                map = initializeMap(latitude, longitude);
                userMarker = L.marker([latitude, longitude]).addTo(map);
                userMarker.bindPopup("<b>You are here!</b><br>Your approximate location.").openPopup();
            }

            function onError(err) {
                let errorMessage = 'An unknown error occurred.';
                switch (err.code) {
                    case err.PERMISSION_DENIED:
                        errorMessage = 'Location access denied. Please enable it or use ZIP code search.';
                        break;
                    case err.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information is unavailable.';
                        break;
                    case err.TIMEOUT:
                        errorMessage = 'Location request timed out.';
                        break;
                }
                mapContainer.innerHTML = `<p><strong>Error:</strong> ${errorMessage}</p>`;
                // If geolocation fails, fall back to a default view
                mapContainer.innerHTML = '';
                map = initializeMap(39.8283, -98.5795); // Center on the US
            }

            // ZIP code search functionality
            const geocoder = L.esri.Geocoding.geocodeService();
            let searchTimeout;

            zipInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = zipInput.value.trim();
                    if (query.length >= 2 && !isNaN(query)) { // Search when at least 2 digits are entered
                        geocoder.geocode().text(query).category('Postal').run((err, response) => {
                            if (err) {
                                console.error("Geocoding error:", err);
                                return;
                            }
                            if (response.results.length > 0) {
                                const result = response.results[0];
                                const lat = result.latLng.lat;
                                const lng = result.latLng.lng;
                                map.setView([lat, lng], 10);
                                if (userMarker) map.removeLayer(userMarker);
                                userMarker = L.marker([lat, lng]).addTo(map);
                                userMarker.bindPopup(`<b>ZIP Code: ${query}</b><br>${result.text}`).openPopup();
                            }
                        });
                    }
                }, 300); // Debounce for 300ms
            });
        });
    </script>
</body>
</html>
