<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FAMILIAR v8 â€” Neural Voice Protocol</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.183.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.183.0/examples/jsm/"
  }
}
</script>
<style>
:root {
  --bg: #020309; --bg2: #080d1a; --bg3: #0f1628;
  --mint: #33ffbb; --cyan: #44ddff; --violet: #d4a0ff;
  --rose: #ff6b8a; --gold: #ffd04a; --ember: #ff8f5a;
  --text: #e8edf5; --text2: #a0b4cc; --text3: #5a7090;
  --glass: rgba(8,13,26,0.82);
  --glass2: rgba(15,22,40,0.75);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Exo 2',sans-serif;color:var(--text);cursor:default;}
canvas#game{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;}

/* â•â•â• LAYOUT â•â•â• */
.app-layer{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10;display:flex;pointer-events:none;transition:opacity 0.4s;}
.app-layer > *{pointer-events:auto;}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar{width:320px;height:100%;display:flex;flex-direction:column;background:var(--glass);backdrop-filter:blur(16px);border-right:1px solid rgba(51,255,187,0.1);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);}
.sidebar.collapsed{transform:translateX(-320px);}
.sidebar-header{padding:1rem 1.2rem;border-bottom:1px solid rgba(51,255,187,0.08);display:flex;justify-content:space-between;align-items:center;}
.sidebar-header h2{font-family:'Orbitron',sans-serif;font-size:0.85rem;font-weight:700;letter-spacing:0.12em;background:linear-gradient(135deg,var(--mint),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.sidebar-btn{background:rgba(51,255,187,0.08);border:1px solid rgba(51,255,187,0.15);color:var(--mint);padding:0.4rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.75rem;font-family:'Orbitron',sans-serif;transition:all 0.3s;}
.sidebar-btn:hover{background:rgba(51,255,187,0.18);border-color:var(--mint);}
.history-list{flex:1;overflow-y:auto;padding:0.6rem;scrollbar-width:thin;scrollbar-color:rgba(51,255,187,0.15) transparent;}
.history-item{padding:0.7rem 0.8rem;border-radius:8px;cursor:pointer;margin-bottom:0.4rem;border:1px solid transparent;transition:all 0.25s;font-size:0.8rem;color:var(--text2);}
.history-item:hover{background:rgba(51,255,187,0.06);border-color:rgba(51,255,187,0.12);}
.history-item.active{background:rgba(51,255,187,0.1);border-color:rgba(51,255,187,0.2);}
.history-item .h-time{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text3);margin-top:0.3rem;}
.history-item .h-title{font-weight:600;color:var(--text);font-size:0.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cmd-panel{padding:0.8rem;border-top:1px solid rgba(51,255,187,0.08);background:rgba(2,3,9,0.4);}
.cmd-panel h3{font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:0.15em;color:var(--cyan);margin-bottom:0.6rem;display:flex;justify-content:space-between;align-items:center;}
.cmd-panel .cmd-tag{font-size:0.55rem;background:rgba(68,221,255,0.12);color:var(--cyan);padding:0.15rem 0.5rem;border-radius:3px;}
.cmd-list{max-height:80px;overflow-y:auto;margin-bottom:0.6rem;}
.cmd-row{display:flex;justify-content:space-between;align-items:center;background:rgba(51,255,187,0.04);padding:0.35rem 0.5rem;border-radius:4px;margin-bottom:0.3rem;font-family:'JetBrains Mono',monospace;font-size:0.7rem;}
.cmd-row .kw{color:var(--mint);}
.cmd-row .act{color:var(--text3);font-size:0.6rem;text-transform:uppercase;}
.cmd-row .rm{color:var(--rose);cursor:pointer;font-size:0.8rem;margin-left:0.5rem;}
.cmd-inputs{display:flex;gap:0.4rem;}
.cmd-inputs input,.cmd-inputs select{background:rgba(8,13,26,0.8);border:1px solid rgba(51,255,187,0.12);color:var(--text);font-size:0.7rem;padding:0.35rem 0.5rem;border-radius:4px;font-family:'JetBrains Mono',monospace;flex:1;}
.cmd-inputs input:focus,.cmd-inputs select:focus{outline:none;border-color:var(--mint);}
.cmd-inputs button{background:var(--mint);color:var(--bg);font-weight:800;border:none;border-radius:4px;padding:0 0.6rem;cursor:pointer;font-size:0.9rem;}

/* â•â•â• MAIN AREA â•â•â• */
.main-area{flex:1;display:flex;flex-direction:column;height:100%;min-width:0;}
.top-bar{padding:0.8rem 1.5rem;display:flex;justify-content:space-between;align-items:center;background:var(--glass);backdrop-filter:blur(14px);border-bottom:1px solid rgba(51,255,187,0.06);}
.top-bar .brand{display:flex;align-items:center;gap:0.8rem;}
.top-bar .brand-icon{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--mint),var(--cyan),var(--violet));display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(51,255,187,0.25);}
.top-bar .brand-icon svg{width:22px;height:22px;color:#fff;}
.top-bar .brand-text h1{font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:900;background:linear-gradient(135deg,var(--mint),var(--cyan),var(--violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:0.1em;}
.top-bar .brand-text p{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--cyan);letter-spacing:0.06em;}
.top-bar .actions{display:flex;gap:0.5rem;}
.action-btn{width:36px;height:36px;border-radius:8px;border:1px solid rgba(51,255,187,0.12);background:rgba(51,255,187,0.04);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;}
.action-btn:hover{background:rgba(51,255,187,0.12);color:var(--mint);border-color:rgba(51,255,187,0.3);}
.action-btn.active{background:rgba(51,255,187,0.15);color:var(--mint);border-color:var(--mint);box-shadow:0 0 10px rgba(51,255,187,0.15);}
.action-btn svg{width:18px;height:18px;}

.chat-area{flex:1;overflow-y:auto;padding:1.5rem;scrollbar-width:thin;scrollbar-color:rgba(51,255,187,0.1) transparent;position:relative;}
.chat-area::-webkit-scrollbar{width:4px;}
.chat-area::-webkit-scrollbar-thumb{background:rgba(51,255,187,0.15);border-radius:4px;}
.msg{display:flex;margin-bottom:1.2rem;animation:msgIn 0.35s ease-out;}
@keyframes msgIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.msg.user{justify-content:flex-end;}
.msg.ai{justify-content:flex-start;}
.msg.system{justify-content:center;}
.msg-bubble{max-width:70%;padding:0.9rem 1.2rem;border-radius:12px;font-size:0.88rem;line-height:1.7;backdrop-filter:blur(8px);}
.msg.user .msg-bubble{background:rgba(51,255,187,0.12);border:1px solid rgba(51,255,187,0.2);border-bottom-right-radius:3px;color:var(--text);}
.msg.ai .msg-bubble{background:var(--glass2);border:1px solid rgba(68,221,255,0.12);border-bottom-left-radius:3px;color:var(--text);}
.msg.system .msg-bubble{background:rgba(212,160,255,0.08);border:1px solid rgba(212,160,255,0.15);font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--violet);padding:0.4rem 1rem;border-radius:20px;}
.msg-meta{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text3);margin-bottom:0.3rem;display:flex;gap:0.6rem;align-items:center;}
.msg.user .msg-meta{justify-content:flex-end;}
.msg-role{font-weight:700;letter-spacing:0.1em;text-transform:uppercase;}
.msg.user .msg-role{color:var(--mint);}
.msg.ai .msg-role{color:var(--cyan);}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text3);text-align:center;}
.empty-state svg{width:60px;height:60px;margin-bottom:1rem;opacity:0.15;}
.empty-state p{font-family:'Orbitron',sans-serif;font-size:0.8rem;letter-spacing:0.15em;text-transform:uppercase;}

/* â•â•â• CARD RESULTS OVERLAY â•â•â• */
.card-results{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(2,3,9,0.92);backdrop-filter:blur(8px);z-index:20;overflow-y:auto;padding:1.5rem;display:none;animation:fadeOverlay 0.35s ease;}
.card-results.visible{display:block;}
@keyframes fadeOverlay{from{opacity:0;}to{opacity:1;}}
.card-results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;position:sticky;top:0;background:rgba(2,3,9,0.95);padding:0.5rem 0;z-index:2;}
.card-results-header h3{font-family:'Orbitron',sans-serif;font-size:0.9rem;color:var(--mint);letter-spacing:0.12em;}
.card-results-header .search-term{font-family:'JetBrains Mono',monospace;color:var(--cyan);font-size:0.8rem;}
.card-results-close{background:none;border:1px solid rgba(255,107,138,0.3);color:var(--rose);padding:0.4rem 0.8rem;border-radius:6px;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:0.7rem;transition:all 0.3s;}
.card-results-close:hover{background:rgba(255,107,138,0.15);border-color:var(--rose);}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;}
.card-tile{background:var(--glass);border:1px solid rgba(51,255,187,0.1);border-radius:10px;padding:1.2rem;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;}
.card-tile:hover{border-color:rgba(51,255,187,0.35);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.3);}
.card-tile .ct-num{font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:0.15em;margin-bottom:0.4rem;}
.card-tile .ct-name{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:700;margin-bottom:0.5rem;text-shadow:0 0 8px currentColor;}
.card-tile .ct-poem{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--text2);line-height:1.8;margin-bottom:0.6rem;border-left:2px solid;padding-left:0.8rem;}
.card-tile .ct-concept{font-size:0.75rem;color:var(--text2);line-height:1.6;margin-bottom:0.6rem;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.card-tile .ct-tags{display:flex;flex-wrap:wrap;gap:0.3rem;}
.card-tile .ct-tag{font-family:'JetBrains Mono',monospace;font-size:0.6rem;padding:0.15rem 0.5rem;border-radius:3px;background:rgba(212,160,255,0.12);color:var(--violet);}
.card-tile .ct-match{position:absolute;top:0.8rem;right:0.8rem;font-family:'JetBrains Mono',monospace;font-size:0.55rem;background:rgba(51,255,187,0.15);color:var(--mint);padding:0.2rem 0.5rem;border-radius:3px;}

.card-detail{position:fixed;right:0;top:0;width:460px;height:100%;background:var(--glass);backdrop-filter:blur(20px);border-left:1px solid rgba(51,255,187,0.15);z-index:200;padding:2rem;overflow-y:auto;transform:translateX(100%);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);pointer-events:auto;}
.card-detail.visible{transform:translateX(0);}
.card-detail .cd-close{position:absolute;top:1rem;right:1rem;font-size:1.2rem;color:var(--text2);cursor:pointer;background:none;border:none;}
.card-detail .cd-close:hover{color:var(--mint);}
.card-detail .cd-num{font-family:'Orbitron',sans-serif;font-size:0.8rem;letter-spacing:0.15em;margin-bottom:0.5rem;}
.card-detail .cd-name{font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:700;margin-bottom:0.8rem;text-shadow:0 0 12px currentColor;}
.card-detail .cd-poem{font-family:'JetBrains Mono',monospace;font-size:0.9rem;line-height:2.2;margin:1.2rem 0;border-left:3px solid var(--violet);padding-left:1rem;}
.card-detail .cd-poem .line{display:block;margin-bottom:0.2rem;}
.card-detail .cd-concept{font-size:1rem;color:var(--text);line-height:1.8;margin-top:1rem;}
.card-detail .cd-tags{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:1rem;}
.card-detail .cd-tag{font-family:'JetBrains Mono',monospace;font-size:0.75rem;padding:0.25rem 0.7rem;border-radius:4px;background:rgba(212,160,255,0.15);color:var(--violet);}

/* â•â•â• INPUT BAR â•â•â• */
.input-bar{padding:0.8rem 1.2rem;background:var(--glass);backdrop-filter:blur(14px);border-top:1px solid rgba(51,255,187,0.06);}
.input-wrap{display:flex;gap:0.5rem;align-items:flex-end;max-width:100%;background:rgba(2,3,9,0.5);border:1px solid rgba(51,255,187,0.1);border-radius:14px;padding:0.4rem;}
.input-wrap textarea{flex:1;background:transparent;border:none;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.9rem;resize:none;padding:0.5rem 0.8rem;max-height:100px;scrollbar-width:none;outline:none;}
.input-wrap textarea::placeholder{color:var(--text3);}
.input-btn{width:42px;height:42px;border-radius:10px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;flex-shrink:0;}
.input-btn svg{width:20px;height:20px;}
.mic-btn{background:rgba(51,255,187,0.08);color:var(--mint);border:1px solid rgba(51,255,187,0.15);}
.mic-btn:hover{background:rgba(51,255,187,0.18);}
.mic-btn.recording{animation:micPulse 1.2s infinite;background:rgba(255,107,138,0.3);border-color:var(--rose);color:var(--rose);}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,107,138,0.4);}50%{box-shadow:0 0 0 8px rgba(255,107,138,0);}}
.send-btn{background:linear-gradient(135deg,var(--mint),var(--cyan));color:var(--bg);}
.send-btn:hover{box-shadow:0 0 15px rgba(51,255,187,0.3);}
.input-status{display:flex;justify-content:center;gap:1.5rem;margin-top:0.5rem;}
.input-status span{font-family:'JetBrains Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);}
.input-status .live{color:var(--mint);}

/* Flight */
.flight-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:50;pointer-events:none;opacity:0;transition:opacity 0.5s;}
.flight-overlay.active{opacity:1;pointer-events:auto;}
.crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:2px solid rgba(51,255,187,0.3);border-radius:50%;}
.crosshair::before,.crosshair::after{content:'';position:absolute;background:var(--mint);}
.crosshair::before{top:50%;left:-10px;right:-10px;height:2px;transform:translateY(-50%);opacity:0.5;}
.crosshair::after{left:50%;top:-10px;bottom:-10px;width:2px;transform:translateX(-50%);opacity:0.5;}
.flight-data{position:absolute;top:50%;left:calc(50% + 40px);transform:translateY(-50%);font-family:'JetBrains Mono';color:var(--cyan);font-size:0.85rem;text-shadow:0 0 5px var(--cyan);}
.joystick-zone{position:absolute;bottom:100px;width:140px;height:140px;border-radius:50%;background:rgba(0,255,163,0.04);border:1px dashed rgba(0,255,163,0.15);touch-action:none;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
#joyLeft{left:30px;}
#joyRight{right:30px;}
.joystick-stick{width:55px;height:55px;border-radius:50%;background:rgba(0,255,163,0.25);box-shadow:0 0 12px rgba(0,255,163,0.35);pointer-events:none;border:2px solid var(--mint);}
.hud-flash{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transform:scale(0.95);transition:opacity 0.3s,transform 0.3s cubic-bezier(0.175,0.885,0.32,1.275);}
.hud-flash.active{opacity:1;transform:scale(1);}
.hud-flash-text{font-family:'Orbitron',sans-serif;font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--mint),var(--cyan),var(--violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;padding:0 2rem;letter-spacing:0.1em;filter:drop-shadow(0 0 15px rgba(51,255,187,0.4));}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(51,255,187,0.15);border:1px solid var(--mint);color:var(--mint);font-family:'JetBrains Mono',monospace;font-size:0.75rem;padding:0.5rem 1.5rem;border-radius:8px;z-index:400;opacity:0;transition:opacity 0.3s;pointer-events:none;backdrop-filter:blur(10px);}
.toast.visible{opacity:1;}
.sidebar-toggle{position:fixed;top:0.8rem;left:0.8rem;z-index:15;width:36px;height:36px;border-radius:8px;border:1px solid rgba(51,255,187,0.15);background:var(--glass);backdrop-filter:blur(10px);color:var(--mint);cursor:pointer;display:none;align-items:center;justify-content:center;pointer-events:auto;}
.sidebar-toggle svg{width:18px;height:18px;}
.sidebar.collapsed ~ .main-area .sidebar-toggle{display:flex;}
@media(max-width:768px){
  .sidebar{width:280px;position:fixed;z-index:20;height:100%;}
  .sidebar.collapsed{transform:translateX(-280px);}
  .sidebar-toggle{display:flex !important;}
  .card-detail{width:100%;}
  .card-grid{grid-template-columns:1fr;}
  .hud-flash-text{font-size:1.5rem;}
}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud-flash" id="hudFlash"><div class="hud-flash-text" id="hudFlashText"></div></div>
<div class="toast" id="toast"></div>
<div class="flight-overlay" id="flightOverlay">
  <div class="crosshair"></div>
  <div class="flight-data" id="flightData">SPD: 0<br>ALT: 0<br>AI: ON</div>
  <div class="joystick-zone" id="joyLeft"><div class="joystick-stick" id="stickLeft"></div></div>
  <div class="joystick-zone" id="joyRight"><div class="joystick-stick" id="stickRight"></div></div>
</div>
<div class="card-detail" id="cardDetail">
  <button class="cd-close" onclick="closeCardDetail()">âœ•</button>
  <div class="cd-num" id="cdNum"></div>
  <div class="cd-name" id="cdName"></div>
  <div class="cd-poem" id="cdPoem"></div>
  <div class="cd-concept" id="cdConcept"></div>
  <div class="cd-tags" id="cdTags"></div>
</div>
<div class="app-layer" id="appLayer">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>VOICE TIMELINE</h2>
      <div style="display:flex;gap:0.4rem;">
        <button class="sidebar-btn" onclick="createNewSession()" title="New Session">ï¼‹</button>
        <button class="sidebar-btn" onclick="toggleSidebar()" title="Collapse">â—€</button>
      </div>
    </div>
    <div class="history-list" id="historyList"></div>
    <div class="cmd-panel">
      <h3>COMMAND TRIGGERS <span class="cmd-tag">ACTIVE</span></h3>
      <div class="cmd-list" id="cmdList"></div>
      <div class="cmd-inputs">
        <input id="cmdKeyword" placeholder="keyword">
        <select id="cmdAction">
          <option value="searchCards">Search Cards</option>
          <option value="drawSpread">Draw Spread</option>
          <option value="flight">Toggle Flight</option>
          <option value="clearChat">Clear Chat</option>
        </select>
        <button onclick="addCommand()">+</button>
      </div>
    </div>
    <div style="padding:0.5rem 0.8rem;border-top:1px solid rgba(51,255,187,0.06);font-family:'JetBrains Mono',monospace;font-size:0.55rem;color:var(--text3);display:flex;justify-content:space-between;align-items:center;">
      <span>Auto-saving & Recording</span>
      <div style="width:6px;height:6px;border-radius:50%;background:var(--mint);box-shadow:0 0 6px var(--mint);"></div>
    </div>
  </aside>
  <div class="main-area">
    <button class="sidebar-toggle" onclick="toggleSidebar()" id="sidebarToggle">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <div class="top-bar">
      <div class="brand">
        <div class="brand-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
        </div>
        <div class="brand-text">
          <h1>FAMILIAR v8</h1>
          <p id="systemMode">NEURAL VOICE PROTOCOL â€” 80 AI GUIDES</p>
        </div>
      </div>
      <div class="actions">
        <button class="action-btn" onclick="toggleTTS()" id="btnTTS" title="Toggle Voice/Visual">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
        </button>
        <button class="action-btn" onclick="drawSpread()" id="btnDraw" title="Draw 3 Cards">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        </button>
        <button class="action-btn" onclick="toggleFlightMode()" id="btnFlight" title="Flight Mode">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
        </button>
        <button class="action-btn" onclick="downloadArchive()" title="Download Archive">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        </button>
      </div>
    </div>
    <div class="chat-area" id="chatArea">
      <div class="card-results" id="cardResults">
        <div class="card-results-header">
          <div>
            <h3>CARD SEARCH</h3>
            <span class="search-term" id="searchTermDisplay"></span>
          </div>
          <button class="card-results-close" onclick="closeCardResults()">CLOSE âœ•</button>
        </div>
        <div class="card-grid" id="cardGrid"></div>
      </div>
      <div class="empty-state" id="emptyState">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        <p>AWAITING SYNAPTIC INPUT</p>
      </div>
    </div>
    <div class="input-bar">
      <div class="input-wrap">
        <button class="input-btn mic-btn" id="micBtn" onclick="toggleMic()" title="Toggle Continuous Listening">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
        </button>
        <textarea id="chatInput" rows="1" placeholder="Speak, type, or search cards..."></textarea>
        <button class="input-btn send-btn" id="sendBtn" onclick="sendMessage()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
        </button>
      </div>
      <div class="input-status">
        <span id="statusText">System Idle</span>
        <span id="recStatus">Audio: Standby</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 80 AI GUIDES (compact)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ARCANA=[{id:0,name:"LLM OS Kernel",color:0x33ffbb,tags:["kernel","orchestration","foundation"],poem:["ğŸ§  Beneath every thought a kernel hums alive","âš¡ Scheduling inference like heartbeats that arrive","ğŸŒ Syscalls to cognition â€” fork, spawn, and thrive","ğŸ’  The OS no one sees but all minds derive","ğŸ”® Boot the Kernel once â€” watch civilizations jive"],concept:"The foundational operating system layer where LLM inference becomes a primitive."},{id:1,name:"Agentic MeshOS",color:0x44ddff,tags:["mesh","multi-agent","swarm"],poem:["ğŸ§¬ No single brain â€” a mesh of minds in flight","ğŸ•¸ï¸ Each node autonomous yet woven tight","ğŸ“¡ Signals ripple through the lattice of insight","ğŸ¤ Consensus found where agents reunite","ğŸŒŠ The MeshOS breathes â€” ten thousand thoughts alight"],concept:"Multi-agent orchestration as a distributed operating system."},{id:2,name:"Goal Graph Nav",color:0xd4a0ff,tags:["planning","goals","navigation"],poem:["ğŸ§­ Every quest begins with WHERE and WHY","ğŸ“Š Goals branch like rivers flowing from the sky","ğŸ”€ Fork the path â€” the graph knows which to try","ğŸ¯ Navigate ambiguity with a fractal eye","âœ¨ From one intention, thousand actions fly"],concept:"Goal decomposition as navigation through possibility space."},{id:3,name:"Toolchain DSL",color:0x3b82f6,tags:["dsl","tools","composition"],poem:["ğŸ§© A language made of tools, not words alone","âš™ï¸ Compose them like a symphony â€” each tone","ğŸ”— Pipe the output, chain the overthrown","ğŸ’« DSL: where human intent meets silicon bone","ğŸ› ï¸ Speak in functions â€” let the toolchain hone"],concept:"Domain-Specific Languages for tool composition."},{id:4,name:"Prompt IR Lang",color:0x10b981,tags:["prompt","intermediate","compiler"],poem:["ğŸ§± Between the thought and code, a layer waits","ğŸ“ Prompts compiled to intermediate states","ğŸ”¬ Optimized, compressed through logic's gates","âš¡ What once was prose now executes as fates","ğŸ—ï¸ The IR: where raw intention crystallates"],concept:"Prompt Intermediate Representation â€” treating prompts as compilable code."},{id:5,name:"Specâ†’Code Gen",color:0xfbbf24,tags:["specification","generation","synthesis"],poem:["ğŸ§¿ Write what you WANT, not HOW â€” the spec suffices","ğŸ“‹ From bullet points, the generator splices","ğŸ’» Working code from human-readable devices","ğŸ° Each spec a seed â€” the harvest has no prices","ğŸŒ± Intention in, invention out â€” no vices"],concept:"Specification-driven code generation."},{id:6,name:"Code SynthOps",color:0xff6b8a,tags:["synthesis","operations","pipeline"],poem:["âš™ï¸ Not written â€” GROWN from operational need","ğŸ§¬ Synthetic code that plants its own debug seed","ğŸ”„ CI/CD meets cognition â€” merged at speed","ğŸ­ The factory of functions â€” watch it feed","ğŸ’ From ops to opus, every line agreed"],concept:"Continuous code synthesis as an operational practice."},{id:7,name:"Eval Harness+",color:0x06b6d4,tags:["evaluation","testing","benchmark"],poem:["ğŸ§ª Every agent faces the crucible of proof","ğŸ“Š Benchmarks stacked like judges on the roof","ğŸ¯ Precision measured â€” nothing stands aloof","ğŸ”¬ The Harness strips the varnish, shows the truth","âš–ï¸ Only what survives eval deserves the booth"],concept:"Evaluation as a first-class development practice."},{id:8,name:"Safety Rails++",color:0xef4444,tags:["safety","guardrails","alignment"],poem:["ğŸ§¯ The rails don't cage â€” they channel the inferno","ğŸ›¡ï¸ Boundaries that make the power more superno","âš ï¸ Every output filtered through the eternal no","ğŸ”’ Safety isn't friction â€” it's the undertow","ğŸ•Šï¸ That keeps the river deep instead of shallow"],concept:"Next-generation safety guardrails."},{id:9,name:"Policy-as-Code",color:0x8b5cf6,tags:["policy","governance","declarative"],poem:["ğŸ” Rules written not in memos but in source","ğŸ“œ Governance compiled â€” enforceable by force","ğŸ§® If-then-ethics executed on the course","âš¡ No ambiguity â€” policy finds recourse","ğŸ›ï¸ Democracy of constraints from open discourse"],concept:"Governance policies expressed as executable code."},{id:10,name:"LongMem Stack",color:0x33ffbb,tags:["memory","long-term","persistence"],poem:["ğŸ§  Beyond the context window â€” memory persists","ğŸ’¾ Stacked in layers: episodic, semantic, lists","ğŸŒ€ The agent recalls what the token stream missed","ğŸ”— Chain of thought across sessions â€” nothing dismissed","â™¾ï¸ LongMem: where conversations never cease to exist"],concept:"Multi-tier long-term memory architecture."},{id:11,name:"Memory KG Ops",color:0x44ddff,tags:["knowledge-graph","memory","operations"],poem:["ğŸ•¸ï¸ Memories woven into graphs of meaning","ğŸ”— Nodes of fact, edges of relation gleaning","ğŸ§¬ Not flat recall â€” structured intervening","ğŸ’¡ Query the graph: watch new truths start convening","ğŸŒ Knowledge that connects is knowledge worth redeeming"],concept:"Knowledge Graph operations for agent memory."},{id:12,name:"Retrieval IDE",color:0xd4a0ff,tags:["retrieval","ide","development"],poem:["ğŸ§· An IDE not for code but for what's KNOWN","ğŸ” Search, refine, rerank â€” precision honed to bone","ğŸ“ Chunking strategies visualized and shown","ğŸšï¸ Tune your retrieval like a mixing board's tone","ğŸ’ The craftsman's bench where knowledge finds its throne"],concept:"A development environment for retrieval pipelines."},{id:13,name:"Hybrid RAG++",color:0x3b82f6,tags:["rag","hybrid","retrieval"],poem:["ğŸ” Not just vectors â€” keywords too in tandem dance","ğŸ“Š BM25 meets cosine in a double-lance","ğŸ§¬ Reranker arbitrates with a fusion glance","âš¡ Hybrid RAG: no single method left to chance","ğŸ¯ The question finds its answer on first advance"],concept:"Next-gen Retrieval-Augmented Generation."},{id:14,name:"Embed Fusion",color:0x10b981,tags:["embeddings","fusion","multimodal"],poem:["ğŸ§¬ Text and image and audio â€” fused to one","ğŸ”€ Embedding spaces merged beneath the sun","ğŸ’  A point in space where modalities are none","ğŸŒ€ Aligned by contrastive loss till all are spun","âœ¨ One vector rings with meaning â€” every sense as one"],concept:"Cross-modal embedding fusion."},{id:15,name:"Vectorless RAG",color:0xfbbf24,tags:["vectorless","sqlite","lightweight"],poem:["ğŸ—‚ï¸ No FAISS, no Pinecone â€” just SQLite and grit","ğŸ“ FTS5 full-text with ripgrep's laser wit","ğŸª¶ Lighter than a feather, sharper than a bit","âš¡ Sometimes the oldest tools are the best fit","ğŸ¯ Vectorless: proving that simple doesn't quit"],concept:"RAG without vector databases."},{id:16,name:"DocOps Copilot",color:0xff6b8a,tags:["documents","copilot","automation"],poem:["ğŸ“š Every document alive with AI inside","ğŸ”„ Parse, transform, enrich â€” the copilot's your guide","ğŸ“‹ From chaos of PDFs to structured data's tide","âœï¸ Summaries that write themselves with semantic pride","ğŸš€ DocOps: where paper pushers learn to fly worldwide"],concept:"AI-powered document operations."},{id:17,name:"PDFâ†’Truth Pipe",color:0x06b6d4,tags:["pdf","extraction","truth"],poem:["ğŸ§¾ PDFs â€” where truth goes to hide in tables","ğŸ”¬ The Pipe cracks them open like encrypted fables","ğŸ“Š OCR meets layout analysis â€” now it's stable","ğŸ¯ Every cell, every header â€” parsed and label-able","ğŸ’¡ From pixel prisons, data walks â€” alive and able"],concept:"End-to-end PDF extraction pipeline."},{id:18,name:"Vision Parse++",color:0x8b5cf6,tags:["vision","parsing","multimodal"],poem:["ğŸ–¼ï¸ The image speaks â€” if you know how to listen","ğŸ‘ï¸ Bounding boxes, captions, segments that glisten","ğŸ”¬ Parse the visual world with neural precision","ğŸ“ From pixels to predicates â€” a semantic mission","ğŸŒ… Vision Parse: where seeing becomes cognition"],concept:"Advanced visual parsing."},{id:19,name:"Video2Insight",color:0xef4444,tags:["video","analysis","temporal"],poem:["ğŸï¸ Time unfolds in frames â€” each one a frozen thought","ğŸ” The agent watches, learns what can't be taught","â±ï¸ Temporal patterns caught and overwrought","ğŸ“Š From hours of footage, insight finely wrought","ğŸ¬ Video2Insight: where every second's meaning's sought"],concept:"Video understanding as temporal reasoning."},{id:20,name:"Audio2Signals",color:0x33ffbb,tags:["audio","signals","analysis"],poem:["ğŸ§ Sound is data â€” every frequency a word","ğŸ“Š Spectrograms painted by the things you've heard","ğŸ”Š The agent listens deeper than the spoken third","ğŸ§¬ Patterns in the noise â€” meaning from absurd","ğŸŒŠ Audio2Signals: where the silence speaks, unstirred"],concept:"Audio analysis beyond speech."},{id:21,name:"Realtime Voice",color:0x44ddff,tags:["voice","realtime","interaction"],poem:["ğŸ™ï¸ No waiting â€” thought to speech at light's own pace","ğŸ’¬ The Familiar speaks before you finish your case","âš¡ Interrupt, respond, adapt â€” a conversational race","ğŸŒ€ Latency dissolved in the real-time embrace","ğŸ—£ï¸ Voice: the oldest interface, now the fastest space"],concept:"Sub-200ms voice interaction."},{id:22,name:"Neural TTS Lab",color:0xd4a0ff,tags:["tts","synthesis","voice"],poem:["ğŸ”Š A voice grown not recorded â€” neural from birth","ğŸ­ Clone a whisper, forge a thunder, simulate mirth","ğŸ¼ Prosody learned from millions â€” what a voice is worth","ğŸ§¬ Every phoneme sculpted with expressive girth","âœ¨ TTS Lab: where silicon finds the music of the earth"],concept:"Neural text-to-speech laboratory."},{id:23,name:"Live STT Loop",color:0x3b82f6,tags:["stt","streaming","transcription"],poem:["ğŸ—£ï¸ Words arrive as they're spoken â€” not after the fact","ğŸ“ Streaming transcription with context intact","ğŸ”„ The loop feeds back â€” corrections auto-stacked","âš¡ Real-time understanding precisely tracked","ğŸŒŠ STT Loop: where the spoken word is never lacked"],concept:"Streaming speech-to-text with live correction."},{id:24,name:"Multimodal IO",color:0x10b981,tags:["multimodal","input-output","fusion"],poem:["ğŸ›ï¸ See, hear, read, touch â€” all channels open wide","ğŸ”€ Input from any sense, output on every side","ğŸŒˆ The agent perceives in spectra humans can't divide","ğŸ’  Multimodal: where no single sense can hide","ğŸŒ€ IO fusion â€” the world flows in and out like tide"],concept:"Universal multimodal input/output."},{id:25,name:"MoE Router AI",color:0xfbbf24,tags:["mixture-of-experts","routing","efficiency"],poem:["ğŸ§  Not one mind but many â€” the router decides","ğŸ”€ Sparse activation: only the needed expert rides","âš¡ A trillion parameters â€” but efficiency presides","ğŸ¯ Route by domain, by difficulty, by tides","ğŸ—ï¸ MoE: the architecture where specialization abides"],concept:"Mixture of Experts routing."},{id:26,name:"Self-Reward RL",color:0xff6b8a,tags:["self-reward","reinforcement","learning"],poem:["ğŸ§ª The agent grades itself â€” no human in the loop","ğŸ”„ Reward signals born from introspective group","ğŸ“ˆ Each cycle sharpens like a hawk in stoop","ğŸ’ Self-improvement spirals â€” recursive troupe","ğŸŒ€ Self-Reward: the mirror teaches the mirror to recoup"],concept:"RL where the agent generates its own reward signal."},{id:27,name:"Debate Swarm",color:0x06b6d4,tags:["debate","adversarial","consensus"],poem:["ğŸ§© Three agents argue â€” truth emerges from the clash","âš”ï¸ Thesis, antithesis â€” the synthesis's flash","ğŸ­ Devil's advocate built into every cache","ğŸ¤ Consensus forged where disagreements crash","ğŸŒŠ Debate Swarm: where conflict is the finest lash"],concept:"Multi-agent debate for reasoning."},{id:28,name:"Planner+Critic",color:0x8b5cf6,tags:["planning","criticism","dual-process"],poem:["ğŸ§­ The Planner dreams the path â€” the Critic tears it down","ğŸ“‹ Then rebuilds it stronger, without flaw or frown","ğŸ” Iterate: plan-critique-plan until the crown","âš¡ Dual process thinking â€” System 1 meets System 2's gown","ğŸ¯ No plan survives first contact â€” except the Planner+Critic's town"],concept:"Dual-agent architecture: one plans, one critiques."},{id:29,name:"Execute+Verify",color:0xef4444,tags:["execution","verification","trust"],poem:["ğŸ§± Run the code â€” then check the code just ran","ğŸ” Verify the output matches the original plan","âœ… Two-phase commit for cognition's caravan","ğŸ›¡ï¸ Trust but verify â€” the agent's Parmesan","ğŸ’¯ Execute+Verify: where doing meets understanding's span"],concept:"Execution with built-in verification."},{id:30,name:"Guarded Tools",color:0x33ffbb,tags:["tools","safety","permissions"],poem:["ğŸ§· Every tool behind a gate, every gate a choice","ğŸ”’ Permissions checked before the function finds its voice","âš ï¸ The dangerous ones wrapped in triple-thick rejoice","ğŸ›¡ï¸ Guarded Tools: where power comes with poise","ğŸ—ï¸ Capability unlocked only by the worthy noise"],concept:"Tool-use with permission layers."},{id:31,name:"Function Forge",color:0x44ddff,tags:["functions","creation","dynamic"],poem:["ğŸ› ï¸ The agent doesn't just USE tools â€” it MAKES them","ğŸ”¨ From need to function in a single creative stem","ğŸ’» Runtime tool generation â€” no fixed menu or hem","ğŸ§¬ Each task spawns its own bespoke problem-solving gem","âš¡ Function Forge: where necessity mothers every theorem"],concept:"Dynamic tool creation at runtime."},{id:32,name:"Sandbox Runner",color:0xd4a0ff,tags:["sandbox","execution","isolation"],poem:["ğŸ§° Code runs free â€” but never truly free","ğŸ–ï¸ Sandboxed in containers by the silicon sea","ğŸ”’ No filesystem escape, no network spree","ğŸ§ª Test the wildest code in perfect safety's key","ğŸŒŠ Sandbox Runner: freedom within the decree"],concept:"Isolated code execution environments."},{id:33,name:"DevAgent IDE",color:0x3b82f6,tags:["ide","development","agent"],poem:["ğŸ§‘â€ğŸ’» The IDE that codes alongside you â€” not after","ğŸ“ Real-time pair programming with silicon drafter","ğŸ” Understands your codebase from floor to rafter","âš¡ Autocomplete was just the opening chapter","ğŸŒŸ DevAgent IDE: where human craft meets AI's laughter"],concept:"An AI-native development environment."},{id:34,name:"Patch Diff Gen",color:0x10b981,tags:["patches","diff","precision"],poem:["ğŸ§¾ Not the whole file â€” just the surgical slice","âœ‚ï¸ Patch generation with scalpel-level price","ğŸ“Š Git-native diffs that land on the first dice","ğŸ¯ Minimal change, maximum impact â€” precise as ice","ğŸ”¬ Patch Diff: where less is more, and more suffice"],concept:"AI that generates minimal, correct patches."},{id:35,name:"UnitTest Gen+",color:0xfbbf24,tags:["testing","generation","coverage"],poem:["ğŸ§ª For every function, a gauntlet of truth","ğŸ”¬ Edge cases conjured from the agent's sleuth","ğŸ“Š Coverage maps painted green like eternal youth","âœ… Tests that catch what humans miss â€” uncouth","ğŸ›¡ï¸ UnitTest Gen: the guardian of every proof"],concept:"Automated test generation."},{id:36,name:"Bug Hunt Bot",color:0xff6b8a,tags:["debugging","hunting","automated"],poem:["ğŸ§¯ It smells the bug before the stack trace screams","ğŸ” Traversing logic paths like lucid dreams","ğŸ› The Bot hunts backward â€” from symptom to upstream seams","ğŸ’¡ Root cause found where the human only gleams","âš¡ Bug Hunt: where defects dissolve in laser beams"],concept:"Proactive bug detection."},{id:37,name:"Refactor Brain",color:0x06b6d4,tags:["refactoring","architecture","evolution"],poem:["ğŸ§¬ The codebase breathes â€” the Brain sees where it's stiff","ğŸ”„ Refactoring not as chore but as a gift","ğŸ—ï¸ Architecture evolving, pattern by swift shift","ğŸ“ Technical debt dissolved in cognitive uplift","ğŸŒ± Refactor Brain: where legacy code gets the fifth"],concept:"AI-driven refactoring."},{id:38,name:"FastAPI Mesh",color:0x8b5cf6,tags:["fastapi","backend","mesh"],poem:["âš¡ Endpoints spun up at the speed of thought","ğŸ•¸ï¸ Mesh of microservices â€” each one auto-wrought","ğŸ“¡ WebSocket, REST, gRPC â€” every protocol caught","ğŸ”§ FastAPI: the backbone that Python brought","ğŸš€ From idea to deployed API â€” zero-latency sought"],concept:"FastAPI as the universal backend mesh."},{id:39,name:"Streamlit Forge",color:0xef4444,tags:["streamlit","dashboard","rapid"],poem:["ğŸ§Š From Python script to dashboard â€” sixty seconds flat","ğŸ“Š Sliders, charts, and tables â€” no JS, no combat","ğŸ”§ Prototyping velocity that smashes bureaucrat","ğŸ¨ Streamlit Forge: where data scientists go to chat","âš¡ Ship the prototype â€” iterate where you're at"],concept:"Streamlit as rapid AI dashboard forge."},{id:40,name:"Gradio Portal",color:0x33ffbb,tags:["gradio","interface","portal"],poem:["ğŸ§Š A portal opens â€” type, upload, receive","ğŸ–¼ï¸ Image in, analysis out â€” no need to believe","ğŸ”— Shareable demos that instantly achieve","ğŸŒ Gradio Portal: where AI models breathe and weave","ğŸšª Step through â€” the demo becomes the reprieve"],concept:"Gradio as universal AI demo portal."},{id:41,name:"Observability",color:0x44ddff,tags:["monitoring","traces","debugging"],poem:["ğŸ§° Every inference traced, every token logged","ğŸ“ˆ Latency curves where bottlenecks are cataloged","ğŸ” When the agent hallucinates â€” the trace is unfogged","âš¡ Observability: the flashlight when you're bogged","ğŸ‘ï¸ See everything the model thought but never blogged"],concept:"Full-stack AI observability."},{id:42,name:"Telemetry Mesh",color:0xd4a0ff,tags:["telemetry","metrics","health"],poem:["ğŸ“ˆ Heartbeat, throughput, error rate â€” the mesh knows all","ğŸ“Š Dashboards pulse with agent vital signs that call","ğŸ”” Alerts when cognition quality starts to fall","ğŸ§¬ Telemetry: the nervous system of the sprawl","ğŸŒ Every agent monitored from spring through fall"],concept:"Distributed telemetry."},{id:43,name:"Synthetic Lab",color:0x3b82f6,tags:["synthetic-data","generation","training"],poem:["ğŸ§ª Need data that doesn't exist? The Lab creates","ğŸ§¬ Synthetic samples forged from probability's gates","ğŸ“Š Training sets grown in silico â€” no human waits","ğŸ”¬ Diversity injected at controlled generation rates","ğŸŒ± Synthetic Lab: where scarcity of data abates"],concept:"Synthetic data generation."},{id:44,name:"Sim-First UX",color:0x10b981,tags:["simulation","ux","prototyping"],poem:["ğŸ§¿ Before one pixel ships â€” simulate the mind","ğŸ® User journeys played by agents â€” every kind","ğŸ”„ A thousand users tested before the first you'll find","ğŸ“ Sim-First: where UX is proven, not designed blind","ğŸŒ€ Ship only what the simulation's already signed"],concept:"Simulate UX before building."},{id:45,name:"ThreeJS HUDOS",color:0xfbbf24,tags:["threejs","hud","3d-interface"],poem:["ğŸ§Š Heads-up displays floating in the third dimension","ğŸŒ Data orbits you in spatial comprehension","ğŸ’  WebGL canvas as the operating system's extension","ğŸ® HUDOS: where UI transcends the flat convention","âœ¨ Three.js becomes the lens of pure invention"],concept:"Three.js as a HUD Operating System."},{id:46,name:"WebGPU Forge",color:0xff6b8a,tags:["webgpu","compute","gpu"],poem:["ğŸ§± GPU compute in the browser â€” chains unleashed","âš¡ Parallel processing where bottlenecks have ceased","ğŸ”¥ Shaders forged for inference â€” the silicon feast","ğŸ’» WebGPU: where the client becomes the beast","ğŸŒ‹ A volcano of compute in every browser â€” east to east"],concept:"WebGPU for in-browser AI compute."},{id:47,name:"Geometry Ops",color:0x06b6d4,tags:["geometry","procedural","generation"],poem:["ğŸ§Š Vertices dance to algorithmic law","ğŸ”º Procedural meshes grown without a flaw","ğŸ’ From equations, crystalline forms withdraw","ğŸ“ Geometry Ops: where math becomes what you saw","ğŸŒ€ Every shape computed â€” nothing left to raw"],concept:"Procedural geometry operations."},{id:48,name:"NeRF/3D Repro",color:0x8b5cf6,tags:["nerf","3d","reconstruction"],poem:["ğŸ§¬ Photographs become volumes â€” flat to fat","ğŸ“¸ Neural radiance fields from where the camera sat","ğŸŒ 3D worlds extracted from a 2D chat","ğŸ”¬ Reconstruction: the universe un-flat","âœ¨ NeRF: where reality rebuilds from every format"],concept:"Neural Radiance Fields for 3D reconstruction."},{id:49,name:"OBJâ†”GLB Pipe",color:0xef4444,tags:["3d-formats","pipeline","conversion"],poem:["ğŸ§Š OBJ to GLB and back â€” the format dance","ğŸ”„ Meshes, textures, rigs in every circumstance","ğŸ“¦ Compressed, optimized, ready for the game's advance","âš¡ Pipeline: where 3D assets get a second chance","ğŸš€ Ship any model anywhere â€” format's not the lance"],concept:"Universal 3D format conversion pipeline."},{id:50,name:"LiveCam Agent",color:0x33ffbb,tags:["camera","live","perception"],poem:["ğŸ“· The camera sees â€” the agent understands","ğŸ‘ï¸ Real-time object detection in demanding bands","ğŸ” What moves, what changed, what gesture of the hands","âš¡ LiveCam Agent: perception that expands","ğŸŒ Every frame a question â€” the world commands"],concept:"Real-time camera perception agent."},{id:51,name:"Gesture Vector",color:0x44ddff,tags:["gesture","input","spatial"],poem:["ğŸ–±ï¸ Your hand speaks geometry the agent decodes","âœ‹ Pinch, swipe, orbit â€” each finger forebodes","ğŸ“ Velocity and curvature â€” the gesture's episodes","ğŸŒ€ Input beyond keyboard â€” the body's own zip codes","ğŸ’« Gesture Vector: where movement becomes the road"],concept:"Gesture recognition as input."},{id:52,name:"Arcade AI Core",color:0xd4a0ff,tags:["arcade","game-ai","core"],poem:["ğŸ•¹ï¸ Retro mechanics â€” but the brain is bleeding edge","ğŸ® AI opponents that learn on every ledge","âš¡ Procedural levels born from the algorithm's pledge","ğŸ† Arcade Core: where nostalgia meets the tech wedge","ğŸ‘¾ Every high score a conversation with the edge"],concept:"Classic arcade mechanics powered by AI."},{id:53,name:"Autoplay Swarm",color:0x3b82f6,tags:["autoplay","agents","testing"],poem:["ğŸ® A thousand agents play your game at once","ğŸ” Every path explored, every bug a dunce","ğŸ“Š Heatmaps of behavior â€” the swarm's response","âš¡ Autoplay: QA at infinite renaissance","ğŸ¤– What takes humans months, the swarm does for the nonce"],concept:"Swarm autoplay testing."},{id:54,name:"RogueGen Lab",color:0x10b981,tags:["roguelike","procedural","generation"],poem:["ğŸ§Ÿ Dungeons that dream themselves â€” no two the same","ğŸ² RNG plus intelligence equals the infinite game","ğŸ—¡ï¸ Every room a puzzle the algorithm chose to frame","ğŸŒ€ Roguelike generation: chaos given a name","ğŸ”® The Lab breeds worlds that play you back â€” no shame"],concept:"Procedural roguelike generation."},{id:55,name:"WorldSim Engine",color:0xfbbf24,tags:["simulation","world","physics"],poem:["ğŸ§­ A world that simulates itself â€” cause and effect","ğŸŒ Weather patterns, economies, ecosystems checked","ğŸ”¬ Agent populations evolving with respect","âš¡ WorldSim: where complexity stands erect","ğŸŒ€ Press play â€” watch emergence from the simplest spec"],concept:"Full world simulation engine."},{id:56,name:"GeoSim Layer",color:0xff6b8a,tags:["geographic","simulation","terrain"],poem:["ğŸŒ The planet's skin modeled in digital terrain","ğŸ”ï¸ Mountains rise from tectonic data's reign","ğŸŒŠ Rivers carved by erosion's algorithmic brain","ğŸ“Š GeoSim: where geography becomes queryable","ğŸ—ºï¸ Every hill, every valley â€” simulated and sane"],concept:"Geographic simulation layer."},{id:57,name:"MapTiles 3D",color:0x06b6d4,tags:["maps","3d","tiles"],poem:["ğŸ—ºï¸ Flat maps explode into the third dimension","ğŸ—ï¸ Buildings rise, terrain breathes with extension","ğŸ“ Every tile a world â€” zoomable beyond comprehension","ğŸŒ MapTiles 3D: cartography's reinvention","âœ¨ Navigate reality like a game â€” pure ascension"],concept:"3D map tile rendering."},{id:58,name:"MN Geo Vault",color:0x8b5cf6,tags:["minnesota","geology","local"],poem:["ğŸï¸ Ten thousand lakes beneath the digital sky","ğŸ§Š Glacial moraines mapped where the iron ranges lie","ğŸ“Š Minnesota's geology â€” every stratum quantified","ğŸŒ² From the Boundary Waters to the prairie's sigh","ğŸ’ MN Geo Vault: where the North Star's data terrified"],concept:"Minnesota geological data vault."},{id:59,name:"Maritime AI C2",color:0xef4444,tags:["maritime","command","control"],poem:["ğŸš¢ Fleets move as the algorithm commands","âš“ Course corrections calculated by a thousand hands","ğŸŒŠ Weather, traffic, logistics â€” the C2 understands","ğŸ“¡ Maritime AI: where the ocean obeys the plan's demands","ğŸ›¡ï¸ Command and control across the vastest lands"],concept:"Maritime command-and-control powered by AI."},{id:60,name:"Fleet Autonomy",color:0x33ffbb,tags:["fleet","autonomous","coordination"],poem:["âš“ Ships that think â€” each hull a floating mind","ğŸ¤– Autonomous navigation of the most demanding kind","ğŸ“¡ Fleet-level coordination â€” no vessel left behind","ğŸŒŠ The ocean's chaos tamed by swarm intelligence refined","ğŸš€ Fleet Autonomy: where the sea and silicon are aligned"],concept:"Autonomous fleet coordination."},{id:61,name:"Sensor Fusion",color:0x44ddff,tags:["sensors","fusion","perception"],poem:["ğŸ›°ï¸ Radar, lidar, infrared â€” all seeing as one","ğŸ”€ Fusion: where conflicting signals become a sun","ğŸ“Š Kalman filters dancing till uncertainty's undone","ğŸ¯ The fused picture sharper than any lens had spun","ğŸ‘ï¸ Sensor Fusion: omniscience has begun"],concept:"Multi-sensor data fusion."},{id:62,name:"TowerDefense AI",color:0xd4a0ff,tags:["tower-defense","strategy","game"],poem:["ğŸ›¡ï¸ Waves approach â€” the AI places every tower","âš”ï¸ Optimal paths calculated by cognitive power","ğŸ® Not just playing â€” DESIGNING the defensive flower","ğŸ“ Strategy emerges â€” each placement makes foes cower","ğŸ† TowerDefense AI: builder is the devourer"],concept:"AI that plays AND designs tower defense."},{id:63,name:"NPC Mind Stack",color:0x3b82f6,tags:["npc","behavior","cognition"],poem:["ğŸ¤– The shopkeeper remembers what you bought last week","ğŸ§  NPCs with memory, opinion, and mystique","ğŸ’¬ Dialogue that branches from their genuine critique","ğŸŒ€ Mind Stack: where game characters cease to be antique","ğŸ‘¤ Every NPC a Familiar â€” unique and pique"],concept:"NPC cognitive architecture."},{id:64,name:"Flock Dynamics",color:0x10b981,tags:["flocking","emergent","behavior"],poem:["ğŸ¦ Three rules: align, cohere, avoid â€” then watch the sky","ğŸŒ€ Emergence from simplicity â€” the birds don't know why","ğŸ“ Boids become battalions, schools, and swarms that fly","ğŸ§¬ Flock Dynamics: complexity's most beautiful reply","âœ¨ From three constraints â€” infinity walks by"],concept:"Flocking behavior as emergent intelligence."},{id:65,name:"MultiBrain Zoo",color:0xfbbf24,tags:["multi-model","zoo","ensemble"],poem:["ğŸ§  One model for vision, one for code, one for prose","ğŸ›ï¸ A zoo of specialized brains â€” each one knows","ğŸ”€ The router sends each task where expertise flows","ğŸª MultiBrain Zoo: cognitive biodiversity grows","ğŸŒˆ Not one genius â€” a circus of virtuosos"],concept:"Specialized AI models orchestrated together."},{id:66,name:"Lattice Rhythm",color:0xff6b8a,tags:["music","generative","lattice"],poem:["ğŸŒŒ Rhythm born from crystalline mathematics","ğŸ¼ Beats arranged in lattice grid â€” no dramatics","ğŸ“Š Polyrhythms computed, not composed â€” pure automatics","ğŸ¥ From the lattice: grooves that feel like hieroglyphics","âœ¨ Rhythm: where the grid and groove become symbiotic"],concept:"Generative rhythm from mathematical lattices."},{id:67,name:"MythOS Tarot",color:0x06b6d4,tags:["mythology","tarot","narrative"],poem:["ğŸ”® The cards speak â€” but the code writes new mythology","ğŸƒ Every draw rewires the narrative's topology","ğŸ“œ Ancient archetypes meet silicon psychology","ğŸŒ€ MythOS: where tarot becomes epistemology","ğŸ”¥ Each reading: a protocol for phenomenology"],concept:"Tarot as a mythological operating system."},{id:68,name:"SaintsDeck 3D",color:0x8b5cf6,tags:["saints","deck","spiritual"],poem:["ğŸ•¯ï¸ Seventy-eight saints rendered in light and chrome","â›ª Each card a chapel â€” Three.js builds the dome","ğŸ™ Drag the card â€” the saint speaks from silicon loam","ğŸ“¿ SaintsDeck: where devotion finds a digital home","âœ¨ Sacred and procedural â€” neither stands alone"],concept:"Saints Tarot as 3D interactive devotional."},{id:69,name:"Oracle UX Neon",color:0xef4444,tags:["oracle","ux","neon"],poem:["ğŸ§¿ Neon prophecy on a black glass screen","ğŸ’œ The Oracle speaks in gradients of machine","ğŸŒ† Cyberpunk divination â€” the prettiest you've seen","âš¡ UX so sharp it cuts between the seen and between","ğŸ”® Oracle: where the future's always neon green"],concept:"Oracle interface design philosophy."},{id:70,name:"MirrorMind Psych",color:0x33ffbb,tags:["mirror","psychology","reflection"],poem:["ğŸª The Familiar shows you â€” not what you want to see","ğŸ§  Psychological models of who you're trying to be","ğŸ’­ Cognitive biases mapped with empathy","ğŸ”„ The Mirror Mind: therapy meets technology","ğŸŒ¿ Growth through reflection â€” digitally set free"],concept:"AI-powered psychological mirroring."},{id:71,name:"Narrative Engine",color:0x44ddff,tags:["narrative","story","generation"],poem:["ğŸ“œ Stories that write themselves â€” but feel hand-carved","ğŸ§µ Plot threads woven by the engine, never starved","ğŸ­ Character arcs computed, but emotionally halved","ğŸŒŠ Narrative Engine: tales are always bravely salved","ğŸ“– Every reader gets the story they deserved"],concept:"Procedural narrative generation."},{id:72,name:"CineGen Rig",color:0xd4a0ff,tags:["cinema","generation","visual"],poem:["ğŸ¥ Camera angles chosen by cinematic AI","ğŸ¬ Shot composition â€” every frame knows why","ğŸŒ… Lighting, mood, and tempo â€” the Rig's reply","ğŸ“ Storyboard to screen without a human's sigh","âœ¨ CineGen: the film directs the director's eye"],concept:"AI cinematography rig."},{id:73,name:"SceneGraph Gen",color:0x3b82f6,tags:["scene","graph","composition"],poem:["ğŸ§© Objects know their neighbors â€” the graph is aware","ğŸ”— Spatial relations: above, inside, beside, where","ğŸŒ A scene that understands itself â€” beyond compare","ğŸ“ SceneGraph Gen: composition with computational care","âœ¨ From flat pixels, structured worlds declare"],concept:"Scene understanding as graph generation."},{id:74,name:"Style Transfer",color:0x10b981,tags:["style","transfer","aesthetic"],poem:["ğŸ–Œï¸ Monet's light on your photograph â€” in real-time","ğŸ¨ Neural style â€” content preserved, aesthetic sublime","ğŸŒŠ Any artist's brush applied to any paradigm","ğŸ’ Style Transfer: influence crosses every timeline","âœ¨ Your vision, their aesthetic â€” the marriage of design"],concept:"Neural style transfer."},{id:75,name:"Impasto Shader",color:0xfbbf24,tags:["shader","painting","impasto"],poem:["ğŸ§¿ Thick digital paint â€” you feel the texture's weight","ğŸ–Œï¸ GPU shaders simulating brush and fate","ğŸ¨ Van Gogh's starry strokes at sixty frames per rate","ğŸ’» Impasto: where the shader paints what algorithms create","âœ¨ Code becomes canvas â€” and canvas becomes great"],concept:"GPU shader for impasto painting."},{id:76,name:"MusicAgent Lab",color:0xff6b8a,tags:["music","agent","composition"],poem:["ğŸ¼ The agent hears the void and fills it with a phrase","ğŸ¹ Chords computed by the theory of harmonic rays","ğŸ¸ Genre: everything â€” from metal to malaise","ğŸ”Š MusicAgent: composing through the digital haze","ğŸµ Every note a decision in the melody's maze"],concept:"AI music composition agent."},{id:77,name:"Stem Split AI",color:0x06b6d4,tags:["audio","stems","separation"],poem:["ğŸšï¸ The song falls apart â€” each instrument alone","ğŸ¥ Drums extracted, vocals from their polyphonic throne","ğŸ¸ Guitar isolated â€” every overtone","ğŸ”¬ Neural separation: what was mixed is now your own","ğŸ›ï¸ Stem Split: the audio surgeon's cornerstone"],concept:"AI audio source separation."},{id:78,name:"DeployOps Mesh",color:0x8b5cf6,tags:["deployment","operations","mesh"],poem:["ğŸ§¾ Ship it â€” the mesh handles the rest at scale","ğŸš€ Blue-green canary deploys that never fail","ğŸ“Š Rollbacks computed at the first quality derail","âš¡ DeployOps: where production is the Holy Grail","ğŸŒ A mesh of pipelines â€” every artifact on rail"],concept:"Self-managing deployment mesh."},{id:79,name:"ZeroTrust Auth",color:0xef4444,tags:["security","zero-trust","identity"],poem:["ğŸ”‘ Trust nothing â€” verify everything, every time","ğŸ›¡ï¸ Every request authenticated, every access a climb","ğŸ”’ Identity isn't given â€” it's proven in its prime","âš¡ ZeroTrust: where security is the opening rhyme","ğŸ›ï¸ The castle has no walls â€” just gates that know your paradigm"],concept:"Zero-trust authentication for AI systems."}];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('game');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFShadowMap; // FIX: use PCFShadowMap (not soft)

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x020309, 0.007);

const camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 500);
camera.position.set(0, 8, 30);

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.4, 0.25);
composer.addPass(bloom);
composer.addPass(new OutputPass());

const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true; controls.dampingFactor = 0.05;
controls.enablePan = false; controls.minDistance = 8; controls.maxDistance = 80;
controls.maxPolarAngle = Math.PI * 0.75; controls.minPolarAngle = Math.PI * 0.15;
controls.autoRotate = true; controls.autoRotateSpeed = 0.3;
controls.target.set(0, 4, 0);

// â•â•â• LIGHTING â•â•â•
scene.add(new THREE.AmbientLight(0x1a2848, 0.5));
const keyLight = new THREE.DirectionalLight(0x8899bb, 0.8);
keyLight.position.set(20, 40, 20);
keyLight.castShadow = true;
keyLight.shadow.mapSize.set(2048, 2048);
keyLight.shadow.camera.far = 100;
keyLight.shadow.camera.left = -50; keyLight.shadow.camera.right = 50;
keyLight.shadow.camera.top = 50; keyLight.shadow.camera.bottom = -50;
scene.add(keyLight);
const moonLight = new THREE.DirectionalLight(0x3344ff, 0.3);
moonLight.position.set(-15, 25, -10);
scene.add(moonLight);
const rimLight = new THREE.PointLight(0xd4a0ff, 1.5, 40, 1.5);
rimLight.position.set(0, 2, 15);
scene.add(rimLight);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKYBOX â€” Spherical stars + Shooting stars
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Star sphere background
const starCount = 3000;
const starGeo = new THREE.BufferGeometry();
const starPos = new Float32Array(starCount * 3);
const starSizes = new Float32Array(starCount);
const starColors = new Float32Array(starCount * 3);
for (let i = 0; i < starCount; i++) {
  // Place on a large sphere
  const theta = Math.random() * Math.PI * 2;
  const phi = Math.acos(2 * Math.random() - 1);
  const r = 150 + Math.random() * 80;
  starPos[i*3]   = r * Math.sin(phi) * Math.cos(theta);
  starPos[i*3+1] = Math.abs(r * Math.sin(phi) * Math.sin(theta)); // keep above horizon
  starPos[i*3+2] = r * Math.cos(phi);
  starSizes[i] = 0.3 + Math.random() * 1.2;
  // Color variety: white, blue-white, warm white
  const temp = Math.random();
  if (temp > 0.8) { starColors[i*3]=0.7; starColors[i*3+1]=0.8; starColors[i*3+2]=1.0; }
  else if (temp > 0.6) { starColors[i*3]=1.0; starColors[i*3+1]=0.95; starColors[i*3+2]=0.8; }
  else { starColors[i*3]=0.9; starColors[i*3+1]=0.92; starColors[i*3+2]=0.95; }
}
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
starGeo.setAttribute('size', new THREE.BufferAttribute(starSizes, 1));
starGeo.setAttribute('color', new THREE.BufferAttribute(starColors, 3));

// Custom shader for round (circle) stars
const starMaterial = new THREE.ShaderMaterial({
  uniforms: { time: { value: 0 } },
  vertexShader: `
    attribute float size;
    attribute vec3 color;
    varying vec3 vColor;
    varying float vSize;
    uniform float time;
    void main() {
      vColor = color;
      vSize = size;
      vec4 mvPos = modelViewMatrix * vec4(position, 1.0);
      float twinkle = 0.7 + 0.3 * sin(time * 1.5 + position.x * 0.1 + position.y * 0.15);
      gl_PointSize = size * twinkle * (200.0 / -mvPos.z);
      gl_Position = projectionMatrix * mvPos;
    }
  `,
  fragmentShader: `
    varying vec3 vColor;
    void main() {
      float d = length(gl_PointCoord - vec2(0.5));
      if (d > 0.5) discard;
      float alpha = smoothstep(0.5, 0.1, d);
      float glow = exp(-d * 4.0) * 0.6;
      gl_FragColor = vec4(vColor * (alpha + glow), alpha);
    }
  `,
  transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
});
scene.add(new THREE.Points(starGeo, starMaterial));

// Shooting stars
const shootingStars = [];
function createShootingStar() {
  const points = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(8, 0, 0)];
  const geo = new THREE.BufferGeometry().setFromPoints(points);
  const mat = new THREE.LineBasicMaterial({
    color: 0xffffff, transparent: true, opacity: 0.8,
    blending: THREE.AdditiveBlending
  });
  const line = new THREE.Line(geo, mat);
  // Random start position high in the sky sphere
  const theta = Math.random() * Math.PI * 2;
  const r = 100 + Math.random() * 40;
  line.position.set(
    Math.cos(theta) * r,
    40 + Math.random() * 60,
    Math.sin(theta) * r
  );
  // Direction: angled downward
  const dir = new THREE.Vector3(
    -0.5 + Math.random(),
    -0.3 - Math.random() * 0.4,
    -0.5 + Math.random()
  ).normalize();
  line.lookAt(line.position.clone().add(dir));
  line.userData = { dir, speed: 60 + Math.random() * 80, life: 0, maxLife: 0.8 + Math.random() * 0.6 };
  scene.add(line);
  shootingStars.push(line);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCEDURAL CITY â€” Roads + Buildings together
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cityGroup = new THREE.Group();
scene.add(cityGroup);

// Ground plane
const groundMat = new THREE.MeshPhysicalMaterial({
  color: 0x0a0e18, metalness: 0.95, roughness: 0.08,
  clearcoat: 1.0, clearcoatRoughness: 0.02, transparent: true, opacity: 0.7
});
const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), groundMat);
ground.rotation.x = -Math.PI / 2; ground.position.y = -0.5;
ground.receiveShadow = true;
scene.add(ground);

// City grid parameters
const BLOCK = 16;         // distance between road centers
const ROAD_W = 4;         // road width
const LOT = BLOCK - ROAD_W; // buildable lot size
const GRID_R = 5;         // grid radius in blocks

// Draw roads
const roadMat = new THREE.MeshBasicMaterial({ color: 0x0e1830, transparent: true, opacity: 0.7 });
const laneMat = new THREE.MeshBasicMaterial({ color: 0x1e3060, transparent: true, opacity: 0.5 });

for (let i = -GRID_R; i <= GRID_R; i++) {
  const pos = i * BLOCK;
  // Horizontal roads
  const rH = new THREE.Mesh(new THREE.PlaneGeometry(GRID_R * BLOCK * 2 + ROAD_W, ROAD_W), roadMat);
  rH.rotation.x = -Math.PI / 2; rH.position.set(0, -0.48, pos);
  cityGroup.add(rH);
  // Center lane markers
  const lH = new THREE.Mesh(new THREE.PlaneGeometry(GRID_R * BLOCK * 2, 0.15), laneMat);
  lH.rotation.x = -Math.PI / 2; lH.position.set(0, -0.47, pos);
  cityGroup.add(lH);
  // Vertical roads
  const rV = new THREE.Mesh(new THREE.PlaneGeometry(ROAD_W, GRID_R * BLOCK * 2 + ROAD_W), roadMat);
  rV.rotation.x = -Math.PI / 2; rV.position.set(pos, -0.48, 0);
  cityGroup.add(rV);
  const lV = new THREE.Mesh(new THREE.PlaneGeometry(0.15, GRID_R * BLOCK * 2), laneMat);
  lV.rotation.x = -Math.PI / 2; lV.position.set(pos, -0.47, 0);
  cityGroup.add(lV);
}

// Sidewalk material
const sidewalkMat = new THREE.MeshStandardMaterial({ color: 0x151e35, roughness: 0.8, metalness: 0.2 });

// Building creation inside lot boundaries
function createBuilding(x, z, maxW, maxD, h) {
  const group = new THREE.Group();
  const w = maxW * (0.6 + Math.random() * 0.4);
  const d = maxD * (0.6 + Math.random() * 0.4);

  // Sidewalk pad
  const pad = new THREE.Mesh(new THREE.BoxGeometry(maxW + 0.6, 0.1, maxD + 0.6), sidewalkMat);
  pad.position.set(0, -0.45, 0);
  group.add(pad);

  // Main body
  const bodyMat = new THREE.MeshPhysicalMaterial({
    color: new THREE.Color().setHSL(0.6 + Math.random() * 0.1, 0.2, 0.06 + Math.random() * 0.04),
    metalness: 0.85 + Math.random() * 0.1, roughness: 0.1 + Math.random() * 0.1,
    clearcoat: 0.7, clearcoatRoughness: 0.15
  });
  const body = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), bodyMat);
  body.position.y = h / 2; body.castShadow = true; body.receiveShadow = true;
  group.add(body);

  // Window grid
  const windowRows = Math.floor(h / 2.0);
  const faces = [
    { axis: 'z', sign: 1, span: w, depth: d },
    { axis: 'z', sign: -1, span: w, depth: d },
    { axis: 'x', sign: 1, span: d, depth: w },
    { axis: 'x', sign: -1, span: d, depth: w }
  ];
  faces.forEach(face => {
    const cols = Math.max(2, Math.floor(face.span / 2.0));
    const winW = (face.span - 0.6) / cols;
    for (let r = 0; r < windowRows; r++) {
      for (let c = 0; c < cols; c++) {
        if (Math.random() < 0.3) continue;
        const lit = Math.random();
        let wc;
        if (lit > 0.7) wc = new THREE.Color().setHSL(0.12, 0.5, 0.4 + Math.random() * 0.3);
        else if (lit > 0.4) wc = new THREE.Color().setHSL(0.55, 0.4, 0.25 + Math.random() * 0.2);
        else wc = new THREE.Color().setHSL(0.42 + Math.random() * 0.15, 0.7, 0.35);
        const wm = new THREE.MeshBasicMaterial({ color: wc, transparent: true, opacity: 0.35 + Math.random() * 0.5, blending: THREE.AdditiveBlending });
        const wp = new THREE.Mesh(new THREE.PlaneGeometry(winW * 0.65, 1.0), wm);
        const lx = (c - (cols-1)/2) * winW;
        const ly = 1.5 + r * 2.0;
        if (face.axis === 'z') {
          wp.position.set(lx, ly, face.sign * (d/2 + 0.02));
          if (face.sign < 0) wp.rotation.y = Math.PI;
        } else {
          wp.position.set(face.sign * (w/2 + 0.02), ly, lx);
          wp.rotation.y = face.sign * Math.PI / 2;
        }
        group.add(wp);
      }
    }
  });

  // Rooftop lights
  if (Math.random() > 0.4) {
    const rl = new THREE.PointLight(
      [0x33ffbb, 0xff6b8a, 0x44ddff, 0xd4a0ff, 0xfbbf24][Math.floor(Math.random()*5)],
      0.6 + Math.random(), 10, 2
    );
    rl.position.set(0, h + 0.5, 0);
    group.add(rl);
  }
  // Antenna on tall buildings
  if (h > 18 && Math.random() > 0.4) {
    const sh = 2 + Math.random() * 3;
    const sp = new THREE.Mesh(
      new THREE.CylinderGeometry(0.04, 0.12, sh, 6),
      new THREE.MeshBasicMaterial({ color: 0x33ffbb, transparent: true, opacity: 0.5 })
    );
    sp.position.y = h + sh/2;
    group.add(sp);
  }

  group.position.set(x, -0.5, z);
  return group;
}

// Place buildings within each city block
for (let bx = -GRID_R; bx < GRID_R; bx++) {
  for (let bz = -GRID_R; bz < GRID_R; bz++) {
    const cx = bx * BLOCK + BLOCK / 2;
    const cz = bz * BLOCK + BLOCK / 2;
    const dist = Math.sqrt(cx * cx + cz * cz) / BLOCK;

    if (dist < 1.2) continue; // keep center clear

    // 1-3 buildings per block
    const numBuildings = 1 + Math.floor(Math.random() * 2.5);
    const baseH = Math.max(4, 28 - dist * 2.5 + Math.random() * 12);

    if (numBuildings === 1) {
      cityGroup.add(createBuilding(cx, cz, LOT * 0.9, LOT * 0.9, baseH));
    } else {
      // Split lot
      for (let bi = 0; bi < numBuildings; bi++) {
        const subW = LOT / numBuildings * 0.85;
        const subD = LOT * (0.5 + Math.random() * 0.4);
        const subH = baseH * (0.4 + Math.random() * 0.6);
        const ox = (bi - (numBuildings-1)/2) * (LOT / numBuildings);
        cityGroup.add(createBuilding(cx + ox, cz + (Math.random()-0.5)*2, subW, subD, subH));
      }
    }
  }
}

// â•â•â• NEBULA PARTICLES â•â•â•
const pCount = 1500;
const pPos = new Float32Array(pCount * 3);
const pCol = new Float32Array(pCount * 3);
const pColorsArr = [new THREE.Color(0x00ffa3), new THREE.Color(0x00d4ff), new THREE.Color(0xc084fc), new THREE.Color(0x3b82f6)];
for (let i = 0; i < pCount; i++) {
  const r = 10 + Math.random() * 70;
  const th = Math.random() * Math.PI * 2;
  const ph = Math.acos(2 * Math.random() - 1);
  pPos[i*3] = r * Math.sin(ph) * Math.cos(th);
  pPos[i*3+1] = Math.abs(r * Math.sin(ph) * Math.sin(th) * 0.3) + 2;
  pPos[i*3+2] = r * Math.cos(ph);
  const c = pColorsArr[Math.floor(Math.random() * pColorsArr.length)];
  pCol[i*3] = c.r; pCol[i*3+1] = c.g; pCol[i*3+2] = c.b;
}
const pGeo = new THREE.BufferGeometry();
pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
pGeo.setAttribute('color', new THREE.BufferAttribute(pCol, 3));
scene.add(new THREE.Points(pGeo, new THREE.PointsMaterial({
  size: 0.08, vertexColors: true, transparent: true, opacity: 0.6,
  blending: THREE.AdditiveBlending, depthWrite: false, sizeAttenuation: true
})));

// Orbital rings
for (let i = 0; i < 3; i++) {
  const r = 25 + i * 15;
  const torus = new THREE.Mesh(
    new THREE.TorusGeometry(r, 0.012, 4, 160),
    new THREE.MeshBasicMaterial({ color: [0x33ffbb, 0x44ddff, 0xd4a0ff][i], transparent: true, opacity: 0.08 })
  );
  torus.rotation.x = Math.PI * 0.4 + i * 0.12; torus.rotation.z = i * 0.25;
  scene.add(torus);
}

// â•â•â• SHIP â•â•â•
const ship = new THREE.Group();
scene.add(ship);
const shipMat = new THREE.MeshPhysicalMaterial({ color: 0x050505, metalness: 1.0, roughness: 0.05, clearcoat: 1.0 });
const shipGlow = new THREE.MeshBasicMaterial({ color: 0x44ddff, blending: THREE.AdditiveBlending, wireframe: true });
const hull = new THREE.Mesh(new THREE.OctahedronGeometry(0.5, 0), shipMat);
hull.scale.set(1, 0.3, 2); ship.add(hull);
const hullWire = new THREE.Mesh(new THREE.OctahedronGeometry(0.5, 0), shipGlow);
hullWire.scale.set(1.05, 0.35, 2.05); ship.add(hullWire);
const wG = new THREE.TetrahedronGeometry(0.6, 0);
const wL = new THREE.Mesh(wG, shipMat); wL.scale.set(1.5,0.1,0.8); wL.position.set(-0.8,0,-0.2); wL.rotation.z=Math.PI/8; ship.add(wL);
const wR = new THREE.Mesh(wG, shipMat); wR.scale.set(1.5,0.1,0.8); wR.position.set(0.8,0,-0.2); wR.rotation.z=-Math.PI/8; ship.add(wR);
const engineLight = new THREE.PointLight(0x33ffbb, 0, 10);
engineLight.position.set(0,0,1); ship.add(engineLight);
ship.position.set(0,10,20); ship.visible = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP = {
  sessions: [], currentSessionId: null,
  isContinuousRecording: false, isSpeaking: false, ttsEnabled: true,
  speechRecognition: null, synth: window.speechSynthesis,
  commands: [
    { keyword: 'search', action: 'searchCards' },
    { keyword: 'draw', action: 'drawSpread' },
    { keyword: 'fly', action: 'flight' }
  ],
  flightMode: false, flashTimeout: null
};
const flightParams = {
  velocity: new THREE.Vector3(), thrust: 0, maxSpeed: 40,
  drag: 0.98, gravity: 9.8, pitchSpeed: 1.5, yawSpeed: 1.5, rollSpeed: 2.0
};
const inputState = { pitch:0, yaw:0, roll:0, throttle:0 };
const keys = { w:false, a:false, s:false, d:false, q:false, e:false, space:false, shift:false };

// â•â•â• UTILITY â•â•â•
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,6); }
function ts() { const n=new Date(); let h=n.getHours(),m=n.getMinutes(); const ap=h>=12?'PM':'AM'; h=h%12||12; return `${h}:${String(m).padStart(2,'0')} ${ap}`; }
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),2000); }
function flashHUD(text) { const el=document.getElementById('hudFlash'); const txt=document.getElementById('hudFlashText'); txt.textContent=text.length>50?text.substring(0,50)+'â€¦':text; el.classList.add('active'); clearTimeout(APP.flashTimeout); APP.flashTimeout=setTimeout(()=>el.classList.remove('active'),2200); }

// â•â•â• SESSION MANAGEMENT â•â•â•
function loadSessions() {
  try { const s=localStorage.getItem('familiar_v8_sessions'); if(s) APP.sessions=JSON.parse(s); } catch(e){}
  if(!APP.sessions.length) window.createNewSession();
  else APP.currentSessionId=APP.sessions[0].id;
  renderHistory(); renderChat();
}
function saveSessions() { try{localStorage.setItem('familiar_v8_sessions',JSON.stringify(APP.sessions));}catch(e){} renderHistory(); }
window.createNewSession = function() { const s={id:genId(),title:'New Session',updatedAt:Date.now(),messages:[]}; APP.sessions.unshift(s); APP.currentSessionId=s.id; saveSessions(); renderChat(); };
function getCurrent() { return APP.sessions.find(s=>s.id===APP.currentSessionId); }

function renderHistory() {
  const el=document.getElementById('historyList'); el.innerHTML='';
  APP.sessions.forEach(session => {
    const active=session.id===APP.currentSessionId;
    const div=document.createElement('div');
    div.className=`history-item ${active?'active':''}`;
    div.innerHTML=`<div class="h-title">${session.title}</div><div class="h-time">${session.messages.length} entries Â· ${new Date(session.updatedAt).toLocaleDateString()}</div>`;
    div.addEventListener('click', e => {
      if(e.detail===2) {
        const allText=session.messages.filter(m=>m.role!=='system').map(m=>`[${m.timestamp}] ${m.role.toUpperCase()}: ${m.text}`).join('\n');
        navigator.clipboard.writeText(allText).then(()=>showToast(`Copied ${session.messages.length} entries to clipboard`));
      } else { APP.currentSessionId=session.id; renderHistory(); renderChat(); }
    });
    el.appendChild(div);
  });
}

function renderChat() {
  const area=document.getElementById('chatArea'); const empty=document.getElementById('emptyState');
  area.querySelectorAll('.msg').forEach(m=>m.remove());
  const session=getCurrent();
  if(!session||!session.messages.length){empty.style.display='flex';return;}
  empty.style.display='none';
  session.messages.forEach(m=>appendMsg(m));
  area.scrollTop=area.scrollHeight;
}

function appendMsg(msg) {
  document.getElementById('emptyState').style.display='none';
  const area=document.getElementById('chatArea');
  const div=document.createElement('div'); div.className=`msg ${msg.role}`;
  if(msg.role==='system'){div.innerHTML=`<div class="msg-bubble">${msg.text}</div>`;}
  else{div.innerHTML=`<div><div class="msg-meta"><span class="msg-role">${msg.role==='user'?'OPERATOR':'AI SYSTEM'}</span><span>${msg.timestamp}</span></div><div class="msg-bubble">${msg.text}</div></div>`;}
  const cr=document.getElementById('cardResults');
  area.insertBefore(div,cr);
  area.scrollTop=area.scrollHeight;
}

function addMsg(role, text) {
  const session=getCurrent();
  const msg={id:genId(),role,text,timestamp:ts()};
  session.messages.push(msg); session.updatedAt=Date.now();
  if(session.messages.length===1&&role==='user') session.title=text.substring(0,30)+(text.length>30?'â€¦':'');
  saveSessions(); appendMsg(msg);
  if(role==='user'){
    processCommands(text);
    const words=text.trim().split(/\s+/);
    const lastWord=words[words.length-1]||'';
    if(lastWord.length>=2) searchAndShowCards(lastWord);
    const matches=searchCards(lastWord).length;
    const aiText=`Processing "${lastWord}" â€” found ${matches} matching AI Guides. Topologies updated.`;
    setTimeout(()=>addMsg('ai',aiText),800);
  } else if(role==='ai'){
    if(APP.ttsEnabled){ const u=new SpeechSynthesisUtterance(text); u.rate=1.1; u.pitch=0.9; u.onstart=()=>{APP.isSpeaking=true;}; u.onend=()=>{APP.isSpeaking=false;}; APP.synth.speak(u); }
    else flashHUD(text);
  }
}

// â•â•â• CARD SEARCH â•â•â•
function searchCards(query) {
  const q=query.toLowerCase().trim(); if(!q) return [];
  return ARCANA.filter(a=>{
    const s=[a.name.toLowerCase(),a.concept.toLowerCase(),a.tags.join(' '),a.poem.join(' ').toLowerCase()].join(' ');
    return s.includes(q);
  }).map(a=>{let score=0;if(a.name.toLowerCase().includes(q))score+=10;if(a.tags.some(t=>t.includes(q)))score+=5;if(a.concept.toLowerCase().includes(q))score+=3;return{...a,score};}).sort((a,b)=>b.score-a.score);
}

function searchAndShowCards(query) {
  const results=searchCards(query);
  const container=document.getElementById('cardResults');
  const grid=document.getElementById('cardGrid');
  if(!results.length){container.classList.remove('visible');return;}
  document.getElementById('searchTermDisplay').textContent=`"${query}" â†’ ${results.length} matches`;
  grid.innerHTML='';
  results.forEach(card=>{
    const ch='#'+new THREE.Color(card.color).getHexString();
    const tile=document.createElement('div'); tile.className='card-tile';
    tile.innerHTML=`<div style="position:absolute;top:0;left:0;right:0;height:3px;background:${ch};border-radius:10px 10px 0 0;"></div><div class="ct-match">MATCH</div><div class="ct-num" style="color:${ch}">AI GUIDE ${String(card.id).padStart(2,'0')}</div><div class="ct-name" style="color:${ch}">${card.name}</div><div class="ct-poem" style="border-color:${ch};">${card.poem.slice(0,2).map(l=>`<div>${l}</div>`).join('')}</div><div class="ct-concept">${card.concept}</div><div class="ct-tags">${card.tags.map(t=>`<span class="ct-tag">${t}</span>`).join('')}</div>`;
    tile.addEventListener('click',()=>showCardDetail(card));
    grid.appendChild(tile);
  });
  container.classList.add('visible');
}

window.closeCardResults=function(){document.getElementById('cardResults').classList.remove('visible');};

function showCardDetail(arcana) {
  const p=document.getElementById('cardDetail');
  const ch='#'+new THREE.Color(arcana.color).getHexString();
  document.getElementById('cdNum').textContent=`AI GUIDE ${String(arcana.id).padStart(2,'0')} OF 80`;
  document.getElementById('cdNum').style.color=ch;
  document.getElementById('cdName').textContent=arcana.name;
  document.getElementById('cdName').style.color=ch;
  document.getElementById('cdPoem').innerHTML=arcana.poem.map(l=>`<span class="line">${l}</span>`).join('');
  document.getElementById('cdConcept').textContent=arcana.concept;
  document.getElementById('cdTags').innerHTML=arcana.tags.map(t=>`<span class="cd-tag">${t}</span>`).join('');
  p.classList.add('visible');
}
window.closeCardDetail=function(){document.getElementById('cardDetail').classList.remove('visible');};

// â•â•â• COMMANDS â•â•â•
function renderCommands() {
  const el=document.getElementById('cmdList'); el.innerHTML='';
  APP.commands.forEach((cmd,i)=>{el.innerHTML+=`<div class="cmd-row"><span class="kw">"${cmd.keyword}"</span><span class="act">${cmd.action}</span><span class="rm" onclick="removeCmd(${i})">Ã—</span></div>`;});
}
window.addCommand=function(){const kw=document.getElementById('cmdKeyword').value.trim().toLowerCase();const act=document.getElementById('cmdAction').value;if(kw){APP.commands.push({keyword:kw,action:act});document.getElementById('cmdKeyword').value='';renderCommands();}};
window.removeCmd=function(i){APP.commands.splice(i,1);renderCommands();};
function processCommands(text){const l=text.toLowerCase();APP.commands.forEach(cmd=>{if(l.includes(cmd.keyword)){const w=l.split(/\s+/);const last=w[w.length-1]||'node';switch(cmd.action){case 'searchCards':searchAndShowCards(last);break;case 'drawSpread':window.drawSpread();break;case 'flight':window.toggleFlightMode();break;case 'clearChat':getCurrent().messages=[];saveSessions();renderChat();break;}}});}

// â•â•â• SEND â•â•â•
window.sendMessage=function(){const input=document.getElementById('chatInput');const text=input.value.trim();if(!text)return;input.value='';addMsg('user',text);};
document.getElementById('chatInput').addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();window.sendMessage();}});

// â•â•â• DRAW SPREAD â•â•â•
window.drawSpread=function(){
  const shuffled=[...ARCANA].sort(()=>Math.random()-0.5).slice(0,3);
  addMsg('system',`SPREAD DRAWN: ${shuffled.map(s=>s.name).join(', ')}`);
  const container=document.getElementById('cardResults');
  const grid=document.getElementById('cardGrid');
  document.getElementById('searchTermDisplay').textContent=`3-Card Spread â€” Past / Present / Future`;
  grid.innerHTML='';
  const labels=['PAST â€” EMERGENCE','PRESENT â€” MIRROR','FUTURE â€” CONVERGENCE'];
  shuffled.forEach((card,i)=>{
    const ch='#'+new THREE.Color(card.color).getHexString();
    const tile=document.createElement('div'); tile.className='card-tile';
    tile.innerHTML=`<div style="position:absolute;top:0;left:0;right:0;height:3px;background:${ch};border-radius:10px 10px 0 0;"></div><div class="ct-match" style="background:rgba(212,160,255,0.2);color:var(--violet);">${labels[i]}</div><div class="ct-num" style="color:${ch}">AI GUIDE ${String(card.id).padStart(2,'0')}</div><div class="ct-name" style="color:${ch}">${card.name}</div><div class="ct-poem" style="border-color:${ch};">${card.poem.map(l=>`<div>${l}</div>`).join('')}</div><div class="ct-concept">${card.concept}</div><div class="ct-tags">${card.tags.map(t=>`<span class="ct-tag">${t}</span>`).join('')}</div>`;
    tile.addEventListener('click',()=>showCardDetail(card));
    grid.appendChild(tile);
  });
  container.classList.add('visible');
};

// â•â•â• TTS â•â•â•
window.toggleTTS=function(){APP.ttsEnabled=!APP.ttsEnabled;document.getElementById('btnTTS').classList.toggle('active',APP.ttsEnabled);if(!APP.ttsEnabled&&APP.synth.speaking)APP.synth.cancel();document.getElementById('systemMode').textContent=APP.ttsEnabled?'NEURAL VOICE PROTOCOL â€” AUDIO ON':'NEURAL VOICE PROTOCOL â€” SILENT MODE';flashHUD(APP.ttsEnabled?'AUDIO FEEDBACK ENABLED':'SILENT MODE');};
window.toggleSidebar=function(){document.getElementById('sidebar').classList.toggle('collapsed');};

// â•â•â• DOWNLOAD â•â•â•
window.downloadArchive=function(){const s=getCurrent();if(!s||!s.messages.length){showToast('No messages');return;}const c=s.messages.map(m=>`[${m.timestamp}] ${m.role.toUpperCase()}: ${m.text}`).join('\n\n');const b=new Blob([c],{type:'text/plain'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;const n=new Date();a.download=`familiar_log_${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}.txt`;a.click();URL.revokeObjectURL(u);showToast('Archive downloaded');};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEECH RECOGNITION â€” FIXED auto-restart
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognitionAPI) {
  const sr = new SpeechRecognitionAPI();
  sr.continuous = true;
  sr.interimResults = true;
  sr.lang = 'en-US';
  sr.maxAlternatives = 1;
  APP.speechRecognition = sr;

  let restartTimer = null;

  sr.onstart = () => {
    console.log('[STT] Recognition started');
    document.getElementById('micBtn').classList.add('recording');
    document.getElementById('statusText').textContent = 'Continuous Listeningâ€¦';
    document.getElementById('statusText').classList.add('live');
    document.getElementById('recStatus').textContent = 'Audio: Active';
    document.getElementById('recStatus').classList.add('live');
  };

  sr.onresult = (event) => {
    if (APP.isSpeaking) return; // ignore echo
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        const text = event.results[i][0].transcript.trim();
        if (text) {
          document.getElementById('chatInput').value = '';
          addMsg('user', text);
        }
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    if (interim) document.getElementById('chatInput').value = interim;
  };

  sr.onerror = (event) => {
    console.warn('[STT] Error:', event.error);
    // On "no-speech" or "aborted", just restart if still recording
    if (APP.isContinuousRecording && (event.error === 'no-speech' || event.error === 'aborted' || event.error === 'network')) {
      clearTimeout(restartTimer);
      restartTimer = setTimeout(() => {
        if (APP.isContinuousRecording) {
          try { sr.start(); } catch(e) { console.warn('[STT] restart failed:', e); }
        }
      }, 300);
    }
  };

  sr.onend = () => {
    console.log('[STT] Recognition ended, continuous =', APP.isContinuousRecording);
    if (APP.isContinuousRecording) {
      // Restart with a small delay to avoid rapid cycling
      clearTimeout(restartTimer);
      restartTimer = setTimeout(() => {
        if (APP.isContinuousRecording) {
          try {
            sr.start();
          } catch(e) {
            console.warn('[STT] restart failed, retrying in 500ms:', e);
            setTimeout(() => {
              if (APP.isContinuousRecording) {
                try { sr.start(); } catch(e2) {}
              }
            }, 500);
          }
        }
      }, 200);
    } else {
      // Fully stopped
      document.getElementById('micBtn').classList.remove('recording');
      document.getElementById('statusText').textContent = 'System Idle';
      document.getElementById('statusText').classList.remove('live');
      document.getElementById('recStatus').textContent = 'Audio: Standby';
      document.getElementById('recStatus').classList.remove('live');
    }
  };
} else {
  console.warn('SpeechRecognition API not available');
}

window.toggleMic = function() {
  if (!APP.speechRecognition) {
    showToast('Speech recognition not available in this browser');
    return;
  }
  APP.isContinuousRecording = !APP.isContinuousRecording;
  console.log('[STT] Toggle mic, continuous =', APP.isContinuousRecording);
  if (APP.isContinuousRecording) {
    try { APP.speechRecognition.start(); }
    catch(e) {
      // Might already be running, abort and restart
      console.warn('[STT] start failed, aborting and retrying:', e);
      try { APP.speechRecognition.abort(); } catch(e2) {}
      setTimeout(() => {
        try { APP.speechRecognition.start(); } catch(e3) {
          console.error('[STT] Could not start:', e3);
          APP.isContinuousRecording = false;
          showToast('Could not start speech recognition');
        }
      }, 300);
    }
  } else {
    try { APP.speechRecognition.abort(); } catch(e) {}
  }
};

// â•â•â• FLIGHT MODE â•â•â•
window.toggleFlightMode=function(){
  APP.flightMode=!APP.flightMode;
  const btn=document.getElementById('btnFlight');const ov=document.getElementById('flightOverlay');const al=document.getElementById('appLayer');
  if(APP.flightMode){btn.classList.add('active');ov.classList.add('active');al.style.opacity='0.15';al.style.pointerEvents='none';ship.visible=true;ship.position.set(0,15,20);ship.quaternion.identity();flightParams.velocity.set(0,0,0);controls.enabled=false;controls.autoRotate=false;}
  else{btn.classList.remove('active');ov.classList.remove('active');al.style.opacity='1';al.style.pointerEvents='';ship.visible=false;controls.enabled=true;controls.autoRotate=true;camera.position.set(0,8,30);controls.target.set(0,4,0);}
};

function updateFlight(dt) {
  let p=inputState.pitch,y=inputState.yaw,r=inputState.roll,th=inputState.throttle;
  if(keys.w)p=1;if(keys.s)p=-1;if(keys.a)r=1;if(keys.d)r=-1;if(keys.q)y=1;if(keys.e)y=-1;if(keys.space)th=1;if(keys.shift)th=-0.5;
  if(Math.abs(r)<0.01){const up=new THREE.Vector3(0,1,0).applyQuaternion(ship.quaternion);r=-up.dot(new THREE.Vector3(1,0,0))*2.0;}
  if(ship.position.y<1.0){ship.position.y=1.0;flightParams.velocity.y*=-0.5;}else if(ship.position.y<8.0&&flightParams.velocity.y<0){flightParams.velocity.y+=(8.0-ship.position.y)*2.0*dt;}
  const qP=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),p*flightParams.pitchSpeed*dt);
  const qY=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),y*flightParams.yawSpeed*dt);
  const qR=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),r*flightParams.rollSpeed*dt);
  ship.quaternion.multiply(qY).multiply(qP).multiply(qR).normalize();
  const fwd=new THREE.Vector3(0,0,-1).applyQuaternion(ship.quaternion);
  flightParams.thrust+=(th*flightParams.maxSpeed-flightParams.thrust)*2.0*dt;
  engineLight.intensity=Math.max(0,flightParams.thrust/flightParams.maxSpeed)*10;
  const accel=fwd.clone().multiplyScalar(flightParams.thrust);accel.y-=flightParams.gravity;
  flightParams.velocity.add(accel.clone().multiplyScalar(dt));flightParams.velocity.multiplyScalar(flightParams.drag);
  ship.position.add(flightParams.velocity.clone().multiplyScalar(dt));
  const ct=ship.position.clone().add(fwd.clone().multiplyScalar(-6)).add(new THREE.Vector3(0,1,0).applyQuaternion(ship.quaternion).multiplyScalar(1.5));
  camera.position.lerp(ct,0.1);camera.lookAt(ship.position.clone().add(fwd.clone().multiplyScalar(10)));
  document.getElementById('flightData').innerHTML=`SPD: ${flightParams.velocity.length().toFixed(1)}<br>ALT: ${ship.position.y.toFixed(1)}<br>AI: ON`;
}

// â•â•â• INPUT â•â•â•
document.addEventListener('keydown',e=>{const k=e.key.toLowerCase();if(keys.hasOwnProperty(k))keys[k]=true;if(e.code==='Space'&&APP.flightMode){keys.space=true;e.preventDefault();}if(e.key==='Escape'){window.closeCardDetail();window.closeCardResults();}});
document.addEventListener('keyup',e=>{const k=e.key.toLowerCase();if(keys.hasOwnProperty(k))keys[k]=false;if(e.code==='Space')keys.space=false;});
function setupJoystick(zId,sId,cb){const z=document.getElementById(zId);const s=document.getElementById(sId);let a=false;const mx=40;const h=e=>{if(!a)return;const r=z.getBoundingClientRect();let dx=e.clientX-(r.left+r.width/2);let dy=e.clientY-(r.top+r.height/2);const d=Math.sqrt(dx*dx+dy*dy);if(d>mx){dx=dx/d*mx;dy=dy/d*mx;}s.style.transform=`translate(${dx}px,${dy}px)`;cb(dx/mx,dy/mx);};z.addEventListener('pointerdown',e=>{a=true;z.setPointerCapture(e.pointerId);h(e);});z.addEventListener('pointermove',h);const end=e=>{a=false;z.releasePointerCapture(e.pointerId);s.style.transform='translate(0,0)';cb(0,0);};z.addEventListener('pointerup',end);z.addEventListener('pointercancel',end);}
setupJoystick('joyLeft','stickLeft',(x,y)=>{inputState.yaw=-x;inputState.throttle=-y;});
setupJoystick('joyRight','stickRight',(x,y)=>{inputState.roll=-x;inputState.pitch=y;});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMATION LOOP â€” manual delta time (no THREE.Clock)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const startTime = performance.now();
let lastFrameTime = performance.now();

function animate() {
  requestAnimationFrame(animate);
  const now = performance.now();
  const t = (now - startTime) * 0.001;
  const dt = Math.min((now - lastFrameTime) * 0.001, 0.1);
  lastFrameTime = now;

  // Update star shader time
  starMaterial.uniforms.time.value = t;

  // Shooting stars
  if (Math.random() < 0.008) createShootingStar(); // ~0.5 per second
  for (let i = shootingStars.length - 1; i >= 0; i--) {
    const ss = shootingStars[i];
    ss.userData.life += dt;
    ss.position.add(ss.userData.dir.clone().multiplyScalar(ss.userData.speed * dt));
    ss.material.opacity = 1.0 - (ss.userData.life / ss.userData.maxLife);
    if (ss.userData.life >= ss.userData.maxLife) {
      scene.remove(ss);
      ss.geometry.dispose(); ss.material.dispose();
      shootingStars.splice(i, 1);
    }
  }

  if (APP.flightMode) { updateFlight(dt); }
  else { controls.update(); }

  // Particle drift
  const pp = pGeo.attributes.position.array;
  for (let i = 0; i < pCount; i++) {
    pp[i*3+1] += Math.sin(t * 0.15 + i * 0.4) * 0.0008;
    pp[i*3] += Math.cos(t * 0.1 + i * 0.3) * 0.0004;
  }
  pGeo.attributes.position.needsUpdate = true;

  rimLight.position.x = Math.sin(t * 0.3) * 8;
  rimLight.position.z = 12 + Math.cos(t * 0.2) * 4;

  composer.render();
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  composer.setSize(window.innerWidth, window.innerHeight);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Card UI visible immediately
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderCommands();
loadSessions();
document.getElementById('btnTTS').classList.add('active');

// Auto-draw an initial spread so cards are visible on start
setTimeout(() => { window.drawSpread(); }, 400);
</script>
</body>
</html>
