<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Morphogenesis 3D</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css"/>
    <style>
        body { margin: 0; background-color: #0e1117; color: white; }
        #root { display: flex; flex-direction: column; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
        stlite.mount({
            requirements: ["numpy"],
            entrypoint: "app.py",
            files: {
                "app.py": `
import streamlit as st
import streamlit.components.v1 as components
import numpy as np
import json

st.set_page_config(layout="wide")

# 1. SETUP STATE
if 'agents' not in st.session_state:
    # [x, y, z, color_val]
    st.session_state.agents = np.random.uniform(-4, 4, (60, 4)).tolist()

st.title("Morphogenesis: Local Exchange")

# 2. LOGIC (The Migration)
def evolve():
    data = np.array(st.session_state.agents)
    for i in range(len(data)):
        val = data[i, 3]
        # Find neighbors with similar value (stigmery)
        mask = np.abs(data[:, 3] - val) < 0.2
        neighbors = data[mask]
        if len(neighbors) > 1:
            center = neighbors[:, :3].mean(axis=0)
            data[i, :3] += (center - data[i, :3]) * 0.1
    st.session_state.agents = data.tolist()

# 3. RENDERER (Constructed safely without triple quotes)
agents_json = json.dumps(st.session_state.agents)

# We build the HTML string line-by-line to avoid syntax errors
html_lines = [
    '<div id="3d-view" style="width:100%; height:450px; background:#000;"></div>',
    '<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>',
    '<script>',
    f'var data = {agents_json};',
    'var scene = new THREE.Scene();',
    'var camera = new THREE.PerspectiveCamera(75, window.innerWidth/450, 0.1, 1000);',
    'var renderer = new THREE.WebGLRenderer({antialias: true});',
    'renderer.setSize(window.innerWidth, 450);',
    'document.getElementById("3d-view").appendChild(renderer.domElement);',
    
    'var group = new THREE.Group();',
    'data.forEach(function(d) {',
    '  var geo = new THREE.SphereGeometry(0.2, 16, 16);',
    '  var color = new THREE.Color().setHSL(d[3], 0.7, 0.5);',
    '  var mat = new THREE.MeshPhongMaterial({color: color});',
    '  var mesh = new THREE.Mesh(geo, mat);',
    '  mesh.position.set(d[0], d[1], d[2]);',
    '  group.add(mesh);',
    '});',
    'scene.add(group);',
    
    'var light = new THREE.PointLight(0xffffff, 1, 100);',
    'light.position.set(10, 10, 10);',
    'scene.add(light);',
    'scene.add(new THREE.AmbientLight(0x404040));',
    'camera.position.z = 10;',
    
    'function animate() {',
    '  requestAnimationFrame(animate);',
    '  group.rotation.y += 0.005;',
    '  renderer.render(scene, camera);',
    '}',
    'animate();',
    '</script>'
]

# Join lines into one string
html_code = "".join(html_lines)

components.html(html_code, height=460)

# 4. CONTROLS
c1, c2 = st.columns(2)
if c1.button("Simulate Migration Step"):
    evolve()
    st.rerun()

if c2.button("Reset Field"):
    st.session_state.agents = np.random.uniform(-4, 4, (60, 4)).tolist()
    st.rerun()
`
            }
        });
    </script>
</body>
</html>
