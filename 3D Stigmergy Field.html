<!DOCTYPE html>
<html>
  <head>
    <title>Morphogenesis 3D</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css"/>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["numpy"],
        entrypoint: "app.py",
        files: {
          "app.py": `
import streamlit as st
import streamlit.components.v1 as components
import numpy as np
import json

# 1. Initialize Global Latent Space
if 'agents' not in st.session_state:
    # 100 agents: [x, y, z, val]
    st.session_state.agents = np.random.uniform(-5, 5, (100, 4)).tolist()

st.title("Community Morphogenesis")

# 2. Logic: The "Sense Organ"
def run_evolution():
    data = np.array(st.session_state.agents)
    for i in range(len(data)):
        # Stigmergy: sense neighbors with similar 'val' (column 3)
        my_val = data[i, 3]
        # Find neighbors within semantic border
        neighbors = data[np.abs(data[:, 3] - my_val) < 0.1]
        if len(neighbors) > 1:
            center_of_mass = neighbors[:, :3].mean(axis=0)
            # Migrate toward kindred clusters
            data[i, :3] += (center_of_mass - data[i, :3]) * 0.05 
    st.session_state.agents = data.tolist()

# 3. The Three.js Bridge
# We pass the data into the HTML component via a JSON string
three_js_html = f"""
<div id="canvas-container" style="width:100%; height:400px; background:#111; border-radius:15px;"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const agentData = {json.dumps(st.session_state.agents)};
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/400, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({{antialias: true}});
    renderer.setSize(window.innerWidth, 400);
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // Create agents as 3D points
    agentData.forEach(d => {{
        const geo = new THREE.SphereGeometry(0.1, 8, 8);
        const mat = new THREE.MeshBasicMaterial({{ color: new THREE.Color().setHSL(d[3], 0.8, 0.5) }});
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(d[0], d[1], d[2]);
        scene.add(mesh);
    }});

    camera.position.z = 10;
    const animate = () => {{
        requestAnimationFrame(animate);
        scene.rotation.y += 0.005; // Slow rotation of the field
        renderer.render(scene, camera);
    }};
    animate();
</script>
"""

components.html(three_js_html, height=420)

col1, col2 = st.columns(2)
if col1.button("Migrate (Step)"):
    run_evolution()
    st.rerun()

if col2.button("Reset Field"):
    st.session_state.agents = np.random.uniform(-5, 5, (100, 4)).tolist()
    st.rerun()

st.markdown("> *The array isn't just a listâ€”it's a field of agents using local competency to reach a global homeostatic state.*")
          `
        }
      });
    </script>
  </body>
</html>
