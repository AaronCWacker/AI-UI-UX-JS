<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>3D Stigmergy Field</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css"/>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["numpy"],
        entrypoint: "app.py",
        files: {
          "app.py": `
import streamlit as st
import streamlit.components.v1 as components
import numpy as np
import json

st.set_page_config(layout="wide", page_title="Three.js Morphogenesis")

st.title("ðŸ§Š 3D Latent Space Migration")
st.caption("Agents finding their 'kindred' clusters via Three.js and Stlite")

# 1. State Management (The "Memory" of the Community)
if 'agent_data' not in st.session_state:
    # Create 50 agents with random 3D positions and 'Value' (Color)
    # [x, y, z, value]
    st.session_state.agent_data = np.random.uniform(-5, 5, (50, 4)).tolist()

# 2. Local Agency Logic
def compute_migration():
    data = np.array(st.session_state.agent_data)
    # Simple rule: move closer to agents with similar values
    for i in range(len(data)):
        # Calculate 'Kindred' pull: simple vector shift toward mean of similar values
        my_val = data[i, 3]
        kindred_indices = np.where(np.abs(data[:, 3] - my_val) < 0.2)[0]
        if len(kindred_indices) > 1:
            target_pos = data[kindred_indices, :3].mean(axis=0)
            data[i, :3] += (target_pos - data[i, :3]) * 0.1 # Small step
    st.session_state.agent_data = data.tolist()

# 3. Three.js Component (The Rendering Engine)
three_js_code = f"""
<div id="container" style="width: 100%; height: 500px; background: #000;"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const data = {json.dumps(st.session_state.agent_data)};
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 500, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({{ antialias: true, alpha: true }});
    renderer.setSize(window.innerWidth, 500);
    document.getElementById('container').appendChild(renderer.domElement);

    const spheres = [];
    data.forEach(item => {{
        const geometry = new THREE.SphereGeometry(0.2, 16, 16);
        const material = new THREE.MeshPhongMaterial({{ 
            color: new THREE.Color().setHSL(item[3], 0.8, 0.5),
            emissive: new THREE.Color().setHSL(item[3], 0.8, 0.2)
        }});
        const sphere = new THREE.Mesh(geometry, material);
        sphere.position.set(item[0], item[1], item[2]);
        scene.add(sphere);
        spheres.push(sphere);
    }});

    const light = new THREE.PointLight(0xffffff, 1, 100);
    light.position.set(10, 10, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));
    camera.position.z = 12;

    function animate() {{
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }}
    animate();
</script>
"""

# Render the 3D Scene
components.html(three_js_code, height=520)

# Controls
if st.button("Trigger Migration Step"):
    compute_migration()
    st.rerun()

if st.button("Reset Field"):
    st.session_state.agent_data = np.random.uniform(-5, 5, (50, 4)).tolist()
    st.rerun()

st.info("Observe how 'Kindred Values' (Colors) begin to cluster in 3D space. "
        "This is the heartbeat of morphogenesis: sorting via local exchange.")
          `
        }
      });
    </script>
  </body>
</html>
