<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alien: Earth - 3D Arcade Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=stylesheet" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0c0a1e;
            color: #e0e0e0;
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #game-container {
            border: 4px solid #4f4f4f;
            box-shadow: 0 0 20px #ff00ff, 0 0 30px #00ffff, inset 0 0 15px #000000;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .text-glow {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff00ff, 0 0 20px #ff00ff;
        }
        .btn-glow {
            box-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
            transition: all 0.3s ease;
        }
        .btn-glow:hover {
            box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff;
            transform: translateY(-2px);
        }
        .modal {
            background-color: rgba(12, 10, 30, 0.95);
            border: 2px solid #ff00ff;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        canvas {
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            background-color: #1a1a2e;
            cursor: crosshair;
            display: block;
            width: 100%;
            height: 100%;
        }
        .character-card {
            border: 2px solid #4f4f4f;
            transition: all 0.3s ease;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }
        .character-card.selected {
            border-color: #ff00ff;
            box-shadow: 0 0 15px #ff00ff;
        }
        .powerup-toast {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .touch-controls {
            position: absolute;
            bottom: 10px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            z-index: 100;
            padding: 0 10px;
            pointer-events: none;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: auto;
        }
        .control-group.left { justify-self: start; align-items: center; }
        .control-group.center { justify-self: center; align-items: center; }
        .control-group.right { justify-self: end; align-items: center; }
        .direction-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 4px;
            width: fit-content;
        }
        .touch-button {
            width: 70px; height: 70px;
            border: 3px solid #00ffff;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            color: #00ffff; font-size: 2.5rem;
            user-select: none;
            box-shadow: 0 0 15px #00ffff, inset 0 0 10px rgba(0, 255, 255, 0.2);
            background: rgba(0, 255, 255, 0.1);
            touch-action: manipulation;
        }
        .touch-button.active { background: rgba(0, 255, 255, 0.3); transform: scale(0.95); }
        .touch-button.fire { width: 90px; height: 90px; border-color: #ff00ff; color: #ff00ff; box-shadow: 0 0 20px #ff00ff; background: rgba(255, 0, 255, 0.1); }
        .touch-button.ability { width: 70px; height: 70px; border-color: #fbbf24; color: #fbbf24; box-shadow: 0 0 15px #fbbf24; background: rgba(251, 191, 36, 0.1); }
        #start-screen { text-align: center; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 2rem 1rem; padding-top: 10vh; overflow-y: auto; box-sizing: border-box; }
        #start-screen h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); margin: 0.5rem 0; }
        #start-screen .button-container { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 300px; }
        #start-screen button { background-color: #06b6d4; color: #000; font-weight: bold; padding: 1rem 2rem; border-radius: 0.5rem; border: none; cursor: pointer; width: 100%; }
        #character-selection-screen { display: none; text-align: center; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 1rem; overflow-y: auto; }
        #character-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; width: 100%; max-width: 64rem; }
        #game-screen { display: none; width: 100%; height: 100%; position: relative; }
        #hud { position: absolute; top: 10px; left: 10px; z-index: 50; }
        #health-bar-container { width: 150px; height: 20px; background: rgba(0,0,0,0.7); border: 2px solid #4f4f4f; border-radius: 4px; overflow: hidden; }
        #health-bar { height: 100%; background: #10b981; transition: width 0.3s ease; }
        #ability-cooldown-container { width: 150px; height: 10px; background: rgba(0,0,0,0.7); border: 1px solid #4f4f4f; margin-top: 5px; }
        #ability-cooldown-bar { height: 100%; background: #fbbf24; width: 100%; }
        #game-over-modal, #pause-modal, #high-score-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; z-index: 1000; background: rgba(0, 0, 0, 0.8); }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-screen">
            <h1 class="text-glow">ALIEN: EARTH</h1>
            <h2>Defend the Colony</h2>
            <div class="button-container">
                <button id="start-game-btn" class="btn-glow">START GAME</button>
                <button id="high-score-btn" class="btn-glow">HIGH SCORES</button>
            </div>
        </div>

        <div id="character-selection-screen">
            <h2 class="text-glow">SELECT HERO</h2>
            <div id="character-grid"></div>
            <div id="character-details" style="margin: 20px;">
                <div id="char-name" style="font-size: 1.5rem; color: #00ffff;"></div>
                <div id="char-passive" style="color: #fbbf24;"></div>
            </div>
            <button id="play-game-btn" class="btn-glow" style="display:none; padding: 1rem 2rem; background: #ff00ff; border:none; cursor:pointer;">DEPLOY</button>
        </div>

        <div id="game-screen">
            <canvas id="game-canvas"></canvas>
            <div id="hud">
                <div>SCORE: <span id="score">0</span></div>
                <div>WAVE: <span id="wave">1</span></div>
                <div id="health-bar-container"><div id="health-bar"></div></div>
                <div id="ability-cooldown-container"><div id="ability-cooldown-bar"></div></div>
            </div>
            <div class="touch-controls">
                <div class="control-group left">
                    <div class="direction-pad">
                        <div></div><div id="up-touch" class="touch-button">‚¨ÜÔ∏è</div><div></div>
                        <div id="left-touch" class="touch-button">‚¨ÖÔ∏è</div><div></div><div id="right-touch" class="touch-button">‚û°Ô∏è</div>
                        <div></div><div id="down-touch" class="touch-button">‚¨áÔ∏è</div><div></div>
                    </div>
                </div>
                <div class="control-group center"><div id="fire-touch" class="touch-button fire">üéØ</div></div>
                <div class="control-group right"><div id="ability-touch" class="touch-button ability">‚ö°</div></div>
            </div>
            <div class="powerup-toast" id="powerup-toast"></div>
        </div>

        <div id="game-over-modal" class="modal">
            <h2 class="text-glow">MISSION FAILED</h2>
            <p>Score: <span id="final-score">0</span></p>
            <button id="restart-game-btn" class="btn-glow">RETRY</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const scoreEl = document.getElementById('score');
        const waveEl = document.getElementById('wave');
        const healthBar = document.getElementById('health-bar');
        const abilityBar = document.getElementById('ability-cooldown-bar');
        const charGrid = document.getElementById('character-grid');
        const charNameDisp = document.getElementById('char-name');
        const charPassDisp = document.getElementById('char-passive');
        const playGameBtn = document.getElementById('play-game-btn');
        const powerupToast = document.getElementById('powerup-toast');

        let scene, camera, renderer, raycaster, mouse, gamePlane;
        let player, gameActive = false, score = 0, wave = 1, isPaused = false;
        let projectiles = [], enemies = [], explosions = [], powerups = [], enemyProjectiles = [];
        let keys = { w: {pressed:false}, a: {pressed:false}, s: {pressed:false}, d: {pressed:false} };
        let GAME_WIDTH = 60, GAME_HEIGHT = 40;
        let selectedCharacter = null;

        const CHARACTERS = [
            { name: 'Kirsh', color: 0x00ffff, ability: 'Shield', cooldown: 10000, passive: 'Auto-Shield', emoji: 'üõ°Ô∏è' },
            { name: 'Ravage', color: 0xff4444, ability: 'Missile', cooldown: 8000, passive: 'Explosive', emoji: 'üöÄ' },
            { name: 'Sif', color: 0xfbbf24, ability: 'Slow', cooldown: 15000, passive: 'Speedster', emoji: '‚è±Ô∏è' },
            { name: 'Nexus', color: 0x8b5cf6, ability: 'Orbital', cooldown: 12000, passive: 'Regen', emoji: 'üõ∏' }
        ];

        class Player {
            constructor(char) {
                this.char = char;
                this.health = 100;
                this.maxHealth = 100;
                this.targetRegen = 100;
                this.speed = char.name === 'Sif' ? 0.45 : 0.3;
                this.fireRate = 200;
                this.lastShot = 0;
                this.abilityReady = true;
                this.abilityTimer = 0;

                const geo = new THREE.BoxGeometry(2, 1, 2);
                const mat = new THREE.MeshPhongMaterial({ color: char.color });
                this.model = new THREE.Mesh(geo, mat);
                this.model.position.set(0, -15, 0);
                scene.add(this.model);
            }

            update() {
                if (keys.a.pressed && this.model.position.x > -GAME_WIDTH/2) this.model.position.x -= this.speed;
                if (keys.d.pressed && this.model.position.x < GAME_WIDTH/2) this.model.position.x += this.speed;
                if (keys.w.pressed && this.model.position.y < GAME_HEIGHT/2) this.model.position.y += this.speed;
                if (keys.s.pressed && this.model.position.y > -GAME_HEIGHT/2) this.model.position.y -= this.speed;

                if (this.health < this.targetRegen) {
                    this.health += 0.05;
                    const pulse = 1 + Math.sin(Date.now() * 0.01) * 0.1;
                    this.model.scale.set(pulse, pulse, pulse);
                    updateUI();
                } else {
                    this.model.scale.set(1, 1, 1);
                }

                if (!this.abilityReady) {
                    this.abilityTimer -= 16.67;
                    abilityBar.style.width = `${100 - (this.abilityTimer/this.char.cooldown)*100}%`;
                    if (this.abilityTimer <= 0) this.abilityReady = true;
                }
            }

            takeDamage(amt) {
                const prev = this.health;
                this.health = Math.max(0, this.health - amt);
                this.targetRegen = this.health + (prev - this.health) * 0.5;
                updateUI();
                if (this.health <= 0) endGame();
            }

            shoot(target) {
                const now = Date.now();
                if (now - this.lastShot < this.fireRate) return;
                this.lastShot = now;
                const dir = new THREE.Vector3().subVectors(target, this.model.position).normalize();
                projectiles.push(new Projectile(this.model.position.clone(), dir, true));
            }
        }

        class Projectile {
            constructor(pos, dir, isPlayer) {
                this.isPlayer = isPlayer;
                this.dir = dir;
                this.speed = isPlayer ? 0.8 : 0.12;
                const geo = new THREE.SphereGeometry(isPlayer ? 0.3 : 0.5, 8, 8);
                const mat = new THREE.MeshBasicMaterial({ color: isPlayer ? 0x00ff00 : 0xff00ff });
                this.model = new THREE.Mesh(geo, mat);
                this.model.position.copy(pos);
                scene.add(this.model);
            }
            update() {
                this.model.position.add(this.dir.clone().multiplyScalar(this.speed));
            }
        }

        class Enemy {
            constructor() {
                this.health = 20;
                const geo = new THREE.ConeGeometry(1, 2, 4);
                const mat = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                this.model = new THREE.Mesh(geo, mat);
                this.model.position.set(Math.random()*GAME_WIDTH - GAME_WIDTH/2, GAME_HEIGHT/2 + 5, 0);
                this.shootTimer = Math.random() * 200;
                scene.add(this.model);
            }
            update() {
                this.model.position.y -= 0.05;
                this.shootTimer++;
                if (this.shootTimer > 300) {
                    const dir = new THREE.Vector3().subVectors(player.model.position, this.model.position).normalize();
                    enemyProjectiles.push(new Projectile(this.model.position.clone(), dir, false));
                    this.shootTimer = 0;
                }
            }
        }

        function initCharacterSelection() {
            charGrid.innerHTML = '';
            CHARACTERS.forEach(c => {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.innerHTML = `<div style="font-size:2rem">${c.emoji}</div><div>${c.name}</div>`;
                card.onclick = () => {
                    document.querySelectorAll('.character-card').forEach(el => el.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedCharacter = c;
                    charNameDisp.innerText = c.name;
                    charPassDisp.innerText = `Passive: ${c.passive}`;
                    playGameBtn.style.display = 'block';
                };
                charGrid.appendChild(card);
            });
        }

        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 35;
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 0, 10);
            scene.add(light, new THREE.AmbientLight(0x404040));
            gamePlane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshBasicMaterial({ visible: false }));
            scene.add(gamePlane);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
        }

        function spawnWave() {
            for (let i = 0; i < 3 + wave; i++) enemies.push(new Enemy());
        }

        function gameLoop() {
            if (!gameActive) return;
            requestAnimationFrame(gameLoop);

            player.update();

            projectiles.forEach((p, pi) => {
                p.update();
                enemies.forEach((e, ei) => {
                    if (p.model.position.distanceTo(e.model.position) < 2) {
                        scene.remove(e.model); enemies.splice(ei, 1);
                        scene.remove(p.model); projectiles.splice(pi, 1);
                        score += 100; scoreEl.innerText = score;
                    }
                });
                enemyProjectiles.forEach((ep, epi) => {
                    if (p.model.position.distanceTo(ep.model.position) < 1.5) {
                        scene.remove(ep.model); enemyProjectiles.splice(epi, 1);
                        scene.remove(p.model); projectiles.splice(pi, 1);
                        player.fireRate = Math.max(50, player.fireRate - 5);
                        showToast("SPEED UP!");
                    }
                });
                if (p.model.position.length() > 60) { scene.remove(p.model); projectiles.splice(pi, 1); }
            });

            enemyProjectiles.forEach((ep, epi) => {
                ep.update();
                if (ep.model.position.distanceTo(player.model.position) < 2) {
                    player.takeDamage(15);
                    scene.remove(ep.model); enemyProjectiles.splice(epi, 1);
                }
            });

            enemies.forEach((e, ei) => {
                e.update();
                if (e.model.position.y < -GAME_HEIGHT/2 - 5) { scene.remove(e.model); enemies.splice(ei, 1); }
            });

            if (enemies.length === 0) { wave++; waveEl.innerText = wave; spawnWave(); }
            renderer.render(scene, camera);
        }

        function updateUI() { healthBar.style.width = `${player.health}%`; }

        function showToast(msg) {
            powerupToast.innerText = msg; powerupToast.style.opacity = 1;
            setTimeout(() => powerupToast.style.opacity = 0, 1000);
        }

        function endGame() {
            gameActive = false;
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over-modal').style.display = 'flex';
        }

        document.getElementById('start-game-btn').onclick = () => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('character-selection-screen').style.display = 'flex';
            initCharacterSelection();
        };

        playGameBtn.onclick = () => {
            document.getElementById('character-selection-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            gameActive = true;
            initThreeJS();
            player = new Player(selectedCharacter);
            spawnWave();
            gameLoop();
        };

        document.getElementById('restart-game-btn').onclick = () => location.reload();

        window.addEventListener('keydown', e => { if(keys[e.key.toLowerCase()]) keys[e.key.toLowerCase()].pressed = true; });
        window.addEventListener('keyup', e => { if(keys[e.key.toLowerCase()]) keys[e.key.toLowerCase()].pressed = false; });
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / canvas.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / canvas.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(gamePlane);
            if (intersects.length > 0) player.shoot(intersects[0].point);
        });
    </script>
</body>
</html>
