<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alien: Earth - Cathedral Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=stylesheet" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; color: #fff; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud { padding: 20px; display: flex; justify-content: space-between; display: none; }
        .bar-container { width: 200px; height: 12px; background: rgba(255,255,255,0.1); border: 1px solid #00ffff; margin-top: 5px; }
        #health-fill { height: 100%; width: 100%; background: #00ffcc; transition: width 0.2s; }
        #boss-ui { text-align: right; visibility: hidden; }
        #boss-fill { height: 100%; width: 100%; background: #ff0044; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); 
                   display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        .btn { padding: 15px 40px; background: #00ffff; color: #000; border: none; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; box-shadow: 0 0 15px #00ffff; margin-top: 20px; }
        #char-sel { display: none; }
        .char-grid { display: flex; gap: 15px; margin-top: 20px; }
        .char-card { border: 2px solid #333; padding: 15px; cursor: pointer; text-align: center; background: #111; transition: 0.2s; }
        .char-card.selected { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }
        #toast { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: #00ffcc; color: #000; padding: 10px 20px; font-weight: bold; opacity: 0; transition: 0.5s; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="hud" class="hud">
            <div>
                <div style="font-size: 0.7rem; color: #00ffff;">HULL REPAIR STATUS</div>
                <div class="bar-container"><div id="health-fill"></div></div>
                <div style="margin-top:5px; font-size: 0.8rem;">SCORE: <span id="score-val">0</span> | KILLS: <span id="kill-val">0</span></div>
            </div>
            <div id="boss-ui">
                <div style="font-size: 0.7rem; color: #ff0044;">GUARDIAN CORE</div>
                <div class="bar-container" style="width:300px;"><div id="boss-fill"></div></div>
            </div>
        </div>

        <div id="start-menu" class="overlay">
            <h1 style="font-size: 3.5rem; text-shadow: 0 0 20px #00ffff; margin: 0;">ALIEN: EARTH</h1>
            <p>Procedural Cathedral World of Orono</p>
            <button class="btn" onclick="openCharSel()">DESCEND TO SURFACE</button>
        </div>

        <div id="char-sel" class="overlay">
            <h2 style="color: #00ffff;">SELECT YOUR OPERATIVE</h2>
            <div class="char-grid">
                <div class="char-card" onclick="selectPilot(0x00ffff, this)">üõ°Ô∏è KIRSH</div>
                <div class="char-card" onclick="selectPilot(0xff4444, this)">üöÄ RAVAGE</div>
                <div class="char-card" onclick="selectPilot(0x8b5cf6, this)">üõ∏ NEXUS</div>
            </div>
            <button id="launch-btn" class="btn" style="display:none;" onclick="initGame()">LAUNCH MISSION</button>
        </div>

        <div id="game-over" class="overlay" style="display:none;">
            <h1 id="status-text" style="color:#ff0044;">MISSION FAILURE</h1>
            <button class="btn" onclick="location.reload()">RE-MATERIALIZE</button>
        </div>

        <div id="toast">SYSTEM REPAIR +10%</div>
    </div>

    <script>
        let scene, camera, renderer, player, boss, clock;
        let gameActive = false, score = 0, kills = 0, playerColor = 0x00ffff;
        let projectiles = [], enemyBullets = [], worldModules = [], keys = {};

        function openCharSel() {
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('char-sel').style.display = 'flex';
        }

        function selectPilot(color, el) {
            playerColor = color;
            document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('launch-btn').style.display = 'block';
        }

        function initGame() {
            document.getElementById('char-sel').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050810, 0.012);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 100, 50);
            scene.add(sun, new THREE.AmbientLight(0x111133, 0.6));

            // Planet Surface
            const groundGeo = new THREE.PlaneGeometry(2000, 2000, 20, 20);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x0a0c0a, roughness: 1 });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.position.z = -15;
            scene.add(ground);

            // Player Setup
            player = {
                hp: 100, targetHp: 100,
                mesh: new THREE.Group()
            };
            const shipGeo = new THREE.ConeGeometry(1, 4, 4);
            const shipMat = new THREE.MeshStandardMaterial({ color: playerColor, emissive: playerColor, emissiveIntensity: 0.5 });
            const ship = new THREE.Mesh(shipGeo, shipMat);
            ship.rotation.x = Math.PI/2;
            player.mesh.add(ship);
            
            const light = new THREE.PointLight(playerColor, 2, 20);
            player.mesh.add(light);
            scene.add(player.mesh);

            // Procedural Cathedral Generation
            for(let i=0; i<25; i++) {
                createCathedral(Math.sin(i * 0.8) * 40, i * 50);
            }

            gameActive = true;
            update();
        }

        function createCathedral(x, y) {
            const group = new THREE.Group();
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x222233, metalness: 0.8, roughness: 0.2 });
            
            // Base Tower
            const base = new THREE.Mesh(new THREE.BoxGeometry(10, 20, 10), wallMat);
            group.add(base);
            
            // Cathedral Arches
            for(let i=0; i<4; i++) {
                const arch = new THREE.Mesh(new THREE.TorusGeometry(6, 0.5, 8, 16, Math.PI), wallMat);
                arch.rotation.z = (i/4) * Math.PI * 2;
                arch.position.y = 8;
                group.add(arch);
            }

            // Spires
            const spire = new THREE.Mesh(new THREE.ConeGeometry(5, 15, 4), wallMat);
            spire.position.y = 17.5;
            group.add(spire);

            // Destroyable Power Core
            const core = new THREE.Mesh(new THREE.IcosahedronGeometry(2), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
            core.position.set(0, 0, 6);
            group.add(core);

            group.position.set(x, y, 0);
            scene.add(group);
            worldModules.push({ group, core, health: 30 });
        }

        function createBoss() {
            boss = { hp: 1000, mesh: new THREE.Mesh(new THREE.TorusKnotGeometry(10, 3, 128, 16), new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x550000 })) };
            boss.mesh.position.set(0, 300, 0);
            scene.add(boss.mesh);
            document.getElementById('boss-ui').style.visibility = 'visible';
        }

        function update() {
            if(!gameActive) return;
            requestAnimationFrame(update);

            const dt = clock.getDelta();
            
            // Controls Forward/Back/Left/Right
            const speed = 0.8;
            if(keys['w']) player.mesh.position.y += speed;
            if(keys['s']) player.mesh.position.y -= speed;
            if(keys['a']) player.mesh.position.x -= speed;
            if(keys['d']) player.mesh.position.x += speed;

            // Camera follow
            camera.position.set(player.mesh.position.x, player.mesh.position.y - 40, 50);
            camera.lookAt(player.mesh.position);

            // Pulse Healing
            if(player.hp < player.targetHp) {
                player.hp += 0.05;
                const p = 1 + Math.sin(Date.now()*0.01)*0.15;
                player.mesh.scale.set(p,p,p);
            } else { player.mesh.scale.set(1,1,1); }
            document.getElementById('health-fill').style.width = player.hp + "%";

            // Boss logic
            if(score > 3000 && !boss) createBoss();
            if(boss) {
                boss.mesh.rotation.y += 0.02;
                const bDir = new THREE.Vector3().subVectors(player.mesh.position, boss.mesh.position).normalize();
                boss.mesh.position.add(bDir.multiplyScalar(0.06));
                if(Math.random() < 0.03) fireBullet(boss.mesh.position, bDir, false);
                document.getElementById('boss-fill').style.width = (boss.hp/1000)*100 + "%";
            }

            // Projectile handling
            projectiles.forEach((p, i) => {
                p.mesh.position.add(p.dir.clone().multiplyScalar(p.spd));
                
                if(boss && p.mesh.position.distanceTo(boss.mesh.position) < 12) {
                    boss.hp -= 15; scene.remove(p.mesh); projectiles.splice(i, 1);
                    if(boss.hp <= 0) {
                        explode(boss.mesh.position, 0xff0000);
                        scene.remove(boss.mesh); boss = null;
                        score += 5000;
                        setTimeout(() => winGame(), 2000);
                    }
                }

                worldModules.forEach(m => {
                    if(m.core && p.mesh.position.distanceTo(m.group.position.clone().add(m.core.position)) < 4) {
                        m.group.remove(m.core); m.core = null;
                        scene.remove(p.mesh); projectiles.splice(i, 1);
                        kills++; score += 200;
                        document.getElementById('score-val').innerText = score;
                        document.getElementById('kill-val').innerText = kills;
                        if(kills % 10 === 0) {
                            player.hp = Math.min(100, player.hp + 10);
                            player.targetHp = Math.min(100, player.targetHp + 10);
                            triggerRepairToast();
                        }
                    }
                });
            });

            enemyBullets.forEach((eb, i) => {
                eb.mesh.position.add(eb.dir.clone().multiplyScalar(eb.spd));
                if(eb.mesh.position.distanceTo(player.mesh.position) < 2.5) {
                    player.hp -= 10; player.targetHp = player.hp + 5;
                    scene.remove(eb.mesh); enemyBullets.splice(i, 1);
                    if(player.hp <= 0) gameOver();
                }
            });

            renderer.render(scene, camera);
        }

        function fireBullet(pos, dir, isPlayer) {
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(isPlayer ? 0.4 : 0.7), new THREE.MeshBasicMaterial({ color: isPlayer ? 0x00ffff : 0xff3300 }));
            mesh.position.copy(pos);
            const bullet = { mesh, dir, spd: isPlayer ? 1.8 : 0.4 };
            if(isPlayer) projectiles.push(bullet); else enemyBullets.push(bullet);
            scene.add(mesh);
        }

        function explode(pos, color) {
            for(let i=0; i<50; i++) {
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({ color }));
                p.position.copy(pos);
                p.userData = { v: new THREE.Vector3((Math.random()-0.5)*2,(Math.random()-0.5)*2,(Math.random()-0.5)*2) };
                scene.add(p);
                setTimeout(() => scene.remove(p), 1000);
            }
        }

        function triggerRepairToast() {
            const t = document.getElementById('toast');
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('status-text').innerText = "MISSION FAILURE";
            document.getElementById('game-over').style.display = 'flex';
        }

        function winGame() {
            gameActive = false;
            document.getElementById('status-text').innerText = "PLANET SECURED";
            document.getElementById('status-text').style.color = "#00ffff";
            document.getElementById('game-over').style.display = 'flex';
        }

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
        window.onmousedown = (e) => {
            if(!gameActive) return;
            fireBullet(player.mesh.position, new THREE.Vector3(0,1,0), true);
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
