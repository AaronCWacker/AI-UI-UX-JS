<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alien: Earth - Cathedral World</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=stylesheet" rel="stylesheet">
    <style>
        body { font-family: 'Orbitron', sans-serif; background-color: #000; color: #fff; margin: 0; overflow: hidden; }
        #game-container { width: 100vw; height: 100vh; position: relative; }
        #hud { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; display: none; width: 90%; }
        #boss-ui { float: right; width: 300px; display: none; }
        .bar-bg { width: 250px; height: 12px; background: rgba(255,255,255,0.1); border: 1px solid #00ffff; margin-top: 5px; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        #player-health-bar { background: linear-gradient(90deg, #00ff88, #00ffcc); }
        #boss-health-bar { background: linear-gradient(90deg, #ff0000, #ff4400); width: 100%; }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; 
                justify-content: center; align-items: center; background: rgba(0,0,0,0.9); z-index: 100; text-align: center;}
        .btn { padding: 15px 40px; background: #00ffff; color: #000; border: none; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 4px; box-shadow: 0 0 15px #00ffff; }
        #char-sel { display: none; }
        .char-card { border: 1px solid #444; padding: 15px; margin: 10px; cursor: pointer; background: #111; min-width: 100px;}
        .char-card.selected { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="hud">
            <div style="float: left;">
                <div style="color:#00ffff; font-size: 0.8rem;">PILOT INTEGRITY</div>
                <div class="bar-bg"><div id="player-health-bar" class="bar-fill"></div></div>
                <div style="margin-top:5px">SCORE: <span id="score">0</span> | KILLS: <span id="kill-count">0</span></div>
            </div>
            <div id="boss-ui">
                <div style="color:#ff0000; font-size: 0.8rem; text-align: right;">ANCIENT GUARDIAN</div>
                <div class="bar-bg" style="width: 300px;"><div id="boss-health-bar" class="bar-fill"></div></div>
            </div>
        </div>

        <div id="start-screen" class="modal">
            <h1 style="font-size: clamp(2rem, 8vw, 4rem); text-shadow: 0 0 20px #00ffff;">ALIEN: EARTH</h1>
            <p>Procedural Cathedral World</p>
            <button class="btn" onclick="showChar()">DESCEND TO SURFACE</button>
        </div>

        <div id="char-sel" class="modal">
            <h2>SELECT PILOT</h2>
            <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                <div class="char-card" onclick="selectChar(0, this)">üõ°Ô∏è KIRSH</div>
                <div class="char-card" onclick="selectChar(1, this)">üöÄ RAVAGE</div>
                <div class="char-card" onclick="selectChar(2, this)">‚è±Ô∏è SIF</div>
                <div class="char-card" onclick="selectChar(3, this)">üõ∏ NEXUS</div>
            </div>
            <button id="launch-btn" class="btn" style="display:none; margin-top: 20px;" onclick="startGame()">INITIATE DEPLOYMENT</button>
        </div>

        <div id="game-over" class="modal" style="display:none">
            <h1 id="over-title">MISSION FAILED</h1>
            <p id="final-stats"></p>
            <button class="btn" onclick="location.reload()">RE-MATERIALIZE</button>
        </div>

        <canvas id="game-canvas"></canvas>
    </div>

<script>
let scene, camera, renderer, raycaster, mouse;
let player, gameActive = false, score = 0, kills = 0, bossObj = null;
let worldModules = [], projectiles = [], enemyProjectiles = [], particles = [];
let keys = {w:false, a:false, s:false, d:false};
let selectedCharData = null;

function showChar() { 
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('char-sel').style.display = 'flex';
}

function selectChar(idx, el) {
    const chars = [{c:0x00ffff},{c:0xff4444},{c:0xfbbf24},{c:0x8b5cf6}];
    selectedCharData = chars[idx];
    document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('launch-btn').style.display = 'block';
}

function startGame() {
    document.getElementById('char-sel').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    init();
    gameActive = true;
    animate();
}

function init() {
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050810, 0.01);

    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.set(0, -25, 50);

    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x050810);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 20, 10);
    scene.add(light, new THREE.AmbientLight(0x222244));

    // Planet Surface
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(2000, 2000, 20, 20),
        new THREE.MeshStandardMaterial({ color: 0x111511, roughness: 0.8 })
    );
    ground.position.z = -15;
    scene.add(ground);

    player = {
        hp: 100, targetHP: 100,
        mesh: new THREE.Group(),
        update: function() {
            const speed = 0.6;
            if(keys.a) this.mesh.position.x -= speed;
            if(keys.d) this.mesh.position.x += speed;
            if(keys.w) this.mesh.position.y += speed;
            if(keys.s) this.mesh.position.y -= speed;
            
            camera.position.x = this.mesh.position.x;
            camera.position.y = this.mesh.position.y - 25;

            if(this.hp < this.targetHP) {
                this.hp += 0.05;
                const p = 1 + Math.sin(Date.now()*0.01)*0.1;
                this.mesh.scale.set(p,p,p);
            }
            document.getElementById('player-health-bar').style.width = this.hp + '%';
        }
    };

    const pMesh = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 3), new THREE.MeshStandardMaterial({ color: selectedCharData.c, emissive: selectedCharData.c, emissiveIntensity: 0.5 }));
    pMesh.rotation.x = Math.PI/2;
    player.mesh.add(pMesh);
    scene.add(player.mesh);

    // Build World
    for(let i=0; i<15; i++) {
        const m = new Cathedral(Math.sin(i)*30, i * 40);
        worldModules.push(m);
    }

    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();
}

class Cathedral {
    constructor(x, y) {
        this.group = new THREE.Group();
        this.group.position.set(x, y, 0);
        const mat = new THREE.MeshStandardMaterial({ color: 0x444455, metalness: 0.6 });
        
        const tower = new THREE.Mesh(new THREE.BoxGeometry(8, 20, 8), mat);
        const spire = new THREE.Mesh(new THREE.ConeGeometry(4, 15, 4), mat);
        spire.position.y = 17.5;
        this.group.add(tower, spire);
        
        this.core = new THREE.Mesh(new THREE.IcosahedronGeometry(2), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
        this.core.position.z = 5;
        this.group.add(this.core);
        
        scene.add(this.group);
    }
}

class Boss {
    constructor() {
        this.hp = 1000;
        this.mesh = new THREE.Mesh(new THREE.TorusKnotGeometry(10, 3, 100, 16), new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x330000 }));
        this.mesh.position.set(0, 150, 0);
        scene.add(this.mesh);
        document.getElementById('boss-ui').style.display = 'block';
    }
    update() {
        this.mesh.rotation.y += 0.02;
        const dir = new THREE.Vector3().subVectors(player.mesh.position, this.mesh.position).normalize();
        this.mesh.position.add(dir.multiplyScalar(0.05));
        
        if(Math.random() < 0.02) {
            enemyProjectiles.push(new Projectile(this.mesh.position.clone(), dir.clone(), false));
        }
        document.getElementById('boss-health-bar').style.width = (this.hp/1000)*100 + '%';
    }
}

class Projectile {
    constructor(pos, dir, isPlayer) {
        this.mesh = new THREE.Mesh(new THREE.SphereGeometry(isPlayer ? 0.3 : 0.6), new THREE.MeshBasicMaterial({ color: isPlayer ? 0x00ffff : 0xff0000 }));
        this.mesh.position.copy(pos);
        this.dir = dir;
        this.speed = isPlayer ? 1.5 : 0.3;
        this.isPlayer = isPlayer;
        scene.add(this.mesh);
    }
}

function animate() {
    if(!gameActive) return;
    requestAnimationFrame(animate);

    player.update();
    
    if(score > 3000 && !bossObj) bossObj = new Boss();
    if(bossObj) bossObj.update();

    projectiles.forEach((p, pi) => {
        p.mesh.position.add(p.dir.clone().multiplyScalar(p.speed));
        if(bossObj && p.mesh.position.distanceTo(bossObj.mesh.position) < 12) {
            bossObj.hp -= 10;
            scene.remove(p.mesh); projectiles.splice(pi, 1);
            if(bossObj.hp <= 0) {
                scene.remove(bossObj.mesh); bossObj = null;
                score += 5000;
                setTimeout(() => endGame(true), 1000);
            }
        }
        worldModules.forEach((m, mi) => {
            if(m.core && p.mesh.position.distanceTo(m.group.position.clone().add(m.core.position)) < 4) {
                m.group.remove(m.core); m.core = null;
                scene.remove(p.mesh); projectiles.splice(pi, 1);
                score += 200; kills++;
                document.getElementById('score').innerText = score;
                document.getElementById('kill-count').innerText = kills;
                if(kills % 10 === 0) { player.hp = Math.min(100, player.hp + 10); player.targetHP = Math.min(100, player.targetHP + 10); }
            }
        });
    });

    enemyProjectiles.forEach((ep, epi) => {
        ep.mesh.position.add(ep.dir.clone().multiplyScalar(ep.speed));
        if(ep.mesh.position.distanceTo(player.mesh.position) < 3) {
            player.hp -= 10;
            player.targetHP = player.hp + 5;
            scene.remove(ep.mesh); enemyProjectiles.splice(epi, 1);
            if(player.hp <= 0) endGame(false);
        }
    });

    renderer.render(scene, camera);
}

function endGame(win) {
    gameActive = false;
    document.getElementById('over-title').innerText = win ? "VICTORY" : "GAME OVER";
    document.getElementById('game-over').style.display = 'flex';
}

window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
window.addEventListener('mousedown', e => {
    if(!gameActive) return;
    const rect = canvas.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / window.innerWidth) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const target = new THREE.Vector3();
    raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0,0,1), 0), target);
    const dir = new THREE.Vector3().subVectors(target, player.mesh.position).normalize();
    projectiles.push(new Projectile(player.mesh.position.clone(), dir, true));
});
</script>
</body>
</html>
