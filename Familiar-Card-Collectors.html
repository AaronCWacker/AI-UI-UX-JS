<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FAMILIAR ARENA ‚Äî Auto Collector</title>
<style>
:root{
  --bg:#050814;--panel:rgba(10,16,32,.78);--panel2:rgba(16,24,48,.84);--line:rgba(255,255,255,.10);
  --text:#eef4ff;--muted:#9db0cf;--mint:#33ffbb;--cyan:#44ddff;--violet:#c79dff;--rose:#ff6f91;--gold:#ffd35e;--amber:#ffad63;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:radial-gradient(circle at top,#152347 0%,#08101f 40%,#04070f 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
body{display:grid;grid-template-rows:auto 1fr auto}
button{font:inherit}
#topbar,#footer{padding:10px 14px;background:rgba(255,255,255,.03);border-bottom:1px solid var(--line)}
#footer{border-top:1px solid var(--line);border-bottom:0;display:flex;justify-content:space-between;gap:12px;color:var(--muted);font-size:.78rem}
#topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
.title{font-family:Orbitron,system-ui,sans-serif;font-weight:900;letter-spacing:.12em;font-size:1rem;background:linear-gradient(135deg,var(--mint),var(--cyan),var(--violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{font-size:.74rem;color:var(--muted);margin-top:2px}
#app{display:grid;grid-template-columns:280px 1fr 300px;gap:12px;padding:12px;height:100%}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;backdrop-filter:blur(12px);box-shadow:0 16px 40px rgba(0,0,0,.28)}
.left,.right{padding:12px;overflow:auto}
.center{display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:12px;overflow:hidden}
.banner{display:flex;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03))}
.bannerTitle{font-family:Orbitron,system-ui,sans-serif;font-size:.82rem;letter-spacing:.12em;color:var(--gold)}
.bannerText{font-size:.78rem;color:var(--muted);line-height:1.45;margin-top:4px}
.livePill{align-self:flex-start;padding:6px 10px;border-radius:999px;border:1px solid rgba(51,255,187,.35);background:rgba(51,255,187,.08);color:var(--mint);font-size:.72rem;font-family:JetBrains Mono,monospace}
#arenaWrap{position:relative;overflow:hidden;border:1px solid var(--line);border-radius:18px;background:radial-gradient(circle at 50% 20%,rgba(68,221,255,.08),rgba(0,0,0,0) 35%),linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
canvas{display:block;width:100%;height:100%}
#hud{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:16px;background:var(--panel2)}
.hudBox{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.badge{padding:6px 9px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid var(--line);font-size:.72rem;color:var(--muted)}
.badge strong{color:var(--text)}
.turn{justify-self:center;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,211,94,.38);background:rgba(255,211,94,.08);font-family:Orbitron,system-ui,sans-serif;font-size:.76rem;letter-spacing:.1em;color:var(--gold)}
.controls{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--line);border-radius:16px;background:var(--panel2)}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--text);font-weight:800;cursor:pointer;transition:.16s transform,.16s border-color,.16s background}
.btn:hover{transform:translateY(-1px)}
.btn.primary{border-color:rgba(51,255,187,.42);background:rgba(51,255,187,.10);color:var(--mint)}
.btn.gold{border-color:rgba(255,211,94,.42);background:rgba(255,211,94,.10);color:var(--gold)}
.btn.rose{border-color:rgba(255,111,145,.42);background:rgba(255,111,145,.10);color:var(--rose)}
.btn:disabled{opacity:.38;cursor:not-allowed;transform:none}
.sectionTitle{margin:0 0 10px;font-family:Orbitron,system-ui,sans-serif;font-size:.82rem;letter-spacing:.1em;color:var(--gold)}
.tip,.cardItem,.logLine{padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:.76rem;color:var(--muted);line-height:1.45}
.tipList,.cardList{display:grid;gap:8px}
.cardItem{cursor:pointer;transition:.16s transform,.16s border-color,.16s box-shadow}
.cardItem:hover{transform:translateY(-1px)}
.cardItem.ready{border-color:rgba(68,221,255,.42);box-shadow:0 0 0 1px rgba(68,221,255,.16)}
.cardItem.used{opacity:.42;filter:grayscale(.8);pointer-events:none}
.cardHead{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px}
.cardName{font-weight:900;color:var(--text);font-size:.84rem}
.cardType{font-family:JetBrains Mono,monospace;font-size:.68rem}
.type-burst{color:var(--gold)}.type-magnet{color:var(--mint)}.type-sweep{color:var(--rose)}.type-freeze{color:var(--cyan)}.type-halo{color:var(--violet)}
.log{display:grid;gap:8px;max-height:320px;overflow:auto}
.small{font-size:.74rem;color:var(--muted)}
.spot{padding:12px;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));margin-bottom:12px}
.spotLabel{font-family:Orbitron,system-ui,sans-serif;font-size:.68rem;letter-spacing:.12em;color:var(--cyan);margin-bottom:6px}
.spotName{font-size:.96rem;font-weight:900;margin-bottom:6px}
.spotText{font-size:.78rem;color:var(--muted);line-height:1.45}
@media (max-width:1100px){#app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;height:auto;overflow:auto}body{overflow:auto}.center{min-height:70vh}}
</style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="topbar">
    <div>
      <div class="title">FAMILIAR ARENA ‚Äî AUTO COLLECTOR</div>
      <div class="subtitle">AI flies the ship and gathers cards. You click collected cards to trigger huge board effects.</div>
    </div>
    <div class="livePill" id="modePill">AUTO-PILOT ACTIVE</div>
  </div>

  <div id="app">
    <aside class="panel left">
      <h3 class="sectionTitle">üß† What Changed</h3>
      <div class="tipList">
        <div class="tip"><strong>AI handles navigation.</strong> The ship constantly steers, boosts, and collects cards for you.</div>
        <div class="tip"><strong>Cards chase the ship.</strong> Nearby pickups drift inward, then snap into a readable halo once collected.</div>
        <div class="tip"><strong>You click powers, not movement.</strong> Collected cards become special actions like magnet pulse, sweep, freeze, and burst collect.</div>
        <div class="tip"><strong>Collect-All effects</strong> let you vacuum huge parts of the field without manually piloting through them.</div>
      </div>
      <div class="spot" style="margin-top:14px">
        <div class="spotLabel">SPECIAL ACTIONS</div>
        <div class="spotName">Clickable Power Cards</div>
        <div class="spotText">As the auto-pilot collects cards, they populate the action list below. Click any ready card for its special effect.</div>
      </div>
      <h3 class="sectionTitle">‚ö° Collected Powers</h3>
      <div class="cardList" id="powerList"></div>
    </aside>

    <main class="panel center">
      <div class="banner">
        <div>
          <div class="bannerTitle">SELF-FLYING COLLECTION MODE</div>
          <div class="bannerText">The ship hunts pickups automatically. Your job is timing special powers: burst nearby cards, magnetize the field, freeze card motion, or sweep the whole arena.</div>
        </div>
        <div class="livePill" id="activityPill">HUNTING</div>
      </div>

      <div id="arenaWrap"><canvas id="game" width="1200" height="760"></canvas></div>

      <div id="hud">
        <div class="hudBox">
          <div class="badge"><strong>Collected</strong> <span id="collectedCount">0</span></div>
          <div class="badge"><strong>Loose Cards</strong> <span id="looseCount">0</span></div>
          <div class="badge"><strong>Halo</strong> <span id="haloCount">0</span></div>
        </div>
        <div class="turn" id="statusText">AUTO GATHERING</div>
        <div class="hudBox" style="justify-content:flex-end">
          <div class="badge"><strong>Combo</strong> <span id="comboCount">0</span></div>
          <div class="badge"><strong>Field Sweep</strong> <span id="sweepCharge">0%</span></div>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="burstBtn">üåü Burst Nearby</button>
          <button class="btn gold" id="collectAllBtn">üß≤ Collect Visible</button>
          <button class="btn rose" id="restartBtn">‚Üª Restart Field</button>
        </div>
        <div class="small" id="hint">Tip: Click the collected power cards on the left for stronger special effects.</div>
      </div>
    </main>

    <aside class="panel right">
      <div class="spot">
        <div class="spotLabel">LIVE ACTION</div>
        <div class="spotName" id="actionTitle">Auto-pilot engaged</div>
        <div class="spotText" id="actionText">The ship is steering itself toward the best cluster of cards.</div>
      </div>
      <h3 class="sectionTitle">üìú Event Log</h3>
      <div class="log" id="log"></div>
    </aside>
  </div>

  <div id="footer">
    <div>Readable orbiting halo ¬∑ auto chase ¬∑ click-to-trigger power cards</div>
    <div>Built for low-friction gathering instead of manual piloting</div>
  </div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width;
const H = canvas.height;

const ui = {
  collectedCount: document.getElementById('collectedCount'),
  looseCount: document.getElementById('looseCount'),
  haloCount: document.getElementById('haloCount'),
  comboCount: document.getElementById('comboCount'),
  sweepCharge: document.getElementById('sweepCharge'),
  statusText: document.getElementById('statusText'),
  hint: document.getElementById('hint'),
  powerList: document.getElementById('powerList'),
  log: document.getElementById('log'),
  actionTitle: document.getElementById('actionTitle'),
  actionText: document.getElementById('actionText'),
  activityPill: document.getElementById('activityPill')
};

const CARD_TYPES = [
  { type:'Burst', color:'#ffd35e', css:'type-burst', desc:'Instantly collects all cards in a large nearby radius.', effect:'burst' },
  { type:'Magnet', color:'#33ffbb', css:'type-magnet', desc:'Pulls all loose cards toward the ship for several seconds.', effect:'magnet' },
  { type:'Sweep', color:'#ff6f91', css:'type-sweep', desc:'Collects every visible loose card in the arena.', effect:'sweep' },
  { type:'Freeze', color:'#44ddff', css:'type-freeze', desc:'Freezes card drift so the halo can absorb them cleanly.', effect:'freeze' },
  { type:'Halo', color:'#c79dff', css:'type-halo', desc:'Expands the readable orbit ring and vacuum radius.', effect:'halo' }
];

const state = {
  time: 0,
  combo: 0,
  totalCollected: 0,
  sweepCharge: 0,
  autopilot: true,
  cards: [],
  haloCards: [],
  powers: [],
  particles: [],
  effects: {
    magnetUntil: 0,
    freezeUntil: 0,
    haloUntil: 0
  },
  ship: {
    x: W * 0.5,
    y: H * 0.55,
    vx: 0,
    vy: 0,
    angle: 0,
    targetX: W * 0.5,
    targetY: H * 0.55,
    baseOrbit: 92
  }
};

function rand(min,max){ return Math.random() * (max - min) + min; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function dist(ax,ay,bx,by){ return Math.hypot(bx-ax, by-ay); }
function lerp(a,b,t){ return a + (b-a)*t; }

function log(msg){
  const line = document.createElement('div');
  line.className = 'logLine';
  line.innerHTML = msg;
  ui.log.prepend(line);
  while (ui.log.children.length > 24) ui.log.removeChild(ui.log.lastChild);
}

function setAction(title,text){
  ui.actionTitle.textContent = title;
  ui.actionText.textContent = text;
}

function spawnCard(edgeBias = false){
  const meta = CARD_TYPES[Math.floor(Math.random() * CARD_TYPES.length)];
  let x, y;
  if (edgeBias || Math.random() < 0.6) {
    const side = Math.floor(Math.random() * 4);
    if (side === 0) { x = rand(30, W-30); y = rand(20, 90); }
    if (side === 1) { x = W - rand(20, 90); y = rand(30, H-30); }
    if (side === 2) { x = rand(30, W-30); y = H - rand(20, 90); }
    if (side === 3) { x = rand(20, 90); y = rand(30, H-30); }
  } else {
    x = rand(40, W-40); y = rand(40, H-40);
  }
  const angle = rand(0, Math.PI * 2);
  state.cards.push({
    id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2),
    x, y,
    vx: Math.cos(angle) * rand(.3, 1.0),
    vy: Math.sin(angle) * rand(.3, 1.0),
    r: 18,
    type: meta.type,
    css: meta.css,
    effect: meta.effect,
    color: meta.color,
    desc: meta.desc,
    collected: false,
    phase: rand(0, Math.PI * 2)
  });
}

function seedField(){
  state.cards = [];
  state.haloCards = [];
  state.powers = [];
  state.particles = [];
  state.combo = 0;
  state.totalCollected = 0;
  state.sweepCharge = 0;
  state.effects.magnetUntil = 0;
  state.effects.freezeUntil = 0;
  state.effects.haloUntil = 0;
  state.ship.x = W * 0.5;
  state.ship.y = H * 0.55;
  state.ship.vx = 0;
  state.ship.vy = 0;
  for (let i = 0; i < 34; i++) spawnCard(true);
  renderPowerList();
  updateUi();
  setAction('Auto-pilot engaged', 'The ship is steering itself toward the best cluster of cards.');
  log('üöÄ <strong>Field reset.</strong> Auto-pilot is gathering cards while you manage special powers.');
}

function bestClusterTarget(){
  const loose = state.cards.filter(c => !c.collected);
  if (!loose.length) return { x: W * 0.5, y: H * 0.5, activity:'IDLE' };

  let best = null;
  for (const card of loose) {
    let score = 0;
    for (const other of loose) {
      const d = dist(card.x, card.y, other.x, other.y);
      if (d < 170) score += 1 - d / 170;
    }
    const shipD = dist(state.ship.x, state.ship.y, card.x, card.y);
    score += clamp(1 - shipD / 700, 0, 1) * 2.2;
    if (!best || score > best.score) best = { x: card.x, y: card.y, score, card };
  }
  return { x: best.x, y: best.y, activity: best.score > 3.2 ? 'CLUSTER LOCK' : 'HUNTING', card: best.card };
}

function collectCard(card, source='auto'){
  if (card.collected) return;
  card.collected = true;
  state.totalCollected += 1;
  state.combo += 1;
  state.sweepCharge = clamp(state.sweepCharge + 6, 0, 100);
  state.powers.unshift({
    id: card.id,
    name: `${card.type} Card`,
    css: card.css,
    color: card.color,
    effect: card.effect,
    desc: card.desc,
    used: false
  });
  state.haloCards.push({
    id: card.id,
    type: card.type,
    color: card.color,
    t: 0,
    slot: state.haloCards.length,
    phase: rand(0, Math.PI * 2)
  });
  for (let i = 0; i < 10; i++) {
    state.particles.push({ x: card.x, y: card.y, vx: rand(-2.5,2.5), vy: rand(-2.5,2.5), life: rand(18,36), color: card.color });
  }
  renderPowerList();
  updateUi();
  if (source === 'auto') log(`‚ú® <strong>${card.type}</strong> card auto-collected into your halo.`);
  if (source === 'special') log(`‚ö° <strong>${card.type}</strong> card was captured by a special effect.`);
}

function renderPowerList(){
  ui.powerList.innerHTML = '';
  if (!state.powers.length) {
    const empty = document.createElement('div');
    empty.className = 'tip';
    empty.textContent = 'No collected power cards yet. Auto-pilot will fill this panel as it gathers cards.';
    ui.powerList.appendChild(empty);
    return;
  }
  state.powers.slice(0, 12).forEach(power => {
    const el = document.createElement('div');
    el.className = `cardItem ${power.used ? 'used' : 'ready'}`;
    el.innerHTML = `<div class="cardHead"><div class="cardName">${power.name}</div><div class="cardType ${power.css}">${power.effect.toUpperCase()}</div></div><div>${power.desc}</div>`;
    if (!power.used) el.addEventListener('click', () => triggerPower(power.id));
    ui.powerList.appendChild(el);
  });
}

function triggerPower(id){
  const power = state.powers.find(p => p.id === id && !p.used);
  if (!power) return;
  power.used = true;
  if (power.effect === 'burst') applyBurst();
  if (power.effect === 'magnet') applyMagnet();
  if (power.effect === 'sweep') applySweep();
  if (power.effect === 'freeze') applyFreeze();
  if (power.effect === 'halo') applyHaloBoost();
  renderPowerList();
  updateUi();
}

function applyBurst(){
  let hits = 0;
  for (const card of state.cards) {
    if (card.collected) continue;
    if (dist(card.x, card.y, state.ship.x, state.ship.y) < 240) {
      collectCard(card, 'special');
      hits += 1;
    }
  }
  setAction('Burst Nearby', `A burst pulse vacuumed ${hits} nearby card${hits === 1 ? '' : 's'} into the halo.`);
  log(`üåü <strong>Burst Nearby</strong> collected ${hits} card${hits === 1 ? '' : 's'}.`);
}

function applyMagnet(){
  state.effects.magnetUntil = state.time + 6.0;
  setAction('Magnet Pulse', 'Loose cards are being pulled aggressively toward the ship for 6 seconds.');
  log('üß≤ <strong>Magnet Pulse</strong> activated. All loose cards are drifting inward.');
}

function applySweep(){
  let hits = 0;
  for (const card of state.cards) {
    if (card.collected) continue;
    collectCard(card, 'special');
    hits += 1;
  }
  state.sweepCharge = 0;
  setAction('Field Sweep', `A full-arena sweep captured ${hits} visible card${hits === 1 ? '' : 's'}.`);
  log(`üí• <strong>Field Sweep</strong> captured ${hits} visible card${hits === 1 ? '' : 's'} instantly.`);
}

function applyFreeze(){
  state.effects.freezeUntil = state.time + 5.0;
  setAction('Freeze Field', 'Card drift is paused for 5 seconds so auto-pilot can harvest cleanly.');
  log('‚ùÑÔ∏è <strong>Freeze Field</strong> activated. Loose card motion is paused.');
}

function applyHaloBoost(){
  state.effects.haloUntil = state.time + 8.0;
  setAction('Halo Expansion', 'The readable orbit ring and vacuum radius are expanded for 8 seconds.');
  log('üü£ <strong>Halo Expansion</strong> activated. Orbit ring and pull radius increased.');
}

function updateUi(){
  const loose = state.cards.filter(c => !c.collected).length;
  ui.collectedCount.textContent = state.totalCollected;
  ui.looseCount.textContent = loose;
  ui.haloCount.textContent = state.haloCards.length;
  ui.comboCount.textContent = state.combo;
  ui.sweepCharge.textContent = `${Math.round(state.sweepCharge)}%`;
}

function autopilot(dt){
  const target = bestClusterTarget();
  ui.activityPill.textContent = target.activity;
  ui.statusText.textContent = target.activity === 'IDLE' ? 'FIELD CLEAR' : 'AUTO GATHERING';

  const ship = state.ship;
  ship.targetX = target.x;
  ship.targetY = target.y;

  const dx = ship.targetX - ship.x;
  const dy = ship.targetY - ship.y;
  const d = Math.hypot(dx, dy) || 1;
  const desiredSpeed = clamp(d * 0.7, 70, 230);
  const steerX = dx / d * desiredSpeed;
  const steerY = dy / d * desiredSpeed;
  ship.vx = lerp(ship.vx, steerX, 0.035);
  ship.vy = lerp(ship.vy, steerY, 0.035);
  ship.x += ship.vx * dt;
  ship.y += ship.vy * dt;
  ship.x = clamp(ship.x, 60, W - 60);
  ship.y = clamp(ship.y, 70, H - 70);
  ship.angle = Math.atan2(ship.vy, ship.vx);

  const magnetOn = state.time < state.effects.magnetUntil;
  const freezeOn = state.time < state.effects.freezeUntil;
  const haloBoost = state.time < state.effects.haloUntil;
  const collectRadius = haloBoost ? 160 : 118;
  const magnetRadius = magnetOn ? 420 : 220;

  for (const card of state.cards) {
    if (card.collected) continue;
    card.phase += dt * 2.2;

    if (!freezeOn) {
      card.x += card.vx;
      card.y += card.vy;
      if (card.x < 22 || card.x > W - 22) card.vx *= -1;
      if (card.y < 22 || card.y > H - 22) card.vy *= -1;
    }

    const cd = dist(card.x, card.y, ship.x, ship.y);
    if (cd < magnetRadius) {
      const pull = clamp(1 - cd / magnetRadius, 0.04, magnetOn ? 0.24 : 0.11);
      card.vx += (ship.x - card.x) * pull * 0.006;
      card.vy += (ship.y - card.y) * pull * 0.006;
    }
    card.vx *= 0.991;
    card.vy *= 0.991;

    if (cd < collectRadius) collectCard(card, 'auto');
  }

  if (state.cards.filter(c => !c.collected).length < 18) {
    for (let i = 0; i < 2; i++) spawnCard(true);
  }

  if (state.sweepCharge >= 100) {
    ui.hint.textContent = 'Sweep fully charged. Click ‚ÄúCollect Visible‚Äù or a Sweep card.';
  } else {
    ui.hint.textContent = 'Auto-pilot gathers; you click power cards for burst, magnet, freeze, halo, or sweep.';
  }
}

function updateHalo(dt){
  const haloBoost = state.time < state.effects.haloUntil;
  const orbitR = state.ship.baseOrbit + (haloBoost ? 30 : 0);
  const speed = haloBoost ? 1.6 : 1.05;
  for (let i = 0; i < state.haloCards.length; i++) {
    const hc = state.haloCards[i];
    hc.t += dt;
    hc.slot = i;
    hc.phase += dt * speed;
    hc.x = state.ship.x + Math.cos(hc.phase + i * 0.46) * (orbitR + (i % 3) * 12);
    hc.y = state.ship.y + Math.sin(hc.phase + i * 0.46) * (orbitR * 0.48 + (i % 2) * 10);
  }
}

function updateParticles(dt){
  for (let i = state.particles.length - 1; i >= 0; i--) {
    const p = state.particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.life -= 1;
    if (p.life <= 0) state.particles.splice(i,1);
  }
}

function drawBackground(){
  ctx.clearRect(0,0,W,H);
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#0a1326');
  g.addColorStop(1,'#050913');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  ctx.strokeStyle = 'rgba(68,221,255,0.08)';
  ctx.lineWidth = 1;
  for (let x = 0; x < W; x += 60) {
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
  for (let y = 0; y < H; y += 60) {
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  for (let i = 0; i < 70; i++) {
    const sx = (i * 173) % W;
    const sy = (i * 97) % H;
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    ctx.fillRect(sx, sy, 2, 2);
  }
}

function drawCard(card, alpha = 1){
  ctx.save();
  ctx.translate(card.x, card.y);
  const angle = Math.atan2(card.vy, card.vx) * 0.15;
  ctx.rotate(angle);
  ctx.globalAlpha = alpha;
  ctx.fillStyle = 'rgba(12,18,36,0.95)';
  ctx.strokeStyle = card.color;
  ctx.lineWidth = 2;
  const w = 26, h = 34;
  ctx.beginPath();
  ctx.roundRect(-w/2, -h/2, w, h, 7);
  ctx.fill();
  ctx.stroke();
  ctx.fillStyle = card.color;
  ctx.fillRect(-w/2 + 3, -h/2 + 3, w - 6, 4);
  ctx.beginPath(); ctx.arc(0, 0, 6 + Math.sin(card.phase) * 1.2, 0, Math.PI * 2); ctx.fill();
  ctx.restore();
}

function drawShip(){
  const s = state.ship;
  const haloBoost = state.time < state.effects.haloUntil;
  const orbitR = s.baseOrbit + (haloBoost ? 30 : 0);

  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.strokeStyle = haloBoost ? 'rgba(199,157,255,0.42)' : 'rgba(68,221,255,0.24)';
  ctx.lineWidth = haloBoost ? 3 : 2;
  ctx.beginPath();
  ctx.ellipse(0,0,orbitR,orbitR*0.48,0,0,Math.PI*2);
  ctx.stroke();
  ctx.restore();

  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.rotate(s.angle);
  ctx.fillStyle = '#dff9ff';
  ctx.strokeStyle = '#44ddff';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(20,0);
  ctx.lineTo(-16,-11);
  ctx.lineTo(-10,0);
  ctx.lineTo(-16,11);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.fillStyle = 'rgba(51,255,187,0.8)';
  ctx.fillRect(-20,-4,10,8);
  ctx.restore();
}

function drawParticles(){
  for (const p of state.particles) {
    ctx.globalAlpha = p.life / 36;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 2.2, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function drawLabels(){
  ctx.save();
  ctx.fillStyle = 'rgba(255,255,255,0.72)';
  ctx.font = '12px JetBrains Mono, monospace';
  const target = bestClusterTarget();
  if (target.card) {
    ctx.fillText(`TRACKING ${target.card.type.toUpperCase()}`, state.ship.x + 32, state.ship.y - 24);
  }
  ctx.restore();
}

function render(){
  drawBackground();
  for (const card of state.cards) if (!card.collected) drawCard(card, 0.95);
  updateHalo(0);
  for (const hc of state.haloCards) drawCard({ x: hc.x, y: hc.y, vx: 0, vy: 0, phase: hc.phase, color: hc.color }, 0.92);
  drawShip();
  drawParticles();
  drawLabels();
}

let last = performance.now();
function frame(now){
  const dt = Math.min((now - last) / 1000, 0.033);
  last = now;
  state.time += dt;
  autopilot(dt);
  updateHalo(dt);
  updateParticles(dt);
  render();
  updateUi();
  requestAnimationFrame(frame);
}

function assert(name, cond){
  if (!cond) console.error('[self-test failed]', name);
}
function selfTest(){
  assert('seedField function exists', typeof seedField === 'function');
  assert('triggerPower function exists', typeof triggerPower === 'function');
  assert('canvas exists', !!canvas && !!ctx);
  seedField();
  assert('field seeded with cards', state.cards.length > 0);
  const before = state.cards.filter(c => !c.collected).length;
  applyMagnet();
  assert('magnet effect armed', state.effects.magnetUntil > state.time);
  if (before > 0) {
    const first = state.cards.find(c => !c.collected);
    collectCard(first, 'special');
    assert('power added after collect', state.powers.length > 0);
  }
}

document.getElementById('restartBtn').addEventListener('click', seedField);
document.getElementById('burstBtn').addEventListener('click', applyBurst);
document.getElementById('collectAllBtn').addEventListener('click', () => {
  if (state.sweepCharge >= 100) applySweep();
  else applyMagnet();
});

selfTest();
seedField();
requestAnimationFrame(frame);
</script>
</body>
</html>
