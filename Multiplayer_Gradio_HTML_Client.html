<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§ ğŸ•¹ï¸ Multiplayer Gradio Client (HTML)</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --text:#e6e6e6; --muted:#9aa4b2; --accent:#7c5cff; --good:#2ecc71; --bad:#ff5c7a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header { padding:16px 18px; border-bottom:1px solid #222634; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    header .title { font-weight:700; letter-spacing:.2px; }
    header .status { font-size:12px; color:var(--muted); }
    main { padding:16px; display:grid; gap:14px; grid-template-columns: 360px 1fr; }
    .card { background:var(--panel); border:1px solid #222634; border-radius:14px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display:flex; gap:10px; align-items:center; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, textarea, button { width:100%; border-radius:12px; border:1px solid #2a2f40; background:#0e1016; color:var(--text); padding:10px 12px; }
    textarea { min-height: 84px; resize: vertical; }
    button { cursor:pointer; background: linear-gradient(135deg, rgba(124,92,255,.20), rgba(124,92,255,.08)); border-color: rgba(124,92,255,.35); }
    button:hover { border-color: rgba(124,92,255,.7); }
    button.ghost { background:#0e1016; border-color:#2a2f40; }
    .btns { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .small { font-size:12px; color:var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #2a2f40; background:#0e1016; font-size:12px; color:var(--muted); }
    .ok { color:var(--good); }
    .err { color:var(--bad); }
    pre { margin:0; white-space:pre-wrap; word-break:break-word; background:#0b0d12; border:1px solid #222634; border-radius:12px; padding:12px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .events { max-height: 320px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <div class="title">ğŸ§ ğŸ•¹ï¸ HTML Client â†’ Gradio Space</div>
    <div class="status" id="status">ğŸ”Œ Not connected (the packets are still putting on shoes ğŸ¥¿ğŸ“¦)</div>
  </header>

  <main>
    <section class="card">
      <div class="small">Space:</div>
      <div class="row" style="margin-bottom:10px;">
        <input id="spaceId" value="awacke1/Stateful_Multiplayer_Gradio" class="mono" />
      </div>

      <div class="grid2" style="margin-bottom:10px;">
        <div>
          <label>room (shared)</label>
          <input id="room" value="LOBBY" />
        </div>
        <div>
          <label>name (yours)</label>
          <input id="name" value="Player" />
        </div>
      </div>

      <div class="row" style="gap:10px; margin-bottom:10px;">
        <button id="btnConnect">Connect ğŸ”Œ</button>
        <button id="btnDisconnect" class="ghost">Stop Poll â›”</button>
      </div>

      <div class="btns" style="margin-bottom:12px;">
        <button id="btnJoin">Join ğŸª‘</button>
        <button id="btnLeave" class="ghost">Leave ğŸ§³</button>
        <button id="btnHelp" class="ghost">Help ğŸ“</button>
      </div>

      <label>command (easy words)</label>
      <textarea id="cmd" placeholder="say hi ğŸ‘‹&#10;put mood happy&#10;add score 5&#10;mine secret yes"></textarea>
      <div class="row" style="margin-top:10px;">
        <button id="btnRun">Run âœ…</button>
      </div>

      <div style="margin-top:12px;">
        <div class="pill"><span>Result</span> <span id="resultBadge" class="mono"></span></div>
        <pre id="result" class="mono" style="margin-top:8px;">(nothing yet)</pre>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Tip: share link like <span class="mono">?room=JAM1&name=Aaron</span></div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">Live state (polled)</div>
        <div class="small">Polling: <span class="mono" id="pollMs">1000</span> ms</div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <div class="small">Roster ğŸ‘¥</div>
          <pre id="roster" class="mono">(empty)</pre>
        </div>
        <div>
          <div class="small">You ğŸ¯</div>
          <pre id="you" class="mono">(unknown)</pre>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <div class="small">Public kv ğŸŒ</div>
          <pre id="public" class="mono">{}</pre>
        </div>
        <div>
          <div class="small">Private kv ğŸ¤« (only your seat)</div>
          <pre id="private" class="mono">{}</pre>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Events tail ğŸ§¾ (last ~40)</div>
        <pre id="events" class="mono events">(none)</pre>
      </div>
    </section>
  </main>

  <script type="module">
    import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

    // --- tiny helpers ---
    const $ = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const qp = new URLSearchParams(location.search);

    // Prefill room/name from URL
    if (qp.get("room")) $("room").value = qp.get("room");
    if (qp.get("name")) $("name").value = qp.get("name");

    let app = null;
    let pollOn = false;
    let pollEveryMs = 1000;

    function setStatus(msg, ok=true) {
      $("status").innerHTML = ok ? `ğŸŸ¢ ${msg}` : `ğŸ”´ ${msg}`;
      $("status").style.color = ok ? "var(--muted)" : "var(--bad)";
    }

    function showResult(obj) {
      const ok = !!obj?.ok;
      $("resultBadge").textContent = ok ? "ok âœ…" : "error âŒ";
      $("resultBadge").className = "mono " + (ok ? "ok" : "err");
      $("result").textContent = JSON.stringify(obj, null, 2);
    }

    async function connect() {
      const spaceId = $("spaceId").value.trim();
      if (!spaceId) return setStatus("No spaceId", false);

      setStatus("Connectingâ€¦ (summoning the API spirits ğŸ§™â€â™‚ï¸ğŸ“¡)");
      app = await Client.connect(spaceId);
      setStatus(`Connected to ${spaceId} âœ¨`);
      return app;
    }

    // Gradio outputs from gr.JSON often come back as result.data[0]
    function unwrapPredict(res) {
      if (!res) return null;
      if (Array.isArray(res.data) && res.data.length === 1) return res.data[0];
      return res.data ?? res;
    }

    async function callCmd(text) {
      if (!app) throw new Error("Not connected");
      const room = $("room").value.trim() || "LOBBY";
      const res = await app.predict("/cmd", [room, text]);
      return unwrapPredict(res);
    }

    async function callState() {
      if (!app) throw new Error("Not connected");
      const room = $("room").value.trim() || "LOBBY";
      const res = await app.predict("/state", [room]);
      return unwrapPredict(res);
    }

    function renderState(s) {
      $("roster").textContent  = JSON.stringify(s?.roster ?? [], null, 2);
      $("you").textContent     = JSON.stringify(s?.you ?? {}, null, 2);
      $("public").textContent  = JSON.stringify(s?.public ?? {}, null, 2);
      $("private").textContent = JSON.stringify(s?.private ?? {}, null, 2);
      $("events").textContent  = JSON.stringify(s?.events_tail ?? [], null, 2);
    }

    async function startPolling() {
      pollOn = true;
      $("pollMs").textContent = String(pollEveryMs);
      while (pollOn) {
        try {
          if (app) {
            const s = await callState();
            renderState(s);
          }
        } catch (e) {
          setStatus(`Polling error: ${e?.message || e}`, false);
        }
        await sleep(pollEveryMs);
      }
    }

    // --- UI wiring ---
    $("btnConnect").onclick = async () => {
      try {
        await connect();
        if (!pollOn) startPolling();
      } catch (e) {
        setStatus(`Connect failed: ${e?.message || e}`, false);
      }
    };

    $("btnDisconnect").onclick = () => {
      pollOn = false;
      setStatus("Polling stopped (the hamsters are off the wheel ğŸ¹ğŸ›‘)");
    };

    $("btnJoin").onclick = async () => {
      try {
        const nm = $("name").value.trim() || "Player";
        showResult(await callCmd(`join ${nm}`));
      } catch (e) {
        showResult({ ok:false, msg: String(e) });
      }
    };

    $("btnLeave").onclick = async () => {
      try {
        showResult(await callCmd(`leave`));
      } catch (e) {
        showResult({ ok:false, msg: String(e) });
      }
    };

    $("btnHelp").onclick = async () => {
      try {
        showResult(await callCmd(`help`));
      } catch (e) {
        showResult({ ok:false, msg: String(e) });
      }
    };

    $("btnRun").onclick = async () => {
      try {
        const text = $("cmd").value.trim();
        showResult(await callCmd(text));
      } catch (e) {
        showResult({ ok:false, msg: String(e) });
      }
    };

    // Optional: auto-connect if room is provided
    // (comment this out if you like manual control)
    if ($("room").value) {
      try { await connect(); startPolling(); } catch {}
    }
  </script>
</body>
</html>
