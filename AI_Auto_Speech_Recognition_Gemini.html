<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Auto Speech Recognition - Gemini</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #444;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        button {
            padding: 10px 18px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        #record-start { background-color: #28a745; color: white; }
        #record-start:disabled { background-color: #8c968f; cursor: not-allowed; }
        #record-stop { background-color: #dc3545; color: white; }
        #record-stop:disabled { background-color: #a3898b; cursor: not-allowed; }
        .util-btn { background-color: #007bff; color: white; }
        .secondary-btn { background-color: #6c757d; color: white; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        
        #status {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 8px;
            font-weight: 500;
            color: #495057;
        }

        #output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .transcript-block {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .transcript-block:hover {
            background-color: #f1f3f5;
        }
        .transcript-block.interim {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Speech To Text</h1>
        <div id="status">Click 'Record Start' to begin.</div>
        <div class="controls">
            <button id="record-start">Record Start</button>
            <button id="record-stop" disabled>Record Stop</button>
            <button id="clear-text" class="secondary-btn">Clear</button>
            <button id="copy-text" class="util-btn">Copy to Clipboard</button>
            <button id="save-txt" class="util-btn">Save as .txt</button>
            <button id="save-md" class="util-btn">Save as .md</button>
        </div>
        <div id="output"></div>
    </div>

    <script>
        // Check for browser support
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!window.SpeechRecognition) {
            alert("Sorry, your browser does not support the Web Speech API. Please try Chrome or Edge.");
        } else {
            const recognition = new SpeechRecognition();
            
            // DOM Elements
            const startBtn = document.getElementById('record-start');
            const stopBtn = document.getElementById('record-stop');
            const clearBtn = document.getElementById('clear-text');
            const copyBtn = document.getElementById('copy-text');
            const saveTxtBtn = document.getElementById('save-txt');
            const saveMdBtn = document.getElementById('save-md');
            const statusDiv = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            
            let currentTranscriptBlock = null;

            // Recognition settings
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            // --- Event Handlers ---

            recognition.onstart = () => {
                statusDiv.textContent = 'ðŸ”´ Recording... Speak now.';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            };

            recognition.onend = () => {
                statusDiv.textContent = 'Recording stopped. Click "Record Start" to begin again.';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            };

            recognition.onerror = (event) => {
                statusDiv.textContent = `Error: ${event.error}. Please check microphone permissions.`;
                console.error('Speech Recognition Error:', event.error);
                startBtn.disabled = false;
                stopBtn.disabled = true;
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // If we have a new final transcript, it means a pause happened.
                if (finalTranscript) {
                    // Finalize the current block if it exists
                    if(currentTranscriptBlock) {
                        currentTranscriptBlock.textContent = currentTranscriptBlock.textContent.replace(currentTranscriptBlock.dataset.interim, finalTranscript.trim());
                        currentTranscriptBlock.classList.remove('interim');
                        currentTranscriptBlock = null;
                    } else {
                        // Or create a new one if there wasn't an interim one
                        const newBlock = createTranscriptBlock(finalTranscript.trim());
                        outputDiv.appendChild(newBlock);
                    }
                }
                
                // Handle the current, ongoing speech (interim results)
                if (interimTranscript) {
                    if (!currentTranscriptBlock) {
                        currentTranscriptBlock = createTranscriptBlock('');
                        currentTranscriptBlock.classList.add('interim');
                        outputDiv.appendChild(currentTranscriptBlock);
                    }
                    currentTranscriptBlock.textContent = interimTranscript;
                    currentTranscriptBlock.dataset.interim = interimTranscript; // store interim for easy replacement
                }

                outputDiv.scrollTop = outputDiv.scrollHeight;
            };

            // --- Button Listeners ---

            startBtn.addEventListener('click', () => recognition.start());
            stopBtn.addEventListener('click', () => recognition.stop());

            clearBtn.addEventListener('click', () => {
                outputDiv.innerHTML = '';
            });

            copyBtn.addEventListener('click', () => {
                const textToCopy = getAggregatedText();
                if (navigator.clipboard && textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        statusDiv.textContent = 'Copied to clipboard!';
                        setTimeout(() => statusDiv.textContent = 'Idle', 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        statusDiv.textContent = 'Failed to copy.';
                    });
                }
            });

            saveTxtBtn.addEventListener('click', () => {
                downloadFile('transcript.txt', getAggregatedText(), 'text/plain');
            });

            saveMdBtn.addEventListener('click', () => {
                downloadFile('transcript.md', getAggregatedText(), 'text/markdown');
            });

            // --- Helper Functions ---

            function createTranscriptBlock(text) {
                const block = document.createElement('div');
                block.classList.add('transcript-block');
                block.textContent = text;
                // Add click-to-copy functionality for each block
                block.addEventListener('click', () => {
                    navigator.clipboard.writeText(block.textContent).then(() => {
                        const originalText = statusDiv.textContent;
                        statusDiv.textContent = `Copied: "${block.textContent.substring(0, 30)}..."`;
                        setTimeout(() => statusDiv.textContent = originalText, 2500);
                    });
                });
                return block;
            }

            function getAggregatedText() {
                const blocks = outputDiv.querySelectorAll('.transcript-block');
                let fullText = '';
                blocks.forEach(block => {
                    fullText += block.textContent + '\n\n';
                });
                return fullText.trim();
            }

            function downloadFile(filename, content, mimeType) {
                if (!content) return;
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }
    </script>

</body>
</html>
