<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Chatbot & Emergent Topology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            margin: 0;
        }

        /* 3D Background */
        #three-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .message-bubble {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recording-pulse {
            animation: pulse 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
            background-color: #ec4899 !important;
            color: white !important;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0px #ec4899; }
            50% { transform: scale(1.1); opacity: 0.8; box-shadow: 0 0 20px #ec4899; }
        }

        .timeline-line::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.2) 10%, rgba(99, 102, 241, 0.2) 90%, transparent);
            transform: translateX(-50%);
            z-index: 0;
        }

        .ui-layer {
            z-index: 10;
            position: relative;
        }
    </style>
</head>
<body class="flex h-screen w-full selection:bg-indigo-500 selection:text-white">

    <div id="three-container"></div>

    <aside class="w-80 glass-panel border-r border-slate-700/50 flex flex-col transition-all duration-300 ui-layer" id="sidebar">
        <div class="p-4 border-b border-slate-700/50 flex justify-between items-center bg-slate-900/50">
            <h2 class="text-lg font-semibold tracking-wide text-slate-200 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Timeline
            </h2>
            <button id="new-chat-btn" class="p-2 hover:bg-slate-700 rounded-lg transition text-indigo-400 hover:text-indigo-300" title="New Session">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="history-list">
            </div>

        <div class="p-4 border-t border-slate-700/50 bg-slate-900/80">
            <h3 class="text-xs font-semibold text-indigo-300 mb-3 uppercase tracking-wider flex justify-between items-center">
                Command Triggers
                <span class="text-[9px] bg-indigo-900/50 px-2 py-0.5 rounded text-indigo-200">Active</span>
            </h3>
            <ul id="command-list" class="text-xs space-y-2 mb-3 max-h-32 overflow-y-auto pr-1">
                </ul>
            <div class="flex gap-2">
                <input id="cmd-keyword" class="w-2/5 bg-slate-800 text-slate-200 text-xs p-2 rounded border border-slate-600 focus:outline-none focus:border-indigo-500 placeholder-slate-500" placeholder="Keyword">
                <select id="cmd-action" class="w-2/5 bg-slate-800 text-slate-200 text-xs p-2 rounded border border-slate-600 focus:outline-none focus:border-indigo-500 cursor-pointer">
                    <option value="growTree">Grow Tree</option>
                    <option value="pulseBg">Pulse Core</option>
                    <option value="clearChat">Clear Data</option>
                </select>
                <button id="add-cmd-btn" class="w-1/5 bg-indigo-600 hover:bg-indigo-500 text-white rounded transition shadow-lg flex items-center justify-center font-bold">+</button>
            </div>
        </div>

        <div class="p-3 border-t border-slate-700/50 text-[10px] text-slate-500 flex justify-between items-center bg-slate-950">
            <span>Auto-saving & Recording</span>
            <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative ui-layer">
        
        <header class="glass-panel border-b border-slate-700/50 p-4 flex justify-between items-center sticky top-0 bg-slate-900/40">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </div>
                <div>
                    <h1 class="text-md font-bold text-slate-100 drop-shadow-md">AI Neural Link</h1>
                    <p class="text-xs text-indigo-400 font-medium tracking-wide">Topology Mapper Active</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button class="p-2 hover:bg-slate-700 rounded-lg transition text-slate-400" id="download-btn" title="Force Download Archive">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
                <button class="p-2 hover:bg-slate-700 rounded-lg transition text-slate-400" id="tts-toggle" title="Toggle Voice Responses">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 sm:p-8 relative timeline-line scroll-smooth" id="chat-container">
            </div>

        <div class="p-4 sm:p-6 bg-gradient-to-t from-[#0f172a] via-[#0f172a] to-transparent">
            <div class="max-w-4xl mx-auto relative glass-panel rounded-2xl p-2 flex items-end shadow-2xl border border-slate-600/50 bg-slate-900/90">
                
                <button id="mic-btn" class="p-3 m-1 rounded-xl bg-slate-700 hover:bg-pink-600 text-slate-300 hover:text-white transition-all duration-300 flex-shrink-0 group">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>

                <textarea id="chat-input" rows="1" class="w-full bg-transparent text-slate-200 placeholder-slate-500 border-none focus:ring-0 resize-none px-4 py-4 text-sm max-h-32" placeholder="Speak, type, or trigger commands..."></textarea>
                
                <button id="send-btn" class="p-3 m-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white transition-all shadow-lg shadow-indigo-500/30 flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-6 h-6 translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
            <div class="text-center mt-2 flex justify-center gap-4">
                <span class="text-[10px] text-slate-500 uppercase tracking-widest" id="status-text">System Idle</span>
                <span class="text-[10px] text-slate-600 uppercase tracking-widest" id="recording-status">Audio: Standby</span>
            </div>
        </div>
    </main>

    <script>
        // --- Core Application State ---
        const AppState = {
            sessions: [],
            currentSessionId: null,
            isRecordingAudio: false,
            ttsEnabled: true,
            speechRecognition: null,
            synth: window.speechSynthesis,
            commands: [
                { keyword: 'generate', action: 'growTree' },
                { keyword: 'alert', action: 'pulseBg' }
            ],
            audioRecorder: null,
            audioChunks: [],
            lastSpokenWord: ''
        };

        // --- DOM Elements ---
        const els = {
            historyList: document.getElementById('history-list'),
            chatContainer: document.getElementById('chat-container'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            micBtn: document.getElementById('mic-btn'),
            newChatBtn: document.getElementById('new-chat-btn'),
            ttsToggle: document.getElementById('tts-toggle'),
            statusText: document.getElementById('status-text'),
            recStatus: document.getElementById('recording-status'),
            downloadBtn: document.getElementById('download-btn'),
            cmdList: document.getElementById('command-list'),
            cmdKeyword: document.getElementById('cmd-keyword'),
            cmdAction: document.getElementById('cmd-action'),
            addCmdBtn: document.getElementById('add-cmd-btn')
        };

        // --- Utilities ---
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function formatFileTimestamp() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const mo = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const y = now.getFullYear();
            return `${h}${m}_${mo}${d}${y}`;
        }

        function formatDisplayTimestamp() {
            const now = new Date();
            let h = now.getHours();
            let m = now.getMinutes();
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12; h = h ? h : 12; 
            m = m < 10 ? '0' + m : m;
            const mo = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const y = now.getFullYear();
            return `${h}:${m} ${ampm} ${mo}/${d}/${y}`;
        }

        // --- Three.js Background Logic ---
        const ThreeBg = {
            scene: null, camera: null, renderer: null, treeGroup: null, particles: null,
            init() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 5, 20);
                this.camera.lookAt(0, 5, 0);

                this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('three-container').appendChild(this.renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
                this.scene.add(ambientLight);
                
                const pointLight = new THREE.PointLight(0x6366f1, 2, 50);
                pointLight.position.set(0, 10, 10);
                this.scene.add(pointLight);

                this.treeGroup = new THREE.Group();
                this.scene.add(this.treeGroup);

                // Add subtle floating particles
                const partGeo = new THREE.BufferGeometry();
                const partCnt = 200;
                const posArr = new Float32Array(partCnt * 3);
                for(let i=0;i<partCnt*3;i++) { posArr[i] = (Math.random() - 0.5) * 40; }
                partGeo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
                const partMat = new THREE.PointsMaterial({ size: 0.05, color: 0x818cf8, transparent: true, opacity: 0.5 });
                this.particles = new THREE.Points(partGeo, partMat);
                this.scene.add(this.particles);

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });

                this.animate();
            },
            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.treeGroup) this.treeGroup.rotation.y += 0.002;
                if (this.particles) this.particles.rotation.y -= 0.001;
                this.renderer.render(this.scene, this.camera);
            },
            growTree(seedWord) {
                // Procedural generation based on string
                const hash = seedWord.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: new THREE.Color().setHSL(Math.abs(hash % 100)/100, 0.8, 0.5),
                    roughness: 0.3, metalness: 0.8, emissive: 0x111111 
                });
                
                const buildBranch = (parent, len, radius, angleX, angleZ, depth) => {
                    if (depth <= 0) {
                        // Leaf node (sphere representing the word connection)
                        const leafGeo = new THREE.SphereGeometry(radius * 3, 8, 8);
                        const leafMat = new THREE.MeshBasicMaterial({ color: mat.color, wireframe: true });
                        const leaf = new THREE.Mesh(leafGeo, leafMat);
                        leaf.position.y = len;
                        parent.add(leaf);
                        return;
                    }
                    const geo = new THREE.CylinderGeometry(radius*0.7, radius, len, 5);
                    geo.translate(0, len/2, 0);
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.rotation.x = angleX;
                    mesh.rotation.z = angleZ;
                    
                    const endPoint = new THREE.Group();
                    endPoint.position.y = len;
                    mesh.add(endPoint);
                    parent.add(mesh);

                    // Sprout 2 branches
                    const spread = 0.5 + (Math.abs(hash%10)/20);
                    buildBranch(endPoint, len*0.75, radius*0.7, spread, (Math.random()-0.5), depth-1);
                    buildBranch(endPoint, len*0.75, radius*0.7, -spread, (Math.random()-0.5), depth-1);
                };

                const root = new THREE.Group();
                root.position.set((Math.random()-0.5)*15, -10, (Math.random()-0.5)*10);
                buildBranch(root, 4, 0.4, 0, 0, 4);
                
                // Animate entry
                root.scale.set(0,0,0);
                this.treeGroup.add(root);
                
                let s = 0;
                const growAnim = setInterval(() => {
                    s += 0.05;
                    root.scale.set(s,s,s);
                    if (s >= 1) clearInterval(growAnim);
                }, 30);
            },
            pulseBg() {
                const initColor = this.scene.background || new THREE.Color(0x0f172a);
                this.scene.background = new THREE.Color(0x4c1d95);
                setTimeout(() => { this.scene.background = initColor; }, 200);
            },
            clearTrees() {
                while(this.treeGroup.children.length > 0){ 
                    this.treeGroup.remove(this.treeGroup.children[0]); 
                }
            }
        };

        // --- Commands Management ---
        function renderCommands() {
            els.cmdList.innerHTML = '';
            AppState.commands.forEach((cmd, idx) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700/50";
                li.innerHTML = `
                    <span class="text-indigo-300 font-mono">"${cmd.keyword}"</span>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 text-[10px] uppercase">${cmd.action}</span>
                        <button onclick="removeCommand(${idx})" class="text-red-400 hover:text-red-300">Ã—</button>
                    </div>
                `;
                els.cmdList.appendChild(li);
            });
        }

        function addCommand() {
            const kw = els.cmdKeyword.value.trim().toLowerCase();
            const act = els.cmdAction.value;
            if (kw) {
                AppState.commands.push({ keyword: kw, action: act });
                els.cmdKeyword.value = '';
                renderCommands();
            }
        }

        window.removeCommand = function(idx) {
            AppState.commands.splice(idx, 1);
            renderCommands();
        }

        els.addCmdBtn.addEventListener('click', addCommand);

        function processCommands(text) {
            const lowerText = text.toLowerCase();
            const words = lowerText.split(/\s+/);
            
            AppState.commands.forEach(cmd => {
                if (lowerText.includes(cmd.keyword)) {
                    executeAction(cmd.action, words[words.length-1] || 'node');
                }
            });
            AppState.lastSpokenWord = words[words.length-1];
        }

        function executeAction(actionStr, contextWord) {
            switch(actionStr) {
                case 'growTree': ThreeBg.growTree(contextWord); break;
                case 'pulseBg': ThreeBg.pulseBg(); break;
                case 'clearChat': 
                    getCurrentSession().messages = []; 
                    saveHistory(); renderChat(); 
                    ThreeBg.clearTrees();
                    break;
            }
        }

        // --- Storage & History Management ---
        function loadHistory() {
            const saved = localStorage.getItem('ai_voice_chat_history');
            if (saved) AppState.sessions = JSON.parse(saved);
            if (AppState.sessions.length === 0) createNewSession();
            else AppState.currentSessionId = AppState.sessions[0].id;
            renderHistory(); renderChat();
        }

        function saveHistory() {
            localStorage.setItem('ai_voice_chat_history', JSON.stringify(AppState.sessions));
            renderHistory();
        }

        function createNewSession() {
            const newSession = { id: generateId(), title: 'New Topology Sequence', updatedAt: Date.now(), messages: [] };
            AppState.sessions.unshift(newSession);
            AppState.currentSessionId = newSession.id;
            ThreeBg.clearTrees();
            saveHistory(); renderChat();
        }

        function getCurrentSession() { return AppState.sessions.find(s => s.id === AppState.currentSessionId); }

        // --- Downloading & Archiving ---
        function downloadArchive(session) {
            const fTime = formatFileTimestamp();
            
            // 1. Text Download
            const textContent = session.messages.map(m => `[${m.timestamp}] ${m.role.toUpperCase()}: ${m.text}`).join('\n\n');
            const blobTxt = new Blob([textContent], { type: 'text/plain' });
            const urlTxt = URL.createObjectURL(blobTxt);
            const aTxt = document.createElement('a');
            aTxt.href = urlTxt;
            aTxt.download = `chatlog_${fTime}.txt`;
            aTxt.click();

            // 2. Audio Download (if recorded)
            if (AppState.audioChunks.length > 0) {
                const blobAud = new Blob(AppState.audioChunks, { type: 'audio/webm' });
                const urlAud = URL.createObjectURL(blobAud);
                const aAud = document.createElement('a');
                aAud.href = urlAud;
                aAud.download = `audiolog_${fTime}.webm`;
                aAud.click();
            }

            addSystemMessage(`Auto-archived session log & audio at 100 entries. File signature: ${fTime}`);
        }

        // --- Chat Rendering ---
        function renderHistory() {
            els.historyList.innerHTML = '';
            AppState.sessions.forEach(session => {
                const isActive = session.id === AppState.currentSessionId;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer transition-all border ${isActive ? 'bg-indigo-900/30 border-indigo-500/50 shadow-inner' : 'hover:bg-slate-800 border-transparent bg-slate-900/40'}`;
                const d = new Date(session.updatedAt);
                const timeStr = `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;
                div.innerHTML = `
                    <div class="text-sm font-medium ${isActive ? 'text-indigo-300' : 'text-slate-300'} truncate">${session.title}</div>
                    <div class="text-[10px] text-slate-500 mt-1 flex justify-between">
                        <span>${session.messages.length} nodes</span>
                        <span>${timeStr}</span>
                    </div>
                `;
                div.onclick = () => { AppState.currentSessionId = session.id; renderHistory(); renderChat(); };
                els.historyList.appendChild(div);
            });
        }

        function renderChat() {
            els.chatContainer.innerHTML = '';
            const session = getCurrentSession();
            if (!session || session.messages.length === 0) {
                els.chatContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-500 z-10 relative">
                        <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        <p class="text-sm tracking-widest uppercase">Awaiting Synaptic Input</p>
                    </div>
                `;
                return;
            }
            session.messages.forEach(msg => appendMessageToDOM(msg));
            scrollToBottom();
        }

        function addSystemMessage(text) {
            const msg = { id: generateId(), role: 'system', text: text, timestamp: formatDisplayTimestamp() };
            getCurrentSession().messages.push(msg);
            saveHistory();
            appendMessageToDOM(msg);
            scrollToBottom();
        }

        function appendMessageToDOM(msg) {
            if (msg.role === 'system') {
                const wrapper = document.createElement('div');
                wrapper.className = "w-full flex justify-center mb-6 relative z-10 message-bubble";
                wrapper.innerHTML = `<span class="bg-indigo-900/40 text-indigo-300 text-[10px] px-3 py-1 rounded-full border border-indigo-500/30 uppercase tracking-wider">${msg.text}</span>`;
                els.chatContainer.appendChild(wrapper);
                return;
            }

            const isUser = msg.role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-8 relative z-10 message-bubble ${isUser ? 'justify-end' : 'justify-start'}`;

            const markerClass = isUser ? 'bg-indigo-500 shadow-[0_0_10px_#6366f1]' : 'bg-pink-500 shadow-[0_0_10px_#ec4899]';
            const markerPos = isUser ? 'right-1/2 translate-x-[calc(50%+1px)]' : 'left-1/2 -translate-x-[calc(50%-1px)]';
            
            wrapper.innerHTML = `
                <div class="absolute top-4 ${markerPos} w-3 h-3 rounded-full border-2 border-[#0f172a] ${markerClass} hidden sm:block"></div>
                <div class="max-w-[85%] sm:max-w-[45%] flex flex-col ${isUser ? 'items-end sm:mr-6' : 'items-start sm:ml-6'}">
                    <div class="flex items-center gap-2 mb-1 px-1">
                        <span class="text-[10px] font-bold text-slate-400 tracking-wider">${isUser ? 'OPERATOR' : 'AI SYSTEM'}</span>
                        <span class="text-[9px] text-slate-500 bg-slate-800/50 px-2 py-0.5 rounded-full border border-slate-700/50">${msg.timestamp}</span>
                    </div>
                    <div class="p-4 rounded-2xl ${isUser ? 'bg-indigo-600 text-white rounded-tr-sm' : 'glass-panel text-slate-200 rounded-tl-sm border border-slate-700/50'} shadow-lg leading-relaxed text-sm backdrop-blur-md">
                        ${msg.text}
                    </div>
                </div>
            `;
            els.chatContainer.appendChild(wrapper);
            const emptyState = els.chatContainer.querySelector('.flex-col.items-center');
            if (emptyState) emptyState.remove();
        }

        function scrollToBottom() { els.chatContainer.scrollTop = els.chatContainer.scrollHeight; }

        function addMessage(role, text) {
            const session = getCurrentSession();
            const msg = { id: generateId(), role: role, text: text, timestamp: formatDisplayTimestamp() };
            session.messages.push(msg);
            session.updatedAt = Date.now();
            
            if (session.messages.length === 1 && role === 'user') session.title = text.substring(0, 25) + '...';
            
            saveHistory();
            appendMessageToDOM(msg);
            scrollToBottom();

            if (role === 'user') {
                processCommands(text);
                setTimeout(() => addMessage('ai', `Acknowledged input stream processing regarding: "${AppState.lastSpokenWord}". Topologies updated.`), 1000);
            } else if (role === 'ai' && AppState.ttsEnabled) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.1; utterance.pitch = 0.9;
                AppState.synth.speak(utterance);
            }

            // The 100 Line Auto-Download Trigger
            if (session.messages.length === 100) downloadArchive(session);
        }

        // --- Event Listeners ---
        els.sendBtn.addEventListener('click', () => {
            const text = els.chatInput.value.trim();
            if (!text) return;
            els.chatInput.value = '';
            addMessage('user', text);
        });

        els.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); els.sendBtn.click(); }
        });

        els.newChatBtn.addEventListener('click', createNewSession);
        els.downloadBtn.addEventListener('click', () => downloadArchive(getCurrentSession()));
        
        els.ttsToggle.addEventListener('click', () => {
            AppState.ttsEnabled = !AppState.ttsEnabled;
            els.ttsToggle.classList.toggle('text-indigo-400', AppState.ttsEnabled);
            els.ttsToggle.classList.toggle('text-slate-400', !AppState.ttsEnabled);
        });

        // --- Audio & Speech Recognition ---
        async function setupAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                AppState.audioRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                AppState.audioRecorder.ondataavailable = e => { if (e.data.size > 0) AppState.audioChunks.push(e.data); };
                els.recStatus.textContent = 'Audio: Active';
                els.recStatus.classList.replace('text-slate-600', 'text-emerald-500');
            } catch (err) {
                console.error("Mic access denied", err);
                els.recStatus.textContent = 'Audio: Denied';
            }
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            AppState.speechRecognition = new SpeechRecognition();
            AppState.speechRecognition.continuous = false;
            AppState.speechRecognition.interimResults = true;

            AppState.speechRecognition.onstart = () => {
                els.micBtn.classList.add('recording-pulse');
                els.statusText.textContent = 'Listening...';
                if(AppState.audioRecorder && AppState.audioRecorder.state === 'inactive') {
                    AppState.audioChunks = [];
                    AppState.audioRecorder.start();
                }
            };
            
            AppState.speechRecognition.onresult = (event) => {
                let interim = ''; let final = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) final += event.results[i][0].transcript;
                    else interim += event.results[i][0].transcript;
                }
                els.chatInput.value = final || interim;
            };

            AppState.speechRecognition.onend = () => {
                els.micBtn.classList.remove('recording-pulse');
                els.statusText.textContent = 'System Idle';
                if(AppState.audioRecorder && AppState.audioRecorder.state === 'recording') AppState.audioRecorder.stop();
                if (els.chatInput.value.trim()) els.sendBtn.click();
            };
        }

        els.micBtn.addEventListener('click', async () => {
            if (!AppState.audioRecorder) await setupAudio();
            if (AppState.speechRecognition) {
                if (els.micBtn.classList.contains('recording-pulse')) AppState.speechRecognition.stop();
                else AppState.speechRecognition.start();
            } else {
                alert("Speech recognition not supported in this browser.");
            }
        });

        // --- Init ---
        ThreeBg.init();
        renderCommands();
        loadHistory();
        els.ttsToggle.classList.add('text-indigo-400');
    </script>
</body>
</html>
