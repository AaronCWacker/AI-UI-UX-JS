<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üèôÔ∏è MIRROR CITY DRIVE ‚Äî Clone Flock Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* üé® Neon UI: because debugging should look like a nightclub */
  html,body{margin:0;overflow:hidden;background:#000;font-family:monospace;color:#0ff}
  #ui{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.72);padding:10px;border:1px solid #0ff;z-index:10;min-width:220px}
  #ui b{color:#ff6bff}
  #touch{
    position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
    display:grid;grid-template-columns:repeat(6,56px);gap:6px;z-index:10;
  }
  .btn{
    width:56px;height:56px;border:1px solid #0ff;background:#111;color:#0ff;
    display:flex;align-items:center;justify-content:center;user-select:none;
    border-radius:8px;
  }
  .btn:active{transform:scale(.98);background:#0b2230}
  #hint{position:fixed;top:10px;right:10px;background:rgba(0,0,0,.6);padding:10px;border:1px solid #0ff;z-index:10;max-width:320px}
  #hint small{color:#9ff}
</style>
</head>
<body>

<div id="ui">
  <b>üèôÔ∏è MIRROR CITY DRIVE</b><br>
  üß† Cells: <span id="cells">0</span><br>
  üßæ CSV Events: <span id="events">0</span><br>
  ü™û Clones: <span id="clones">0</span><br>
  üé• Cam: <span id="cam">3P</span> | ü§ñ CloneAI: <span id="aiMode">BRAIN</span><br>
  üåä Water drag: <span id="water">OFF</span><br>
  <small>Press <b>P</b> to copy CSV to clipboard.</small>
</div>

<div id="hint">
  <b>Keys</b><br>
  <small>
    W/A/S/D = Drive &nbsp;|&nbsp; Space = Shoot &nbsp;|&nbsp; C = Camera<br>
    E = Door ‚Äúencourage‚Äù &nbsp;|&nbsp; M = Clone AI Mode (BRAIN/CSV)<br>
    P = Copy CSV memory &nbsp;|&nbsp; R = Reset position
  </small>
</div>

<!-- üì± iPad-sized buttons (same vibe as keyboard keys) -->
<div id="touch">
  <div class="btn" data-k="w">W</div>
  <div class="btn" data-k="a">A</div>
  <div class="btn" data-k="s">S</div>
  <div class="btn" data-k="d">D</div>
  <div class="btn" data-k=" ">‚ê£</div>
  <div class="btn" data-k="c">C</div>
  <div class="btn" data-k="e">E</div>
  <div class="btn" data-k="m">M</div>
  <div class="btn" data-k="p">P</div>
  <div class="btn" data-k="r">R</div>
  <div class="btn" data-k="q">Q</div>
  <div class="btn" data-k="f">F</div>
</div>

<!-- üßæ CSV ‚ÄúBrain Memory‚Äù Script (edit this like a quest log) -->
<script type="text/plain" id="brainCsv">
#time_s,cmd,arg1,arg2,arg3
0.0,GOTO_NEAREST_ROAD,,,
2.0,FOLLOW_ROAD,6.0,,         # follow road for 6 seconds (pretend you're law-abiding)
8.0,TURN,LEFT,90,             # turn left 90 degrees
10.0,GOTO_NEAREST_BUILDING,,,
13.0,GOTO_BUILDING_DOOR,NEAREST,,
16.0,PARK_AT_DOOR,2.0,,       # park for 2 seconds like a civilized cyberpunk
18.0,OPEN_DOOR,,,
19.0,ENTER_BUILDING,,,
23.0,EXIT_BUILDING,,,
25.0,GOTO_NEAREST_RAMP,,,
27.0,HIT_RAMP,1.0,,           # take ramp at ~full send
30.0,SHOOT_BURST,12,,         # shoot 12 bullets (because lasers are therapy)
</script>

<script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
<script>
/* =========================================================
üèôÔ∏è MIRROR CITY DRIVE ‚Äî Clone Flock Edition
‚ÄúYour clones aren‚Äôt learning‚Ä¶ they‚Äôre *collecting your habits*.‚Äù
========================================================= */

/* üß† Tiny helper: clamp, lerp, sign-without-drama */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;

/* =========================================================
üí° SCENE SETUP ‚Äî fog so thick the city feels like a memory
========================================================= */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x020210,60,900);

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,3000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0x404040));
const sun=new THREE.DirectionalLight(0xffffff,0.85);
sun.position.set(100,160,60);
sun.castShadow=true;
scene.add(sun);

const neon=new THREE.PointLight(0xff00ff,1.1,160);
neon.position.set(0,30,0);
scene.add(neon);

/* =========================================================
üéÆ INPUT ‚Äî keyboard supremacy, touchscreen diplomacy
========================================================= */
const keys={};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
document.querySelectorAll(".btn").forEach(b=>{
  b.ontouchstart=()=>keys[b.dataset.k]=true;
  b.ontouchend=()=>keys[b.dataset.k]=false;
});

/* =========================================================
üåç TERRAIN ‚Äî smooth lies with bumpy truths (and water regret)
========================================================= */
function soilHeight(x,z){
  // A ‚Äúsmooth but bumpy‚Äù surface: small amplitude, long wavelength
  return Math.sin(x*0.03)*0.55 + Math.cos(z*0.028)*0.45 + Math.sin((x+z)*0.012)*0.35;
}
const WATER_LEVEL=-0.6;

/* Water plane (visual + drag) */
const water=new THREE.Mesh(
  new THREE.PlaneGeometry(2400,2400),
  new THREE.MeshBasicMaterial({color:0x001b44,transparent:true,opacity:0.38})
);
water.rotation.x=-Math.PI/2;
water.position.y=WATER_LEVEL;
scene.add(water);

/* Soil mesh (visual only; physics uses soilHeight sampling) */
const soil=new THREE.Mesh(
  new THREE.PlaneGeometry(2400,2400,120,120),
  new THREE.MeshStandardMaterial({color:0x121217,roughness:1})
);
soil.rotation.x=-Math.PI/2;
soil.receiveShadow=true;
// Deform vertices (safe-ish in r128 if geometry has attributes; keep simple, not perfect)
{
  const g=soil.geometry;
  const pos=g.attributes.position;
  for(let i=0;i<pos.count;i++){
    const x=pos.getX(i), z=pos.getY(i); // PlaneGeometry uses (x,y) before rotation
    const y=soilHeight(x,z);
    pos.setZ(i,y);
  }
  pos.needsUpdate=true;
  g.computeVertexNormals();
}
scene.add(soil);

/* =========================================================
üõ£Ô∏è LAYERS ‚Äî soil, road, highway, building floors, ramps
‚ÄúWelcome to verticality. Population: your steering hand.‚Äù
========================================================= */

/* A road strip at y=0.05 and a highway at y=5 */
const roadLayer = { y:0.
