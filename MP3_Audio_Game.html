<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéõÔ∏è 16-Pad MP3 Segment Looper</title>
  <style>
    :root{
      --bg:#070913; --panel:rgba(255,255,255,.07); --line:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92); --muted:rgba(255,255,255,.70);
    }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap{ max-width: 980px; margin: 24px auto; padding: 0 16px 28px; }
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size: 18px; margin: 0 0 10px; letter-spacing:.2px; }
    .sub{ font-size: 13px; color: var(--muted); line-height:1.35; }
    .btn{
      cursor:pointer; user-select:none;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 10px 12px;
      font-weight: 800;
      font-size: 13px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{ background: rgba(125,211,252,.16); border-color: rgba(125,211,252,.32); }
    .btn.danger{ background: rgba(248,113,113,.12); border-color: rgba(248,113,113,.25); }

    .kv{ display:flex; gap:8px; align-items:center; }
    input[type="number"]{
      width: 86px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      font-weight: 800;
    }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .pad{
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      cursor: pointer;
      user-select:none;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      min-height: 78px;
    }
    .pad:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .pad.on{
      background: rgba(52,211,153,.14);
      border-color: rgba(52,211,153,.35);
    }
    .pad.playing{
      outline: 2px solid rgba(125, 211, 252, .85);
      outline-offset: 2px;
    }
    .pad .top{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .pad .name{ font-weight: 900; font-size: 13px; }
    .pad .time{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; opacity: .85; }
    .pad .meta{ margin-top: 6px; font-size: 12px; color: var(--muted); line-height:1.3; }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      font-size: 13px;
      min-height: 18px;
      color: var(--muted);
    }
    .small{ font-size: 12px; color: var(--muted); }
    a{ color: rgba(125,211,252,.95); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üéõÔ∏è 16-Pad MP3 Segment Looper</h1>
      <div class="sub">
        Put <b>this .html</b> and an <b>.mp3 with the same basename</b> in the same GitHub Pages folder.
        Example: <code>mytrack.html</code> + <code>mytrack.mp3</code>. Then click <b>Enable Audio</b>.
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <button class="btn primary" id="enable">üîä Enable Audio</button>
        <button class="btn" id="load">üì• Load MP3</button>
        <button class="btn primary" id="play">‚ñ∂ Play</button>
        <button class="btn" id="stop">‚èπ Stop</button>
        <button class="btn danger" id="clear">üßπ Clear Pads</button>

        <div class="kv">
          <span class="small">BPM</span>
          <input type="number" id="bpm" value="120" min="40" max="240" />
        </div>

        <div class="kv">
          <span class="small">Bars/Loop</span>
          <input type="number" id="bars" value="1" min="1" max="16" />
        </div>

        <div class="kv">
          <span class="small">Quantize</span>
          <select id="quant" class="btn" style="padding:9px 10px;">
            <option value="bar" selected>Bar</option>
            <option value="beat">Beat</option>
          </select>
        </div>
      </div>

      <div class="msg" id="msg">Ready.</div>

      <div class="grid" id="grid"></div>

      <div style="height:10px"></div>
      <div class="small">
        Tip: GitHub Pages serves MP3 fine, but the first play must be user-initiated (browser policy).
        If you want true seamless looping, use shorter stems or use WebAudio buffer mode.
      </div>
    </div>
  </div>

  <!-- Howler.js for MP3 loading + seeking -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

  <script>
    // =========================
    // 0) Helpers
    // =========================
    const $ = (id) => document.getElementById(id);
    const msg = (t) => { $("msg").textContent = t; };

    // Derive MP3 name from current HTML file:
    // e.g. https://site/path/mytrack.html -> https://site/path/mytrack.mp3
    function mp3UrlFromHtml() {
      const url = new URL(window.location.href);
      const path = url.pathname;                       // /path/mytrack.html
      const base = path.replace(/\.html?$/i, "");       // /path/mytrack
      const mp3Path = base + ".mp3";                   // /path/mytrack.mp3
      return url.origin + mp3Path;
    }

    // =========================
    // 1) Segment definitions (EDIT THESE)
    // =========================
    // Make 16 segments; start/end in seconds.
    // You can start with rough guesses and refine by ear.
    const segments = Array.from({length: 16}, (_, i) => ({
      id: i,
      name: `Pad ${i+1}`,
      start: i * 1.0,         // TODO: change
      end: (i * 1.0) + 0.75,  // TODO: change
      note: "Edit start/end seconds in code"
    }));

    // Example: if you have known hooks:
    // segments[0] = {id:0, name:"Hook A", start:12.00, end:14.00, note:"chorus pickup"};
    // segments[1] = {id:1, name:"Hook B", start:14.00, end:16.00, note:"chorus answer"};

    // =========================
    // 2) State
    // =========================
    let howl = null;
    let audioUnlocked = false;

    // Sequencer
    let running = false;
    let stepTimer = null;
    let nextStepAt = 0;

    // Each pad can be toggled on/off
    const padOn = new Array(16).fill(false);

    // Track currently scheduled stop timeouts so we can cancel them on Stop()
    const activeStops = new Map(); // soundId -> timeoutId

    // =========================
    // 3) UI grid
    // =========================
    const grid = $("grid");

    function renderPads() {
      grid.innerHTML = "";
      segments.forEach((s) => {
        const el = document.createElement("div");
        el.className = "pad" + (padOn[s.id] ? " on" : "");
        el.id = `pad-${s.id}`;
        el.innerHTML = `
          <div class="top">
            <div class="name">${s.name}</div>
            <div class="time">${fmt(s.start)} ‚Üí ${fmt(s.end)}</div>
          </div>
          <div class="meta">${s.note || ""}</div>
        `;
        el.addEventListener("click", () => {
          padOn[s.id] = !padOn[s.id];
          renderPads();
          // Optional: audition immediately when toggled ON
          if (padOn[s.id]) audition(s.id);
        });
        grid.appendChild(el);
      });
    }

    function fmt(x){
      return (Math.round(x*100)/100).toFixed(2) + "s";
    }

    renderPads();

    // =========================
    // 4) Audio: unlock + load
    // =========================
    async function unlockAudio() {
      // Howler uses WebAudio under the hood; calling play after a gesture is enough.
      // We'll "prime" with a silent play attempt by creating the Howl later and using user click.
      audioUnlocked = true;
      msg("Audio unlocked ‚úÖ Now click ‚ÄúLoad MP3‚Äù.");
    }

    function loadMp3() {
      if (!audioUnlocked) {
        msg("Click ‚ÄúEnable Audio‚Äù first (browser requirement).");
        return;
      }
      const url = mp3UrlFromHtml();
      msg(`Loading MP3‚Ä¶ ${url}`);

      howl = new Howl({
        src: [url],
        html5: true,     // stream MP3 (works well on Pages)
        volume: 1.0,
        preload: true,
        onload: () => msg("MP3 loaded ‚úÖ Toggle pads, then ‚ñ∂ Play."),
        onloaderror: (_, err) => msg("Load error ‚ùå Check DevTools Console + confirm MP3 exists beside HTML."),
        onplayerror: () => {
          // sometimes mobile needs explicit unlock
          msg("Play blocked ‚ùå Click Enable Audio again, then Play.");
        }
      });

      // Helpful debugging if it fails
      console.log("MP3 URL:", url);
    }

    // =========================
    // 5) Core: play a segment (start->end)
    // =========================
    function playSegment(segId) {
      if (!howl) { msg("Load MP3 first."); return; }

      const s = segments[segId];
      const dur = Math.max(0.02, s.end - s.start);

      // Start playback (new sound instance)
      // If already playing another instance, that's OK: this is a looper / sampler.
      const soundId = howl.play();

      // Seek to start time
      howl.seek(s.start, soundId);

      // Visual highlight
      const padEl = document.getElementById(`pad-${segId}`);
      if (padEl) padEl.classList.add("playing");

      // Stop exactly at end time
      const stopTid = setTimeout(() => {
        howl.stop(soundId);
        activeStops.delete(soundId);
        if (padEl) padEl.classList.remove("playing");
      }, dur * 1000);

      activeStops.set(soundId, stopTid);
    }

    function audition(segId) {
      // quick preview without transport
      playSegment(segId);
    }

    function stopAll() {
      running = false;
      if (stepTimer) { clearTimeout(stepTimer); stepTimer = null; }
      nextStepAt = 0;

      if (howl) howl.stop();

      // cancel scheduled stops
      for (const [soundId, tid] of activeStops.entries()) {
        clearTimeout(tid);
      }
      activeStops.clear();

      // clear playing outlines
      segments.forEach(s => {
        const padEl = document.getElementById(`pad-${s.id}`);
        if (padEl) padEl.classList.remove("playing");
      });

      msg("Stopped.");
    }

    // =========================
    // 6) Transport: bar/beat quantized pad triggering
    // =========================
    function startTransport() {
      if (!howl) { msg("Load MP3 first."); return; }
      if (running) return;

      const bpm = clamp(Number($("bpm").value || 120), 40, 240);
      const bars = clamp(Number($("bars").value || 1), 1, 16);
      const quant = $("quant").value; // "bar" | "beat"

      const beatMs = 60000 / bpm;
      const barMs = beatMs * 4; // 4/4 assumption
      const stepMs = (quant === "beat") ? beatMs : barMs;
      const loopSteps = (quant === "beat") ? (bars * 4) : bars;

      let step = 0;
      running = true;

      // schedule loop with drift-resistant "nextStepAt" clock
      nextStepAt = performance.now() + 10;

      msg(`Playing ‚úÖ ${bpm} BPM, ${bars} bar loop, quantize: ${quant}.`);

      const tick = () => {
        if (!running) return;

        const now = performance.now();
        const lateBy = now - nextStepAt;

        // fire step
        // Simple mapping: pads 1-16 correspond to steps 0-15 (bar or beat steps).
        // If your loop has fewer than 16 steps, only first N pads are used.
        // For example, quant="beat", bars=1 => 4 steps => pads 1-4 used.
        const stepPads = Math.min(16, loopSteps);
        if (step < stepPads) {
          // At each step, trigger any pads that are ON at that index
          // (Here: one pad per step index; you can expand to multiple layers later.)
          if (padOn[step]) playSegment(step);
        }

        step = (step + 1) % loopSteps;

        // schedule next
        nextStepAt += stepMs;
        const wait = Math.max(0, nextStepAt - performance.now());
        stepTimer = setTimeout(tick, wait);

        // optional debug if very late
        if (lateBy > 30) console.log("Scheduling late by (ms):", lateBy.toFixed(1));
      };

      tick();
    }

    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

    // =========================
    // 7) Buttons
    // =========================
    $("enable").addEventListener("click", unlockAudio);
    $("load").addEventListener("click", loadMp3);
    $("play").addEventListener("click", startTransport);
    $("stop").addEventListener("click", stopAll);
    $("replay").addEventListener("click", () => {
      // replay / audition all ON pads in quick succession
      if (!howl) { msg("Load MP3 first."); return; }
      msg("Auditioning ON pads‚Ä¶");
      let t = 0;
      for (let i=0;i<16;i++){
        if (padOn[i]) {
          setTimeout(() => playSegment(i), t);
          t += 120;
        }
      }
      if (t === 0) msg("No pads ON. Click pads to toggle.");
    });

    $("clear").addEventListener("click", () => {
      stopAll();
      for (let i=0;i<16;i++) padOn[i] = false;
      renderPads();
      msg("Cleared pads.");
    });

    // =========================
    // 8) Helpful keyboard shortcuts
    // =========================
    window.addEventListener("keydown", (e) => {
      if (e.code === "Space") { e.preventDefault(); running ? stopAll() : startTransport(); }
      // number keys 1-9 toggle pads 1-9
      const n = Number(e.key);
      if (n >= 1 && n <= 9) {
        const idx = n - 1;
        padOn[idx] = !padOn[idx];
        renderPads();
      }
    });
  </script>
</body>
</html>
