<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>üèéÔ∏è NEON SWARM STUNT RALLY</title>
  <style>
    body { margin: 0; overflow: hidden; background: #050505; font-family: 'Arial Black', sans-serif; touch-action: none; }

    /* HUD */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    }
    
    #score-box {
      position: absolute; top: 20px; left: 20px;
      color: #fff; text-shadow: 2px 2px 0 #000;
      text-transform: uppercase;
    }
    .big-text { font-size: 40px; color: #ffeb3b; font-style: italic; }
    .label { font-size: 12px; color: #00e5ff; letter-spacing: 2px; }

    /* Powerup Status */
    #status-bar {
      position: absolute; top: 20px; right: 20px; text-align: right;
    }
    .status-item { 
      background: rgba(0,0,0,0.8); color: #fff; padding: 5px 10px; 
      margin-bottom: 5px; border-radius: 4px; font-size: 12px;
      display: none; /* Hidden by default */
      border-left: 5px solid #fff;
    }

    /* Popups */
    .popup {
      position: absolute; left: 50%; top: 30%; transform: translate(-50%, -50%);
      font-size: 40px; color: #fff; text-shadow: 0 0 20px #ff00ff;
      opacity: 0; transition: top 1s, opacity 1s;
      white-space: nowrap; pointer-events: none;
    }

    /* CONTROLS (Mobile & Desktop) */
    #mobile-ui {
      position: absolute; bottom: 20px; left: 0; width: 100%; height: 160px;
      pointer-events: none;
    }
    .btn {
      position: absolute; pointer-events: auto;
      background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%; color: white; text-align: center;
      user-select: none; backdrop-filter: blur(4px);
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .btn:active { background: rgba(0, 255, 255, 0.5); border-color: #fff; transform: scale(0.95); }
    
    /* Steering D-Pad */
    #dpad-left { bottom: 20px; left: 20px; width: 60px; height: 60px; line-height: 60px; font-size: 24px; }
    #dpad-right { bottom: 20px; left: 90px; width: 60px; height: 60px; line-height: 60px; font-size: 24px; }
    
    /* Action Buttons */
    #btn-jump { bottom: 30px; right: 20px; width: 70px; height: 70px; line-height: 70px; font-size: 14px; border-color: #d0f; background: rgba(200, 0, 255, 0.2); }
    #btn-nitro { bottom: 40px; right: 100px; width: 50px; height: 50px; line-height: 50px; font-size: 10px; border-color: #fd0; background: rgba(255, 200, 0, 0.2); }
    
    /* Toggles */
    #btn-auto { 
      top: -140px; right: 20px; width: auto; height: auto; 
      padding: 10px 15px; border-radius: 20px; font-size: 12px;
      position: absolute; pointer-events: auto;
    }
    .auto-on { background: #0f0 !important; color: #000 !important; font-weight: bold; }

    #tutorial {
      position: absolute; bottom: 5px; width: 100%; text-align: center; color: #555; font-size: 10px; font-family: monospace;
    }
  </style>
</head>
<body>

  <div id="ui-layer">
    <div id="score-box">
      <div class="label">SCORE</div>
      <div id="score-val" class="big-text">0</div>
      <div class="label" style="margin-top:5px; color:#f0f">SWARM</div>
      <div id="swarm-dist" style="font-size:20px">0m</div>
    </div>

    <div id="status-bar">
      <div id="status-nitro" class="status-item" style="border-color:#ffeb3b">NITRO BOOST!</div>
      <div id="status-jump" class="status-item" style="border-color:#d0f">MOON GRAVITY</div>
    </div>
  </div>

  <div id="popup-container"></div>

  <div id="mobile-ui">
    <div id="dpad-left" class="btn">‚óÄ</div>
    <div id="dpad-right" class="btn">‚ñ∂</div>
    <div id="btn-nitro" class="btn">BOOST</div>
    <div id="btn-jump" class="btn">JUMP</div>
    <div id="btn-auto" class="btn">AUTO PILOT: OFF</div>
  </div>
  
  <div id="tutorial">[WASD/Arrows] Drive ‚Ä¢ [SPACE] Jump ‚Ä¢ [SHIFT] Boost ‚Ä¢ [C] Cam</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <script>
    // =========================================================
    // 1. ENGINE CONSTANTS
    // =========================================================
    const SETTINGS = {
      gravity: 0.9,
      accel: 1.5,
      maxSpeed: 4.0,
      turnSpeed: 0.05,
      jumpForce: 2.2,
      friction: 0.97,
      botCount: 12
    };

    let scene, camera, renderer, clock;
    let player;
    let bots = [];
    let powerups = [];
    let particles = [];
    let worldMeshes = []; 
    let raycaster = new THREE.Raycaster();
    let downVec = new THREE.Vector3(0,-1,0);

    // Game State
    let score = 0;
    let autoPilot = false;
    let input = { fwd:0, turn:0, jump:false, boost:false };
    let frameCount = 0;
    let playerHistory = []; // Trail for bots

    // =========================================================
    // 2. INITIALIZATION
    // =========================================================
    function init() {
      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a001a);
      scene.fog = new THREE.FogExp2(0x0a001a, 0.002);

      // Camera
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 1, 3000);
      
      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lights
      const amb = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(amb);
      const sun = new THREE.DirectionalLight(0x00ffff, 0.8);
      sun.position.set(100, 200, 50);
      sun.castShadow = true;
      scene.add(sun);

      // World
      buildWorld();
      
      // Player
      player = new Car(true, 0x00e5ff); 
      scene.add(player.mesh);

      // Bots
      for(let i=0; i<SETTINGS.botCount; i++) {
        const bot = new Car(false, 0xff0055);
        bot.mesh.position.z = -20 - (i*10); // Start behind
        scene.add(bot.mesh);
        bots.push(bot);
      }

      // Listeners
      setupControls();
      clock = new THREE.Clock();
      loop();
    }

    function buildWorld() {
      // Grid Floor
      const grid = new THREE.GridHelper(4000, 100, 0x440044, 0x111111);
      grid.position.y = 0.1;
      scene.add(grid);

      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(4000, 4000),
        new THREE.MeshPhongMaterial({ color: 0x050505 })
      );
      floor.rotation.x = -Math.PI/2;
      floor.receiveShadow = true;
      scene.add(floor);
      worldMeshes.push(floor);

      // Ramps & Obstacles
      const rampMat = new THREE.MeshPhongMaterial({ color: 0x222222, emissive: 0x220033 });
      
      for(let i=0; i<60; i++) {
        const x = (Math.random()-0.5)*1500;
        const z = (Math.random()-0.5)*1500;
        
        // Random Ramps
        const ramp = new THREE.Mesh(new THREE.BoxGeometry(30, 2, 60), rampMat);
        ramp.position.set(x, 0, z);
        ramp.rotation.y = Math.random() * Math.PI;
        ramp.rotation.x = -0.3; // Slope up
        ramp.position.y = 5; // Lifted due to rotation center
        ramp.castShadow = true; ramp.receiveShadow = true;
        scene.add(ramp);
        worldMeshes.push(ramp);

        // Spawn Powerup on top of some ramps
        if (Math.random() > 0.5) {
          spawnPowerup(x, 15, z);
        }
      }
    }

    function spawnPowerup(x, y, z) {
      const type = Math.random() > 0.5 ? 'nitro' : 'jump';
      const color = type === 'nitro' ? 0xffff00 : 0xaa00ff;
      
      const geo = new THREE.BoxGeometry(4,4,4);
      const mat = new THREE.MeshBasicMaterial({ color: color, wireframe: true });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.set(x, y, z);
      
      // Glow core
      const core = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), new THREE.MeshBasicMaterial({color:color}));
      mesh.add(core);

      scene.add(mesh);
      powerups.push({ mesh, type, active: true });
    }

    // =========================================================
    // 3. CAR & BOT LOGIC
    // =========================================================
    class Car {
      constructor(isPlayer, color) {
        this.isPlayer = isPlayer;
        this.mesh = new THREE.Group();

        // Visuals
        const body = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.8, 5), new THREE.MeshPhongMaterial({ color: color }));
        body.position.y = 0.8;
        body.castShadow = true;
        this.mesh.add(body);

        // Wheels (Neon)
        const wMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        const wheelPos = [[-1.4,0.5,1.5], [1.4,0.5,1.5], [-1.4,0.5,-1.5], [1.4,0.5,-1.5]];
        wheelPos.forEach(p => {
          const w = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,0.4,12), wMat);
          w.rotation.z = Math.PI/2;
          w.position.set(...p);
          this.mesh.add(w);
        });

        if (isPlayer) {
            // Trail Emitter
            this.trail = [];
        } else {
            // Bot visual distinction (Hologram style)
            body.material.wireframe = true;
            body.material.transparent = true;
            body.material.opacity = 0.5;
        }

        // Physics
        this.pos = new THREE.Vector3();
        this.vel = new THREE.Vector3();
        this.rot = 0;
        this.onGround = false;
        
        // Stats (Modified by Powerups)
        this.baseSpeed = SETTINGS.maxSpeed;
        this.baseJump = SETTINGS.jumpForce;
        this.speedMult = 1;
        this.jumpMult = 1;
        
        this.timers = { nitro: 0, jump: 0 };
      }

      update(dt) {
        // 1. Buffs
        if (this.timers.nitro > 0) {
            this.timers.nitro -= dt;
            this.speedMult = 2.0;
            if(this.isPlayer) document.getElementById('status-nitro').style.display = 'block';
        } else {
            this.speedMult = 1.0;
            if(this.isPlayer) document.getElementById('status-nitro').style.display = 'none';
        }

        if (this.timers.jump > 0) {
            this.timers.jump -= dt;
            this.jumpMult = 2.0;
            if(this.isPlayer) document.getElementById('status-jump').style.display = 'block';
        } else {
            this.jumpMult = 1.0;
            if(this.isPlayer) document.getElementById('status-jump').style.display = 'none';
        }

        // 2. Input Logic
        let gas = 0;
        let turn = 0;
        let doJump = false;

        if (this.isPlayer) {
          gas = autoPilot ? 1 : input.fwd;
          turn = input.turn;
          doJump = input.jump;
          if (input.boost && this.timers.nitro <= 0) gas *= 1.5; // Small manual boost
        } else {
          // AI Logic: Follow Player History
          // Swarm Logic: Each bot targets a point in player history based on its index
          // Bot 0 follows 10 frames ago, Bot 1 follows 20 frames ago...
          const swarmIndex = bots.indexOf(this);
          const historyIndex = Math.max(0, playerHistory.length - (20 + swarmIndex * 10));
          
          if (playerHistory.length > 0) {
             const target = playerHistory[historyIndex];
             // Steer towards target
             const dx = target.x - this.pos.x;
             const dz = target.z - this.pos.z;
             const dist = Math.sqrt(dx*dx + dz*dz);
             const angleTo = Math.atan2(dx, dz); // Target angle
             
             // Smooth rotation
             let angleDiff = angleTo - this.rot;
             while (angleDiff > Math.PI) angleDiff -= Math.PI*2;
             while (angleDiff < -Math.PI) angleDiff += Math.PI*2;
             
             turn = Math.max(-1, Math.min(1, angleDiff * 2.0));
             
             // Gas if far
             gas = (dist > 5) ? 1.1 : 0; // Go slightly faster to catch up
             
             // Jump if player jumped there?
             // Simple: If player is high up, jump
             if (target.y > this.pos.y + 2 && this.onGround) doJump = true;
          }
        }

        // 3. Physics
        if (this.onGround) {
            // Drive
            const speed = this.baseSpeed * this.speedMult;
            this.vel.x += Math.sin(this.rot) * gas * SETTINGS.accel * dt;
            this.vel.z += Math.cos(this.rot) * gas * SETTINGS.accel * dt;
            
            // Turn
            if (this.vel.length() > 0.5) {
               this.rot += turn * SETTINGS.turnSpeed * Math.sign(gas || 1);
            }
            
            // Friction
            this.vel.multiplyScalar(SETTINGS.friction);
            
            // Jump
            if (doJump) {
               this.vel.y = this.baseJump * this.jumpMult;
               this.onGround = false;
               this.pos.y += 0.5;
            }
        } else {
            // Air Drag
            this.vel.multiplyScalar(0.995);
        }

        // Gravity
        const g = (this.jumpMult > 1) ? SETTINGS.gravity * 0.5 : SETTINGS.gravity;
        this.vel.y -= g * dt;

        // Apply Position
        this.pos.add(this.vel.clone().multiplyScalar(dt * 30));

        // 4. Collision Ground
        this.checkGround();
        
        // 5. Update Mesh
        this.mesh.position.copy(this.pos);
        this.mesh.rotation.y = this.rot;

        // Visual tilt
        this.mesh.rotation.z = -turn * 0.2;
        this.mesh.rotation.x = -gas * 0.1;
      }

      checkGround() {
         const origin = this.pos.clone().add(new THREE.Vector3(0,1,0));
         raycaster.set(origin, downVec);
         const hits = raycaster.intersectObjects(worldMeshes);
         
         if(hits.length > 0 && hits[0].distance < 1.5) {
            if(this.vel.y <= 0) {
                this.onGround = true;
                this.vel.y = 0;
                this.pos.y = hits[0].point.y + 0.5;
            }
         } else {
            this.onGround = false;
         }
         
         if(this.pos.y < 0) { this.pos.y = 0; this.onGround = true; this.vel.y = 0; }
      }
    }

    // =========================================================
    // 4. MAIN LOOP & SYSTEMS
    // =========================================================

    function loop() {
      requestAnimationFrame(loop);
      const dt = Math.min(clock.getDelta(), 0.1);

      // Player Logic
      player.update(dt);
      
      // History Recording
      frameCount++;
      playerHistory.push(player.pos.clone());
      if(playerHistory.length > 500) playerHistory.shift(); // Keep buffer manageable

      // Bot Logic (Swarm)
      let minDist = 9999;
      bots.forEach(b => {
         b.update(dt);
         const d = b.pos.distanceTo(player.pos);
         if(d < minDist) minDist = d;
      });

      // Reward System
      if (minDist < 20) {
         score += 1; // "Leading the pack" bonus
         document.getElementById('swarm-dist').innerText = "SWARM: CLOSE";
         document.getElementById('swarm-dist').style.color = "#0f0";
      } else {
         document.getElementById('swarm-dist').innerText = "SWARM: " + Math.floor(minDist) + "m";
         document.getElementById('swarm-dist').style.color = "#fff";
      }
      document.getElementById('score-val').innerText = score;

      // Powerup Logic
      powerups.forEach(p => {
         if (!p.active) return;
         p.mesh.rotation.y += dt * 2;
         p.mesh.rotation.x += dt;
         
         // Collision
         if (player.pos.distanceTo(p.mesh.position) < 4) {
             activatePowerup(p.type);
             p.active = false;
             scene.remove(p.mesh);
         }
      });

      // Camera
      const camOffset = new THREE.Vector3(0, 8, -18).applyAxisAngle(new THREE.Vector3(0,1,0), player.rot);
      const camPos = player.pos.clone().add(camOffset);
      camera.position.lerp(camPos, 0.1);
      camera.lookAt(player.pos.clone().add(new THREE.Vector3(0, 2, 0)));

      renderer.render(scene, camera);
    }

    function activatePowerup(type) {
        score += 500;
        let msg = "";
        if (type === 'nitro') {
            player.timers.nitro = 5.0; // 5 seconds
            msg = "NITRO BOOST!";
            createPopup(msg, "#ffeb3b");
        } else {
            player.timers.jump = 8.0;
            msg = "MOON BOOTS!";
            createPopup(msg, "#d0f");
        }
    }

    function createPopup(text, color) {
        const div = document.createElement('div');
        div.className = 'popup';
        div.innerText = text;
        div.style.color = color;
        div.style.top = "30%";
        document.getElementById('popup-container').appendChild(div);
        
        // Animation
        setTimeout(() => { div.style.top = "20%"; div.style.opacity = 1; }, 10);
        setTimeout(() => { div.style.opacity = 0; }, 1000);
        setTimeout(() => { div.remove(); }, 2000);
    }

    // =========================================================
    // 5. INPUT HANDLING
    // =========================================================
    function setupControls() {
        // Keyboard
        window.addEventListener('keydown', e => {
            if(e.code==='KeyW' || e.code==='ArrowUp') input.fwd = 1;
            if(e.code==='KeyS' || e.code==='ArrowDown') input.fwd = -1;
            if(e.code==='KeyA' || e.code==='ArrowLeft') input.turn = 1;
            if(e.code==='KeyD' || e.code==='ArrowRight') input.turn = -1;
            if(e.code==='Space') input.jump = true;
            if(e.code==='ShiftLeft') input.boost = true;
            if(e.code==='KeyC') { /* Cam toggle logic if needed */ }
        });
        window.addEventListener('keyup', e => {
            if(['KeyW','KeyS','ArrowUp','ArrowDown'].includes(e.code)) input.fwd = 0;
            if(['KeyA','KeyD','ArrowLeft','ArrowRight'].includes(e.code)) input.turn = 0;
            if(e.code==='Space') input.jump = false;
            if(e.code==='ShiftLeft') input.boost = false;
        });

        // Touch
        const bindBtn = (id, start, end) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', e => { e.preventDefault(); start(); });
            el.addEventListener('touchend', e => { e.preventDefault(); end(); });
        };

        bindBtn('dpad-left', () => input.turn=1, () => input.turn=0);
        bindBtn('dpad-right', () => input.turn=-1, () => input.turn=0);
        bindBtn('btn-jump', () => input.jump=true, () => input.jump=false);
        bindBtn('btn-nitro', () => input.boost=true, () => input.boost=false);
        
        document.getElementById('btn-auto').addEventListener('touchstart', (e) => {
            e.preventDefault();
            autoPilot = !autoPilot;
            const btn = document.getElementById('btn-auto');
            btn.innerText = autoPilot ? "AUTO PILOT: ON" : "AUTO PILOT: OFF";
            btn.classList.toggle('auto-on');
        });
    }

    init();
  </script>
</body>
</html>
