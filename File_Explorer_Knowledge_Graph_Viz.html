<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Treemap File Manager</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --background-color: #f0f2f5;
            --text-color: #333;
            --header-color: #2c3e50;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --danger-color: #e74c3c;
            --container-bg: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }
        .main-header {
            text-align: center;
            margin-bottom: 1rem;
        }
        .main-header h1 {
            margin: 0 0 0.25rem 0;
            color: var(--header-color);
        }
        .main-header p {
            margin: 0;
            color: #555;
            max-width: 600px;
        }
        .header-controls {
            width: 95%;
            max-width: 1400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        .control-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .action-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 8px 16px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .action-button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
        }
        #folder-picker-label {
            background-color: #28a745;
        }
        #folder-picker-label:hover {
            background-color: #218838;
        }
        #reset-view-btn.hidden, #filter-bar.hidden {
            display: none;
        }
        #filter-bar {
            padding: 0.5rem;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        #file-type-filter {
            padding: 6px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        #folder-picker { display: none; }

        #treemap-container {
            position: relative;
            width: 95%;
            max-width: 1400px;
            flex-grow: 1; /* Takes up remaining vertical space */
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            background-color: var(--container-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        .node-group {
            position: absolute;
            box-sizing: border-box;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .internal {
            border: 1px solid #aaa;
            cursor: pointer;
        }
        .leaf {
            background-clip: padding-box;
            box-shadow: inset 0px 0px 0px 1px rgba(255, 255, 255, 0.8);
        }
        .leaf:hover, .internal:hover {
            filter: brightness(1.15);
            z-index: 10;
        }
        .node-label {
            padding: 3px 6px; color: #fff; background-color: rgba(0,0,0,0.5);
            font-size: 13px; font-weight: bold; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .leaf-label {
            padding: 4px; color: rgba(255, 255, 255, 0.95); text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            font-size: 12px; word-break: break-word; pointer-events: none;
        }
        #tooltip {
            position: fixed; background-color: rgba(0, 0, 0, 0.85); color: white;
            padding: 8px 12px; border-radius: 4px; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; font-size: 14px;
            z-index: 1001; transform: translate(15px, 10px); max-width: 400px;
        }
        #context-menu {
            position: fixed; display: none; background-color: #fff;
            border: 1px solid #bdc3c7; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px; padding: 5px 0; z-index: 1000; min-width: 180px;
        }
        #context-menu button {
            display: block; width: 100%; padding: 8px 20px; border: none;
            background: none; text-align: left; cursor: pointer; font-size: 14px;
        }
        #context-menu button:hover { background-color: #f0f2f5; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center;
            justify-content: center; z-index: 2000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content p { margin: 0 0 20px 0; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 5px;
            cursor: pointer; margin: 0 10px;
        }
        #modal-confirm { background-color: var(--danger-color); color: white; }
        #modal-cancel { background-color: #bdc3c7; }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>Advanced Treemap File Manager</h1>
        <p>Select a local folder to visualize its contents. <strong>All processing is done in your browser. No files are uploaded.</strong></p>
    </div>

    <div class="header-controls">
        <div class="control-group">
            <label for="folder-picker" id="folder-picker-label" class="action-button">üìÅ Scan Local Folder</label>
            <input type="file" id="folder-picker" webkitdirectory directory multiple />
            <button id="toggle-filter-btn" class="action-button hidden">üîç Filters</button>
            <button id="reset-view-btn" class="action-button hidden">üîº Reset View</button>
        </div>
        <div id="filter-bar" class="control-group hidden">
            <label for="file-type-filter">File Type:</label>
            <select id="file-type-filter">
                <option value="all">All</option>
            </select>
        </div>
    </div>

    <div id="treemap-container"></div>
    <div id="tooltip"></div>

    <div id="context-menu"></div>

    <div id="modal-overlay">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button id="modal-confirm">Yes</button>
            <button id="modal-cancel">Cancel</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const folderPicker = document.getElementById('folder-picker');
        const treemapContainer = document.getElementById('treemap-container');
        const tooltip = document.getElementById('tooltip');
        const contextMenu = document.getElementById('context-menu');
        const toggleFilterBtn = document.getElementById('toggle-filter-btn');
        const filterBar = document.getElementById('filter-bar');
        const fileTypeFilter = document.getElementById('file-type-filter');
        const resetViewBtn = document.getElementById('reset-view-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        
        // --- State Management ---
        let originalFileTree = null; // The complete, unmodified file tree
        let currentDisplayRoot = null; // The node currently being displayed as the root (for zooming)
        let rightClickedNode = null;
        let modalConfirmCallback = null;

        // --- Core Application Logic ---

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            setTimeout(() => {
                originalFileTree = buildFileTree(files);
                if (!originalFileTree || originalFileTree.children.length === 0) return;
                
                currentDisplayRoot = originalFileTree;
                updateVisualization();
                toggleFilterBtn.classList.remove('hidden');
            }, 50);
        }
        
        function buildFileTree(files) {
            const rootName = files[0].webkitRelativePath.split('/')[0];
            const root = { name: rootName, path: rootName, children: [] };
            
            for (const file of files) {
                if (file.size === 0) continue;
                const pathParts = file.webkitRelativePath.split('/');
                let currentNode = root;
                for (let i = 1; i < pathParts.length - 1; i++) {
                    const part = pathParts[i];
                    let dirNode = currentNode.children.find(child => child.name === part && child.children);
                    if (!dirNode) {
                        const parentPath = pathParts.slice(0, i + 1).join('/');
                        dirNode = { name: part, path: parentPath, children: [] };
                        currentNode.children.push(dirNode);
                    }
                    currentNode = dirNode;
                }
                const fileName = pathParts[pathParts.length - 1];
                const extension = fileName.includes('.') ? `.${fileName.split('.').pop()}`.toLowerCase() : 'none';
                currentNode.children.push({
                    name: fileName, value: file.size, path: file.webkitRelativePath,
                    type: file.type, lastModified: new Date(file.lastModified).toLocaleString(),
                    extension: extension
                });
            }
            return root;
        }

        function populateFileTypeFilter(data) {
            const currentFilterValue = fileTypeFilter.value;
            const extensions = new Set();
            function findExtensions(node) {
                if (!node) return;
                if (node.children) {
                    node.children.forEach(findExtensions);
                } else if (node.extension) {
                    extensions.add(node.extension);
                }
            }
            findExtensions(data);
            
            fileTypeFilter.innerHTML = '<option value="all">All</option>';
            const sortedExtensions = [...extensions].sort();
            
            sortedExtensions.forEach(ext => {
                const option = document.createElement('option');
                option.value = ext;
                option.textContent = ext;
                fileTypeFilter.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (sortedExtensions.includes(currentFilterValue)) {
                fileTypeFilter.value = currentFilterValue;
            } else {
                fileTypeFilter.value = 'all';
            }
        }

        function filterTree(node, filterType) {
            if (filterType === 'all') return node;

            const newNode = { ...node };

            if (!node.children) {
                return node.extension === filterType ? newNode : null;
            }

            newNode.children = node.children
                .map(child => filterTree(child, filterType))
                .filter(Boolean); // Remove nulls

            return newNode.children.length > 0 ? newNode : null;
        }

        function updateVisualization() {
            if (!currentDisplayRoot) return;
            
            // Dynamically update the filter options based on the current view
            populateFileTypeFilter(currentDisplayRoot);

            const filterType = fileTypeFilter.value;
            const filteredData = filterTree(JSON.parse(JSON.stringify(currentDisplayRoot)), filterType);
            
            if (filteredData) {
                renderTreemap(filteredData);
            } else {
                treemapContainer.innerHTML = `<p style="padding: 2rem;">No files match the current filter.</p>`;
            }

            resetViewBtn.classList.toggle('hidden', currentDisplayRoot === originalFileTree);
        }

        function renderTreemap(data) {
            treemapContainer.innerHTML = '';
            const width = treemapContainer.clientWidth;
            const height = treemapContainer.clientHeight;

            const root = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value);

            d3.treemap().size([width, height]).paddingInner(1).paddingOuter(3).paddingTop(22).tile(d3.treemapSquarify)(root);
            
            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const node = d3.select('#treemap-container').selectAll('div').data(root.descendants()).join('div')
                .attr('class', d => `node-group ${d.children ? 'internal' : 'leaf'}`)
                .style('left', d => `${d.x0}px`).style('top', d => `${d.y0}px`)
                .style('width', d => `${d.x1 - d.x0}px`).style('height', d => `${d.y1 - d.y0}px`);
            
            const leaves = node.filter(d => !d.children);
            leaves.style('background-color', d => {
                let ancestor = d;
                while (ancestor.depth > 1) { ancestor = ancestor.parent; }
                return color(ancestor.data.name);
            }).on('contextmenu', (e, d) => showContextMenu(e, d));

            leaves.append('div').attr('class', 'leaf-label').text(d => d.data.name);

            const directories = node.filter(d => d.children);
            directories.on('click', (event, d) => {
                currentDisplayRoot = d.data;
                updateVisualization();
            }).on('contextmenu', (e, d) => showContextMenu(e, d));

            directories.append('div').attr('class', 'node-label').text(d => d.data.name);

            node.on('mouseenter', (event, d) => {
                tooltip.style.opacity = 1;
                let content = d.children ? `<strong>Directory:</strong> ${d.data.path}<br><strong>Total Size:</strong> ${formatBytes(d.value)}`
                                         : `<strong>File:</strong> ${d.data.name}<br><strong>Path:</strong> ${d.data.path}<br><strong>Size:</strong> ${formatBytes(d.value)}<br><strong>Type:</strong> ${d.data.type || 'N/A'}<br><strong>Modified:</strong> ${d.data.lastModified}`;
                tooltip.innerHTML = content;
            }).on('mousemove', (event) => {
                tooltip.style.left = `${event.clientX + 15}px`;
                tooltip.style.top = `${event.clientY + 10}px`;
            }).on('mouseleave', () => { tooltip.style.opacity = 0; });
        }
        
        function showContextMenu(event, d) {
            event.preventDefault();
            event.stopPropagation();
            rightClickedNode = d;
            contextMenu.innerHTML = ''; // Clear previous menu

            const copyPathBtn = document.createElement('button');
            copyPathBtn.textContent = 'üìã Copy Path';
            copyPathBtn.onclick = () => {
                const textArea = document.createElement('textarea');
                textArea.value = rightClickedNode.data.path;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            };
            contextMenu.appendChild(copyPathBtn);

            if (d.children) { // It's a directory
                const focusBtn = document.createElement('button');
                focusBtn.textContent = 'üîé Focus on Directory';
                focusBtn.onclick = () => { currentDisplayRoot = rightClickedNode.data; updateVisualization(); };
                contextMenu.appendChild(focusBtn);
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '‚ùå Remove from View';
            deleteBtn.onclick = () => {
                showModal(`Remove "${rightClickedNode.data.name}" from the view?`, () => {
                    if (!rightClickedNode.parent) return; // Cannot delete root
                    const parentNode = findNodeByPath(originalFileTree, rightClickedNode.parent.data.path);
                    if (parentNode && parentNode.children) {
                        const index = parentNode.children.findIndex(child => child.path === rightClickedNode.data.path);
                        if (index > -1) {
                            parentNode.children.splice(index, 1);
                            updateVisualization();
                        }
                    }
                });
            };
            contextMenu.appendChild(deleteBtn);

            contextMenu.style.display = 'block';
            contextMenu.style.left = `${event.clientX}px`;
            contextMenu.style.top = `${event.clientY}px`;
        }

        function findNodeByPath(rootNode, path) {
            if (rootNode.path === path) return rootNode;
            if (!rootNode.children) return null;
            for (const child of rootNode.children) {
                const found = findNodeByPath(child, path);
                if (found) return found;
            }
            return null;
        }

        function showModal(message, confirmCallback) {
            modalMessage.textContent = message;
            modalConfirmCallback = confirmCallback;
            modalOverlay.style.display = 'flex';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }

        // --- Event Listeners ---
        folderPicker.addEventListener('change', handleFileSelect);
        toggleFilterBtn.addEventListener('click', () => filterBar.classList.toggle('hidden'));
        fileTypeFilter.addEventListener('change', updateVisualization);
        resetViewBtn.addEventListener('click', () => {
            currentDisplayRoot = originalFileTree;
            updateVisualization();
        });
        window.addEventListener('click', () => contextMenu.style.display = 'none');
        modalCancel.addEventListener('click', () => modalOverlay.style.display = 'none');
        modalConfirm.addEventListener('click', () => {
            if (modalConfirmCallback) modalConfirmCallback();
            modalOverlay.style.display = 'none';
        });
        window.addEventListener('resize', updateVisualization);
    });
    </script>

</body>
</html>
