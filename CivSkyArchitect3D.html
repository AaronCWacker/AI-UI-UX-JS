<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SKYFORGE: Architect's Ascent</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;600;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: 'Exo 2', sans-serif; 
            color: #0ff; 
        }

        #viewport { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            cursor: crosshair; 
        }

        /* --- ADVANCED HUD --- */
        #hud {
            position: fixed; 
            top: 15px; 
            left: 15px; 
            z-index: 10;
            background: linear-gradient(135deg, rgba(0,10,30,0.95) 0%, rgba(0,5,20,0.85) 100%);
            border: 2px solid #0ff;
            border-left: 5px solid #f0a;
            padding: 20px;
            width: 280px;
            box-shadow: 0 0 40px rgba(0,255,255,0.3), inset 0 0 30px rgba(0,0,0,0.5);
            border-radius: 5px;
        }
        
        .hud-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: #f0a;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #f0a;
        }

        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .stat-row:hover {
            background: rgba(0,255,255,0.1);
            border-left-color: #0ff;
        }

        .stat-val { 
            font-weight: bold; 
            font-size: 20px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .label { 
            color: #888; 
            font-size: 11px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        #combo-display {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,0,255,0.1);
            border: 1px solid #f0a;
            text-align: center;
            font-size: 14px;
            color: #f0a;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* --- LEVEL & XP BAR --- */
        #level-bar {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #0ff;
        }
        
        .level-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #0ff;
        }
        
        .xp-bar-bg {
            width: 100%;
            height: 8px;
            background: #111;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #f0a);
            width: 0%;
            transition: width 0.5s;
            box-shadow: 0 0 10px #0ff;
        }

        /* --- ENHANCED SLOT MACHINE --- */
        #ui-layer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            z-index: 10; 
            display: flex; 
            justify-content: center; 
            padding-bottom: 20px;
        }
        
        .machine-frame { 
            width: 450px; 
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 3px solid #0ff;
            border-top: 6px solid #f0a;
            padding: 20px;
            box-shadow: 0 0 60px rgba(0,255,255,0.5), inset 0 0 40px rgba(0,0,0,0.8);
            border-radius: 10px;
        }
        
        .machine-title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: #f0a;
            font-size: 18px;
            margin-bottom: 15px;
            letter-spacing: 4px;
            text-shadow: 0 0 15px #f0a;
        }

        .reels { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px;
            background: #000;
            height: 120px;
            margin-bottom: 15px;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
        }
        
        .reel-strip { 
            background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);
            border-right: 2px solid #222;
            position: relative;
            overflow: hidden;
        }
        
        .reel-strip:last-child {
            border-right: none;
        }
        
        .symbol { 
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: relative;
            transition: transform 0.3s;
        }
        
        .symbol:hover {
            transform: scale(1.1);
        }
        
        .symbol.win {
            animation: symbolWin 0.5s infinite;
        }
        
        @keyframes symbolWin {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(2); }
        }

        .controls { 
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .btn { 
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            color: #0ff;
            border: 2px solid #0ff;
            padding: 15px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,255,255,0.3);
        }
        
        .btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #0ff 0%, #08a 100%);
            color: #000;
            box-shadow: 0 0 20px rgba(0,255,255,0.8);
            transform: translateY(-2px);
        }
        
        .btn.active { 
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border-color: #f0a;
            box-shadow: 0 0 20px rgba(255,0,255,0.6);
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        #btn-spin { 
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border-color: #f0a;
            font-size: 14px;
            box-shadow: 0 0 20px rgba(255,0,255,0.5);
        }
        
        #btn-spin:hover:not(:disabled) {
            background: linear-gradient(135deg, #fff 0%, #f0a 100%);
            box-shadow: 0 0 30px rgba(255,0,255,0.9);
        }

        /* Payout Table */
        .payout-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 10px;
            color: #666;
            margin-top: 10px;
        }
        
        .payout-item {
            padding: 5px;
            background: rgba(0,0,0,0.5);
            border-left: 2px solid #333;
            display: flex;
            justify-content: space-between;
        }

        /* --- CAMERA CONTROLS --- */
        #camera-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .cam-btn {
            width: 50px;
            height: 50px;
            background: rgba(0,20,40,0.9);
            border: 2px solid #0ff;
            color: #0ff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        .cam-btn:hover {
            background: rgba(0,255,255,0.3);
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }

        /* --- OVERLAY --- */
        #overlay { 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background: linear-gradient(135deg, #000 0%, #0a0a20 50%, #000 100%);
            z-index:200; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            justify-content:center;
        }
        
        #overlay h1 { 
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem; 
            color: #f0a;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 10px;
            text-shadow: 0 0 30px #f0a, 0 0 60px #f0a;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { text-shadow: 0 0 30px #f0a; }
            50% { text-shadow: 0 0 60px #f0a, 0 0 90px #f0a; }
        }
        
        #overlay p { 
            color: #0ff;
            margin-bottom: 20px;
            font-size: 18px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
        }
        
        #overlay button { 
            padding: 20px 60px;
            font-size: 22px;
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border: 3px solid #f0a;
            font-weight: 900;
            cursor: pointer;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 40px #f0a;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        #overlay button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px #f0a;
        }

        /* --- NOTIFICATIONS --- */
        .float-text { 
            position: absolute;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            font-size: 24px;
            z-index: 100;
        }
        
        @keyframes floatUp { 
            0% { opacity: 1; transform: translateY(0) scale(0.5); } 
            50% { transform: translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); } 
        }

        /* --- BUILDING INFO PANEL --- */
        #build-info {
            position: fixed;
            top: 50%;
            right: -350px;
            transform: translateY(-50%);
            width: 300px;
            background: rgba(0,10,30,0.95);
            border: 2px solid #0ff;
            border-right: none;
            padding: 20px;
            z-index: 15;
            transition: right 0.3s;
            border-radius: 5px 0 0 5px;
        }
        
        #build-info.visible {
            right: 0;
        }
        
        .info-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 16px;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }
        
        .info-row {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .info-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .info-value {
            color: #0ff;
            font-size: 16px;
            font-weight: bold;
        }
        
        #upgrade-btn {
            width: 100%;
            margin-top: 15px;
        }

        /* Milestone Notifications */
        .milestone {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0,0,0,0.95);
            border: 4px solid #f0a;
            padding: 40px;
            z-index: 150;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 0 80px #f0a;
            animation: milestoneAppear 0.5s forwards;
        }
        
        @keyframes milestoneAppear {
            to { transform: translate(-50%, -50%) scale(1); }
        }
        
        .milestone h2 {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 0 0 20px #f0a;
        }
        
        .milestone p {
            color: #0ff;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .milestone button {
            padding: 15px 40px;
            background: #f0a;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1>SKYFORGE</h1>
    <p>
        Command the Architect Drone. Spin to gather resources.<br>
        Click the drone to deploy structures. Build a thriving metropolis.<br>
        Match symbols for powerful combos. Upgrade your city to ascend.
    </p>
    <button onclick="initSim()">‚ö° INITIALIZE SKYFORGE ‚ö°</button>
</div>

<div id="viewport"></div>

<div id="hud">
    <div class="hud-title">‚ö° SKYFORGE CONTROL ‚ö°</div>
    
    <div class="stat-row">
        <span class="label">‚ö° Energy</span>
        <span id="ui-energy" class="stat-val" style="color:#0ff">150</span>
    </div>
    
    <div class="stat-row">
        <span class="label">üîß Materials</span>
        <span id="ui-materials" class="stat-val" style="color:#ffaa00">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">üíé Credits</span>
        <span id="ui-credits" class="stat-val" style="color:#f0f">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">üß¨ Population</span>
        <span id="ui-pop" class="stat-val" style="color:#0f0">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">üèóÔ∏è Structures</span>
        <span id="ui-builds" class="stat-val" style="color:#ff0">0</span>
    </div>
    
    <div id="combo-display">NO COMBO</div>
    
    <div id="level-bar">
        <div class="level-title">
            <span>ARCHITECT LVL <span id="level-num">1</span></span>
            <span id="xp-text">0 / 100 XP</span>
        </div>
        <div class="xp-bar-bg">
            <div class="xp-bar-fill" id="xp-bar"></div>
        </div>
    </div>
</div>

<div id="ui-layer">
    <div class="machine-frame">
        <div class="machine-title">üé∞ RESOURCE FORGE üé∞</div>
        <div class="reels" id="reels-container"></div>
        <div class="controls">
            <button class="btn" id="btn-turbo" onclick="toggleTurbo()">‚ö° TURBO</button>
            <button class="btn" id="btn-auto" onclick="toggleAuto()">üîÑ AUTO</button>
            <button class="btn" id="btn-spin" onclick="spin()">SPIN (15 E)</button>
        </div>
        <div class="payout-info">
            <div class="payout-item"><span>‚ö°‚ö°‚ö°</span> <span>+50 E</span></div>
            <div class="payout-item"><span>üîßüîßüîß</span> <span>+15 MAT</span></div>
            <div class="payout-item"><span>üíéüíéüíé</span> <span>+30 CR</span></div>
            <div class="payout-item"><span>üß¨üß¨üß¨</span> <span>+20 POP</span></div>
            <div class="payout-item"><span>üöÄüöÄüöÄ</span> <span>MEGA</span></div>
            <div class="payout-item"><span>üåüüåüüåü</span> <span>JACKPOT</span></div>
        </div>
    </div>
</div>

<div id="camera-controls">
    <button class="cam-btn" onclick="Sim.adjustCamera('in')">+</button>
    <button class="cam-btn" onclick="Sim.adjustCamera('out')">‚àí</button>
    <button class="cam-btn" onclick="Sim.adjustCamera('reset')">‚åÇ</button>
</div>

<div id="build-info">
    <div class="info-title">STRUCTURE DATA</div>
    <div class="info-row">
        <div class="info-label">Type</div>
        <div class="info-value" id="info-type">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Level</div>
        <div class="info-value" id="info-level">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Production</div>
        <div class="info-value" id="info-production">-</div>
    </div>
    <button class="btn" id="upgrade-btn" onclick="upgradeSelected()">UPGRADE (50 CR)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* ================= ENHANCED AUDIO ================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    play: function(freq, type, dur, vol=0.1, slide=false) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) o.frequency.exponentialRampToValueAtTime(freq/2, this.ctx.currentTime+dur);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        o.connect(g);
        g.connect(this.ctx.destination);
        o.start();
        o.stop(this.ctx.currentTime + dur);
    },
    chord: function(freqs, type='sine', dur=0.3, vol=0.05) {
        freqs.forEach(f => this.play(f, type, dur, vol));
    },
    born: () => SFX.chord([400, 500, 600], 'sine', 0.15, 0.04),
    droneHit: () => {
        SFX.play(200, 'square', 0.15, 0.15);
        setTimeout(()=>SFX.chord([150, 180, 220], 'sawtooth', 0.25, 0.12, true), 50);
    },
    build: () => SFX.chord([80, 120, 160], 'square', 0.4, 0.2),
    spin: () => SFX.play(300, 'sawtooth', 0.08, 0.08),
    win: () => SFX.chord([500, 625, 750, 1000], 'sine', 0.5, 0.15),
    jackpot: () => {
        for(let i=0; i<5; i++) {
            setTimeout(()=>SFX.chord([400+i*100, 500+i*100, 600+i*100], 'sine', 0.3, 0.1), i*100);
        }
    },
    upgrade: () => SFX.chord([600, 800, 1000], 'triangle', 0.3, 0.1),
    levelUp: () => {
        SFX.chord([400, 500, 600, 800], 'sine', 0.5, 0.15);
        setTimeout(()=>SFX.chord([800, 1000, 1200, 1600], 'sine', 0.5, 0.15), 200);
    }
};

/* ================= ENHANCED 3D SIMULATION ================= */
const Sim = {
    scene: null,
    camera: null,
    renderer: null,
    raycaster: null,
    mouse: null,
    
    entities: [],
    buildings: [],
    selectedBuilding: null,
    
    drone: null,
    droneSpeed: 1,
    
    // Camera
    cameraDistance: 100,
    cameraAngle: 0,
    
    init: function() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x0a0a15, 0.008);
        
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
        this.updateCameraPosition();

        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('viewport').appendChild(this.renderer.domElement);

        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        window.addEventListener('pointerdown', this.onMouseClick.bind(this));

        // Enhanced Lighting
        const amb = new THREE.AmbientLight(0x303050, 0.6);
        this.scene.add(amb);
        
        const sun = new THREE.DirectionalLight(0xffaa00, 1.5);
        sun.position.set(80, 150, 80);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 4096;
        sun.shadow.mapSize.height = 4096;
        sun.shadow.camera.left = -100;
        sun.shadow.camera.right = 100;
        sun.shadow.camera.top = 100;
        sun.shadow.camera.bottom = -100;
        this.scene.add(sun);
        
        // Accent light
        const accent = new THREE.PointLight(0xff00ff, 2, 100);
        accent.position.set(0, 50, 0);
        this.scene.add(accent);

        // Ground with glow
        const grid = new THREE.GridHelper(300, 60, 0x0ff, 0x0aa);
        this.scene.add(grid);
        
        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(300, 300),
            new THREE.MeshStandardMaterial({
                color: 0x0a0a20,
                roughness: 0.8,
                metalness: 0.2,
                emissive: 0x00ffff,
                emissiveIntensity: 0.1
            })
        );
        plane.rotation.x = -Math.PI/2;
        plane.receiveShadow = true;
        this.scene.add(plane);

        this.createDrone();
        this.animate();
        
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    },

    updateCameraPosition: function() {
        this.camera.position.set(
            Math.cos(this.cameraAngle) * this.cameraDistance,
            this.cameraDistance * 0.6,
            Math.sin(this.cameraAngle) * this.cameraDistance
        );
        this.camera.lookAt(0, 0, 0);
    },

    adjustCamera: function(dir) {
        if(dir === 'in') this.cameraDistance = Math.max(50, this.cameraDistance - 20);
        else if(dir === 'out') this.cameraDistance = Math.min(200, this.cameraDistance + 20);
        else if(dir === 'reset') { this.cameraDistance = 100; this.cameraAngle = 0; }
        this.updateCameraPosition();
    },

    createDrone: function() {
        const group = new THREE.Group();
        
        // Core sphere
        const core = new THREE.Mesh(
            new THREE.IcosahedronGeometry(2, 1),
            new THREE.MeshStandardMaterial({
                color: 0xffffff,
                emissive: 0xffaa00,
                emissiveIntensity: 1,
                roughness: 0.2,
                metalness: 0.8
            })
        );
        group.add(core);
        
        // Outer ring
        const ring = new THREE.Mesh(
            new THREE.TorusGeometry(4, 0.3, 8, 32),
            new THREE.MeshStandardMaterial({
                color: 0x00ffff,
                emissive: 0x00ffff,
                emissiveIntensity: 0.5,
                wireframe: true
            })
        );
        group.add(ring);
        
        // Hitbox
        const hitbox = new THREE.Mesh(
            new THREE.SphereGeometry(7),
            new THREE.MeshBasicMaterial({visible:false})
        );
        hitbox.userData = { isDrone: true };
        group.add(hitbox);

        // Lights
        const light = new THREE.PointLight(0xffaa00, 2, 40);
        group.add(light);

        group.position.set(0, 40, 0);
        this.scene.add(group);
        this.drone = group;
    },

    updateDrone: function(time) {
        if(!this.drone) return;
        
        const speed = this.droneSpeed * 0.0005;
        this.drone.position.x = Math.sin(time * speed) * 50;
        this.drone.position.z = Math.cos(time * speed * 0.7) * 50;
        this.drone.position.y = 40 + Math.sin(time * 0.003) * 8;
        
        this.drone.rotation.x += 0.01;
        this.drone.rotation.y += 0.02;
        
        // Pulse effect
        const scale = 1 + Math.sin(time * 0.005) * 0.1;
        this.drone.children[0].scale.setScalar(scale);
    },

    onMouseClick: function(event) {
        this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersects = this.raycaster.intersectObjects(this.scene.children, true);
        
        for (let hit of intersects) {
            if (hit.object.userData.isDrone) {
                this.deployDrone();
                this.spawnFloatText(event.clientX, event.clientY, "+5 MAT", '#ffaa00');
                break;
            } else if (hit.object.userData.isBuilding) {
                this.selectBuilding(hit.object.userData.building);
                break;
            }
        }
    },

    deployDrone: function() {
        if(Game.materials < 5) {
            alert("Need 5+ materials to build!");
            return;
        }
        
        SFX.droneHit();
        Game.materials -= 5;
        
        // Enhanced explosion
        this.spawnParticles(this.drone.position.x, this.drone.position.y, this.drone.position.z, 0xffaa00, 20);
        
        // Drop crate with better visuals
        const crateGeo = new THREE.BoxGeometry(3, 3, 3);
        const crateMat = new THREE.MeshStandardMaterial({
            color: 0x00ffcc,
            emissive: 0x00ffcc,
            emissiveIntensity: 0.5,
            wireframe: true
        });
        const crate = new THREE.Mesh(crateGeo, crateMat);
        crate.position.copy(this.drone.position);
        this.scene.add(crate);
        
        // Add glow
        const glowLight = new THREE.PointLight(0x00ffcc, 3, 20);
        crate.add(glowLight);
        
        new TWEEN.Tween(crate.position)
            .to({ y: 0 }, 1200)
            .easing(TWEEN.Easing.Bounce.Out)
            .onComplete(() => {
                this.scene.remove(crate);
                this.buildStructure(crate.position.x, crate.position.z);
            })
            .start();
            
        new TWEEN.Tween(crate.rotation)
            .to({x: Math.PI*3, y: Math.PI*3}, 1200)
            .start();
    },

    buildStructure: function(x, z) {
        SFX.build();
        
        const types = [
            {name: 'Tower', height: 15, geo: 'box', color: 0x0099ff, production: 'energy', value: 2},
            {name: 'Dome', height: 8, geo: 'dodeca', color: 0xffaa00, production: 'materials', value: 1},
            {name: 'Pyramid', height: 12, geo: 'cone', color: 0xff00ff, production: 'credits', value: 3},
            {name: 'Cube', height: 6, geo: 'box', color: 0x00ff00, production: 'population', value: 5}
        ];
        
        const type = types[Math.floor(Math.random() * types.length)];
        
        let geo;
        if(type.geo === 'box') geo = new THREE.BoxGeometry(4, type.height, 4);
        else if(type.geo === 'dodeca') geo = new THREE.DodecahedronGeometry(5);
        else if(type.geo === 'cone') geo = new THREE.ConeGeometry(4, type.height, 4);
        
        const mat = new THREE.MeshStandardMaterial({
            color: type.color,
            emissive: type.color,
            emissiveIntensity: 0.3,
            roughness: 0.4,
            metalness: 0.6
        });
        
        const building = new THREE.Mesh(geo, mat);
        building.position.set(x, type.height/2, z);
        building.castShadow = true;
        building.receiveShadow = true;
        
        // Building data
        building.userData = {
            isBuilding: true,
            building: {
                type: type.name,
                level: 1,
                production: type.production,
                value: type.value,
                mesh: building,
                baseColor: type.color
            }
        };
        
        // Add building light
        const light = new THREE.PointLight(type.color, 1, 20);
        light.position.y = type.height/2;
        building.add(light);
        
        this.scene.add(building);
        this.buildings.push(building.userData.building);
        
        Game.buildingsBuilt++;
        Game.addXP(10);
        
        this.spawnParticles(x, 0, z, 0xaaaaaa, 15);
    },

    selectBuilding: function(building) {
        // Deselect previous
        if(this.selectedBuilding) {
            this.selectedBuilding.mesh.material.emissiveIntensity = 0.3;
        }
        
        this.selectedBuilding = building;
        building.mesh.material.emissiveIntensity = 0.8;
        
        // Show info panel
        document.getElementById('info-type').innerText = building.type;
        document.getElementById('info-level').innerText = building.level;
        document.getElementById('info-production').innerText = 
            `+${building.value} ${building.production}/tick`;
        document.getElementById('build-info').classList.add('visible');
        
        SFX.play(400, 'sine', 0.1, 0.05);
    },

    upgradeBuilding: function(building) {
        if(Game.credits < 50) {
            alert("Need 50 credits!");
            return;
        }
        
        Game.credits -= 50;
        building.level++;
        building.value = Math.floor(building.value * 1.5);
        
        // Visual upgrade
        building.mesh.scale.multiplyScalar(1.1);
        const newColor = building.baseColor + 0x111111;
        building.mesh.material.color.setHex(newColor);
        building.mesh.material.emissiveIntensity = 1;
        
        SFX.upgrade();
        this.spawnParticles(building.mesh.position.x, building.mesh.position.y, building.mesh.position.z, 0xff00ff, 10);
        
        // Update info
        this.selectBuilding(building);
        Game.addXP(25);
        Game.updateHUD();
    },

    spawnAgent: function() {
        if(this.entities.length > 100) return;
        
        const colors = [0x00ffcc, 0xff00ff, 0xffaa00, 0x00ff00];
        const mesh = new THREE.Mesh(
            new THREE.TetrahedronGeometry(0.6),
            new THREE.MeshStandardMaterial({
                color: colors[Math.floor(Math.random()*colors.length)],
                emissive: 0xffffff,
                emissiveIntensity: 0.5
            })
        );
        mesh.position.set(0, 0.6, 0);
        mesh.castShadow = true;
        this.scene.add(mesh);
        
        this.entities.push({
            mesh: mesh,
            target: new THREE.Vector3(0, 0.6, 0),
            speed: 0.05 + Math.random() * 0.1
        });
        
        SFX.born();
    },

    spawnParticles: function(x, y, z, color, count=10) {
        for(let i=0; i<count; i++) {
            const m = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.5, 0.5),
                new THREE.MeshBasicMaterial({color: color})
            );
            m.position.set(x, y, z);
            this.scene.add(m);
            
            new TWEEN.Tween(m.position)
                .to({
                    x: x + (Math.random()-0.5)*8,
                    y: y + Math.random()*8,
                    z: z + (Math.random()-0.5)*8
                }, 600 + Math.random()*400)
                .onComplete(() => this.scene.remove(m))
                .start();
                
            new TWEEN.Tween(m.rotation)
                .to({x: Math.PI*2, y: Math.PI*2}, 800)
                .start();
        }
    },

    spawnFloatText: function(x, y, text, color='#fff') {
        const div = document.createElement('div');
        div.className = 'float-text';
        div.innerText = text;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.color = color;
        div.style.textShadow = `0 0 10px ${color}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    },

    animate: function(time) {
        requestAnimationFrame((t) => Sim.animate(t));
        TWEEN.update(time);
        
        this.updateDrone(time);
        
        // Slowly rotate camera
        this.cameraAngle += 0.0002;
        this.updateCameraPosition();
        
        // Agent AI
        for(let a of this.entities) {
            if(a.mesh.position.distanceTo(a.target) < 1) {
                if(this.buildings.length > 0) {
                    const b = this.buildings[Math.floor(Math.random() * this.buildings.length)];
                    a.target.set(
                        b.mesh.position.x + (Math.random()-0.5)*8,
                        0.6,
                        b.mesh.position.z + (Math.random()-0.5)*8
                    );
                } else {
                    a.target.set((Math.random()-0.5)*60, 0.6, (Math.random()-0.5)*60);
                }
            }
            
            const dir = new THREE.Vector3().subVectors(a.target, a.mesh.position).normalize();
            a.mesh.position.add(dir.multiplyScalar(a.speed));
            a.mesh.lookAt(a.target);
            a.mesh.rotation.x += 0.05;
        }
        
        // Building production
        if(time % 100 < 1) { // Every ~100 frames
            Game.produceResources();
        }

        this.renderer.render(this.scene, this.camera);
    }
};

/* ================= ENHANCED GAME LOGIC ================= */
const Game = {
    energy: 150,
    materials: 0,
    credits: 0,
    spinning: false,
    auto: false,
    turbo: false,
    buildingsBuilt: 0,
    
    level: 1,
    xp: 0,
    xpNeeded: 100,
    
    symbols: ['‚ö°', 'üîß', 'üíé', 'üß¨', 'üöÄ', 'üåü'],
    weights: [30, 25, 20, 15, 7, 3], // Rarity weights
    
    comboMultiplier: 1,
    spinsSinceWin: 0,

    init: function() {
        this.createReels();
        this.updateHUD();
        
        // Hide building panel on outside click
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#build-info') && !e.target.closest('#viewport')) {
                document.getElementById('build-info').classList.remove('visible');
                if(Sim.selectedBuilding) {
                    Sim.selectedBuilding.mesh.material.emissiveIntensity = 0.3;
                    Sim.selectedBuilding = null;
                }
            }
        });
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<3; i++) {
            const s = document.createElement('div');
            s.className = 'reel-strip';
            s.id = `reel-${i}`;
            s.innerHTML = `<div class="symbol">${this.randSym()}</div>`;
            c.appendChild(s);
        }
    },

    randSym: function() {
        const total = this.weights.reduce((a,b) => a+b, 0);
        let rand = Math.random() * total;
        for(let i=0; i<this.symbols.length; i++) {
            rand -= this.weights[i];
            if(rand <= 0) return this.symbols[i];
        }
        return this.symbols[0];
    },

    toggleAuto: function() {
        this.auto = !this.auto;
        document.getElementById('btn-auto').classList.toggle('active');
        if(this.auto && !this.spinning) this.spin();
    },
    
    toggleTurbo: function() {
        this.turbo = !this.turbo;
        Sim.droneSpeed = this.turbo ? 3 : 1;
        document.getElementById('btn-turbo').classList.toggle('active');
    },

    spin: async function() {
        if(this.spinning) return;
        if(this.energy < 15) {
            this.auto = false;
            document.getElementById('btn-auto').classList.remove('active');
            alert("Need 15 Energy to spin!");
            return;
        }
        
        this.spinning = true;
        this.energy -= 15;
        this.spinsSinceWin++;
        this.updateHUD();
        SFX.spin();

        // Spin animation
        const results = [];
        const spinDuration = this.turbo ? 100 : 200;
        
        for(let i=0; i<3; i++) {
            const el = document.getElementById(`reel-${i}`);
            el.style.transform = 'translateY(30px)';
            el.style.opacity = '0.5';
            
            await new Promise(r => setTimeout(r, spinDuration));
            
            const sym = this.randSym();
            results.push(sym);
            el.children[0].innerText = sym;
            el.style.transform = 'translateY(0)';
            el.style.opacity = '1';
        }
        
        await this.evaluateResults(results);
        
        this.spinning = false;
        this.updateHUD();
        
        if(this.auto) setTimeout(() => this.spin(), this.turbo ? 300 : 700);
    },

    evaluateResults: async function(results) {
        const [a, b, c] = results;
        
        // Clear previous win states
        document.querySelectorAll('.symbol').forEach(s => s.classList.remove('win'));
        
        let comboText = "NO COMBO";
        let hasWin = false;
        
        // Check for 3 of a kind
        if(a === b && b === c) {
            hasWin = true;
            document.querySelectorAll('.symbol').forEach(s => s.classList.add('win'));
            
            switch(a) {
                case '‚ö°':
                    this.energy += 50 * this.comboMultiplier;
                    comboText = "‚ö° ENERGY SURGE ‚ö°";
                    SFX.win();
                    break;
                case 'üîß':
                    this.materials += 15 * this.comboMultiplier;
                    comboText = "üîß MATERIAL RUSH üîß";
                    SFX.win();
                    break;
                case 'üíé':
                    this.credits += 30 * this.comboMultiplier;
                    comboText = "üíé CREDIT BONUS üíé";
                    SFX.win();
                    break;
                case 'üß¨':
                    const popBonus = 20 * this.comboMultiplier;
                    for(let i=0; i<popBonus; i++) Sim.spawnAgent();
                    comboText = "üß¨ POPULATION BOOM üß¨";
                    SFX.win();
                    break;
                case 'üöÄ':
                    this.energy += 100;
                    this.materials += 30;
                    this.credits += 50;
                    comboText = "üöÄ MEGA BONUS üöÄ";
                    SFX.jackpot();
                    break;
                case 'üåü':
                    this.energy += 200;
                    this.materials += 60;
                    this.credits += 100;
                    for(let i=0; i<50; i++) Sim.spawnAgent();
                    comboText = "üåü ‚ú® JACKPOT ‚ú® üåü";
                    this.showMilestone("JACKPOT!", "You hit the ultimate combo!");
                    SFX.jackpot();
                    break;
            }
            
            this.spinsSinceWin = 0;
            this.comboMultiplier = Math.min(3, this.comboMultiplier + 0.1);
            this.addXP(50);
        }
        // Check for 2 of a kind
        else if(a === b || b === c || a === c) {
            hasWin = true;
            const sym = (a === b) ? a : (b === c) ? b : a;
            comboText = `PAIR: ${sym}${sym}`;
            
            // Smaller rewards
            if(sym === '‚ö°') this.energy += 20;
            else if(sym === 'üîß') this.materials += 5;
            else if(sym === 'üíé') this.credits += 10;
            else if(sym === 'üß¨') for(let i=0; i<5; i++) Sim.spawnAgent();
            
            this.addXP(15);
            SFX.play(400, 'sine', 0.2, 0.08);
        }
        else {
            // No combo - reset multiplier
            this.comboMultiplier = 1;
            
            // Pity system
            if(this.spinsSinceWin > 10) {
                this.energy += 5;
                comboText = "ENERGY +5 (PITY)";
            }
        }
        
        document.getElementById('combo-display').innerText = comboText;
        this.updateHUD();
    },

    produceResources: function() {
        for(let b of Sim.buildings) {
            if(b.production === 'energy') this.energy += b.value;
            else if(b.production === 'materials') this.materials += b.value;
            else if(b.production === 'credits') this.credits += b.value;
            else if(b.production === 'population') {
                for(let i=0; i<b.value; i++) Sim.spawnAgent();
            }
        }
        this.updateHUD();
    },

    addXP: function(amount) {
        this.xp += amount;
        if(this.xp >= this.xpNeeded) {
            this.levelUp();
        }
        this.updateXPBar();
    },

    levelUp: function() {
        this.level++;
        this.xp = 0;
        this.xpNeeded = Math.floor(this.xpNeeded * 1.5);
        
        SFX.levelUp();
        this.showMilestone(`LEVEL ${this.level}`, "Architect rank increased!");
        
        // Rewards
        this.energy += 50;
        this.materials += 20;
        this.credits += 30;
        
        this.updateXPBar();
    },

    updateXPBar: function() {
        const percent = (this.xp / this.xpNeeded) * 100;
        document.getElementById('xp-bar').style.width = percent + '%';
        document.getElementById('level-num').innerText = this.level;
        document.getElementById('xp-text').innerText = `${this.xp} / ${this.xpNeeded} XP`;
    },

    showMilestone: function(title, desc) {
        const div = document.createElement('div');
        div.className = 'milestone';
        div.innerHTML = `
            <h2>${title}</h2>
            <p>${desc}</p>
            <button onclick="this.parentElement.remove()">CONTINUE</button>
        `;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 5000);
    },

    updateHUD: function() {
        document.getElementById('ui-energy').innerText = this.energy;
        document.getElementById('ui-materials').innerText = this.materials;
        document.getElementById('ui-credits').innerText = this.credits;
        document.getElementById('ui-pop').innerText = Sim.entities.length;
        document.getElementById('ui-builds').innerText = this.buildingsBuilt;
        
        // Disable spin if not enough energy
        document.getElementById('btn-spin').disabled = this.energy < 15;
        
        // Check milestones
        if(this.buildingsBuilt === 10 && !this.milestones?.buildings10) {
            this.milestones = this.milestones || {};
            this.milestones.buildings10 = true;
            this.showMilestone("CITY FOUNDER", "Built 10 structures!");
            this.addXP(100);
        }
        
        if(Sim.entities.length >= 50 && !this.milestones?.pop50) {
            this.milestones = this.milestones || {};
            this.milestones.pop50 = true;
            this.showMilestone("POPULATION BOOM", "Reached 50 citizens!");
            this.addXP(150);
        }
    }
};

window.initSim = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init();
    Sim.init();
    Game.init();
};

window.toggleAuto = () => Game.toggleAuto();
window.toggleTurbo = () => Game.toggleTurbo();
window.spin = () => Game.spin();
window.upgradeSelected = () => {
    if(Sim.selectedBuilding) {
        Sim.upgradeBuilding(Sim.selectedBuilding);
    }
};

</script>
</body>
</html>
