<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Red Dead – A-Frame Wild West</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- A-Frame (includes Three.js) -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

<!-- A-Frame extras (physics, animation, etc.) -->
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@master/dist/aframe-extras.min.js"></script>

<style>
  body { margin:0; overflow:hidden; font-family:Courier New,monospace; }
  #ui, #msg { position:absolute; top:20px; left:20px; color:#fff; background:rgba(0,0,0,.6);
               padding:12px; border-radius:8px; font-size:18px; z-index:100; pointer-events:none; }
  #msg { top:auto; bottom:20px; left:20px; color:#ffcc00; max-width:560px; }
  #crosshair { position:absolute; top:50%; left:50%; width:20px; height:20px;
               margin:-10px 0 0 -10px; border:2px solid #ffcc00; border-radius:50%; z-index:99; }
  button { margin-top:8px; padding:6px 12px; background:#8B4513; color:#fff;
           border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
  button:hover { background:#A0522D; }
</style>
</head>
<body>

<div id="ui">
  Health: <span id="health">100</span>% |
  Ammo: <span id="ammo">6</span>/6 |
  Score: <span id="score">0</span>
</div>
<div id="msg">
  <strong>Voice:</strong> "shoot", "reload", "ride", "stop"<br>
  <strong>Move:</strong> WASD | <strong>Look:</strong> Mouse | <strong>Shoot:</strong> Click / Voice
  <button onclick="startGame()">Start</button>
</div>
<div id="crosshair"></div>

<a-scene background="color:#87CEEB" cursor="rayOrigin:mouse" embedded
         physics="debug:false" style="width:100vw;height:100vh">

  <!-- Camera / Player -->
  <a-entity id="player" camera look-controls="pointerLockEnabled:true"
            wasd-controls="acceleration:30" position="0 1.6 5">
    <a-entity cursor position="0 0 -0.5"
              geometry="primitive:ring;radiusInner:0.02;radiusOuter:0.03"
              material="color:#ffcc00;shader:flat"></a-entity>
  </a-entity>

  <!-- Ground (100×100) -->
  <a-plane class="ground" position="0 0 0" rotation="-90 0 0"
           width="100" height="100" color="#D2B48C"
           src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/textures/terrain/grasslight-big.jpg"
           repeat="10 10" roughness="0.9"></a-plane>

  <!-- Lights -->
  <a-light type="directional" intensity="0.8" position="10 20 10" castShadow></a-light>
  <a-light type="ambient" intensity="0.4"></a-light>

  <!-- Sky -->
  <a-sky color="#87CEEB"></a-sky>

  <!-- ----- Targets (cacti & outlaw) ----- -->
  <a-entity class="shootable" position="-5 1 -10" mixin="cactus"></a-entity>
  <a-entity class="shootable" position="8 1 -15" mixin="cactus2"></a-entity>
  <a-entity id="outlaw" class="shootable" position="0 1.6 -20" mixin="outlaw"></a-entity>

  <!-- Horse -->
  <a-entity id="horse" position="-10 0.8 -8" mixin="horse-model"></a-entity>

  <!-- Assets -->
  <a-assets timeout="30000">
    <audio id="gunshot" src="https://cdn.jsdelivr.net/gh/mozvr/aframe-audio-assets@master/gunshot.mp3"></audio>
    <audio id="reload"  src="https://cdn.jsdelivr.net/gh/mozvr/aframe-audio-assets@master/reload.mp3"></audio>
    <audio id="horse"   src="https://cdn.jsdelivr.net/gh/mozvr/aframe-audio-assets@master/horse.mp3"></audio>
    <audio id="hit"     src="https://cdn.jsdelivr.net/gh/mozvr/aframe-audio-assets@master/hit.mp3"></audio>
    <audio id="bgmusic" src="https://cdn.jsdelivr.net/gh/mozvr/aframe-audio-assets@master/western.mp3" loop></audio>
  </a-assets>

  <!-- Mixins -->
  <a-mixin id="cactus"
           gltf-model="#cactus"
           animation="property: rotation; to: 0 360 0; loop: true; dur: 12000; easing: linear"></a-mixin>
  <a-mixin id="cactus2"
           gltf-model="#cactus"
           animation="property: rotation; to: 0 -360 0; loop: true; dur: 15000; easing: linear"></a-mixin>
  <a-mixin id="outlaw"
           gltf-model="#outlaw"
           animation="property: position; to: 0 1.6 -20; dur: 2000; dir: alternate; loop: true"></a-mixin>
  <a-mixin id="horse-model"
           gltf-model="#horse"
           animation="property: rotation; to: 0 180 0; dur: 800; easing: easeInOutSine"></a-mixin>

</a-scene>

<script>
/* ==============================================================
   GAME STATE
   ============================================================== */
let health = 100, ammo = 6, score = 0, riding = false, gameOn = false;
let recognition, horseInterval;

/* ==============================================================
   DOM HELPERS
   ============================================================== */
const $ = s => document.querySelector(s);
const healthEl = $('#health'), ammoEl = $('#ammo'), scoreEl = $('#score');

/* ==============================================================
   START
   ============================================================== */
function startGame() {
  if (gameOn) return;
  gameOn = true;
  $('#msg').innerHTML = `Voice commands active – say <b>shoot / reload / ride / stop</b>`;
  document.getElementById('bgmusic').play();

  // pointer lock
  document.body.addEventListener('click', () => document.body.requestPointerLock());

  // speech
  if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    recognition.onresult = e => {
      const cmd = e.results[e.results.length-1][0].transcript.trim().toLowerCase();
      handleVoice(cmd);
    };
    recognition.start();
  } else alert('Speech recognition not supported – use Chrome/Edge');

  // click = shoot
  document.addEventListener('click', shoot);
}

/* ==============================================================
   VOICE COMMAND
   ============================================================== */
function handleVoice(c) {
  if (!gameOn) return;
  if (c.includes('shoot')) shoot();
  else if (c.includes('reload')) reload();
  else if (c.includes('ride') && !riding) mountHorse();
  else if (c.includes('stop') && riding) dismountHorse();
}

/* ==============================================================
   SHOOT
   ============================================================== */
function shoot() {
  if (ammo <= 0) { play('reload'); return; }
  ammo--; updateUI(); play('gunshot');

  const cam = $('#player').components.camera.camera;
  const pos = new THREE.Vector3();
  const dir = new THREE.Vector3();
  cam.getWorldPosition(pos);
  cam.getWorldDirection(dir).multiplyScalar(-1); // forward

  // ----- bullet + particle trail -----
  const bullet = document.createElement('a-entity');
  bullet.setAttribute('position', pos);
  bullet.setAttribute('geometry', 'primitive:sphere;radius:0.06');
  bullet.setAttribute('material', 'color:#ffcc00;emissive:#ffcc00;emissiveIntensity:0.8');
  bullet.setAttribute('class', 'bullet');
  document.querySelector('a-scene').appendChild(bullet);

  // particle system (simple smoke trail)
  const trail = document.createElement('a-entity');
  trail.setAttribute('particle-system',
    'preset:default; color:#ffcc00,#ff9900,#cccccc; opacity:0.8,0.4; velocityValue:0 0 0; ' +
    'accelerationValue:0 -2 0; size:0.2,0.05; lifetime:0.6; particleCount:60');
  bullet.appendChild(trail);

  // move bullet
  const speed = 80;
  const start = performance.now();
  const maxDist = 120;
  const ray = new THREE.Raycaster(pos, dir.clone().normalize());

  const move = now => {
    const dt = (now - start) / 1000;
    const dist = speed * dt;
    if (dist > maxDist) { bullet.remove(); return; }

    const newPos = pos.clone().add(dir.clone().multiplyScalar(dist));
    bullet.setAttribute('position', newPos);

    // collision with shootable
    const hits = ray.intersectObjects(
      document.querySelectorAll('.shootable').map(e=>e.object3D), true);
    if (hits.length && hits[0].distance <= dist) {
      const target = hits[0].object.el.closest('.shootable');
      hitTarget(target);
      bullet.remove();
      return;
    }
    requestAnimationFrame(move);
  };
  requestAnimationFrame(move);
}

/* ----- hit ----- */
function hitTarget(el) {
  play('hit');
  score += 100; updateUI();

  // break apart + fall
  const parts = [
    {offset: new THREE.Vector3(0,0,0),   color:'#228B22'},
    {offset: new THREE.Vector3(0.3,0.4,0),color:'#228B22'},
    {offset: new THREE.Vector3(-0.3,0.4,0),color:'#228B22'},
    {offset: new THREE.Vector3(0,0.8,0), color:'#8B4513'}
  ];
  parts.forEach(p => {
    const piece = document.createElement('a-box');
    piece.setAttribute('depth',0.4); piece.setAttribute('height',0.6); piece.setAttribute('width',0.4);
    piece.setAttribute('material',`color:${p.color}`);
    const pos = el.getAttribute('position');
    piece.setAttribute('position',
      `${pos.x+p.offset.x} ${pos.y+p.offset.y} ${pos.z+p.offset.z}`);
    piece.setAttribute('dynamic-body','mass:2');
    piece.setAttribute('animation',
      `property:position; to:${pos.x+p.offset.x} ${pos.y-5} ${pos.z+p.offset.z}; dur:2000; easing:easeInQuad`);
    document.querySelector('a-scene').appendChild(piece);
    setTimeout(()=>piece.remove(), 2500);
  });
  el.remove();
}

/* ==============================================================
   RELOAD
   ============================================================== */
function reload() {
  play('reload');
  setTimeout(()=>{ ammo=6; updateUI(); },1200);
}

/* ==============================================================
   HORSE LOGIC
   ============================================================== */
function mountHorse() {
  if (riding) return;
  riding = true; play('horse');
  const horse = $('#horse');
  const player = $('#player');
  const hPos = horse.getAttribute('position');
  player.setAttribute('position', `${hPos.x} 2.5 ${hPos.z}`);

  // horse movement loop – follows camera direction & stays inside ground
  const groundSize = 100, margin = 8;
  horseInterval = setInterval(()=>{
    if (!riding) return;
    const cam = $('#player').components.camera.camera;
    const dir = new THREE.Vector3();
    cam.getWorldDirection(dir).multiplyScalar(-0.25); // speed

    const cur = horse.object3D.position;
    const next = cur.clone().add(dir);

    // bounce off edges
    if (Math.abs(next.x) > groundSize/2 - margin) dir.x *= -1;
    if (Math.abs(next.z) > groundSize/2 - margin) dir.z *= -1;

    horse.object3D.position.add(dir);
    horse.object3D.lookAt(horse.object3D.position.clone().add(dir));

    // keep player on horse
    player.setAttribute('position',
      `${horse.object3D.position.x} 2.5 ${horse.object3D.position.z}`);
  },50);
}

function dismountHorse() {
  if (!riding) return;
  riding = false;
  clearInterval(horseInterval);
  const horsePos = $('#horse').object3D.position;
  $('#player').setAttribute('position',
    `${horsePos.x} 1.6 ${horsePos.z + 2}`);
}

/* ==============================================================
   UTILS
   ============================================================== */
function play(id){ const s=document.getElementById(id); if(s) s.currentTime=0, s.play(); }
function updateUI(){ healthEl.textContent=health; ammoEl.textContent=ammo; scoreEl.textContent=score; }

/* ----- outlaw timer damage ----- */
setTimeout(()=>{
  if (document.getElementById('outlaw')) {
    health -= 30; updateUI();
    if (health<=0){ alert('Game Over – the outlaw got you!'); location.reload(); }
  }
},15000);

updateUI();
</script>

<!-- Simple placeholder models (you can replace with real GLTFs) -->
<a-assets>
  <a-asset-item id="cactus"   src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf"></a-asset-item>
  <a-asset-item id="outlaw"  src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Fox/glTF/Fox.gltf"></a-asset-item>
  <a-asset-item id="horse"   src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Horse/glTF/Horse.gltf"></a-asset-item>
</a-assets>

</body>
</html>
