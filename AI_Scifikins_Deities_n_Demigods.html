<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScifiKin: Battle Realms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Orbitron',sans-serif;background:#0c0a1e;color:#e0e0e0;margin:0;overflow:hidden}
        .game-container{border:4px solid #4f4f4f;box-shadow:0 0 20px #ff00ff,0 0 30px #00ffff,inset 0 0 15px #000}
        .text-glow{text-shadow:0 0 5px #fff,0 0 10px #fff,0 0 15px #ff00ff,0 0 20px #ff00ff}
        .btn-glow{box-shadow:0 0 5px #00ffff,0 0 10px #00ffff;transition:all .3s}
        .btn-glow:hover{box-shadow:0 0 10px #ff00ff,0 0 20px #ff00ff;transform:translateY(-2px)}
        .modal{background:rgba(12,10,30,.95);border:2px solid #ff00ff}
        canvas{background-image:url('https://www.transparenttextures.com/patterns/stardust.png');background-color:#1a1a2e;cursor:crosshair}
        .character-card{border:2px solid #4f4f4f;transition:all .3s}
        .character-card.selected{border-color:#ff00ff;box-shadow:0 0 15px #ff00ff}
        .powerup-toast{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:8px;color:#000;font-weight:bold;z-index:100;opacity:0;transition:opacity .5s,bottom .5s}
        #game-ui{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:flex-start;z-index:10;pointer-events:none}
        .ui-panel{background:rgba(0,0,0,.7);border:2px solid #4f4f4f;border-radius:8px;padding:12px;backdrop-filter:blur(10px);pointer-events:auto}
        .health-section h3,.ability-section h3{font-size:1.1rem;margin-bottom:8px;text-shadow:0 0 5px currentColor}
        .health-bar,.ability-bar{width:120px;height:12px;background:rgba(75,75,75,.8);border:1px solid #666;border-radius:6px;overflow:hidden;margin-top:4px}
        .health-fill,.ability-fill{height:100%;transition:width .3s}
        .wave-score{text-align:center;background:rgba(0,0,0,.7);border:2px solid #ff00ff;border-radius:8px;padding:12px 20px;backdrop-filter:blur(10px);pointer-events:auto}
        .wave-score p{margin:4px 0;font-size:1.1rem}
    </style>
</head>
<body>
<div id="game-container" class="w-screen h-screen relative">
    <!-- START SCREEN -->
    <div id="start-screen" class="text-center w-full h-full flex flex-col items-center justify-center p-4">
        <h1 class="text-4xl md:text-6xl font-bold text-glow mb-4">SCIFIKIN: BATTLE REALMS</h1>
        <h2 class="text-xl md:text-2xl text-cyan-300 mb-8">ARCADE QUEST</h2>
        <p class="mb-8 max-w-2xl mx-auto">The multiverse fractures! Choose your ScifiKin champion and battle through realms of gods, tech, and dreams to claim Level 10 glory!</p>
        <button id="start-game-btn" class="bg-cyan-500 text-black font-bold py-3 px-8 rounded-lg text-xl btn-glow">Start Quest</button>
    </div>

    <!-- CHARACTER SELECTION -->
    <div id="character-selection-screen" class="hidden text-center w-full h-full flex flex-col items-center justify-center p-4">
        <h2 class="text-4xl font-bold text-glow mb-2">CHOOSE YOUR CHAMPION</h2>
        <p class="mb-4 text-gray-400">Each ScifiKin faction has a unique passive ability.</p>
        <div id="character-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 w-full max-w-4xl"></div>
        <div id="character-details" class="p-4 rounded-lg bg-black bg-opacity-50 min-h-[150px] w-full max-w-4xl">
            <h3 id="char-name" class="text-2xl font-bold text-cyan-300"></h3>
            <p id="char-faction" class="text-lg text-fuchsia-400"></p>
            <p id="char-passive" class="mt-2 text-yellow-300"></p>
            <p id="char-ability" class="mt-2"></p>
        </div>
        <button id="play-game-btn" class="bg-fuchsia-500 text-black font-bold py-3 px-8 rounded-lg text-xl btn-glow mt-6 hidden">Embark!</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden w-full h-full relative">
        <canvas id="game-canvas" class="w-full h-full"></canvas>
        <div id="game-ui">
            <div class="ui-panel health-section">
                <h3 id="player-name-display" class="text-cyan-400"></h3>
                <div class="health-bar"><div id="player-health-bar" class="health-fill bg-green-500" style="width:100%"></div></div>
            </div>
            <div class="wave-score">
                <p>Score: <span id="score" class="font-bold text-yellow-400">0</span></p>
                <p>Wave: <span id="wave" class="font-bold text-red-400">1</span></p>
            </div>
            <div class="ui-panel ability-section">
                <h3 class="text-fuchsia-400">Q - Ability</h3>
                <div class="ability-bar"><div id="ability-cooldown-bar" class="ability-fill bg-cyan-500" style="width:100%"></div></div>
            </div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="modal p-8 rounded-lg text-center max-w-md w-full">
            <h2 class="text-5xl font-bold text-glow text-red-500 mb-4">QUEST FAILED</h2>
            <div id="final-stats">
                <p class="text-2xl mb-2">Final Score: <span id="final-score" class="text-yellow-300"></span></p>
                <p class="text-2xl mb-6">Wave Reached: <span id="final-wave" class="text-red-400"></span></p>
                <button id="restart-game-btn" class="bg-cyan-500 text-black font-bold py-3 px-8 rounded-lg text-xl btn-glow">Try Again</button>
            </div>
        </div>
    </div>

    <div id="powerup-toast-container"></div>
</div>

<!-- ====================== AUDIO ====================== -->
<script>
    let audioCtx;
    function initAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    function playSound(type,vol=0.3,pitch=1){
        initAudio();
        const osc=audioCtx.createOscillator(),gain=audioCtx.createGain(),now=audioCtx.currentTime;
        osc.type = type==='explosion'?'sawtooth':type==='shoot'?'square':type==='powerup'?'sine':'triangle';
        osc.frequency.setValueAtTime(
            type==='shoot'?800*pitch:
            type==='explosion'?200*pitch:
            type==='hit'?300*pitch:
            type==='powerup'?600*pitch:
            type==='damage'?150*pitch:440,now);
        gain.gain.setValueAtTime(0,now);
        gain.gain.linearRampToValueAtTime(vol,now+0.01);
        const decay=type==='explosion'?0.3:type==='shoot'?0.1:type==='powerup'?0.5:0.2;
        gain.gain.exponentialRampToValueAtTime(0.01,now+decay);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);osc.stop(now+decay);
    }
    const charSounds={Godsworn:{shoot:1.2,exp:1.1},Decker:{shoot:2,exp:1.8},Inquisitor:{shoot:0.8,exp:0.7},
                     Adventurer:{shoot:1,exp:0.9},Pooka:{shoot:1.5,exp:1.4}};
</script>

<!-- ====================== GAME ====================== -->
<script>
/* ---------- DOM ---------- */
const startScreen=document.getElementById('start-screen'),charSel=document.getElementById('character-selection-screen'),
      gameScreen=document.getElementById('game-screen'),gameOver=document.getElementById('game-over-modal'),
      startBtn=document.getElementById('start-game-btn'),playBtn=document.getElementById('play-game-btn'),
      restartBtn=document.getElementById('restart-game-btn'),charGrid=document.getElementById('character-grid'),
      charName=document.getElementById('char-name'),charFaction=document.getElementById('char-faction'),
      charPassive=document.getElementById('char-passive'),charAbility=document.getElementById('char-ability'),
      canvas=document.getElementById('game-canvas'),scoreEl=document.getElementById('score'),waveEl=document.getElementById('wave'),
      playerName=document.getElementById('player-name-display'),healthBar=document.getElementById('player-health-bar'),
      abilityBar=document.getElementById('ability-cooldown-bar'),finalScore=document.getElementById('final-score'),
      finalWave=document.getElementById('final-wave'),toastContainer=document.getElementById('powerup-toast-container');

/* ---------- CONFIG ---------- */
let selectedChar=null,gameLoopId,player,projectiles=[],enemies=[],explosions=[],powerups=[],score=0,wave=1,gameActive=false,
    abilityReady=true,abilityTimer=0,activePowerups={},scene,camera,renderer,raycaster,plane,HEIGHT,WIDTH=100,
    mouse=new THREE.Vector2(),keys={a:{pressed:false},d:{pressed:false}};

const CHARACTERS=[
    {name:'Godsworn',faction:'Deities',color:0xffd700,passive:'Health regen',ability:'Stun all',cooldown:15000,dur:2000,health:100,speed:0.5,projCol:0xffd700,projSpd:1.2},
    {name:'Decker',faction:'Shadowrun',color:0x00ff00,passive:'Fast shots',ability:'Double fire-rate',cooldown:20000,dur:5000,health:120,speed:0.4,projCol:0x00ff00,projSpd:1.5},
    {name:'Inquisitor',faction:'Warhammer 40k',color:0xff4500,passive:'Big boom',ability:'Triple shot',cooldown:18000,dur:1000,health:150,speed:0.3,projCol:0xff4500,projSpd:1.0},
    {name:'Adventurer',faction:'Runescape',color:0x4682b4,passive:'Recharge shield',ability:'Invulnerability',cooldown:25000,dur:4000,health:130,speed:0.4,projCol:0x4682b4,projSpd:1.1},
    {name:'Pooka',faction:'Changeling',color:0xda70d6,passive:'Dodge',ability:'Confuse enemies',cooldown:17000,dur:3000,health:110,speed:0.6,projCol:0xda70d6,projSpd:1.3}
];
const POWERUPS=[
    {type:'divineBoon',col:0xffd700,dur:5000,name:'Divine Boon'},
    {type:'matrixHack',col:0x00ff00,dur:7000,name:'Matrix Hack'},
    {type:'holyPurge',col:0xff4500,dur:0,name:'Holy Purge'},
    {type:'questBoost',col:0x4682b4,dur:10000,name:'Quest Boost'},
    {type:'glamourSurge',col:0xda70d6,dur:8000,name:'Glamour Surge'},
    {type:'doubleShot',col:0x00fa9a,dur:10000,name:'Double Shot'},
    {type:'tripleShot',col:0x32cd32,dur:8000,name:'Triple Shot'},
    {type:'scoreMultiplier',col:0xffff00,dur:10000,name:'2x Score'},
    {type:'enemySlow',col:0xadd8e6,dur:7000,name:'Realm Slow'},
    {type:'healthPack',col:0xffc0cb,dur:0,name:'Healing Rune'}
];

/* ---------- 3D MODELS ---------- */
function createPlayerModel(c){
    const g=new THREE.Group(),mat=new THREE.MeshStandardMaterial({color:c.color,metalness:.6,roughness:.4,emissive:c.color,emissiveIntensity:.1});
    const parts=[];
    if(c.name==='Godsworn'){
        const torso=new THREE.Mesh(new THREE.CylinderGeometry(.5,1,2.5,12),mat);torso.position.y=1.25;
        const head=new THREE.Mesh(new THREE.SphereGeometry(.8,20,20),mat);head.position.y=3;
        const halo=new THREE.Mesh(new THREE.TorusGeometry(1.2,.1,8,32),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:.6}));
        halo.position.y=3.5;halo.rotation.x=-Math.PI/2;
        const cape=new THREE.Mesh(new THREE.PlaneGeometry(2.2,2.5),new THREE.MeshStandardMaterial({color:c.color,transparent:true,opacity:.8,side:THREE.DoubleSide}));
        cape.position.set(0,1.2,-1.1);
        g.add(torso,head,halo,cape);
        parts.push({p:cape,t:'wave'});
        g.userData.halo=halo;
    }else if(c.name==='Decker'){
        const torso=new THREE.Mesh(new THREE.BoxGeometry(1.5,2,1),mat);torso.position.y=1.25;
        const head=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),mat);head.position.y=2.8;
        const visor=new THREE.Mesh(new THREE.PlaneGeometry(.9,.4),new THREE.MeshBasicMaterial({color:0x00ff88,transparent:true,opacity:.9}));
        visor.position.set(0,2.85,.55);
        const screen=new THREE.Mesh(new THREE.PlaneGeometry(.8,.6),new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:.3,side:THREE.DoubleSide}));
        const left=screen.clone();left.position.set(-.8,1.8,.6);
        const right=screen.clone();right.position.set(.8,1.8,.6);
        g.add(torso,head,visor,left,right);
        parts.push({p:visor,t:'scan'},{p:left,t:'pulse'},{p:right,t:'pulse'});
    }else if(c.name==='Inquisitor'){
        const torso=new THREE.Mesh(new THREE.BoxGeometry(2.2,2.8,1.8),mat);torso.position.y=1.4;
        const head=new THREE.Mesh(new THREE.BoxGeometry(1.3,1.3,1.3),mat);head.position.y=3.4;
        const fist=new THREE.Mesh(new THREE.BoxGeometry(.8,.8,1.2),mat);
        const left=fist.clone();left.position.set(-1.8,1.8,0);
        const right=fist.clone();right.position.set(1.8,1.8,0);
        const cannon=new THREE.Mesh(new THREE.CylinderGeometry(.2,.3,1.2,8),new THREE.MeshStandardMaterial({color:0xff6600,emissive:0xff6600,emissiveIntensity:.2}));
        cannon.position.set(0,2.2,1.2);cannon.rotation.x=Math.PI/2;
        g.add(torso,head,left,right,cannon);
        parts.push({p:left,t:'punch'},{p:right,t:'punch'},{p:cannon,t:'charge'});
    }else if(c.name==='Adventurer'){
        const torso=new THREE.Mesh(new THREE.CylinderGeometry(.7,.7,2.2,12),mat);torso.position.y=1.1;
        const head=new THREE.Mesh(new THREE.SphereGeometry(.65,20,20),mat);head.position.y=2.7;
        const shield=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.8,.3),new THREE.MeshStandardMaterial({color:c.color,transparent:true,opacity:.7}));
        shield.position.set(-1.2,1.7,0);
        const sword=new THREE.Mesh(new THREE.BoxGeometry(.1,.1,2),new THREE.MeshStandardMaterial({color:0xcccccc}));
        sword.position.set(1.1,1.5,0);
        g.add(torso,head,shield,sword);
        parts.push({p:shield,t:'energy'},{p:sword,t:'slash'});
    }else{ // Pooka
        const core=new THREE.Mesh(new THREE.IcosahedronGeometry(1.6,1),mat);core.position.y=2.2;
        const wingMat=new THREE.MeshStandardMaterial({color:c.color,transparent:true,opacity:.9,side:THREE.DoubleSide});
        const wings=[];
        for(let i=0;i<4;i++){
            const wing=new THREE.Mesh(new THREE.PlaneGeometry(2.2+i*.3,1.2+i*.2),wingMat);
            const a=i/4*Math.PI*2;
            wing.position.set(Math.cos(a)*1.2,2.2,Math.sin(a)*1.2);wing.rotation.y=a;
            g.add(wing);wings.push(wing);
            parts.push({p:wing,t:'flutter',s:.08+i*.02});
        }
        const aura=new THREE.Mesh(new THREE.SphereGeometry(2.5,16,16),new THREE.MeshBasicMaterial({color:c.color,transparent:true,opacity:.2}));
        g.add(core,aura);parts.push({p:aura,t:'pulse'});
        g.userData.wings=wings;
    }
    g.scale.set(1.3,1.3,1.3);g.userData.anim=parts;
    return g;
}
function createEnemyModel(t){
    const g=new THREE.Group(),mat=new THREE.MeshStandardMaterial({color:0x888888,roughness:.7});
    if(t==='demigod'){
        const head=new THREE.Mesh(new THREE.SphereGeometry(1,20,20),new THREE.MeshStandardMaterial({color:0xffd700,metalness:.8}));
        head.position.y=2.5;
        const body=new THREE.Mesh(new THREE.CylinderGeometry(.8,1.5,3,16),mat);body.position.y=1;
        const crown=new THREE.Mesh(new THREE.TorusGeometry(1.3,.2,8,20),mat);crown.position.y=3.2;crown.rotation.x=Math.PI/2;
        g.add(head,body,crown);g.userData.anim=[{p:head,t:'glow'},{p:crown,t:'rotate'}];g.scale.set(1.6,1.6,1.6);
    }else if(t==='drone'){
        const body=new THREE.Mesh(new THREE.SphereGeometry(1,16,12),new THREE.MeshStandardMaterial({color:0x00ff00,metalness:.9}));body.scale.y=.6;
        const thruster=new THREE.Mesh(new THREE.CylinderGeometry(.15,.25,.8,8),mat);
        const thr=[];
        for(let i=0;i<4;i++){
            const a=i/4*Math.PI*2,th=thruster.clone();
            th.position.set(Math.cos(a)*.8,-.8,Math.sin(a)*.8);th.rotation.z=a+Math.PI/2;
            g.add(th);thr.push(th);
        }
        g.add(body);g.userData.anim=[{p:body,t:'hover'},{p:thr,t:'thrust'}];
    }else if(t==='chaos'){
        const head=new THREE.Mesh(new THREE.SphereGeometry(1,16,16),new THREE.MeshStandardMaterial({color:0xff4500}));head.scale.z=1.8;head.position.y=1.2;head.rotation.x=Math.PI/6;
        const body=new THREE.Mesh(new THREE.CylinderGeometry(.6,.4,2.2,12),mat);body.position.y=0;
        const tent=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,1.5,6),mat);
        for(let i=0;i<6;i++){
            const a=i/6*Math.PI*2,tt=tent.clone();
            tt.position.set(Math.cos(a)*.8,.5,Math.sin(a)*.8);tt.rotation.z=a;
            g.add(tt);
        }
        g.add(head,body);g.userData.anim=[{p:head,t:'bob'}];
    }else if(t==='goblin'){
        const head=new THREE.Mesh(new THREE.SphereGeometry(.8,16,16),new THREE.MeshStandardMaterial({color:0x4682b4}));
        head.position.y=1.8;
        const body=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.8,1),mat);body.position.y=.6;
        const ear=new THREE.Mesh(new THREE.SphereGeometry(.4,8,8),mat);ear.scale.set(1.2,.8,1);
        const left=ear.clone();left.position.set(-.7,2.2,0);
        const right=ear.clone();right.position.set(.7,2.2,0);
        g.add(head,body,left,right);g.userData.anim=[{p:body,t:'bounce'}];
    }else{ // nightmare
        const core=new THREE.Mesh(new THREE.IcosahedronGeometry(1.2,1),new THREE.MeshStandardMaterial({color:0xda70d6,metalness:.7}));
        core.position.y=1.8;
        const ring=new THREE.Group();
        const spike=new THREE.Mesh(new THREE.ConeGeometry(.25,1.2,8),mat);
        for(let i=0;i<8;i++){
            const a=i/8*Math.PI*2,s=spike.clone();
            s.position.set(Math.cos(a)*1.5,1.8,Math.sin(a)*1.5);s.rotation.z=a+Math.PI/2;
            ring.add(s);
        }
        g.add(core,ring);g.userData.ring=ring;
        g.userData.anim=[{p:ring,t:'rotate'},{p:core,t:'pulse'}];
    }
    g.position.y=1;return g;
}
function createPowerupModel(info){
    const g=new THREE.Group();
    const crystal=new THREE.Mesh(new THREE.OctahedronGeometry(.8,0),new THREE.MeshStandardMaterial({color:info.col,transparent:true,opacity:.9,metalness:.8,roughness:.1}));
    const glow=new THREE.Mesh(new THREE.SphereGeometry(1.2,16,16),new THREE.MeshBasicMaterial({color:info.col,transparent:true,opacity:.4}));
    g.add(crystal,glow);g.userData.anim=[{p:crystal,t:'spin'},{p:glow,t:'pulse'}];
    return g;
}

/* ---------- ANIMATION HELPERS ---------- */
function updateAnim(model,dt){
    if(!model.userData.anim) return;
    model.userData.anim.forEach(a=>{
        const p=a.p,t=a.t;
        const tm=performance.now()*.001;
        switch(t){
            case'wave':p.position.z=-1.1+Math.sin(tm*2)*.1;p.rotation.x=Math.sin(tm*3)*.2;break;
            case'scan':p.material.opacity=.4+Math.sin(tm*10)*.5;break;
            case'pulse':p.scale.setScalar(1+Math.sin(tm*4)*.1);break;
            case'punch':p.rotation.z=Math.sin(tm*8)*.3;break;
            case'charge':p.material.emissiveIntensity=.2+Math.sin(tm*6)*.1;break;
            case'energy':p.material.opacity=.5+Math.sin(tm*5)*.3;break;
            case'slash':p.rotation.y=Math.sin(tm*12)*.4;break;
            case'flutter':p.rotation.z+=a.s||.1;p.scale.setScalar(1+Math.sin(tm*8)*.1);break;
            case'glow':p.material.emissiveIntensity=.1+Math.sin(tm*2)*.05;break;
            case'rotate':p.rotation.y+=dt*1.5;break;
            case'hover':p.position.y=Math.sin(tm*3)*.2;break;
            case'thrust':Array.isArray(p)?p.forEach((pp,i)=>pp.material.emissiveIntensity=.3+Math.sin(tm*10+i)*.2):null;break;
            case'bob':p.position.y+=Math.sin(tm*2)*.02;break;
            case'bounce':p.position.y=Math.abs(Math.sin(tm*6))*.1;break;
            case'spin':p.rotation.x+=dt*2;p.rotation.y+=dt*1.5;break;
        }
    });
}

/* ---------- CLASSES ---------- */
class Player{
    constructor(c){this.c=c;this.model=createPlayerModel(c);this.model.position.z=HEIGHT/2-5;
        this.health=this.max=c.health;this.shootCD=0;this.shield=null;this.shieldReady=true;
        this.lastHit=0;this.regen=0;this.dodge=c.name==='Pooka'?.3:0;this.animTime=0;
        scene.add(this.model);}
    update(dt){
        if(keys.a.pressed && this.model.position.x>-WIDTH/2) this.model.position.x-=this.c.speed;
        if(keys.d.pressed && this.model.position.x<WIDTH/2) this.model.position.x+=this.c.speed;
        if(this.shootCD>0) this.shootCD--;
        if(this.c.name==='Adventurer'){
            if(!this.shieldReady && Date.now()-this.lastHit>5000){this.shieldReady=true;this.addShield(0x4682b4,3.5);}
        }
        if(this.c.name==='Godsworn'){this.regen+=dt*60;if(this.regen>=120){this.heal(1);this.regen=0;}}
        updateAnim(this.model,dt);
        if(this.c.name==='Pooka' && this.model.userData.wings) this.model.userData.wings.forEach((w,i)=>w.rotation.z+=.08+i*.02);
    }
    shoot(t){
        const rate=activePowerups.divineBoon||activePowerups.matrixHack?5:20;
        if(this.shootCD>0) return;
        playSound('shoot',.25,charSounds[this.c.name]?.shoot||1);
        const offs=activePowerups.tripleShot?[-12,12]:activePowerups.doubleShot?[-6,6]:[0];
        offs.forEach(o=>{const nt=t.clone(),d=new THREE.Vector3().subVectors(t,this.model.position).normalize(),
            p=new THREE.Vector3(-d.z,0,d.x).multiplyScalar(o*.01);nt.add(p);
            projectiles.push(new Projectile(this.model.position.clone(),nt,this.c));});
        this.shootCD=rate;
    }
    takeDamage(a){
        if(this.shield) return;
        playSound('damage',.4,.7);
        if(activePowerups.questBoost){delete activePowerups.questBoost;if(this.shield)this.model.remove(this.shield);this.shield=null;return;}
        if(this.c.name==='Adventurer' && this.shieldReady){this.shieldReady=false;this.lastHit=Date.now();if(this.shield)this.model.remove(this.shield);this.shield=null;return;}
        if(this.c.name==='Pooka' && Math.random()<this.dodge){playSound('powerup',.2,2);return;}
        this.health-=a;this.lastHit=Date.now();updateHealth();if(this.health<=0) endGame();
    }
    heal(a){this.health=Math.min(this.max,this.health+a);updateHealth();}
    addShield(col,size){
        if(this.shield) this.model.remove(this.shield);
        const geo=new THREE.SphereGeometry(size,16,16),mat=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.5,wireframe:true});
        this.shield=new THREE.Mesh(geo,mat);this.model.add(this.shield);
    }
}
class Projectile{
    constructor(pos,t,c){this.c=c;const geo=new THREE.SphereGeometry(.5,8,8),mat=new THREE.MeshBasicMaterial({color:c.projCol,transparent:true});
        this.model=new THREE.Mesh(geo,mat);this.model.position.copy(pos);this.target=t.clone();this.speed=c.projSpd;
        this.mega=!!activePowerups.holyPurge;if(this.mega) delete activePowerups.holyPurge;
        this.homing=!!activePowerups.glamourSurge;this.homingTarg=null;
        if(this.homing&&enemies.length){let min=Infinity;enemies.forEach(e=>{const d=this.model.position.distanceTo(e.model.position);if(d<min){min=d;this.homingTarg=e;}});}
        const dir=new THREE.Vector3().subVectors(t,pos).normalize();this.vel=dir.multiplyScalar(this.speed);scene.add(this.model);
        this.trail=[];for(let i=0;i<5;i++){const p=new THREE.Mesh(new THREE.SphereGeometry(.1,6,6),new THREE.MeshBasicMaterial({color:c.projCol,transparent:true,opacity:.6}));
            p.position.copy(this.model.position);scene.add(p);this.trail.push({m:p,l:1});}}
    update(){
        if(this.homing&&this.homingTarg&&this.homingTarg.model.parent===scene){
            const d=new THREE.Vector3().subVectors(this.homingTarg.model.position,this.model.position).normalize();
            this.vel.lerp(d.multiplyScalar(this.speed),.12);
        }else this.homing=false;
        this.model.position.add(this.vel);
        this.trail.forEach((t,i)=>{t.l-=.08;t.m.material.opacity=t.l;t.m.position.lerp(this.model.position,.1);
            if(t.l<=0){scene.remove(t.m);this.trail.splice(i,1);}});
    }
}
class Explosion{
    constructor(pos,col,mega,char){playSound('explosion',.5,charSounds[char]?.exp||1);
        const geo=new THREE.SphereGeometry(1,16,16),mat=new THREE.MeshBasicMaterial({color:col,transparent:true});
        this.model=new THREE.Mesh(geo,mat);this.model.position.copy(pos);
        this.max=mega?35:12;if(char==='Inquisitor') this.max*=1.6;this.life=1;this.particles=[];
        for(let i=0;i<20;i++){
            const pgeo=new THREE.SphereGeometry(Math.random()*.3+.1,8,8),pmat=new THREE.MeshBasicMaterial({color:col,transparent:true});
            const p=new THREE.Mesh(pgeo,pmat);p.position.copy(pos);
            const v=new THREE.Vector3((Math.random()-.5)*4,Math.random()*2,(Math.random()-.5)*4);
            scene.add(p);this.particles.push({m:p,v:v,l:1});
        }
        scene.add(this.model);}
    update(){
        const s=THREE.MathUtils.lerp(this.model.scale.x,this.max,.12);this.model.scale.setScalar(s);this.model.material.opacity=this.life;
        this.particles.forEach((p,i)=>{p.m.position.add(p.v);p.l-=.04;p.m.material.opacity=p.l;p.v.y-=.05;
            if(p.l<=0){scene.remove(p.m);this.particles.splice(i,1);}});
        this.life-=.035;
    }
}
class Enemy{
    constructor(x,z,t){this.t=t;this.model=createEnemyModel(t);this.model.position.set(x,2,z);this.stun=false;this.ground=false;this.gtime=0;
        let s,v;switch(t){case'demigod':s=.03+wave*.006;v=60;break;case'drone':s=.12+wave*.018;v=30;break;
            case'chaos':s=.06+wave*.01;v=40;break;case'goblin':s=.08+wave*.012;v=25;break;default:s=.1+wave*.015;v=20;}
        this.speed=s;this.val=v;this.hit=false;scene.add(this.model);}
    update(dt){
        let sp=this.speed;if(activePowerups.enemySlow) sp*=.4;if(!this.stun) this.model.position.z+=sp;
        if(this.model.position.z>=HEIGHT/2 && !this.ground){this.ground=true;this.groundAction();}
        if(this.ground){this.gtime+=dt;this.groundUpdate(dt);}
        this.model.rotation.y+=.025;updateAnim(this.model,dt);
        if(this.model.position.distanceTo(player.model.position)<3.5 && !this.hit){this.hit=true;player.takeDamage(12);this.die();}
        if(this.model.position.z>HEIGHT/2+5){player.takeDamage(25);this.die();}
    }
    groundAction(){
        playSound('explosion',.3,.3);
        switch(this.t){
            case'demigod':explosions.push(new Explosion(this.model.position.clone().add(new THREE.Vector3(0,0,5)),0xffd700,true,'Godsworn'));break;
            case'drone':for(let i=0;i<3;i++){const nx=this.model.position.x+(Math.random()-.5)*4;enemies.push(new Enemy(nx,HEIGHT/2,'drone'));}break;
            case'chaos':activePowerups.enemySlow=true;setTimeout(()=>{delete activePowerups.enemySlow;},3000);break;
            case'goblin':for(let i=0;i<2;i++)setTimeout(()=>{const tgt=player.model.position.clone();tgt.z-=10;
                projectiles.push(new Projectile(this.model.position.clone(),tgt,{projCol:0xff6600,projSpd:.8}));},i*500);break;
            case'nightmare':player.stun=true;setTimeout(()=>{player.stun=false;},2000);break;
        }
    }
    groundUpdate(dt){if(this.gtime>3){explosions.push(new Explosion(this.model.position,0xff4444,true,'Inquisitor'));this.die();}}
    die(){scene.remove(this.model);const i=enemies.indexOf(this);if(i>-1) enemies.splice(i,1);}
}
class Powerup{
    constructor(pos){this.info=POWERUPS[Math.floor(Math.random()*POWERUPS.length)];this.model=createPowerupModel(this.info);
        this.model.position.copy(pos);this.model.position.y=2.5;this.speed=.22;scene.add(this.model);}
    update(){this.model.rotation.y+=.04;this.model.position.z+=this.speed;
        this.model.position.y=2.5+Math.sin(performance.now()*.005)*.3;updateAnim(this.model,.016);}
}

/* ---------- THREE SETUP ---------- */
function initThree(){
    HEIGHT=(WIDTH*canvas.offsetHeight)/canvas.offsetWidth;
    scene=new THREE.Scene();scene.fog=new THREE.FogExp2(0x1a1a2e,.02);
    camera=new THREE.PerspectiveCamera(75,canvas.offsetWidth/canvas.offsetHeight,.1,1000);
    camera.position.set(0,60,HEIGHT/2+15);camera.lookAt(0,0,0);
    renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});renderer.setSize(canvas.offsetWidth,canvas.offsetHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
    scene.add(new THREE.AmbientLight(0x404040,1.2));
    const dir=new THREE.DirectionalLight(0xffffff,1.8);dir.position.set(20,40,20);dir.castShadow=true;dir.shadow.mapSize.set(2048,2048);scene.add(dir);
    scene.add(new THREE.DirectionalLight(0x00aaff,.6).position.set(-10,20,-10));
    const starsGeo=new THREE.BufferGeometry(),cnt=1000,pos=new Float32Array(cnt*3);
    for(let i=0;i<cnt*3;i+=3){pos[i]=(Math.random()-.5)*2000;pos[i+1]=Math.random()*500;pos[i+2]=(Math.random()-.5)*2000;}
    starsGeo.setAttribute('position',new THREE.BufferAttribute(pos,3));
    scene.add(new THREE.Points(starsGeo,new THREE.PointsMaterial({color:0xffffff,size:2,transparent:true,opacity:.8})));
    raycaster=new THREE.Raycaster();
    const pg=new THREE.PlaneGeometry(WIDTH,HEIGHT),pm=new THREE.MeshBasicMaterial({visible:false});
    plane=new THREE.Mesh(pg,pm);plane.rotation.x=-Math.PI/2;scene.add(plane);
}

/* ---------- UI / LOGIC ---------- */
function initChars(){
    charGrid.innerHTML='';CHARACTERS.forEach(c=>{
        const card=document.createElement('div');card.className='p-4 rounded-lg cursor-pointer character-card bg-black bg-opacity-40';
        card.style.borderColor=`#${new THREE.Color(c.color).getHexString()}`;
        card.dataset.name=c.name;card.innerHTML=`<h3 class="text-2xl font-bold" style="color:#${new THREE.Color(c.color).getHexString()};text-shadow:0 0 5px #${new THREE.Color(c.color).getHexString()};">${c.name}</h3><p class="text-lg">${c.faction}</p>`;
        card.onclick=()=>{selectedChar=c;document.querySelectorAll('.character-card').forEach(x=>x.classList.remove('selected'));card.classList.add('selected');
            charName.textContent=c.name;charFaction.textContent=c.faction;charPassive.textContent=c.passive;charAbility.textContent=c.ability;playBtn.classList.remove('hidden');};
        charGrid.appendChild(card);
    });
}
function spawnWave(){
    const cnt=6+wave*3;
    for(let i=0;i<cnt;i++){
        const x=(Math.random()-.5)*(WIDTH-10),z=-HEIGHT/2-Math.random()*20;
        let t;const r=Math.random();
        if(wave>3&&r<.15)t='demigod';
        else if(wave>2&&r<.35)t='drone';
        else if(wave>1&&r<.55)t='chaos';
        else if(r<.75)t='goblin';
        else t='nightmare';
        enemies.push(new Enemy(x,z,t));
    }
}
function updateScore(v){const m=activePowerups.scoreMultiplier?2:1;score+=v*m;scoreEl.textContent=score;playSound('hit',.15,2+Math.random()*.5);}
function updateHealth(){const p=player.health/player.max*100;healthBar.style.width=`${Math.max(0,p)}%`;
    healthBar.className='health-fill transition-all duration-300';
    if(p<25)healthBar.classList.add('bg-red-500');else if(p<60)healthBar.classList.add('bg-yellow-500');else healthBar.classList.add('bg-green-500');}
function useAbility(){
    if(!abilityReady) return;abilityReady=false;abilityTimer=selectedChar.cooldown;playSound('powerup',.6,.5);
    switch(selectedChar.name){
        case'Godsworn':enemies.forEach(e=>e.stun=true);setTimeout(()=>{enemies.forEach(e=>e.stun=false);},selectedChar.dur);break;
        case'Decker':activePowerups.matrixHack=true;setTimeout(()=>{delete activePowerups.matrixHack;},selectedChar.dur);break;
        case'Inquisitor':
            const hit=raycaster.intersectObject(plane);if(hit.length){const p=hit[0].point;player.shoot(p);
                setTimeout(()=>{player.shoot(p);},150);setTimeout(()=>{player.shoot(p);},300);}break;
        case'Adventurer':player.shield=true;player.addShield(0x4682b4,4.2);
            setTimeout(()=>{player.shield=false;if(player.shieldObj){player.model.remove(player.shieldObj);player.shieldObj=null;}},selectedChar.dur);break;
        case'Pooka':enemies.forEach(e=>{e.stun=true;e.speed*=-1;});
            setTimeout(()=>{enemies.forEach(e=>{e.stun=false;e.speed=Math.abs(e.speed);});},selectedChar.dur);break;
    }
}
function activatePowerup(p){
    showToast(p.info.name,`#${new THREE.Color(p.info.col).getHexString()}`);playSound('powerup',.5,1.5);
    if(p.info.dur>0){
        if(activePowerups[p.info.type]) clearTimeout(activePowerups[p.info.type].t);
        const t=setTimeout(()=>{delete activePowerups[p.info.type];},p.info.dur);
        activePowerups[p.info.type]={t};
    }
    switch(p.info.type){
        case'divineBoon':activePowerups.divineBoon=true;break;
        case'matrixHack':activePowerups.matrixHack=true;break;
        case'holyPurge':activePowerups.holyPurge=true;break;
        case'questBoost':activePowerups.questBoost=true;player.addShield(0x4682b4,3.2);break;
        case'glamourSurge':activePowerups.glamourSurge=true;break;
        case'healthPack':player.heal(35);break;
    }
}
function showToast(msg,col){
    const t=document.createElement('div');t.className='powerup-toast';t.textContent=msg;t.style.backgroundColor=col;
    toastContainer.appendChild(t);
    setTimeout(()=>{t.style.opacity='1';t.style.bottom='40px';t.style.transform='translateX(-50%) scale(1.1)';},10);
    setTimeout(()=>{t.style.opacity='0';t.style.bottom='20px';t.style.transform='translateX(-50%) scale(0.9)';setTimeout(()=>t.remove(),500);},2500);
}

/* ---------- GAME LOOP ---------- */
let last=0;
function loop(now){
    if(!gameActive) return;gameLoopId=requestAnimationFrame(loop);
    const dt=Math.min((now-last)/1000,.05);last=now;
    if(player && !player.stun) player.update(dt);
    // projectiles
    for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i];p.update();
        if(p.model.position.distanceTo(p.target)<p.speed*2 || p.model.position.z<-HEIGHT/2 || p.model.position.z>HEIGHT/2){
            explosions.push(new Explosion(p.model.position,p.c.projCol,p.mega,p.c.name));
            scene.remove(p.model);p.trail.forEach(tr=>scene.remove(tr.m));projectiles.splice(i,1);
        }
    }
    // explosions
    for(let i=explosions.length-1;i>=0;i--){
        const e=explosions[i];e.update();
        for(let j=enemies.length-1;j>=0;j--){
            const en=enemies[j];
            if(e.model.position.distanceTo(en.model.position)<e.model.scale.x*.8){
                updateScore(en.val);
                if(Math.random()<.2){const pos=new THREE.Vector3(en.model.position.x,2.5,Math.max(-HEIGHT/2,en.model.position.z));
                    powerups.push(new Powerup(pos));}
                scene.remove(en.model);enemies.splice(j,1);
            }
        }
        if(e.life<=0){scene.remove(e.model);e.particles.forEach(pa=>scene.remove(pa.m));explosions.splice(i,1);}
    }
    // enemies
    for(let i=enemies.length-1;i>=0;i--) enemies[i].update(dt);
    // powerups
    for(let i=powerups.length-1;i>=0;i--){
        const p=powerups[i];p.update();
        if(p.model.position.distanceTo(player.model.position)<3.5){activatePowerup(p);scene.remove(p.model);powerups.splice(i,1);}
        else if(p.model.position.z>HEIGHT/2){scene.remove(p.model);powerups.splice(i,1);}
    }
    // wave
    if(enemies.length===0){wave++;waveEl.textContent=wave;spawnWave();}
    // ability
    if(!abilityReady){
        abilityTimer=Math.max(0,abilityTimer-dt*1000);
        const prog=Math.max(0,1-abilityTimer/selectedChar.cooldown);
        abilityBar.style.width=`${prog*100}%`;
        if(abilityTimer<=0){abilityReady=true;abilityBar.style.width='100%';}
    }
    // camera
    const camZ=player.model.position.z+HEIGHT/4;
    camera.position.z=THREE.MathUtils.lerp(camera.position.z,camZ,.05);
    renderer.render(scene,camera);
}

/* ---------- STATE ---------- */
function show(s){['start-screen','character-selection-screen','game-screen'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    document.getElementById(s).classList.remove('hidden');}
function startGame(){
    if(!selectedChar) return;
    score=0;wave=1;gameActive=true;projectiles=[];enemies=[];explosions=[];powerups=[];activePowerups={};
    scoreEl.textContent=score;waveEl.textContent=wave;show('game-screen');initThree();player=new Player(selectedChar);
    if(player.c.name==='Adventurer' && player.shieldReady) player.addShield(0x4682b4,3.5);
    playerName.textContent=player.c.name;updateHealth();abilityBar.style.width='100%';spawnWave();last=performance.now();loop(last);
}
function endGame(){gameActive=false;cancelAnimationFrame(gameLoopId);finalScore.textContent=score;finalWave.textContent=wave;gameOver.classList.remove('hidden');
    while(scene.children.length) scene.remove(scene.children[0]);}
function restart(){gameOver.classList.add('hidden');selectedChar=null;playBtn.classList.add('hidden');
    charName.textContent='';charFaction.textContent='';charPassive.textContent='';charAbility.textContent='';show('character-selection-screen');}

/* ---------- INPUT ---------- */
startBtn.onclick=()=>{show('character-selection-screen');initChars();};
playBtn.onclick=startGame;restartBtn.onclick=restart;
canvas.onmousemove=e=>{
    const r=canvas.getBoundingClientRect();
    mouse.x=((e.clientX-r.left)/canvas.offsetWidth)*2-1;
    mouse.y=-((e.clientY-r.top)/canvas.offsetHeight)*2+1;
    if(gameActive) raycaster.setFromCamera(mouse,camera);
};
canvas.onclick=()=>{if(gameActive){const i=raycaster.intersectObject(plane);if(i.length) player.shoot(i[0].point);}};
window.onkeydown=e=>{if(!gameActive) return;
    if(e.key==='a'||e.key==='ArrowLeft') keys.a.pressed=true;
    if(e.key==='d'||e.key==='ArrowRight') keys.d.pressed=true;
    if(e.key==='q') useAbility();};
window.onkeyup=e=>{if(!gameActive) return;
    if(e.key==='a'||e.key==='ArrowLeft') keys.a.pressed=false;
    if(e.key==='d'||e.key==='ArrowRight') keys.d.pressed=false;};
window.onresize=()=>{if(!gameActive) return;
    camera.aspect=canvas.offsetWidth/canvas.offsetHeight;camera.updateProjectionMatrix();
    renderer.setSize(canvas.offsetWidth,canvas.offsetHeight);HEIGHT=(WIDTH*canvas.offsetWidth)/canvas.offsetHeight;
    if(plane){scene.remove(plane);const g=new THREE.PlaneGeometry(WIDTH,HEIGHT);plane.geometry.dispose();plane.geometry=g;scene.add(plane);}};
document.addEventListener('click',()=>{initAudio();},{once:true});
</script>
</body>
</html>
