<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Interior Commander - First Person Build</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
    body { font-family: 'Courier New', monospace; background: #000; overflow: hidden; color: #0ff; }
    #canvas-container { width: 100vw; height: 100vh; position: relative; }
    
    /* HUD & UI */
    #hud {
      position: absolute; top: 10px; left: 10px; z-index: 100;
      background: rgba(0, 20, 40, 0.8); border: 1px solid #0ff;
      padding: 12px; border-radius: 5px; pointer-events: none;
    }
    
    #ui-top-right {
      position: absolute; top: 10px; right: 10px;
      display: flex; flex-direction: column; gap: 10px; z-index: 200;
    }

    .action-btn {
      background: rgba(0, 40, 80, 0.8); border: 2px solid #0ff; color: #0ff;
      padding: 15px; cursor: pointer; border-radius: 8px; font-weight: bold;
      font-family: inherit; text-align: center; width: 140px;
    }
    .action-btn.active { background: #0ff; color: #000; }

    #dpad {
      position: absolute; bottom: 20px; left: 20px;
      display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px);
      gap: 10px; z-index: 100;
    }
    .ctrl-btn {
      background: rgba(0, 255, 136, 0.2); border: 2px solid #00ff88;
      color: #00ff88; border-radius: 50%; font-size: 1.2em;
      display: flex; align-items: center; justify-content: center;
    }
    
    #upload-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 1000;
    }
    #upload-overlay.hidden { display: none; }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="hud">
    <div style="font-weight:bold; margin-bottom: 5px;">SYSTEM: 1ST_PERSON_CORE</div>
    <div id="pos-display">X:0 Y:0 Z:0</div>
  </div>

  <div id="ui-top-right">
    <button class="action-btn" id="btn-flight">MODE: FLY</button>
    <button class="action-btn" id="btn-light">LIGHT: OFF</button>
    <button class="action-btn" id="btn-reupload" style="border-color:#f0f; color:#f0f;">RELOAD GLB</button>
  </div>

  <div id="dpad">
    <button class="ctrl-btn" id="btn-up" style="grid-column:2; grid-row:1;">W</button>
    <button class="ctrl-btn" id="btn-left" style="grid-column:1; grid-row:2;">A</button>
    <button class="ctrl-btn" id="btn-down" style="grid-column:2; grid-row:3;">S</button>
    <button class="ctrl-btn" id="btn-right" style="grid-column:3; grid-row:2;">D</button>
    <button class="ctrl-btn" id="btn-rise" style="grid-column:3; grid-row:1; border-color:#0ff; color:#0ff;">↑</button>
    <button class="ctrl-btn" id="btn-fall" style="grid-column:3; grid-row:3; border-color:#0ff; color:#0ff;">↓</button>
  </div>

  <div id="upload-overlay">
    <h2 style="margin-bottom:20px;">DEPLOY COMMAND STRUCTURE</h2>
    <input type="file" id="file-input" accept=".glb,.gltf" style="display:none;">
    <button class="action-btn" id="upload-btn" style="width:250px; background:#00ff88; color:#000;">LOAD .GLB</button>
  </div>

  <script type="importmap">
    { "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
    }}
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const state = {
      keys: {},
      velocity: new THREE.Vector3(),
      moveSpeed: 0.6,
      yaw: 0,
      pitch: 0,
      isFlight: true,
      lightOn: false,
      playerPos: new THREE.Vector3(0, 10, 30),
      structure: null
    };

    // --- SETUP ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // --- NATURAL SKYBOX ---
    const skyGeo = new THREE.SphereGeometry(1500, 32, 32);
    const skyMat = new THREE.ShaderMaterial({
      uniforms: {
        topColor: { value: new THREE.Color(0x2266ff) },
        bottomColor: { value: new THREE.Color(0xffffff) },
        offset: { value: 400 },
        exponent: { value: 0.6 }
      },
      vertexShader: `varying vec3 vWorldPosition; void main() { vec4 worldPosition = modelMatrix * vec4(position, 1.0); vWorldPosition = worldPosition.xyz; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
      fragmentShader: `uniform vec3 topColor; uniform vec3 bottomColor; uniform float offset; uniform float exponent; varying vec3 vWorldPosition; void main() { float h = normalize(vWorldPosition + offset).y; gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0); }`,
      side: THREE.BackSide
    });
    scene.add(new THREE.Mesh(skyGeo, skyMat));

    // --- PROCEDURAL GRASS GROUND ---
    const groundGeo = new THREE.PlaneGeometry(2000, 2000);
    const canvas = document.createElement('canvas');
    canvas.width = 256; canvas.height = 256;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#225522'; ctx.fillRect(0,0,256,256);
    for(let i=0; i<2000; i++) {
      ctx.fillStyle = `rgb(0, ${Math.random()*100 + 50}, 0)`;
      ctx.fillRect(Math.random()*256, Math.random()*256, 1, 1);
    }
    const groundMat = new THREE.MeshStandardMaterial({ 
      map: new THREE.CanvasTexture(canvas),
      roughness: 0.9
    });
    groundMat.map.repeat.set(100, 100);
    groundMat.map.wrapS = groundMat.map.wrapT = THREE.RepeatWrapping;
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Flashlight
    const flashlight = new THREE.SpotLight(0xffffff, 0, 150, Math.PI/6, 0.3, 1);
    flashlight.castShadow = true;
    scene.add(flashlight);
    scene.add(flashlight.target);

    // Ambient
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));

    // --- GLB LOADER ---
    const loader = new GLTFLoader();
    function loadGLB(file) {
      if(state.structure) scene.remove(state.structure);
      const url = URL.createObjectURL(file);
      loader.load(url, (gltf) => {
        state.structure = gltf.scene;
        // Adjust scale to make it a "world" you walk inside
        state.structure.scale.set(50, 50, 50); 
        scene.add(state.structure);
        document.getElementById('upload-overlay').classList.add('hidden');
      });
    }

    // --- INPUTS ---
    window.addEventListener('keydown', (e) => state.keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => state.keys[e.key.toLowerCase()] = false);
    
    // Mouse Look
    document.addEventListener('mousemove', (e) => {
      if (document.pointerLockElement === renderer.domElement || state.keys['mousedown']) {
        state.yaw -= e.movementX * 0.003;
        state.pitch -= e.movementY * 0.003;
        state.pitch = Math.max(-Math.PI/2.1, Math.min(Math.PI/2.1, state.pitch));
      }
    });
    renderer.domElement.addEventListener('mousedown', () => {
      renderer.domElement.requestPointerLock();
      state.keys['mousedown'] = true;
    });
    window.addEventListener('mouseup', () => state.keys['mousedown'] = false);

    // Mobile D-Pad
    const bind = (id, k) => {
      const el = document.getElementById(id);
      el.onpointerdown = (e) => { e.preventDefault(); state.keys[k] = true; };
      el.onpointerup = () => state.keys[k] = false;
    };
    bind('btn-up', 'w'); bind('btn-down', 's'); bind('btn-left', 'a'); bind('btn-right', 'd');
    bind('btn-rise', ' '); bind('btn-fall', 'q');

    // Buttons
    document.getElementById('btn-flight').onclick = () => {
      state.isFlight = !state.isFlight;
      document.getElementById('btn-flight').innerText = state.isFlight ? "MODE: FLY" : "MODE: WALK";
      document.getElementById('btn-flight').classList.toggle('active', state.isFlight);
    };
    document.getElementById('btn-light').onclick = () => {
      state.lightOn = !state.lightOn;
      flashlight.intensity = state.lightOn ? 2.5 : 0;
      document.getElementById('btn-light').innerText = state.lightOn ? "LIGHT: ON" : "LIGHT: OFF";
      document.getElementById('btn-light').classList.toggle('active', state.lightOn);
    };
    document.getElementById('upload-btn').onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = (e) => loadGLB(e.target.files[0]);
    document.getElementById('btn-reupload').onclick = () => document.getElementById('upload-overlay').classList.remove('hidden');

    // --- MAIN LOOP ---
    function animate() {
      requestAnimationFrame(animate);

      const forward = new THREE.Vector3(0, 0, -1).applyEuler(new THREE.Euler(0, state.yaw, 0));
      const right = new THREE.Vector3(1, 0, 0).applyEuler(new THREE.Euler(0, state.yaw, 0));

      // Movement
      const move = new THREE.Vector3();
      if (state.keys['w']) move.add(forward);
      if (state.keys['s']) move.add(forward.clone().negate());
      if (state.keys['a']) move.add(right.clone().negate());
      if (state.keys['d']) move.add(right);
      
      if (move.length() > 0) move.normalize().multiplyScalar(state.moveSpeed);
      
      state.velocity.x = move.x;
      state.velocity.z = move.z;

      // Verticality
      if (state.isFlight) {
        if (state.keys[' ']) state.velocity.y = state.moveSpeed;
        else if (state.keys['q']) state.velocity.y = -state.moveSpeed;
        else state.velocity.y *= 0.9;
      } else {
        // Simple Gravity
        if (state.playerPos.y > 6) state.velocity.y -= 0.05;
        else {
          state.playerPos.y = 6;
          state.velocity.y = 0;
        }
      }

      state.playerPos.add(state.velocity);
      camera.position.copy(state.playerPos);
      camera.rotation.set(state.pitch, state.yaw, 0, 'YXZ');

      // Flashlight Sync
      flashlight.position.copy(camera.position);
      const lightDir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
      flashlight.target.position.copy(camera.position).add(lightDir);

      document.getElementById('pos-display').innerText = 
        `X:${state.playerPos.x.toFixed(0)} Y:${state.playerPos.y.toFixed(0)} Z:${state.playerPos.z.toFixed(0)}`;

      renderer.render(scene, camera);
    }

    animate();

    window.onresize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
  </script>
</body>
</html>
