<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Civ 10: Sky Architect</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: #000; overflow: hidden; font-family: 'Rajdhani', sans-serif; color: #00ffcc; }

        #viewport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; cursor: crosshair; background: radial-gradient(circle at center, #0a0a20 0%, #000 100%); }

        /* --- HUD --- */
        #hud {
            position: fixed; top: 20px; left: 20px; z-index: 10;
            background: rgba(0, 20, 40, 0.85); border-left: 4px solid #ffaa00;
            padding: 15px; width: 220px; pointer-events: none;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-val { font-weight: bold; color: #fff; font-size: 18px; }
        .label { color: #888; font-size: 12px; letter-spacing: 1px; }

        /* --- SLOT UI --- */
        #ui-layer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 10; display: flex; justify-content: center; padding-bottom: 20px; pointer-events: none; }
        .machine-frame { pointer-events: auto; width: 360px; background: #111; border: 2px solid #333; border-top: 4px solid #00ffcc; padding: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
        .reels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; background: #000; height: 90px; margin-bottom: 10px; overflow: hidden; }
        .reel-strip { transform: translateY(0); transition: transform 0.1s; }
        .symbol { height: 90px; display: flex; align-items: center; justify-content: center; font-size: 40px; background: #0a0a0a; border-right: 1px solid #222; }

        .controls { display: flex; gap: 5px; }
        .btn { background: #222; color: #888; border: 1px solid #444; flex: 1; padding: 15px; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: #333; color: white; }
        .btn.active { background: #004433; color: #00ffcc; border-color: #00ffcc; }
        #btn-spin { background: #002233; color: #00ccff; border-color: #00ccff; flex: 2; }

        /* --- OVERLAY --- */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:200; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #overlay h1 { font-size: 3rem; color: #ffaa00; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 20px #ff4500; }
        #overlay p { color: #aaa; margin-bottom: 40px; font-size: 18px; }
        #overlay button { padding: 15px 50px; font-size: 20px; background: #ffaa00; border: none; font-weight: 900; cursor: pointer; color: #000; box-shadow: 0 0 30px #ffaa00; }

        /* --- NOTIFICATION --- */
        .float-text { position: absolute; font-weight: bold; color: white; pointer-events: none; animation: floatUp 1.5s forwards; text-shadow: 0 0 5px black; font-size: 20px; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* --- DRONE TARGET INDICATOR --- */
        #drone-target {
            position: fixed; top: 50%; left: 50%; width: 50px; height: 50px;
            border: 2px dashed rgba(255, 170, 0, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; display: none;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1>CIV 10: ARCHITECT</h1>
    <p>Spin to survive. Click the DRONE to build.</p>
    <button onclick="initSim()">INITIALIZE CITY</button>
</div>

<div id="viewport"></div>

<div id="hud">
    <div class="stat-row"><span class="label">CITY DENSITY</span> <span id="ui-builds" class="stat-val" style="color:#ffaa00">0</span></div>
    <div class="stat-row"><span class="label">POPULATION</span> <span id="ui-pop" class="stat-val">0</span></div>
    <div class="stat-row"><span class="label">ENERGY</span> <span id="ui-food" class="stat-val">100</span></div>
</div>

<div id="ui-layer">
    <div class="machine-frame">
        <div class="reels" id="reels-container"></div>
        <div class="controls">
            <button class="btn" id="btn-auto" onclick="toggleAuto()">AUTO</button>
            <button class="btn" id="btn-spin" onclick="spin()">CHARGE (10 E)</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* ================= AUDIO ================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    play: function(freq, type, dur, vol=0.1, slide=false) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) o.frequency.exponentialRampToValueAtTime(freq/2, this.ctx.currentTime+dur);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    born: () => SFX.play(600, 'sine', 0.1, 0.05),
    droneHit: () => {
        SFX.play(150, 'square', 0.1, 0.2);
        setTimeout(()=>SFX.play(100, 'sawtooth', 0.2, 0.2, true), 50);
    },
    buildLand: () => [100, 80].forEach(f=>SFX.play(f,'square',0.3,0.3)),
    spin: () => SFX.play(200, 'sawtooth', 0.05, 0.05)
};

/* ================= 3D SIMULATION ================= */
const Sim = {
    scene: null, camera: null, renderer: null, raycaster: null, mouse: null,
    
    // Arrays
    entities: [],
    buildings: [],
    
    // Special
    drone: null,
    droneTarget: new THREE.Vector3(0, 30, 0),
    
    init: function() {
        // Setup Three.js
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x0a0a15, 0.015);
        
        this.camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 1000);
        this.camera.position.set(0, 60, 80);
        this.camera.lookAt(0, 0, 0);

        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        document.getElementById('viewport').appendChild(this.renderer.domElement);

        // Inputs
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        window.addEventListener('pointerdown', this.onMouseClick.bind(this));

        // Lights
        const amb = new THREE.AmbientLight(0x404060, 0.8);
        this.scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffaa00, 1);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 2048; sun.shadow.mapSize.height = 2048;
        this.scene.add(sun);

        // Ground
        const grid = new THREE.GridHelper(200, 40, 0x333344, 0x111111);
        this.scene.add(grid);
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshBasicMaterial({color:0x050505}));
        plane.rotation.x = -Math.PI/2;
        plane.receiveShadow = true;
        this.scene.add(plane);

        // Init Objects
        this.createDrone();
        this.animate();
        
        // Resize
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    },

    // --- THE ARCHITECT DRONE ---
    createDrone: function() {
        const group = new THREE.Group();
        
        // Visuals
        const body = new THREE.Mesh(new THREE.IcosahedronGeometry(2, 0), new THREE.MeshBasicMaterial({color:0xffaa00, wireframe:true}));
        const core = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 0), new THREE.MeshBasicMaterial({color:0xffffff}));
        group.add(body); group.add(core);
        
        // Invisible Click Hitbox (Larger than visual)
        const hitbox = new THREE.Mesh(new THREE.SphereGeometry(6), new THREE.MeshBasicMaterial({visible:false}));
        hitbox.userData = { isDrone: true };
        group.add(hitbox);

        // Light
        const light = new THREE.PointLight(0xffaa00, 1, 30);
        group.add(light);

        group.position.set(0, 30, 0);
        this.scene.add(group);
        this.drone = group;
    },

    updateDrone: function(time) {
        if(!this.drone) return;
        
        // Sine wave flight path
        this.drone.position.x = Math.sin(time * 0.0005) * 40;
        this.drone.position.z = Math.cos(time * 0.0003) * 40;
        this.drone.position.y = 30 + Math.sin(time * 0.002) * 5;
        
        this.drone.rotation.x += 0.02;
        this.drone.rotation.y += 0.02;
    },

    // --- INTERACTION ---
    onMouseClick: function(event) {
        // Calculate mouse position
        this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersects = this.raycaster.intersectObjects(this.scene.children, true);
        
        for (let hit of intersects) {
            if (hit.object.userData.isDrone) {
                this.triggerDroneDrop();
                this.spawnFloatText(event.clientX, event.clientY, "+1 BUILDING MAT");
                break;
            }
        }
    },

    triggerDroneDrop: function() {
        SFX.droneHit();
        
        // 1. Explosion Effect at Drone
        this.spawnParticles(this.drone.position.x, this.drone.position.y, this.drone.position.z, 0xffaa00);
        
        // 2. Drop Crate
        const crateGeo = new THREE.BoxGeometry(2, 2, 2);
        const crateMat = new THREE.MeshBasicMaterial({color: 0x00ffcc, wireframe:true});
        const crate = new THREE.Mesh(crateGeo, crateMat);
        crate.position.copy(this.drone.position);
        this.scene.add(crate);
        
        // 3. Animate Fall
        new TWEEN.Tween(crate.position)
            .to({ y: 0 }, 1000)
            .easing(TWEEN.Easing.Bounce.Out)
            .onComplete(() => {
                this.scene.remove(crate);
                this.buildStructure(crate.position.x, crate.position.z);
            })
            .start();
            
        // 4. Animate rotation while falling
        new TWEEN.Tween(crate.rotation).to({x:4, y:4}, 1000).start();
    },

    buildStructure: function(x, z) {
        SFX.buildLand();
        
        // Choose Type
        const r = Math.random();
        let geo, mat, h;
        
        if(r > 0.8) {
            // Skyscraper
            h = 10 + Math.random()*10;
            geo = new THREE.BoxGeometry(3, h, 3);
            mat = new THREE.MeshStandardMaterial({color: 0x00aaff, roughness: 0.2});
        } else if (r > 0.4) {
            // Dome House
            h = 4;
            geo = new THREE.DodecahedronGeometry(3);
            mat = new THREE.MeshStandardMaterial({color: 0xffaa00, metalness:0.5});
        } else {
            // Bunker
            h = 2;
            geo = new THREE.BoxGeometry(5, 2, 5);
            mat = new THREE.MeshStandardMaterial({color: 0x555555});
        }

        const building = new THREE.Mesh(geo, mat);
        building.position.set(x, h/2, z);
        building.castShadow = true;
        building.receiveShadow = true;
        this.scene.add(building);
        
        this.buildings.push(building);
        Game.buildingsBuilt++;
        Game.updateHUD();

        // Explosion dust
        this.spawnParticles(x, 0, z, 0xaaaaaa);
    },

    spawnParticles: function(x, y, z, color) {
        for(let i=0; i<10; i++) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color:color}));
            m.position.set(x,y,z);
            this.scene.add(m);
            
            // Random scatter
            new TWEEN.Tween(m.position)
                .to({
                    x: x + (Math.random()-0.5)*5,
                    y: y + (Math.random()-0.5)*5,
                    z: z + (Math.random()-0.5)*5
                }, 500)
                .onComplete(()=>this.scene.remove(m))
                .start();
        }
    },

    spawnAgent: function() {
        if(this.entities.length > 50) return; // Cap pop
        const mesh = new THREE.Mesh(new THREE.TetrahedronGeometry(0.5), new THREE.MeshBasicMaterial({color:0x00ffcc}));
        mesh.position.set(0, 0.5, 0);
        this.scene.add(mesh);
        this.entities.push({ mesh: mesh, target: new THREE.Vector3(0,0,0) });
        SFX.born();
    },

    spawnFloatText: function(x, y, text) {
        const div = document.createElement('div');
        div.className = 'float-text';
        div.innerText = text;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        document.body.appendChild(div);
        setTimeout(()=>div.remove(), 1500);
    },

    animate: function(time) {
        requestAnimationFrame((t) => Sim.animate(t));
        TWEEN.update(time);
        this.updateDrone(time);
        
        // Agent AI
        for(let a of this.entities) {
            // Move randomly
            if(a.mesh.position.distanceTo(a.target) < 1) {
                // Find a building to walk to
                if(this.buildings.length > 0) {
                    const b = this.buildings[Math.floor(Math.random()*this.buildings.length)];
                    a.target.set(b.position.x + (Math.random()-0.5)*5, 0.5, b.position.z + (Math.random()-0.5)*5);
                } else {
                    a.target.set((Math.random()-0.5)*40, 0.5, (Math.random()-0.5)*40);
                }
            }
            
            const dir = new THREE.Vector3().subVectors(a.target, a.mesh.position).normalize();
            a.mesh.position.add(dir.multiplyScalar(0.1));
            a.mesh.lookAt(a.target);
        }

        this.renderer.render(this.scene, this.camera);
    }
};

/* ================= GAME LOGIC ================= */
const Game = {
    energy: 100,
    spinning: false,
    auto: false,
    buildingsBuilt: 0,
    
    symbols: ['üß¨', 'üîã', 'üõ°Ô∏è'],

    init: function() {
        this.createReels();
        this.updateHUD();
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<3; i++) {
            const s = document.createElement('div');
            s.className = 'reel-strip';
            s.id = `reel-${i}`;
            s.innerHTML = `<div class="symbol">${this.randSym()}</div>`;
            c.appendChild(s);
        }
    },

    randSym: function() { return this.symbols[Math.floor(Math.random()*this.symbols.length)]; },

    toggleAuto: function() {
        this.auto = !this.auto;
        document.getElementById('btn-auto').classList.toggle('active');
        if(this.auto && !this.spinning) this.spin();
    },

    spin: async function() {
        if(this.spinning) return;
        if(this.energy < 10) { this.auto = false; alert("Need Energy!"); return; }
        
        this.spinning = true;
        this.energy -= 10;
        this.updateHUD();
        SFX.spin();

        // Spin Logic
        const res = [];
        for(let i=0; i<3; i++) {
            const el = document.getElementById(`reel-${i}`);
            el.style.transform = 'translateY(20px)';
            await new Promise(r=>setTimeout(r,100));
            const sym = this.randSym();
            res.push(sym);
            el.children[0].innerText = sym;
            el.style.transform = 'translateY(0)';
        }
        
        // Results
        const dna = res.filter(s=>s==='üß¨').length;
        const batt = res.filter(s=>s==='üîã').length;
        
        if(dna > 0) { for(let k=0; k<dna*3; k++) Sim.spawnAgent(); }
        if(batt > 0) { this.energy += batt * 15; }

        this.spinning = false;
        this.updateHUD();
        if(this.auto) setTimeout(()=>this.spin(), 500);
    },

    updateHUD: function() {
        document.getElementById('ui-pop').innerText = Sim.entities.length;
        document.getElementById('ui-food').innerText = this.energy;
        document.getElementById('ui-builds').innerText = this.buildingsBuilt;
    }
};

window.initSim = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init(); Sim.init(); Game.init();
};
window.toggleAuto = () => Game.toggleAuto();
window.spin = () => Game.spin();

</script>
</body>
</html>
