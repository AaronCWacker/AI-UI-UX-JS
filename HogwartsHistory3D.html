<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sovereign's Forge: Era of Dragons</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: #000; overflow: hidden; font-family: 'Cinzel', serif; color: #d4af37; }

        /* --- 3D VIEWPORT --- */
        #viewport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); }

        /* --- UI LAYERS --- */
        #ui-layer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; display: flex; justify-content: center; padding-bottom: 20px; }

        /* --- SLOT MACHINE --- */
        .machine-frame {
            pointer-events: auto; width: 95%; max-width: 800px;
            background: linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%);
            border: 4px solid #4a3c31; border-image: linear-gradient(to bottom, #d4af37, #4a3c31) 1;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); padding: 15px;
            transition: transform 0.5s;
        }
        .machine-frame.minimized { transform: translateY(150%); }

        /* --- EGG HUNT MODAL --- */
        #egg-hunt-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 50;
            display: none; align-items: center; justify-content: center; flex-direction: column;
            pointer-events: auto;
        }
        #egg-hunt-layer.active { display: flex; animation: fadeIn 0.5s; }
        
        .egg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .dragon-egg {
            width: 100px; height: 130px;
            background: radial-gradient(circle at 30% 30%, #550000, #220000);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            border: 2px solid #800;
            box-shadow: 0 0 20px #ff0000;
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .dragon-egg:hover { transform: scale(1.1); box-shadow: 0 0 40px #ff4500; }
        .dragon-egg.cracked { background: #000; border: 1px dashed #444; pointer-events: none; box-shadow: none; }
        .egg-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; opacity: 0; transition: opacity 0.5s;
        }
        .dragon-egg.cracked .egg-content { opacity: 1; }

        /* --- HUD & CONTROLS --- */
        .hud-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #888; text-transform: uppercase; }
        .hud-val { color: #fff; font-weight: bold; font-size: 18px; text-shadow: 0 0 5px #d4af37; }
        
        .reels-window { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; background: #000; border: 2px solid #222; height: 180px; overflow: hidden; margin-bottom: 15px; position: relative; }
        .reel-strip { display: flex; flex-direction: column; }
        .symbol { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 40px; background: #1a1a1a; border-bottom: 1px solid #333; }
        
        .controls { display: flex; gap: 10px; }
        .btn { background: linear-gradient(180deg, #5e4b35 0%, #2e2316 100%); border: 1px solid #8c7352; color: #d4af37; padding: 15px 0; flex: 1; font-family: 'Cinzel'; font-weight: 900; font-size: 16px; cursor: pointer; }
        #btn-spin { flex: 2; background: linear-gradient(180deg, #8a2be2 0%, #4b0082 100%); color: #fff; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- TOASTS --- */
        #toast { position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: 900; color: #fff; text-shadow: 0 0 20px #ff0000; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 100; text-align: center; }
        #toast.active { top: 15%; opacity: 1; transform: translate(-50%, -50%) scale(1.2); }

        /* START SCREEN */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #overlay button { padding: 20px 40px; font-size: 24px; cursor: pointer; background: #d4af37; border: none; font-family: 'Cinzel'; font-weight: bold; }

    </style>
</head>
<body>

<div id="overlay">
    <h1 style="color:#d4af37; font-size: 3rem; margin-bottom: 20px;">SOVEREIGN'S FORGE</h1>
    <p style="color:#888; margin-bottom: 40px;">Era of Dragons</p>
    <button onclick="initGame()">ENTER REALM</button>
</div>

<div id="viewport"></div>
<div id="toast">DRAGON SUMMONED!</div>

<div id="egg-hunt-layer">
    <h1 style="color: #ff4500; text-shadow: 0 0 20px red;">THE DRAGON'S VAULT</h1>
    <p>Break eggs to reveal Ancient Magic or Gold.</p>
    <div class="egg-grid" id="egg-grid">
        </div>
    <button class="btn" id="close-egg-btn" style="margin-top: 30px; display: none;" onclick="closeEggHunt()">RETURN TO CASTLE</button>
</div>

<div id="ui-layer">
    <div class="machine-frame" id="slot-machine">
        <div class="hud-header">
            <div>Gold: <span id="ui-gold" class="hud-val">500</span></div>
            <div>City Size: <span id="ui-mass" class="hud-val">0</span> blocks</div>
        </div>
        <div class="reels-window" id="reels-container"></div>
        <div class="controls">
            <button class="btn" onclick="toggleAuto()" id="btn-auto">AUTO</button>
            <button class="btn" onclick="spin()" id="btn-spin">CONSTRUCT (20g)</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* =========================================================================
   AUDIO & FX
   ========================================================================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    playTone: function(freq, type, dur, vol=0.1, slide=false) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) osc.frequency.exponentialRampToValueAtTime(freq/2, this.ctx.currentTime + dur);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + dur);
    },
    spin: () => SFX.playTone(100, 'sawtooth', 0.1, 0.05),
    win: () => [440, 554, 659, 880].forEach((f,i) => setTimeout(() => SFX.playTone(f, 'triangle', 0.5, 0.1), i*100)),
    dragonRoar: () => {
        // Simulated roar using low freq noise-like oscillating
        for(let i=0; i<10; i++) setTimeout(()=> SFX.playTone(100 - (i*5), 'sawtooth', 0.2, 0.3), i*30);
    },
    crack: () => SFX.playTone(800, 'square', 0.05, 0.2),
    magic: () => SFX.playTone(1200, 'sine', 0.5, 0.1, true)
};

/* =========================================================================
   3D WORLD ENGINE: DRAGONS & CITIES
   ========================================================================= */
const World = {
    scene: null, camera: null, renderer: null,
    dragon: null,
    materials: {},
    buildQueue: [],
    cursor: { x: 0, y: 0, z: 0, ring: 0 },
    
    init: function() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x050505, 0.01);
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 2000);
        this.camera.position.set(60, 50, 60);
        this.camera.lookAt(0, 10, 0);

        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        document.getElementById('viewport').appendChild(this.renderer.domElement);

        // Lights
        const amb = new THREE.AmbientLight(0x404060, 0.5);
        this.scene.add(amb);
        this.sun = new THREE.DirectionalLight(0xffaa00, 1.5);
        this.sun.position.set(100, 200, 100);
        this.sun.castShadow = true;
        this.sun.shadow.mapSize.width = 2048;
        this.sun.shadow.mapSize.height = 2048;
        this.scene.add(this.sun);

        // Materials
        this.materials.stone = new THREE.MeshStandardMaterial({ color: 0x555566, roughness: 0.9 });
        this.materials.glow = new THREE.MeshStandardMaterial({ color: 0xff4500, emissive: 0xff0000, emissiveIntensity: 2 });
        this.materials.bridge = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.5 });
        this.materials.dragon = new THREE.MeshStandardMaterial({ color: 0x880000, roughness: 0.4, metalness: 0.5 });

        // Ground
        const ground = new THREE.Mesh(new THREE.CircleGeometry(400, 64), new THREE.MeshStandardMaterial({ color: 0x080808 }));
        ground.rotation.x = -Math.PI/2;
        ground.receiveShadow = true;
        this.scene.add(ground);

        this.createDragon();
        this.animate();
        
        // Initial Keep Base
        this.queueBuild('KEEP', 20);
    },

    createDragon: function() {
        this.dragon = new THREE.Group();
        
        // Body segments (Procedural Dragon)
        const bodyGeo = new THREE.ConeGeometry(2, 8, 8);
        bodyGeo.rotateX(Math.PI/2);
        const body = new THREE.Mesh(bodyGeo, this.materials.dragon);
        this.dragon.add(body);
        
        // Wings
        const wingGeo = new THREE.BufferGeometry();
        const vertices = new Float32Array([0,0,0,  5,0,2,  2,0,-3]); // Triangle wing
        wingGeo.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
        const wingL = new THREE.Mesh(wingGeo, this.materials.dragon);
        const wingR = new THREE.Mesh(wingGeo, this.materials.dragon);
        wingL.position.set(1, 1, 0);
        wingR.position.set(-1, 1, 0);
        wingR.rotation.y = Math.PI;
        
        this.dragon.add(wingL); this.dragon.add(wingR);
        this.dragon.wings = [wingL, wingR]; // Ref for animation

        this.dragon.position.set(0, -100, 0); // Hide initially
        this.scene.add(this.dragon);
    },

    summonDragon: function(targetX, targetZ) {
        // Dragon Swoop Animation
        this.dragon.position.set(100, 100, 100);
        this.dragon.lookAt(0, 0, 0);
        
        // Fly path
        new TWEEN.Tween(this.dragon.position)
            .to({ x: targetX, y: 40, z: targetZ }, 2000)
            .easing(TWEEN.Easing.Cubic.Out)
            .onUpdate(() => {
                this.dragon.lookAt(targetX, 0, targetZ);
            })
            .onComplete(() => {
                SFX.dragonRoar();
                this.dragonBreath(targetX, targetZ);
                // Fly away
                new TWEEN.Tween(this.dragon.position)
                    .to({ x: -100, y: 150, z: -100 }, 3000)
                    .start();
            })
            .start();
    },

    dragonBreath: function(tx, tz) {
        // Particle/Beam effect
        const beamGeo = new THREE.CylinderGeometry(0.5, 4, 40, 8);
        beamGeo.rotateX(-Math.PI/2);
        const beam = new THREE.Mesh(beamGeo, this.materials.glow);
        beam.position.copy(this.dragon.position);
        beam.lookAt(tx, 0, tz);
        this.scene.add(beam);
        
        new TWEEN.Tween(beam.scale).to({ x:0, y:0, z:0 }, 500).onComplete(()=>this.scene.remove(beam)).start();
        
        // INSTANT CITY BUILD TRIGGER
        setTimeout(() => {
            this.buildOutpost(tx, tz);
        }, 200);
    },

    queueBuild: function(type, count) {
        for(let i=0; i<count; i++) this.buildQueue.push(type);
    },

    processBuildQueue: function() {
        if(this.buildQueue.length === 0) return;
        
        const type = this.buildQueue.shift();
        const geo = new THREE.BoxGeometry(2, 2, 2);
        let mat = this.materials.stone;
        
        // Calculate Position
        let x=0, y=0, z=0;
        
        if(type === 'KEEP') {
            // Spiral upward
            const angle = this.cursor.ring * 0.5;
            const rad = 4 + (this.cursor.y * 0.2);
            x = Math.cos(angle) * rad;
            z = Math.sin(angle) * rad;
            y = this.cursor.y;
            this.cursor.ring++;
            if(this.cursor.ring > 12) { this.cursor.ring = 0; this.cursor.y += 2; }
        } else if (type === 'BRIDGE') {
            mat = this.materials.bridge;
            // Bridge Logic handled elsewhere, this is dummy fallback
        }

        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(x, y + 50, z);
        mesh.castShadow = true;
        this.scene.add(mesh);

        new TWEEN.Tween(mesh.position).to({ y: y }, 500).easing(TWEEN.Easing.Bounce.Out).start();
    },

    buildOutpost: function(cx, cz) {
        // Builds a tower cluster at specific coordinates instantly
        for(let i=0; i<15; i++) {
            const h = i * 2;
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(3, 2, 3), this.materials.stone);
            mesh.position.set(cx, h + 50, cz);
            this.scene.add(mesh);
            // Cascading drop
            new TWEEN.Tween(mesh.position).to({ y: h }, 500 + (i*100)).easing(TWEEN.Easing.Bounce.Out).start();
        }
        // Connect Bridge
        this.buildBridge(0, 0, cx, cz);
    },

    buildBridge: function(x1, z1, x2, z2) {
        const dist = Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(z2-z1, 2));
        const steps = Math.floor(dist / 2);
        
        for(let i=0; i<steps; i++) {
            const t = i / steps;
            const x = x1 + (x2 - x1) * t;
            const z = z1 + (z2 - z1) * t;
            
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 2), this.materials.bridge);
            mesh.position.set(x, 10 + 50, z); // High bridge
            this.scene.add(mesh);
            
            new TWEEN.Tween(mesh.position)
                .to({ y: 10 + Math.sin(t*Math.PI)*5 }, 800 + (i*50)) // Arch shape
                .easing(TWEEN.Easing.Quadratic.Out)
                .start();
        }
    },

    animate: function(time) {
        requestAnimationFrame((t) => World.animate(t));
        TWEEN.update(time);
        
        // Build loop
        if(this.buildQueue.length > 0 && Math.random() > 0.5) this.processBuildQueue();

        // Animate Dragon Wings
        if(this.dragon) {
            const flap = Math.sin(time * 0.01) * 0.5;
            this.dragon.wings[0].rotation.z = flap;
            this.dragon.wings[1].rotation.z = -flap;
        }

        // Camera Orbit
        const camTime = Date.now() * 0.0001;
        this.camera.position.x = Math.cos(camTime) * 80;
        this.camera.position.z = Math.sin(camTime) * 80;
        this.camera.lookAt(0, 15, 0);

        this.renderer.render(this.scene, this.camera);
    }
};

/* =========================================================================
   GAME LOGIC & EGG HUNT
   ========================================================================= */
const Game = {
    gold: 500,
    mass: 20,
    bet: 20,
    spinning: false,
    auto: false,
    symbols: [
        { char: 'üß±', type: 'wall' }, { char: 'üõ°Ô∏è', type: 'wall' }, 
        { char: 'üí∞', type: 'gold' }, { char: 'üè∞', type: 'rare' }, 
        { char: 'üêâ', type: 'dragon' }
    ],

    init: function() {
        this.createReels();
        document.getElementById('ui-gold').innerText = this.gold;
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<5; i++) {
            const strip = document.createElement('div');
            strip.className = 'reel-strip';
            strip.id = `reel-${i}`;
            for(let j=0; j<3; j++) {
                const el = document.createElement('div');
                el.className = 'symbol';
                el.textContent = this.randSym().char;
                strip.appendChild(el);
            }
            c.appendChild(strip);
        }
    },

    randSym: function() { return this.symbols[Math.floor(Math.random()*this.symbols.length)]; },

    spin: async function() {
        if(this.spinning) return;
        if(this.gold < this.bet) { this.toast("NO GOLD", "red"); this.auto = false; return; }
        
        this.spinning = true;
        this.gold -= this.bet;
        this.updateUI();
        SFX.spin();

        // Simulate Spin
        const grid = [];
        for(let i=0; i<5; i++) {
            const col = [this.randSym(), this.randSym(), this.randSym()];
            grid.push(col);
            
            const strip = document.getElementById(`reel-${i}`);
            strip.style.transition = 'transform 0.2s';
            strip.style.transform = 'translateY(20px)';
            
            await new Promise(r => setTimeout(r, 100));
            // Update Visuals
            Array.from(strip.children).forEach((el, idx) => el.textContent = col[idx].char);
            strip.style.transform = 'translateY(0)';
        }

        this.checkWin(grid);
        this.spinning = false;
        if(this.auto && !document.getElementById('egg-hunt-layer').classList.contains('active')) {
            setTimeout(() => this.spin(), 800);
        }
    },

    checkWin: function(grid) {
        const flat = grid.flat();
        const dragons = flat.filter(s => s.type === 'dragon').length;
        const walls = flat.filter(s => s.type === 'wall').length;

        // Build walls logic
        if(walls > 2) {
            World.queueBuild('KEEP', walls);
            this.mass += walls;
        }

        // TRIGGER THE INNER GAME
        if(dragons >= 2) {
            this.startEggHunt();
        } else if (walls > 2) {
            this.toast(`BUILDING... +${walls} BLOCKS`);
        }

        this.updateUI();
    },

    // --- INNER GAME: DRAGON EGG HUNT ---
    startEggHunt: function() {
        this.auto = false; // Stop auto spin
        document.getElementById('slot-machine').classList.add('minimized');
        const modal = document.getElementById('egg-hunt-layer');
        modal.classList.add('active');
        
        // Generate Eggs
        const grid = document.getElementById('egg-grid');
        grid.innerHTML = '';
        document.getElementById('close-egg-btn').style.display = 'none';
        
        // 9 Eggs: 1 connects city, others gold
        for(let i=0; i<3; i++) {
            const egg = document.createElement('div');
            egg.className = 'dragon-egg';
            const content = Math.random() > 0.7 ? 'üèóÔ∏è' : 'üí∞'; // City or Gold
            
            egg.innerHTML = `<div class="egg-content">${content}</div>`;
            egg.onclick = () => this.crackEgg(egg, content);
            grid.appendChild(egg);
        }
    },

    crackEgg: function(el, content) {
        if(el.classList.contains('cracked')) return;
        el.classList.add('cracked');
        SFX.crack();
        
        if(content === 'üí∞') {
            const amt = 50 + Math.floor(Math.random()*100);
            this.gold += amt;
            this.toast(`ANCIENT GOLD! +${amt}`);
        } else if (content === 'üèóÔ∏è') {
            // TRIGGER WORLD EVENT
            SFX.magic();
            this.toast("CITY FOUNDATION DISCOVERED!");
            this.closeEggHunt();
            
            // Initiate Dragon Build Sequence
            const angle = Math.random() * Math.PI * 2;
            const dist = 60 + Math.floor(Math.random() * 40);
            const tx = Math.cos(angle) * dist;
            const tz = Math.sin(angle) * dist;
            
            setTimeout(() => World.summonDragon(tx, tz), 500);
        }
        this.updateUI();
        
        // Show close button after first click
        document.getElementById('close-egg-btn').style.display = 'block';
    },

    closeEggHunt: function() {
        document.getElementById('egg-hunt-layer').classList.remove('active');
        document.getElementById('slot-machine').classList.remove('minimized');
    },

    updateUI: function() {
        document.getElementById('ui-gold').innerText = this.gold;
        document.getElementById('ui-mass').innerText = this.mass;
    },

    toast: function(msg, col='#fff') {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.color = col;
        t.classList.add('active');
        setTimeout(() => t.classList.remove('active'), 2000);
    }
};

window.initGame = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init(); World.init(); Game.init();
};
window.spin = () => Game.spin();
window.toggleAuto = () => { Game.auto = !Game.auto; if(Game.auto) Game.spin(); };
window.closeEggHunt = () => Game.closeEggHunt();

</script>
</body>
</html>
