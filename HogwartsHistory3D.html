<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sovereign's Forge: Ultimate Architect</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: #000; overflow: hidden; font-family: 'Cinzel', serif; color: #d4af37; }

        /* --- 3D VIEWPORT --- */
        #viewport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle at center, #111 0%, #000 100%); }

        /* --- UI LAYER --- */
        #ui-layer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; display: flex; justify-content: center; padding-bottom: 20px; }

        /* --- QUEST HUD (Top Right) --- */
        #quest-panel {
            position: fixed; top: 20px; right: 20px; width: 300px;
            background: rgba(0,0,0,0.8); border: 2px solid #d4af37;
            padding: 15px; border-radius: 8px; z-index: 10;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            font-family: 'Roboto Mono', monospace;
            transform: translateX(120%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #quest-panel.active { transform: translateX(0); }
        .quest-title { color: #ffaa00; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .quest-name { color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 10px; font-family: 'Cinzel', serif; }
        .progress-container { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-bottom: 5px; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8c00, #ffff00); transition: width 0.3s; }
        .quest-status { font-size: 12px; color: #aaa; text-align: right; }

        /* --- SLOT MACHINE --- */
        .machine-frame {
            pointer-events: auto; width: 95%; max-width: 800px;
            background: linear-gradient(180deg, #222 0%, #111 100%);
            border: 4px solid #5e4b35; border-image: linear-gradient(to bottom, #d4af37, #5e4b35) 1;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); padding: 15px;
            transition: opacity 0.3s;
        }
        .machine-frame.dimmed { opacity: 0.3; pointer-events: none; }

        .reels-window { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; background: #000; height: 160px; overflow: hidden; margin-bottom: 15px; border: 2px solid #333; }
        .reel-strip { transform: translateY(0); will-change: transform; }
        .symbol { height: 80px; display: flex; align-items: center; justify-content: center; font-size: 40px; background: #151515; border-bottom: 1px solid #222; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        
        .controls { display: flex; gap: 10px; }
        .btn { background: #332211; border: 1px solid #8c7352; color: #d4af37; padding: 15px; flex: 1; font-family: 'Cinzel'; font-weight: 900; font-size: 16px; cursor: pointer; transition: all 0.2s; }
        .btn:hover { background: #443322; }
        .btn.active { background: #aa0000; color: white; box-shadow: 0 0 15px #ff0000; border-color: red; }
        #btn-spin { flex: 2; background: linear-gradient(180deg, #4b0082, #2a004a); color: #fff; border-color: #8a2be2; }

        /* --- EGG HUNT UI --- */
        #minigame-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        #minigame-layer.active { display: flex; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        
        .egg-grid { display: flex; gap: 30px; margin-top: 30px; }
        .egg {
            width: 120px; height: 150px; background: radial-gradient(circle at 30% 30%, #400, #100);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            border: 3px solid #600; box-shadow: 0 0 30px #f00; cursor: pointer;
            position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .egg:hover { transform: scale(1.1); }
        .egg.cracked { opacity: 0.5; transform: scale(0.9); pointer-events: none; border-style: dashed; }
        .egg-reward { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 50px; opacity: 0; }
        .egg.cracked .egg-reward { opacity: 1; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: translate(-50%,-50%) scale(0); } 100% { transform: translate(-50%,-50%) scale(1); } }

        /* --- START SCREEN --- */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #overlay h1 { font-size: 3rem; color: #ffaa00; text-shadow: 0 0 30px #ff4500; margin-bottom: 20px; }
        #overlay button { padding: 20px 50px; font-size: 20px; font-weight: bold; background: #d4af37; border: none; cursor: pointer; font-family: 'Cinzel'; }

        /* --- TOAST --- */
        #toast { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 40px; color: #fff; text-shadow: 0 0 20px gold; pointer-events: none; z-index: 100; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #toast.active { transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body>

<div id="overlay">
    <h1>SOVEREIGN'S FORGE</h1>
    <p style="color:#888; margin-bottom: 40px;">Ultimate Architect Edition</p>
    <button onclick="initSystem()">INITIALIZE REALM</button>
</div>

<div id="viewport"></div>

<div id="quest-panel">
    <div class="quest-title">Royal Decree</div>
    <div class="quest-name" id="q-name">The Wizard's Spire</div>
    <div class="progress-container">
        <div class="progress-bar" id="q-bar"></div>
    </div>
    <div class="quest-status"><span id="q-current">0</span> / <span id="q-target">100</span> Blocks</div>
</div>

<div id="minigame-layer">
    <h1 style="color: #ff4500; text-shadow: 0 0 30px red;">DRAGON'S VAULT</h1>
    <p style="color: #aaa;">Choose an egg to reveal its power</p>
    <div class="egg-grid" id="egg-grid"></div>
</div>

<div id="toast">LEVEL UP!</div>

<div id="ui-layer">
    <div class="machine-frame" id="slot-machine">
        <div class="hud-header" style="display:flex; justify-content:space-between; color:#888; font-size:12px; margin-bottom:10px;">
            <div>TREASURY: <span id="ui-gold" style="color:white; font-size:16px;">1000</span></div>
            <div>REALM SIZE: <span id="ui-mass" style="color:white; font-size:16px;">0</span></div>
        </div>
        <div class="reels-window" id="reels-container"></div>
        <div class="controls">
            <button class="btn" id="btn-auto" onclick="toggleAuto()">AUTO: OFF</button>
            <button class="btn" id="btn-spin" onclick="spin()">CONSTRUCT (20g)</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* =========================================================================
   AUDIO & FX
   ========================================================================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    play: function(freq, type, dur, vol=0.1, slide=false) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) osc.frequency.exponentialRampToValueAtTime(freq/2, this.ctx.currentTime + dur);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + dur);
    },
    spin: () => SFX.play(100, 'sawtooth', 0.05, 0.05),
    thud: () => SFX.play(60, 'square', 0.2, 0.2, true),
    magic: () => [800, 1200, 1600].forEach((f,i) => setTimeout(() => SFX.play(f, 'sine', 0.3, 0.1), i*100)),
    levelUp: () => [440, 554, 659, 880, 1100].forEach((f,i) => setTimeout(() => SFX.play(f, 'triangle', 0.5, 0.1), i*80))
};

/* =========================================================================
   3D WORLD ENGINE
   ========================================================================= */
const World = {
    scene: null, camera: null, renderer: null,
    particles: [],
    materials: {},
    buildQueue: [],
    
    // Architect Cursor
    cursor: { x:0, y:0, z:0, ring:0 },
    
    init: function() {
        const cvs = document.getElementById('viewport');
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x050505, 0.015);
        
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
        this.camera.position.set(50, 40, 50);
        this.camera.lookAt(0, 10, 0);

        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        cvs.appendChild(this.renderer.domElement);

        // Lighting
        const amb = new THREE.AmbientLight(0x404050, 0.6);
        this.scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffaa00, 1.5);
        sun.position.set(100, 200, 50);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 2048; sun.shadow.mapSize.height = 2048;
        this.scene.add(sun);

        // Materials
        this.materials.stone = new THREE.MeshStandardMaterial({ color: 0x555566, roughness: 0.9 });
        this.materials.gold = new THREE.MeshStandardMaterial({ color: 0xffaa00, roughness: 0.2, metalness: 0.8 });
        this.materials.magic = new THREE.MeshStandardMaterial({ color: 0x8a2be2, emissive: 0x4b0082, emissiveIntensity: 1 });
        this.materials.ground = new THREE.MeshStandardMaterial({ color: 0x080808, roughness: 1 });

        // Ground
        const plane = new THREE.Mesh(new THREE.CircleGeometry(300, 64), this.materials.ground);
        plane.rotation.x = -Math.PI/2;
        plane.receiveShadow = true;
        this.scene.add(plane);

        this.animate();
        // Initial Build
        this.addBlocks('KEEP', 15);
        
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    },

    addBlocks: function(type, count, startX=0, startZ=0) {
        for(let i=0; i<count; i++) {
            this.buildQueue.push({ type, dx:startX, dz:startZ });
        }
    },

    processQueue: function() {
        if(this.buildQueue.length === 0) return;
        
        const task = this.buildQueue.shift();
        const geo = new THREE.BoxGeometry(2, 2, 2);
        let mat = this.materials.stone;
        let pos = {x:0, y:0, z:0};

        if(task.type === 'KEEP') {
            // Spiral
            const angle = this.cursor.ring * 0.6;
            const r = 5 + (this.cursor.y * 0.1);
            pos.x = Math.cos(angle) * r;
            pos.z = Math.sin(angle) * r;
            pos.y = this.cursor.y;
            this.cursor.ring++;
            if(this.cursor.ring > 10) { this.cursor.ring = 0; this.cursor.y += 2; }
        } else if (task.type === 'SPECIAL') {
            // Quest Building
            mat = this.materials.magic;
            pos.x = task.dx + (Math.random()*4-2);
            pos.z = task.dz + (Math.random()*4-2);
            pos.y = this.cursor.y + 10; // Floating structures
        }

        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(pos.x, pos.y + 60, pos.z);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        this.scene.add(mesh);

        // Tween Drop
        new TWEEN.Tween(mesh.position)
            .to({ y: pos.y }, 600)
            .easing(TWEEN.Easing.Bounce.Out)
            .onComplete(() => {
                SFX.thud();
                this.spawnParticles(pos.x, pos.y, pos.z, mat.color);
                // Camera Shake
                if(Math.random() > 0.8) {
                    new TWEEN.Tween(this.camera.position)
                        .to({ y: this.camera.position.y - 0.5 }, 50)
                        .yoyo(true).repeat(3).start();
                }
            })
            .start();
    },

    spawnParticles: function(x, y, z, color) {
        const geo = new THREE.BoxGeometry(0.3, 0.3, 0.3);
        const mat = new THREE.MeshBasicMaterial({ color: color });
        for(let i=0; i<8; i++) {
            const p = new THREE.Mesh(geo, mat);
            p.position.set(x, y, z);
            p.vel = {
                x: (Math.random()-0.5) * 0.4,
                y: Math.random() * 0.5,
                z: (Math.random()-0.5) * 0.4
            };
            this.scene.add(p);
            this.particles.push({ mesh: p, life: 1.0 });
        }
    },

    animate: function(time) {
        requestAnimationFrame((t) => World.animate(t));
        TWEEN.update(time);
        
        // Build Processing
        if(this.buildQueue.length > 0 && Math.random() > 0.3) this.processQueue();

        // Particles
        for(let i=this.particles.length-1; i>=0; i--) {
            const p = this.particles[i];
            p.mesh.position.add(p.vel);
            p.vel.y -= 0.02; // Gravity
            p.mesh.rotation.x += 0.1;
            p.life -= 0.02;
            if(p.life <= 0) {
                this.scene.remove(p.mesh);
                this.particles.splice(i, 1);
            }
        }

        // Camera Orbit
        const ct = Date.now() * 0.0001;
        this.camera.position.x = Math.cos(ct) * 60;
        this.camera.position.z = Math.sin(ct) * 60;
        this.camera.lookAt(0, this.cursor.y/2, 0);

        this.renderer.render(this.scene, this.camera);
    }
};

/* =========================================================================
   GAME LOGIC: SLOTS, QUESTS, AUTO
   ========================================================================= */
const Game = {
    gold: 1000,
    bet: 20,
    mass: 15,
    auto: false,
    spinning: false,
    
    // Symbols
    symbols: [
        { char: 'ðŸ§±', type: 'wall', val: 5 },
        { char: 'ðŸ“œ', type: 'blueprint', val: 10 }, // Quest Item
        { char: 'ðŸ’Ž', type: 'gem', val: 20 },
        { char: 'ðŸ‰', type: 'dragon', val: 50 }     // Minigame
    ],

    // Third Game: The Quest System
    quest: {
        active: true,
        name: "The Wizard's Spire",
        target: 50,
        current: 0,
        level: 1
    },

    init: function() {
        this.updateHUD();
        this.createReels();
        this.updateQuestUI();
        document.getElementById('quest-panel').classList.add('active');
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<5; i++) {
            const strip = document.createElement('div');
            strip.className = 'reel-strip';
            strip.id = `reel-${i}`;
            for(let j=0; j<3; j++) {
                const s = document.createElement('div');
                s.className = 'symbol';
                s.textContent = this.randSym().char;
                strip.appendChild(s);
            }
            c.appendChild(strip);
        }
    },

    randSym: function() { 
        // Blueprint bias if quest is active
        const r = Math.random();
        if(r > 0.85) return this.symbols[1]; // Blueprint
        if(r > 0.95) return this.symbols[3]; // Dragon
        return this.symbols[0]; // Wall
    },

    toggleAuto: function() {
        this.auto = !this.auto;
        const btn = document.getElementById('btn-auto');
        btn.textContent = this.auto ? "AUTO: ON" : "AUTO: OFF";
        btn.classList.toggle('active');
        if(this.auto && !this.spinning) this.spin();
    },

    spin: async function() {
        if(this.spinning) return;
        if(this.gold < this.bet) { this.toast("NO GOLD", "red"); this.auto = false; this.toggleAuto(); return; }
        
        this.spinning = true;
        this.gold -= this.bet;
        this.updateHUD();
        SFX.spin();

        // Simulate Spin
        const grid = [];
        for(let i=0; i<5; i++) {
            const col = [this.randSym(), this.randSym(), this.randSym()];
            grid.push(col);
            const strip = document.getElementById(`reel-${i}`);
            
            // Visual Blur
            strip.style.transition = 'transform 0.1s';
            strip.style.transform = 'translateY(10px)';
            await new Promise(r => setTimeout(r, 80));
            
            // Set Result
            Array.from(strip.children).forEach((el, idx) => el.textContent = col[idx].char);
            strip.style.transform = 'translateY(0)';
        }

        await new Promise(r => setTimeout(r, 200));
        this.checkWin(grid);
    },

    checkWin: function(grid) {
        const flat = grid.flat();
        const walls = flat.filter(s => s.type === 'wall').length;
        const blueprints = flat.filter(s => s.type === 'blueprint').length;
        const dragons = flat.filter(s => s.type === 'dragon').length;

        // 1. Basic Construction
        if(walls >= 3) {
            World.addBlocks('KEEP', walls);
            this.mass += walls;
        }

        // 2. Quest Progress (Third Game)
        if(blueprints > 0) {
            this.advanceQuest(blueprints);
        }

        // 3. Minigame Trigger
        if(dragons >= 2) {
            this.startMinigame();
            return; // Halt logic to wait for minigame
        }

        // Continue Auto?
        this.spinning = false;
        if(this.auto && !document.getElementById('minigame-layer').classList.contains('active')) {
            setTimeout(() => this.spin(), 500);
        }
        this.updateHUD();
    },

    // --- QUEST LOGIC ---
    advanceQuest: function(amount) {
        this.quest.current += amount * 2; // Multiplier
        if(this.quest.current >= this.quest.target) {
            this.quest.current = this.quest.target;
            this.completeQuest();
        }
        SFX.magic();
        this.updateQuestUI();
    },

    completeQuest: function() {
        this.toast(`DECREE FULFILLED!`);
        SFX.levelUp();
        
        // Massive Build Event
        World.addBlocks('SPECIAL', 30, Math.random()*40-20, Math.random()*40-20);
        this.gold += 500;
        
        // Next Quest
        setTimeout(() => {
            this.quest.level++;
            this.quest.current = 0;
            this.quest.target = Math.floor(this.quest.target * 1.5);
            this.quest.name = `Sanctuary Level ${this.quest.level}`;
            this.updateQuestUI();
        }, 2000);
    },

    updateQuestUI: function() {
        document.getElementById('q-name').innerText = this.quest.name;
        document.getElementById('q-current').innerText = this.quest.current;
        document.getElementById('q-target').innerText = this.quest.target;
        const pct = (this.quest.current / this.quest.target) * 100;
        document.getElementById('q-bar').style.width = `${pct}%`;
    },

    // --- MINIGAME: TRUE AUTO HANDLING ---
    startMinigame: function() {
        const modal = document.getElementById('minigame-layer');
        modal.classList.add('active');
        document.getElementById('slot-machine').classList.add('dimmed');
        
        const grid = document.getElementById('egg-grid');
        grid.innerHTML = '';
        
        // Create 3 eggs
        for(let i=0; i<3; i++) {
            const egg = document.createElement('div');
            egg.className = 'egg';
            const reward = Math.random() > 0.5 ? 'ðŸ’°' : 'ðŸ§±';
            egg.innerHTML = `<div class="egg-reward">${reward}</div>`;
            egg.onclick = () => this.resolveMinigame(egg, reward);
            grid.appendChild(egg);
        }

        // AUTO-PLAY THE MINIGAME
        if(this.auto) {
            this.toast("AUTO-SOLVING PUZZLE...", "#aaa");
            setTimeout(() => {
                const eggs = document.querySelectorAll('.egg');
                const randomEgg = eggs[Math.floor(Math.random() * eggs.length)];
                if(randomEgg) randomEgg.click();
            }, 1500);
        }
    },

    resolveMinigame: function(el, reward) {
        if(el.classList.contains('cracked')) return;
        el.classList.add('cracked');
        SFX.thud();

        if(reward === 'ðŸ’°') {
            const win = 200;
            this.gold += win;
            this.toast(`VAULT LOOT! +${win}g`);
        } else {
            const build = 20;
            World.addBlocks('KEEP', build);
            this.mass += build;
            this.toast(`ANCIENT BRICKS! +${build}`);
        }

        // Close after delay
        setTimeout(() => {
            document.getElementById('minigame-layer').classList.remove('active');
            document.getElementById('slot-machine').classList.remove('dimmed');
            this.spinning = false;
            if(this.auto) this.spin();
        }, 1500);
    },

    updateHUD: function() {
        document.getElementById('ui-gold').innerText = this.gold;
        document.getElementById('ui-mass').innerText = this.mass;
    },

    toast: function(msg, col='gold') {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.textShadow = `0 0 20px ${col}`;
        t.classList.add('active');
        setTimeout(() => t.classList.remove('active'), 2000);
    }
};

window.initSystem = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init(); World.init(); Game.init();
};
window.toggleAuto = () => Game.toggleAuto();
window.spin = () => Game.spin();

</script>
</body>
</html>
