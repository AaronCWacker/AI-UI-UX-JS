<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Civ 9: Swarm Command</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: #000; overflow: hidden; font-family: 'Rajdhani', sans-serif; color: #00ffcc; }

        #viewport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle at center, #050510 0%, #000 100%); }

        /* --- HUD --- */
        #hud {
            position: fixed; top: 20px; left: 20px; z-index: 10;
            background: rgba(0, 20, 40, 0.8); border: 1px solid #00ffcc;
            padding: 15px; width: 220px;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            font-size: 14px;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-val { font-weight: bold; color: #fff; }
        .bar-bg { width: 100%; height: 4px; background: #333; margin-bottom: 10px; }
        .bar-fill { height: 100%; width: 50%; background: #00ffcc; transition: width 0.2s; }
        
        /* --- SLOT MACHINE --- */
        #ui-layer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 10; display: flex; justify-content: center; padding-bottom: 20px; pointer-events: none; }
        
        .machine-frame {
            pointer-events: auto; width: 350px;
            background: linear-gradient(180deg, #111 0%, #000 100%);
            border: 2px solid #333; border-top: 4px solid #ff0055;
            padding: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        
        .reels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; background: #000; height: 100px; margin-bottom: 10px; border: 1px solid #222; overflow: hidden; }
        .reel-strip { transform: translateY(0); }
        .symbol { height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px; background: #0a0a0a; border-right: 1px solid #222; }

        .controls { display: flex; gap: 5px; }
        .btn { background: #222; color: #888; border: 1px solid #444; flex: 1; padding: 15px; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn:hover { background: #333; color: white; }
        .btn.active { background: #004433; color: #00ffcc; border-color: #00ffcc; }
        #btn-spin { background: #330011; color: #ff0055; border-color: #ff0055; flex: 2; }
        #btn-spin:active { transform: scale(0.95); }

        /* --- TOAST --- */
        #toast {
            position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%) scale(0);
            font-size: 40px; font-weight: 900; color: white; text-shadow: 0 0 20px red;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; z-index: 100; text-align: center;
        }
        #toast.active { transform: translate(-50%, -50%) scale(1); }
        .sub-toast { font-size: 16px; color: #aaa; display: block; margin-top: 5px; }

        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:200; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #overlay h1 { font-size: 3rem; color: #ff0055; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; }
        #overlay button { padding: 15px 40px; font-size: 20px; background: #00ffcc; border: none; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

<div id="overlay">
    <h1>Civ 9: Swarm Command</h1>
    <p style="color:#666; margin-bottom:30px;">Grow Population. Gather Energy. Defend the Hive.</p>
    <button onclick="initSim()">INITIALIZE SIMULATION</button>
</div>

<div id="viewport"></div>

<div id="hud">
    <div class="stat-row"><span>POPULATION</span> <span id="ui-pop" class="stat-val">0</span></div>
    <div class="bar-bg"><div id="bar-pop" class="bar-fill" style="width:0%"></div></div>
    
    <div class="stat-row"><span>FOOD SUPPLY</span> <span id="ui-food" class="stat-val">100</span></div>
    <div class="bar-bg"><div id="bar-food" class="bar-fill" style="width:100%; background:#ffaa00;"></div></div>
    
    <div class="stat-row" style="margin-top:10px;"><span>THREAT LEVEL</span> <span id="ui-threat" class="stat-val" style="color:#ff0055">SAFE</span></div>
</div>

<div id="toast">TITAN DETECTED<span class="sub-toast">Swarm Engaging!</span></div>

<div id="ui-layer">
    <div class="machine-frame">
        <div class="reels" id="reels-container"></div>
        <div class="controls">
            <button class="btn" id="btn-auto" onclick="toggleAuto()">AUTO</button>
            <button class="btn" id="btn-spin" onclick="spin()">DEPLOY (10 Food)</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* =========================================================================
   AUDIO (Synthed)
   ========================================================================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    play: function(freq, type, dur, vol=0.1) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    born: () => SFX.play(800, 'sine', 0.1, 0.05),
    die: () => SFX.play(150, 'sawtooth', 0.2, 0.05),
    laser: () => {
        if(!SFX.ctx) return;
        const o = SFX.ctx.createOscillator();
        const g = SFX.ctx.createGain();
        o.frequency.setValueAtTime(600, SFX.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(100, SFX.ctx.currentTime + 0.1);
        g.gain.setValueAtTime(0.05, SFX.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, SFX.ctx.currentTime + 0.1);
        o.connect(g); g.connect(SFX.ctx.destination);
        o.start(); o.stop(SFX.ctx.currentTime + 0.1);
    },
    alarm: () => [400, 300].forEach((f,i)=>setTimeout(()=>SFX.play(f, 'square', 0.2, 0.1), i*200))
};

/* =========================================================================
   SIMULATION ENGINE (Three.js)
   ========================================================================= */
const Sim = {
    scene: null, camera: null, renderer: null,
    entities: [],
    enemies: [],
    resources: [],
    projectiles: [],
    
    // Config
    maxPop: 150,
    bounds: 40,
    
    init: function() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x000000, 0.02);
        
        this.camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 1000);
        this.camera.position.set(0, 60, 60);
        this.camera.lookAt(0, 0, 0);

        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('viewport').appendChild(this.renderer.domElement);

        // Lights
        const light = new THREE.PointLight(0x00ffcc, 1, 100);
        light.position.set(0, 20, 0);
        this.scene.add(light);
        this.scene.add(new THREE.AmbientLight(0x222233));

        // Grid Floor
        const grid = new THREE.GridHelper(100, 20, 0x004433, 0x111111);
        this.scene.add(grid);

        // Materials
        this.matAgent = new THREE.MeshBasicMaterial({ color: 0x00ffcc });
        this.matEnemy = new THREE.MeshBasicMaterial({ color: 0xff0055, wireframe: true });
        this.matRes = new THREE.MeshBasicMaterial({ color: 0xffaa00 });

        this.animate();
        
        // Resize
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    },

    // --- SPAWN LOGIC ---
    spawnAgent: function(count) {
        for(let i=0; i<count; i++) {
            if(this.entities.length >= this.maxPop) return;
            
            const geo = new THREE.TetrahedronGeometry(0.5);
            const mesh = new THREE.Mesh(geo, this.matAgent);
            
            // Spawn near center
            const ang = Math.random() * Math.PI * 2;
            const rad = Math.random() * 10;
            mesh.position.set(Math.cos(ang)*rad, 0.5, Math.sin(ang)*rad);
            
            this.scene.add(mesh);
            
            this.entities.push({
                mesh: mesh,
                age: 0,
                maxAge: 500 + Math.random()*500, // Short life
                state: 'IDLE', // IDLE, ATTACK, HARVEST
                target: null,
                speed: 0.1 + Math.random()*0.1
            });
            SFX.born();
        }
    },

    spawnEnemy: function() {
        // A TITAN
        const geo = new THREE.IcosahedronGeometry(4, 1);
        const mesh = new THREE.Mesh(geo, this.matEnemy);
        mesh.position.set((Math.random()-0.5)*60, 4, (Math.random()-0.5)*60);
        this.scene.add(mesh);
        
        this.enemies.push({
            mesh: mesh,
            hp: 200,
            maxHp: 200
        });
        
        // Alert
        document.getElementById('toast').classList.add('active');
        document.getElementById('ui-threat').innerText = "CRITICAL";
        SFX.alarm();
        
        setTimeout(() => document.getElementById('toast').classList.remove('active'), 3000);
    },

    spawnResource: function(count) {
        for(let i=0; i<count; i++) {
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mesh = new THREE.Mesh(geo, this.matRes);
            const pos = { x: (Math.random()-0.5)*70, z: (Math.random()-0.5)*70 };
            mesh.position.set(pos.x, 0.5, pos.z);
            
            this.scene.add(mesh);
            this.resources.push({ mesh: mesh, val: 10 });
        }
    },

    // --- GAME LOOP ---
    animate: function() {
        requestAnimationFrame(() => Sim.animate());

        // 1. Manage Enemies
        if(this.enemies.length === 0 && document.getElementById('ui-threat').innerText === "CRITICAL") {
            document.getElementById('ui-threat').innerText = "SAFE";
        }
        
        for(let i=this.enemies.length-1; i>=0; i--) {
            const e = this.enemies[i];
            e.mesh.rotation.x += 0.01;
            e.mesh.rotation.y += 0.02;
            if(e.hp <= 0) {
                // Die logic
                this.scene.remove(e.mesh);
                this.enemies.splice(i, 1);
                Game.addFood(100); // Loot
            }
        }

        // 2. Manage Agents
        for(let i=this.entities.length-1; i>=0; i--) {
            const a = this.entities[i];
            
            // Age
            a.age++;
            if(a.age > a.maxAge) {
                this.scene.remove(a.mesh);
                this.entities.splice(i, 1);
                SFX.die();
                continue;
            }

            // AI LOGIC
            // Priority 1: Attack Enemies
            if(this.enemies.length > 0) {
                a.target = this.enemies[0]; // Hive mind target
                a.state = 'ATTACK';
            } else if (this.resources.length > 0) {
                // Priority 2: Harvest
                if(!a.target || a.target.dead) {
                    // Find closest
                    let closest = null;
                    let minD = 999;
                    for(let r of this.resources) {
                        const d = a.mesh.position.distanceTo(r.mesh.position);
                        if(d < minD) { minD = d; closest = r; }
                    }
                    a.target = closest;
                    a.state = 'HARVEST';
                }
            } else {
                a.state = 'IDLE';
                a.target = null;
            }

            // Movement
            if(a.target) {
                const tx = a.target.mesh.position.x;
                const tz = a.target.mesh.position.z;
                const dx = tx - a.mesh.position.x;
                const dz = tz - a.mesh.position.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                
                if(dist > 3) {
                    a.mesh.position.x += (dx/dist) * a.speed;
                    a.mesh.position.z += (dz/dist) * a.speed;
                    a.mesh.lookAt(tx, 0.5, tz);
                } else {
                    // Action range
                    if(a.state === 'ATTACK') {
                        // Shoot laser
                        if(a.age % 20 === 0) {
                            this.fireProjectile(a.mesh.position, a.target.mesh.position);
                            a.target.hp--;
                            SFX.laser();
                        }
                    } else if (a.state === 'HARVEST') {
                        // Gather
                        if(a.age % 30 === 0) {
                            Game.addFood(1);
                            // Visual beam
                            this.fireProjectile(a.mesh.position, a.target.mesh.position, 0xffaa00);
                        }
                    }
                }
            } else {
                // Idle wander
                a.mesh.rotation.y += 0.1;
            }
        }
        
        // 3. Projectiles (Visuals only)
        for(let i=this.projectiles.length-1; i>=0; i--) {
            const p = this.projectiles[i];
            p.life--;
            if(p.life <= 0) {
                this.scene.remove(p.mesh);
                this.projectiles.splice(i, 1);
            }
        }

        this.renderer.render(this.scene, this.camera);
    },

    fireProjectile: function(start, end, color=0x00ffcc) {
        const geo = new THREE.BufferGeometry().setFromPoints([start, end]);
        const mat = new THREE.LineBasicMaterial({ color: color });
        const line = new THREE.Line(geo, mat);
        this.scene.add(line);
        this.projectiles.push({ mesh: line, life: 5 }); // lasts 5 frames
    }
};

/* =========================================================================
   GAME LOGIC (Slot Machine Controller)
   ========================================================================= */
const Game = {
    food: 100,
    spinning: false,
    auto: false,
    
    // Symbols
    symbols: [
        { char: 'ðŸ§¬', type: 'spawn', val: 5 }, // Spawn 5 agents
        { char: 'ðŸ“¦', type: 'res', val: 3 },   // Spawn 3 resource crates
        { char: 'ðŸ‘¹', type: 'boss', val: 1 }   // Spawn Enemy
    ],

    init: function() {
        this.updateHUD();
        this.createReels();
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<3; i++) {
            const strip = document.createElement('div');
            strip.className = 'reel-strip';
            strip.id = `reel-${i}`;
            const sym = document.createElement('div');
            sym.className = 'symbol';
            sym.textContent = this.randSym().char;
            strip.appendChild(sym);
            c.appendChild(strip);
        }
    },

    randSym: function() {
        const r = Math.random();
        if(r > 0.95) return this.symbols[2]; // Boss (Rare)
        if(r > 0.6) return this.symbols[0];  // DNA
        return this.symbols[1]; // Resource
    },

    addFood: function(amt) {
        this.food += amt;
        this.updateHUD();
    },

    toggleAuto: function() {
        this.auto = !this.auto;
        document.getElementById('btn-auto').classList.toggle('active');
        if(this.auto && !this.spinning) this.spin();
    },

    spin: async function() {
        if(this.spinning) return;
        if(this.food < 10) { 
            this.auto = false; 
            document.getElementById('btn-auto').classList.remove('active');
            alert("STARVATION! Not enough food to spawn."); 
            return; 
        }

        this.spinning = true;
        this.food -= 10;
        this.updateHUD();

        // Spin Animation
        const results = [];
        for(let i=0; i<3; i++) {
            const strip = document.getElementById(`reel-${i}`);
            strip.style.transition = 'transform 0.1s';
            strip.style.transform = 'translateY(20px)';
            await new Promise(r => setTimeout(r, 100));
            
            const sym = this.randSym();
            results.push(sym);
            strip.children[0].textContent = sym.char;
            strip.style.transform = 'translateY(0)';
        }
        
        this.processResults(results);
    },

    processResults: function(results) {
        const dna = results.filter(s => s.type === 'spawn').length;
        const res = results.filter(s => s.type === 'res').length;
        const boss = results.filter(s => s.type === 'boss').length;

        if(dna > 0) Sim.spawnAgent(dna * 5); // 1 icon = 5 agents
        if(res > 0) Sim.spawnResource(res * 2);
        if(boss > 0) Sim.spawnEnemy();

        this.spinning = false;
        if(this.auto) setTimeout(() => this.spin(), 500);
    },

    updateHUD: function() {
        const pop = Sim.entities.length;
        document.getElementById('ui-pop').innerText = pop;
        document.getElementById('bar-pop').style.width = `${Math.min(100, (pop/Sim.maxPop)*100)}%`;
        
        document.getElementById('ui-food').innerText = Math.floor(this.food);
    }
};

window.initSim = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init();
    Sim.init();
    Game.init();
    
    // Game Loop for UI updates
    setInterval(() => Game.updateHUD(), 500);
};
window.toggleAuto = () => Game.toggleAuto();
window.spin = () => Game.spin();

</script>
</body>
</html>
