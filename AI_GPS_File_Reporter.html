<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIP Code Map with Squarified Treemap Explorer</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #0c0a1e;
            color: #e0e0e0;
            display: flex;
            flex-direction: row;
        }
        #main-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100vh;
        }
        #map-container {
            width: 50%;
            height: 100%;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #map p {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #555;
        }
        #treemap-section {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #f4f4f9;
        }
        #treemap-container {
            position: relative;
            width: 100%;
            flex-grow: 1;
            border: 1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        #search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #zip-input {
            padding: 8px;
            font-size: 1rem;
            width: 250px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .control-button {
            background-color: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-button:hover {
            background-color: #2563eb;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #timer-display {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            min-width: 80px;
            text-align: center;
        }
        .folder-picker-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 1rem;
        }
        .folder-picker-label:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        #folder-picker {
            display: none;
        }
        #file-stats {
            padding: 1rem;
            background-color: #ecf0f1;
            border-top: 1px solid #ccc;
            text-align: left;
        }
        #file-stats p {
            margin: 0.5rem 0;
            color: #333;
        }
        .node-group {
            position: absolute;
            box-sizing: border-box;
            overflow: hidden;
        }
        .internal {
            border: 1px solid #aaa;
        }
        .leaf {
            background-clip: padding-box;
            box-shadow: inset 0px 0px 0px 1px rgba(255, 255, 255, 0.8);
            transition: filter 0.2s ease-in-out;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            cursor: pointer;
        }
        .leaf:hover {
            filter: brightness(1.15);
            z-index: 10;
        }
        .node-label {
            display: block;
            padding: 2px 5px;
            color: #fff;
            background-color: rgba(0,0,0,0.4);
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-decoration: none;
            cursor: pointer;
        }
        .node-label:hover {
            background-color: rgba(0,0,0,0.6);
        }
        .leaf-label {
            padding: 3px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            text-align: left;
            font-size: 11px;
            white-space: normal;
            word-break: break-word;
            pointer-events: none;
        }
        #tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            z-index: 1001;
            transform: translate(15px, 10px);
        }
        #context-menu {
            position: fixed;
            display: none;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px;
            padding: 5px 0;
            z-index: 1000;
        }
        #context-menu button {
            display: block;
            width: 100%;
            padding: 8px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }
        #context-menu button:hover {
            background-color: #3498db;
            color: white;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content p {
            margin-bottom: 20px;
        }
        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        #modal-confirm {
            background-color: #e74c3c;
            color: white;
        }
        #modal-cancel {
            background-color: #bdc3c7;
        }
    </style>
</head>
<body>
    <!-- References:
    - A heuristic extending the Squarified treemapping algorithm: Abstract (https://arxiv.org/abs/1609.00754), PDF (https://arxiv.org/pdf/1609.00754)
    - Squarified Treemaps: PDF (https://vanwijk.win.tue.nl/stm.pdf)
    - Treemaps with Bounded Aspect Ratio: Abstract (https://arxiv.org/abs/1012.1749), PDF (https://arxiv.org/pdf/1012.1749)
    - Interactive Visualisation of Hierarchical Quantitative Data: an Evaluation: Abstract (https://www.arxiv.org/abs/1908.01277v1), PDF (https://www.arxiv.org/pdf/1908.01277v1)
    - Treemapping - Wikipedia: Article (https://en.wikipedia.org/wiki/Treemapping)
    - A Novel Algorithm for Real-time Procedural Generation of Building Floor Plans: HTML (https://ar5iv.labs.arxiv.org/html/1211.5842)
    - Fat Polygonal Partitions with Applications to Visualization and Embeddings: Abstract (https://arxiv.org/abs/1009.1866), PDF (https://arxiv.org/pdf/1009.1866)
    - Tiling heuristics and evaluation metrics for treemaps with a target node aspect ratio: PDF (https://www.diva-portal.org/smash/get/diva2:1129639/FULLTEXT01.pdf)
    -->
    <div id="main-container">
        <div id="map-container">
            <div id="search-container">
                <input id="zip-input" type="text" placeholder="Enter ZIP prefix (e.g., 75) or state (e.g., TX)">
                <button id="current-location-button" class="control-button">Current Location</button>
                <button id="gps-timer-button" class="control-button">Start GPS Timer</button>
                <div id="timer-display"></div>
            </div>
            <div id="map"></div>
        </div>
        <div id="treemap-section">
            <label for="folder-picker" class="folder-picker-label">Choose a Folder</label>
            <input type="file" id="folder-picker" webkitdirectory directory multiple />
            <div id="file-stats">
                <p><strong>File Count:</strong> <span id="file-count">0</span></p>
                <p><strong>Earliest Created:</strong> <span id="earliest-created">-</span></p>
                <p><strong>Latest Created:</strong> <span id="latest-created">-</span></p>
                <p><strong>Earliest Modified:</strong> <span id="earliest-modified">-</span></p>
                <p><strong>Latest Modified:</strong> <span id="latest-modified">-</span></p>
            </div>
            <div id="treemap-container"></div>
        </div>
    </div>
    <div id="tooltip"></div>
    <div id="context-menu">
        <button id="menu-copy-path">Copy Path</button>
        <button id="menu-delete">Delete from View</button>
    </div>
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <p>This will only remove the item from the visualization.<br>It <strong>will not</strong> be deleted from your computer. Do you want to continue?</p>
            <button id="modal-confirm">Yes, Remove</button>
            <button id="modal-cancel">Cancel</button>
        </div>
    </div>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Esri Leaflet JavaScript -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ZIP Code Data
            const zipPrefixData = {
                "0": { lat: 40.0583, lng: -74.4057, name: "New Jersey", zoom: 6, radius: 150000 },
                "1": { lat: 42.4072, lng: -71.3824, name: "Massachusetts", zoom: 6, radius: 200000 },
                "2": { lat: 38.9072, lng: -77.0369, name: "District of Columbia", zoom: 6, radius: 100000 },
                "3": { lat: 33.7490, lng: -84.3880, name: "Georgia", zoom: 6, radius: 300000 },
                "4": { lat: 38.0406, lng: -84.5037, name: "Kentucky", zoom: 6, radius: 250000 },
                "5": { lat: 44.3148, lng: -85.6024, name: "Michigan", zoom: 6, radius: 300000 },
                "6": { lat: 41.8781, lng: -87.6298, name: "Illinois", zoom: 6, radius: 350000 },
                "7": { lat: 31.9686, lng: -99.9018, name: "Texas", zoom: 6, radius: 500000 },
                "8": { lat: 39.5501, lng: -105.7821, name: "Colorado", zoom: 6, radius: 300000 },
                "9": { lat: 47.7511, lng: -120.7401, name: "Washington", zoom: 6, radius: 350000 },
                "00": { lat: 40.0583, lng: -74.4057, name: "New Jersey (Trenton area)", zoom: 8, radius: 50000 },
                "01": { lat: 42.3601, lng: -71.0589, name: "Massachusetts (Boston area)", zoom: 8, radius: 50000 },
                "02": { lat: 41.7637, lng: -72.6851, name: "Connecticut (Hartford area)", zoom: 8, radius: 50000 },
                "03": { lat: 43.6615, lng: -70.2553, name: "Maine (Portland area)", zoom: 8, radius: 50000 },
                "04": { lat: 41.3083, lng: -72.9279, name: "Connecticut (New Haven area)", zoom: 8, radius: 50000 },
                "05": { lat: 41.8057, lng: -71.4082, name: "Rhode Island (Providence area)", zoom: 8, radius: 50000 },
                "06": { lat: 44.5588, lng: -72.5778, name: "Vermont (Montpelier area)", zoom: 8, radius: 50000 },
                "07": { lat: 40.2170, lng: -74.7429, name: "New Jersey (Trenton area)", zoom: 8, radius: 50000 },
                "08": { lat: 42.6526, lng: -73.7562, name: "New York (Albany area)", zoom: 8, radius: 50000 },
                "09": { lat: 42.8864, lng: -78.8784, name: "New York (Buffalo area)", zoom: 8, radius: 50000 },
                "10": { lat: 38.9072, lng: -77.0369, name: "District of Columbia", zoom: 8, radius: 50000 },
                "11": { lat: 38.8048, lng: -77.0469, name: "Virginia (Alexandria area)", zoom: 8, radius: 50000 },
                "12": { lat: 39.2904, lng: -76.6122, name: "Maryland (Baltimore area)", zoom: 8, radius: 50000 },
                "13": { lat: 38.8790, lng: -77.0105, name: "District of Columbia", zoom: 8, radius: 50000 },
                "14": { lat: 39.9526, lng: -75.1652, name: "Pennsylvania (Philadelphia area)", zoom: 8, radius: 50000 },
                "15": { lat: 40.4406, lng: -79.9959, name: "Pennsylvania (Pittsburgh area)", zoom: 8, radius: 50000 },
                "16": { lat: 39.7392, lng: -104.9903, name: "Colorado (Denver area)", zoom: 8, radius: 50000 },
                "17": { lat: 39.0997, lng: -94.5786, name: "Missouri (Kansas City area)", zoom: 8, radius: 50000 },
                "18": { lat: 39.7684, lng: -86.1581, name: "Indiana (Indianapolis area)", zoom: 8, radius: 50000 },
                "19": { lat: 38.6270, lng: -90.1994, name: "Missouri (St. Louis area)", zoom: 8, radius: 50000 },
                "20": { lat: 37.6872, lng: -97.3301, name: "Kansas (Wichita area)", zoom: 8, radius: 50000 },
                "21": { lat: 36.1627, lng: -86.7816, name: "Tennessee (Nashville area)", zoom: 8, radius: 50000 },
                "22": { lat: 34.0007, lng: -81.0348, name: "South Carolina (Columbia area)", zoom: 8, radius: 50000 },
                "23": { lat: 37.5407, lng: -77.4360, name: "Virginia (Richmond area)", zoom: 8, radius: 50000 },
                "24": { lat: 38.9784, lng: -76.4922, name: "Maryland (Annapolis area)", zoom: 8, radius: 50000 },
                "25": { lat: 25.7617, lng: -80.1918, name: "Florida (Miami area)", zoom: 8, radius: 50000 },
                "26": { lat: 28.5383, lng: -81.3792, name: "Florida (Orlando area)", zoom: 8, radius: 50000 },
                "27": { lat: 27.9506, lng: -82.4572, name: "Florida (Tampa area)", zoom: 8, radius: 50000 },
                "28": { lat: 33.7490, lng: -84.3880, name: "Georgia (Atlanta area)", zoom: 8, radius: 50000 },
                "29": { lat: 30.3322, lng: -81.6557, name: "Florida (Jacksonville area)", zoom: 8, radius: 50000 },
                "30": { lat: 32.7765, lng: -79.9311, name: "South Carolina (Charleston area)", zoom: 8, radius: 50000 },
                "31": { lat: 33.5207, lng: -86.8025, name: "Alabama (Birmingham area)", zoom: 8, radius: 50000 },
                "32": { lat: 32.3668, lng: -86.3000, name: "Alabama (Montgomery area)", zoom: 8, radius: 50000 },
                "33": { lat: 34.7465, lng: -92.2896, name: "Arkansas (Little Rock area)", zoom: 8, radius: 50000 },
                "34": { lat: 35.1495, lng: -90.0490, name: "Tennessee (Memphis area)", zoom: 8, radius: 50000 },
                "35": { lat: 35.5951, lng: -82.5515, name: "North Carolina (Asheville area)", zoom: 8, radius: 50000 },
                "36": { lat: 36.1699, lng: -115.1398, name: "Nevada (Las Vegas area)", zoom: 8, radius: 50000 },
                "37": { lat: 36.8529, lng: -75.9780, name: "Virginia (Virginia Beach area)", zoom: 8, radius: 50000 },
                "38": { lat: 38.8339, lng: -104.8214, name: "Colorado (Colorado Springs area)", zoom: 8, radius: 50000 },
                "39": { lat: 39.9612, lng: -82.9988, name: "Ohio (Columbus area)", zoom: 8, radius: 50000 },
                "40": { lat: 35.4676, lng: -97.5164, name: "Oklahoma (Oklahoma City area)", zoom: 8, radius: 50000 },
                "41": { lat: 41.4993, lng: -81.6944, name: "Ohio (Cleveland area)", zoom: 8, radius: 50000 },
                "42": { lat: 39.1031, lng: -84.5120, name: "Ohio (Cincinnati area)", zoom: 8, radius: 50000 },
                "43": { lat: 42.3314, lng: -83.0458, name: "Michigan (Detroit area)", zoom: 8, radius: 50000 },
                "44": { lat: 39.7589, lng: -84.1916, name: "Ohio (Dayton area)", zoom: 8, radius: 50000 },
                "45": { lat: 43.6187, lng: -116.2146, name: "Idaho (Boise area)", zoom: 8, radius: 50000 },
                "46": { lat: 38.0406, lng: -84.5037, name: "Kentucky (Lexington area)", zoom: 8, radius: 50000 },
                "47": { lat: 35.9606, lng: -83.9207, name: "Tennessee (Knoxville area)", zoom: 8, radius: 50000 },
                "48": { lat: 42.9634, lng: -85.6681, name: "Michigan (Grand Rapids area)", zoom: 8, radius: 50000 },
                "49": { lat: 40.7608, lng: -111.8910, name: "Utah (Salt Lake City area)", zoom: 8, radius: 50000 },
                "50": { lat: 21.3069, lng: -157.8583, name: "Hawaii (Honolulu area)", zoom: 8, radius: 50000 },
                "51": { lat: 37.7749, lng: -122.4194, name: "California (San Francisco area)", zoom: 8, radius: 50000 },
                "52": { lat: 41.2524, lng: -95.9980, name: "Nebraska (Omaha area)", zoom: 8, radius: 50000 },
                "53": { lat: 43.0389, lng: -87.9065, name: "Wisconsin (Milwaukee area)", zoom: 8, radius: 50000 },
                "54": { lat: 38.2544, lng: -85.7594, name: "Kentucky (Louisville area)", zoom: 8, radius: 50000 },
                "55": { lat: 44.9778, lng: -93.2650, name: "Minnesota (Minneapolis area)", zoom: 8, radius: 50000 },
                "56": { lat: 44.8015, lng: -91.4985, name: "Wisconsin (Eau Claire area)", zoom: 8, radius: 50000 },
                "57": { lat: 40.7143, lng: -74.0060, name: "New York (New York City area)", zoom: 8, radius: 50000 },
                "58": { lat: 35.2271, lng: -80.8431, name: "North Carolina (Charlotte area)", zoom: 8, radius: 50000 },
                "59": { lat: 41.0814, lng: -81.5190, name: "Ohio (Akron area)", zoom: 8, radius: 50000 },
                "60": { lat: 33.4484, lng: -112.0740, name: "Arizona (Phoenix area)", zoom: 8, radius: 50000 },
                "61": { lat: 29.7604, lng: -95.3698, name: "Texas (Houston area)", zoom: 8, radius: 50000 },
                "62": { lat: 32.7357, lng: -97.1081, name: "Texas (Arlington area)", zoom: 8, radius: 50000 },
                "63": { lat: 36.5298, lng: -87.3595, name: "Tennessee (Clarksville area)", zoom: 8, radius: 50000 },
                "64": { lat: 38.2527, lng: -85.7585, name: "Kentucky (Louisville area)", zoom: 8, radius: 50000 },
                "65": { lat: 40.7128, lng: -74.0060, name: "New York (New York City area)", zoom: 8, radius: 50000 },
                "66": { lat: 13.4443, lng: 144.7937, name: "Guam", zoom: 8, radius: 50000 },
                "67": { lat: 18.2208, lng: -66.5901, name: "Puerto Rico (Aguadilla area)", zoom: 8, radius: 50000 },
                "68": { lat: 18.4655, lng: -66.1057, name: "Puerto Rico (San Juan area)", zoom: 8, radius: 50000 },
                "69": { lat: 18.2013, lng: -67.1452, name: "Puerto Rico (Mayaguez area)", zoom: 8, radius: 50000 },
                "70": { lat: 33.8361, lng: -117.9143, name: "California (Anaheim area)", zoom: 8, radius: 50000 },
                "71": { lat: 29.4241, lng: -98.4936, name: "Texas (San Antonio area)", zoom: 8, radius: 50000 },
                "72": { lat: 32.7767, lng: -96.7970, name: "Texas (Dallas area)", zoom: 8, radius: 50000 },
                "73": { lat: 30.2672, lng: -97.7431, name: "Texas (Austin area)", zoom: 8, radius: 50000 },
                "74": { lat: 27.8006, lng: -97.3964, name: "Texas (Corpus Christi area)", zoom: 8, radius: 50000 },
                "75": { lat: 32.7767, lng: -96.7970, name: "Texas (Dallas area)", zoom: 8, radius: 50000 },
                "76": { lat: 33.5779, lng: -101.8552, name: "Texas (Lubbock area)", zoom: 8, radius: 50000 },
                "77": { lat: 31.1171, lng: -97.7278, name: "Texas (Killeen area)", zoom: 8, radius: 50000 },
                "78": { lat: 29.4241, lng: -98.4936, name: "Texas (San Antonio area)", zoom: 8, radius: 50000 },
                "79": { lat: 30.6270, lng: -96.3344, name: "Texas (College Station area)", zoom: 8, radius: 50000 },
                "80": { lat: 33.6846, lng: -117.8265, name: "California (Irvine area)", zoom: 8, radius: 50000 },
                "81": { lat: 32.7157, lng: -117.1611, name: "California (San Diego area)", zoom: 8, radius: 50000 },
                "82": { lat: 34.0522, lng: -118.2437, name: "California (Los Angeles area)", zoom: 8, radius: 50000 },
                "83": { lat: 37.3382, lng: -121.8863, name: "California (San Jose area)", zoom: 8, radius: 50000 },
                "84": { lat: 34.4208, lng: -119.6982, name: "California (Santa Barbara area)", zoom: 8, radius: 50000 },
                "85": { lat: 35.3733, lng: -119.0187, name: "California (Bakersfield area)", zoom: 8, radius: 50000 },
                "86": { lat: 36.7468, lng: -119.7726, name: "California (Fresno area)", zoom: 8, radius: 50000 },
                "87": { lat: 38.5816, lng: -121.4944, name: "California (Sacramento area)", zoom: 8, radius: 50000 },
                "88": { lat: 37.7652, lng: -122.2416, name: "California (Oakland area)", zoom: 8, radius: 50000 },
                "89": { lat: 39.5296, lng: -119.8138, name: "Nevada (Reno area)", zoom: 8, radius: 50000 },
                "90": { lat: 45.5231, lng: -122.6765, name: "Oregon (Portland area)", zoom: 8, radius: 50000 },
                "91": { lat: 47.6062, lng: -122.3321, name: "Washington (Seattle area)", zoom: 8, radius: 50000 },
                "92": { lat: 61.2181, lng: -149.9003, name: "Alaska (Anchorage area)", zoom: 8, radius: 50000 },
                "93": { lat: 44.9778, lng: -93.2650, name: "Minnesota (Minneapolis area)", zoom: 8, radius: 50000 },
                "94": { lat: 37.5485, lng: -121.9886, name: "California (Fremont area)", zoom: 8, radius: 50000 },
                "95": { lat: 39.3643, lng: -74.4229, name: "New Jersey (Atlantic City area)", zoom: 8, radius: 50000 },
                "96": { lat: 35.0078, lng: -97.0929, name: "Oklahoma (Norman area)", zoom: 8, radius: 50000 },
                "97": { lat: 44.9537, lng: -93.0900, name: "Minnesota (St. Paul area)", zoom: 8, radius: 50000 },
                "98": { lat: 26.3017, lng: -98.1633, name: "Texas (McAllen area)", zoom: 8, radius: 50000 },
                "99": { lat: 47.7511, lng: -120.7401, name: "Washington (Wenatchee area)", zoom: 8, radius: 50000 },
                "750": { lat: 33.0198, lng: -96.6989, name: "Plano, TX", zoom: 10, radius: 10000 },
                "751": { lat: 32.5993, lng: -96.9389, name: "Waxahachie, TX", zoom: 10, radius: 10000 },
                "752": { lat: 32.7767, lng: -96.7970, name: "Dallas, TX", zoom: 10, radius: 10000 },
                "753": { lat: 32.8140, lng: -96.8700, name: "Dallas, TX (PO Boxes)", zoom: 10, radius: 10000 },
                "754": { lat: 33.4262, lng: -95.5439, name: "Sulphur Springs, TX", zoom: 10, radius: 10000 },
                "755": { lat: 33.4251, lng: -94.0477, name: "Texarkana, TX", zoom: 10, radius: 10000 },
                "756": { lat: 32.5007, lng: -94.7405, name: "Longview, TX", zoom: 10, radius: 10000 },
                "757": { lat: 32.3513, lng: -95.3011, name: "Tyler, TX", zoom: 10, radius: 10000 },
                "758": { lat: 31.8030, lng: -95.1566, name: "Palestine, TX", zoom: 10, radius: 10000 },
                "759": { lat: 31.2977, lng: -94.7218, name: "Lufkin, TX", zoom: 10, radius: 10000 },
                "780": { lat: 29.3627, lng: -98.6270, name: "San Antonio, TX", zoom: 10, radius: 10000 },
                "781": { lat: 29.5899, lng: -98.2289, name: "New Braunfels, TX", zoom: 10, radius: 10000 },
                "782": { lat: 29.4241, lng: -98.4936, name: "San Antonio, TX", zoom: 10, radius: 10000 },
                "783": { lat: 27.8006, lng: -97.3964, name: "Corpus Christi, TX", zoom: 10, radius: 10000 },
                "784": { lat: 27.8006, lng: -97.3964, name: "Corpus Christi, TX", zoom: 10, radius: 10000 },
                "785": { lat: 26.3017, lng: -98.1633, name: "McAllen, TX", zoom: 10, radius: 10000 },
                "786": { lat: 30.5083, lng: -97.6789, name: "Round Rock, TX", zoom: 10, radius: 10000 },
                "787": { lat: 30.2672, lng: -97.7431, name: "Austin, TX", zoom: 10, radius: 10000 },
                "788": { lat: 29.2072, lng: -99.7862, name: "Uvalde, TX", zoom: 10, radius: 10000 },
                "789": { lat: 29.9508, lng: -96.8783, name: "La Grange, TX", zoom: 10, radius: 10000 }
            };
            const stateData = {
                "TX": { lat: 31.9686, lng: -99.9018, name: "Texas", zoom: 6, radius: 500000 },
                "FL": { lat: 27.9944, lng: -81.7603, name: "Florida", zoom: 6, radius: 400000 },
                "NM": { lat: 34.5199, lng: -105.8701, name: "New Mexico", zoom: 6, radius: 300000 },
                "CA": { lat: 36.7783, lng: -119.4179, name: "California", zoom: 6, radius: 600000 },
                "WI": { lat: 44.5000, lng: -89.5000, name: "Wisconsin", zoom: 6, radius: 250000 },
                "MN": { lat: 46.7296, lng: -94.6859, name: "Minnesota", zoom: 6, radius: 300000 },
                "NY": { lat: 43.2994, lng: -74.2179, name: "New York", zoom: 6, radius: 350000 }
            };
            const cyclingStates = ["TX", "FL", "NM", "CA", "MN", "WI"];
            const cyclingPrefixes = [
                "71", "72", "73", "74", "75", "76", "77", "78", "79", "98",
                "25", "26", "27", "29", "30",
                "87", "88",
                "51", "70", "80", "81", "82", "83", "84", "85", "86", "87", "88", "94",
                "55", "93", "97",
                "53", "54", "56"
            ];

            // Map Initialization
            const mapContainer = document.getElementById('map');
            const zipInput = document.getElementById('zip-input');
            const currentLocationButton = document.getElementById('current-location-button');
            const gpsTimerButton = document.getElementById('gps-timer-button');
            const timerDisplay = document.getElementById('timer-display');
            let map, userMarker, areaCircle, searchTimeout, timerInterval;
            let timerRunning = false;
            let currentPrefixIndex = 0;

            function initializeMap(lat, lng, zoom = 6) {
                mapContainer.innerHTML = "";
                map = L.map('map').setView([lat, lng], zoom);
                L.esri.basemapLayer('Imagery').addTo(map);
                L.esri.basemapLayer('ImageryLabels').addTo(map);
                return map;
            }

            function addAreaCircle(lat, lng, radius, name) {
                if (areaCircle) map.removeLayer(areaCircle);
                areaCircle = L.circle([lat, lng], {
                    radius: radius,
                    color: '#ff00ff',
                    fillColor: '#ff00ff',
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(map);
                areaCircle.bindPopup(`<b>Area:</b> ${name}`);
            }

            function locateUser(zoom) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;
                            const locationData = { latitude, longitude };
                            localStorage.setItem('lastLocation', JSON.stringify(locationData));
                            if (userMarker) map.removeLayer(userMarker);
                            if (areaCircle) map.removeLayer(areaCircle);
                            map.setView([latitude, longitude], zoom);
                            userMarker = L.marker([latitude, longitude]).addTo(map);
                            userMarker.bindPopup(`<b>You are here!</b><br>Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`).openPopup();
                        },
                        (err) => {
                            let errorMessage = 'An unknown error occurred.';
                            switch (err.code) {
                                case err.PERMISSION_DENIED:
                                    errorMessage = 'Location access denied. Please enable it or use ZIP code/state search.';
                                    break;
                                case err.POSITION_UNAVAILABLE:
                                    errorMessage = 'Location information unavailable.';
                                    break;
                                case err.TIMEOUT:
                                    errorMessage = 'Location request timed out.';
                                    break;
                            }
                            L.popup()
                                .setLatLng(map.getCenter())
                                .setContent(`<p><strong>Error:</strong> ${errorMessage}</p>`)
                                .openOn(map);
                        }, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    L.popup()
                        .setLatLng(map.getCenter())
                        .setContent('<p>Sorry, Geolocation is not supported by your browser.</p>')
                        .openOn(map);
                }
            }

            // Treemap Initialization
            const folderPicker = document.getElementById('folder-picker');
            const treemapContainer = document.getElementById('treemap-container');
            const tooltip = document.getElementById('tooltip');
            const contextMenu = document.getElementById('context-menu');
            const deleteModal = document.getElementById('delete-modal');
            let currentFileTree = null;
            let nodeToDelete = null;
            let zipFilter = '';

            function buildFileTree(files) {
                const root = { name: "root", path: "", children: [] };
                for (const file of files) {
                    if (file.size === 0) continue;
                    const pathParts = file.webkitRelativePath.split('/');
                    let currentNode = root;
                    let currentPath = '';
                    for (let i = 0; i < pathParts.length; i++) {
                        const part = pathParts[i];
                        currentPath = currentPath ? `${currentPath}/${part}` : part;
                        if (i === pathParts.length - 1) {
                            const createdDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                            const modifiedDate = new Date(createdDate.getTime() + Math.random() * 10 * 24 * 60 * 60 * 1000);
                            currentNode.children.push({
                                name: part,
                                value: file.size,
                                path: currentPath,
                                created: createdDate,
                                modified: modifiedDate
                            });
                        } else {
                            let dirNode = currentNode.children.find(child => child.name === part && child.children);
                            if (!dirNode) {
                                dirNode = { name: part, children: [], path: currentPath };
                                currentNode.children.push(dirNode);
                            }
                            currentNode = dirNode;
                        }
                    }
                }
                return root;
            }

            function filterFileTree(tree, filter) {
                if (!filter) return tree;
                const filtered = { name: tree.name, path: tree.path, children: [] };
                function traverse(node, parent) {
                    if (!node.children) {
                        if (node.name.includes(`_${filter}`)) {
                            parent.children.push({ ...node });
                        }
                        return;
                    }
                    const newNode = { name: node.name, path: node.path, children: [] };
                    node.children.forEach(child => traverse(child, newNode));
                    if (newNode.children.length > 0) {
                        parent.children.push(newNode);
                    }
                }
                tree.children.forEach(child => traverse(child, filtered));
                return filtered;
            }

            function getFileStats(tree) {
                let fileCount = 0;
                let earliestCreated = null;
                let latestCreated = null;
                let earliestModified = null;
                let latestModified = null;
                function traverse(node) {
                    if (!node.children) {
                        fileCount++;
                        if (!earliestCreated || node.created < earliestCreated) earliestCreated = node.created;
                        if (!latestCreated || node.created > latestCreated) latestCreated = node.created;
                        if (!earliestModified || node.modified < earliestModified) earliestModified = node.modified;
                        if (!latestModified || node.modified > latestModified) latestModified = node.modified;
                    } else {
                        node.children.forEach(traverse);
                    }
                }
                tree.children.forEach(traverse);
                return {
                    fileCount,
                    earliestCreated: earliestCreated ? earliestCreated.toLocaleString() : '-',
                    latestCreated: latestCreated ? latestCreated.toLocaleString() : '-',
                    earliestModified: earliestModified ? earliestModified.toLocaleString() : '-',
                    latestModified: latestModified ? latestModified.toLocaleString() : '-'
                };
            }

            function updateFileStats(stats) {
                document.getElementById('file-count').textContent = stats.fileCount;
                document.getElementById('earliest-created').textContent = stats.earliestCreated;
                document.getElementById('latest-created').textContent = stats.latestCreated;
                document.getElementById('earliest-modified').textContent = stats.earliestModified;
                document.getElementById('latest-modified').textContent = stats.latestModified;
            }

            function getFirstTwoParams(filename) {
                const parts = filename.split('_');
                if (parts.length >= 2) {
                    return `${parts[0]}_${parts[1]}`;
                }
                return filename;
            }

            function copyToClipboard(text, successMessage, errorMessage) {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            tooltip.style.opacity = 1;
                            tooltip.innerHTML = successMessage;
                            setTimeout(() => { tooltip.style.opacity = 0; }, 1000);
                        })
                        .catch(() => {
                            tooltip.style.opacity = 1;
                            tooltip.innerHTML = errorMessage;
                            setTimeout(() => { tooltip.style.opacity = 0; }, 2000);
                        });
                } else {
                    tooltip.style.opacity = 1;
                    tooltip.innerHTML = 'Clipboard not available. Please run in a secure context (HTTPS or localhost).';
                    setTimeout(() => { tooltip.style.opacity = 0; }, 2000);
                }
            }

            function renderTreemap(data) {
                treemapContainer.innerHTML = '';
                const width = treemapContainer.clientWidth;
                const height = treemapContainer.clientHeight;
                const root = d3.hierarchy(data).sum(d => d.value || 0).sort((a, b) => (b.value || 0) - (a.value || 0));
                const treemapLayout = d3.treemap()
                    .size([width, height])
                    .paddingInner(1)
                    .paddingOuter(3)
                    .paddingTop(20)
                    .tile(d3.treemapSquarify);
                treemapLayout(root);
                const color = d3.scaleOrdinal(d3.schemeCategory10);
                const node = d3.select('#treemap-container')
                    .selectAll('div')
                    .data(root.descendants())
                    .join('div')
                    .attr('class', d => `node-group ${d.children ? 'internal' : 'leaf'}`)
                    .style('left', d => `${d.x0}px`)
                    .style('top', d => `${d.y0}px`)
                    .style('width', d => `${d.x1 - d.x0}px`)
                    .style('height', d => `${d.y1 - d.y0}px`);

                const leaves = node.filter(d => !d.children);
                leaves.style('background-color', d => {
                    let ancestor = d;
                    while (ancestor.depth > 1) { ancestor = ancestor.parent; }
                    return color(ancestor.data.name);
                })
                    .on('click', (event, d) => {
                        event.preventDefault();
                        event.stopPropagation();
                        copyToClipboard(
                            d.data.name,
                            `Copied filename: ${d.data.name}`,
                            'Failed to copy filename. Ensure HTTPS or localhost.'
                        );
                    })
                    .on('contextmenu', (event, d) => {
                        event.preventDefault();
                        event.stopPropagation();
                        nodeToDelete = d;
                        contextMenu.style.display = 'block';
                        contextMenu.style.left = `${event.clientX}px`;
                        contextMenu.style.top = `${event.clientY}px`;
                        const textToCopy = getFirstTwoParams(d.data.name);
                        copyToClipboard(
                            textToCopy,
                            `Copied: ${textToCopy}`,
                            'Failed to copy parameters. Ensure HTTPS or localhost.'
                        );
                    });
                leaves.append('div')
                    .attr('class', 'leaf-label')
                    .text(d => d.data.name);
                leaves.on('mouseenter', (event, d) => {
                    tooltip.style.opacity = 1;
                    tooltip.innerHTML = `
                        <strong>File:</strong> ${d.data.name}<br>
                        <strong>Path:</strong> ${d.data.path}<br>
                        <strong>Size:</strong> ${formatBytes(d.value)}<br>
                        <strong>Created:</strong> ${d.data.created ? d.data.created.toLocaleString() : 'N/A'}<br>
                        <strong>Modified:</strong> ${d.data.modified ? d.data.modified.toLocaleString() : 'N/A'}
                    `;
                })
                    .on('mousemove', (event) => {
                        tooltip.style.left = `${event.clientX}px`;
                        tooltip.style.top = `${event.clientY}px`;
                    })
                    .on('mouseleave', () => {
                        tooltip.style.opacity = 0;
                    });

                const directories = node.filter(d => d.children);
                directories.append('a')
                    .attr('class', 'node-label')
                    .attr('href', d => `file:///${d.data.path ? d.data.path.replace(/\//g, '\\') : ''}`)
                    .on('click', event => event.preventDefault())
                    .text(d => d.data.name);
                directories.on('mouseenter', (event, d) => {
                    tooltip.style.opacity = 1;
                    tooltip.innerHTML = `
                        <strong>Directory:</strong> ${d.data.path}<br>
                        <strong>Total Size:</strong> ${formatBytes(d.value)}
                    `;
                })
                    .on('mousemove', (event) => {
                        tooltip.style.left = `${event.clientX}px`;
                        tooltip.style.top = `${event.clientY}px`;
                    })
                    .on('mouseleave', () => {
                        tooltip.style.opacity = 0;
                    });

                const stats = getFileStats(data);
                updateFileStats(stats);
            }

            function handleFileSelect(event) {
                const files = event.target.files;
                if (files.length === 0) {
                    treemapContainer.innerHTML = '<p style="padding: 2rem;">No files selected or folder is empty.</p>';
                    updateFileStats({ fileCount: 0, earliestCreated: '-', latestCreated: '-', earliestModified: '-', latestModified: '-' });
                    return;
                }
                currentFileTree = buildFileTree(files);
                const filteredTree = filterFileTree(currentFileTree, zipFilter);
                renderTreemap(filteredTree);
            }

            function formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
            }

            // Integrated ZIP Code and Treemap Filtering
            zipInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = zipInput.value.trim().toUpperCase();
                    zipFilter = query.length === 2 && zipPrefixData[query] ? query : '';
                    if (currentFileTree) {
                        const filteredTree = filterFileTree(currentFileTree, zipFilter);
                        renderTreemap(filteredTree);
                    }
                    if (userMarker) map.removeLayer(userMarker);
                    if (areaCircle) map.removeLayer(areaCircle);
                    if (query.length === 1 && zipPrefixData[query]) {
                        const { lat, lng, name, zoom, radius } = zipPrefixData[query];
                        map.setView([lat, lng], zoom);
                        userMarker = L.marker([lat, lng]).addTo(map);
                        userMarker.bindPopup(`<b>State:</b> ${name}`).openPopup();
                        addAreaCircle(lat, lng, radius, name);
                        const locationData = { latitude: lat, longitude: lng, isZip: true };
                        localStorage.setItem('lastLocation', JSON.stringify(locationData));
                    } else if (query.length === 2 && stateData[query]) {
                        const { lat, lng, name, zoom, radius } = stateData[query];
                        map.setView([lat, lng], zoom);
                        userMarker = L.marker([lat, lng]).addTo(map);
                        userMarker.bindPopup(`<b>State:</b> ${name}`).openPopup();
                        addAreaCircle(lat, lng, radius, name);
                        const locationData = { latitude: lat, longitude: lng, isZip: true };
                        localStorage.setItem('lastLocation', JSON.stringify(locationData));
                    } else if ((query.length === 2 || query.length === 3) && zipPrefixData[query]) {
                        const { lat, lng, name, zoom, radius } = zipPrefixData[query];
                        map.setView([lat, lng], zoom);
                        userMarker = L.marker([lat, lng]).addTo(map);
                        userMarker.bindPopup(`<b>ZIP Prefix:</b> ${query}<br>${name}`).openPopup();
                        addAreaCircle(lat, lng, radius, name);
                        const locationData = { latitude: lat, longitude: lng, isZip: true };
                        localStorage.setItem('lastLocation', JSON.stringify(locationData));
                    } else if (query.length >= 5) {
                        const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&addressdetails=1&limit=1&countrycodes=us`;
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    const result = data[0];
                                    const lat = parseFloat(result.lat);
                                    const lng = parseFloat(result.lon);
                                    map.setView([lat, lng], 12);
                                    userMarker = L.marker([lat, lng]).addTo(map);
                                    userMarker.bindPopup(`<b>Search Result:</b><br>${result.display_name}`).openPopup();
                                    addAreaCircle(lat, lng, 5000, result.display_name);
                                    const locationData = { latitude: lat, longitude: lng, isZip: true };
                                    localStorage.setItem('lastLocation', JSON.stringify(locationData));
                                } else {
                                    L.popup()
                                        .setLatLng(map.getCenter())
                                        .setContent(`<p><strong>Error:</strong> No location found for "${query}". Try a valid US ZIP code.</p>`)
                                        .openOn(map);
                                }
                            })
                            .catch(error => {
                                console.error("Geocoding error:", error);
                                L.popup()
                                    .setLatLng(map.getCenter())
                                    .setContent(`<p><strong>Error:</strong> An error occurred while searching.</p>`)
                                    .openOn(map);
                            });
                    } else {
                        L.popup()
                            .setLatLng(map.getCenter())
                            .setContent(`<p><strong>Error:</strong> No location found for "${query}". Try a valid state, ZIP prefix, or full ZIP code.</p>`)
                            .openOn(map);
                    }
                }, 300);
            });

            gpsTimerButton.addEventListener('click', () => {
                if (!timerRunning) {
                    startTimer();
                } else {
                    stopTimer();
                }
            });

            function startTimer() {
                timerRunning = true;
                gpsTimerButton.textContent = 'Stop GPS Timer';
                updateTimerDisplay(10);
                timerInterval = setInterval(() => {
                    let timeLeft = parseInt(timerDisplay.textContent.split('|')[1].trim(), 10);
                    if (timeLeft > 0) {
                        updateTimerDisplay(timeLeft - 1);
                    } else {
                        const prefix = cyclingPrefixes[currentPrefixIndex];
                        zipFilter = prefix;
                        if (currentFileTree) {
                            const filteredTree = filterFileTree(currentFileTree, zipFilter);
                            renderTreemap(filteredTree);
                        }
                        const { lat, lng, name, zoom, radius } = zipPrefixData[prefix];
                        map.setView([lat, lng], zoom);
                        if (userMarker) map.removeLayer(userMarker);
                        if (areaCircle) map.removeLayer(areaCircle);
                        userMarker = L.marker([lat, lng]).addTo(map);
                        userMarker.bindPopup(`<b>ZIP Prefix:</b> ${prefix}<br>${name}`).openPopup();
                        addAreaCircle(lat, lng, radius, name);
                        const locationData = { latitude: lat, longitude: lng, isZip: true };
                        localStorage.setItem('lastLocation', JSON.stringify(locationData));
                        currentPrefixIndex = (currentPrefixIndex + 1) % cyclingPrefixes.length;
                        updateTimerDisplay(10);
                    }
                }, 1000);
            }

            function stopTimer() {
                timerRunning = false;
                gpsTimerButton.textContent = 'Start GPS Timer';
                clearInterval(timerInterval);
                timerDisplay.textContent = '';
            }

            function updateTimerDisplay(seconds) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const sec = String(now.getSeconds()).padStart(2, '0');
                timerDisplay.textContent = `${hours}:${minutes}:${sec} | ${seconds}s`;
            }

            currentLocationButton.addEventListener('click', () => locateUser(16));
            folderPicker.addEventListener('change', handleFileSelect);
            window.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });
            document.getElementById('menu-copy-path').addEventListener('click', () => {
                if (nodeToDelete && navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(nodeToDelete.data.path)
                        .then(() => {
                            tooltip.style.opacity = 1;
                            tooltip.innerHTML = `Copied path: ${nodeToDelete.data.path}`;
                            setTimeout(() => { tooltip.style.opacity = 0; }, 1000);
                        })
                        .catch(() => {
                            tooltip.style.opacity = 1;
                            tooltip.innerHTML = 'Failed to copy path. Ensure HTTPS or localhost.';
                            setTimeout(() => { tooltip.style.opacity = 0; }, 2000);
                        });
                } else {
                    tooltip.style.opacity = 1;
                    tooltip.innerHTML = 'Clipboard not available. Please run in a secure context (HTTPS or localhost).';
                    setTimeout(() => { tooltip.style.opacity = 0; }, 2000);
                }
            });
            document.getElementById('menu-delete').addEventListener('click', () => {
                if (nodeToDelete) {
                    deleteModal.style.display = 'flex';
                }
            });
            document.getElementById('modal-cancel').addEventListener('click', () => {
                deleteModal.style.display = 'none';
                nodeToDelete = null;
            });
            document.getElementById('modal-confirm').addEventListener('click', () => {
                if (nodeToDelete && nodeToDelete.parent) {
                    const children = nodeToDelete.parent.data.children;
                    const index = children.findIndex(child => child.path === nodeToDelete.data.path);
                    if (index > -1) {
                        children.splice(index, 1);
                    }
                    const filteredTree = filterFileTree(currentFileTree, zipFilter);
                    renderTreemap(filteredTree);
                }
                deleteModal.style.display = 'none';
                nodeToDelete = null;
            });
            window.addEventListener('resize', () => {
                if (currentFileTree) {
                    const filteredTree = filterFileTree(currentFileTree, zipFilter);
                    renderTreemap(filteredTree);
                }
            });

            map = initializeMap(39.8283, -98.5795);
            locateUser(10);
        });
    </script>
</body>
</html>
