<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SKYFORGE Architect</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;600;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: 'Exo 2', sans-serif; 
            color: #0ff; 
        }

        #viewport { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            cursor: crosshair; 
        }

        /* Custom Dialog System */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .dialog-overlay.active {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .dialog-box {
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 3px solid #0ff;
            border-top: 6px solid #f0a;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border-radius: 10px;
            box-shadow: 0 0 60px rgba(0,255,255,0.5);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .dialog-icon {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .dialog-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-shadow: 0 0 20px #f0a;
        }
        
        .dialog-message {
            color: #0ff;
            font-size: 16px;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border: 2px solid #f0a;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,0,255,0.5);
            transition: all 0.3s;
        }
        
        .dialog-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,0,255,0.8);
        }
        
        .dialog-btn.secondary {
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            border-color: #0ff;
            box-shadow: 0 0 10px rgba(0,255,255,0.3);
        }
        
        /* Notification Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 160;
            pointer-events: none;
        }
        
        .toast {
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 2px solid #0ff;
            border-left: 5px solid #f0a;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(0,255,255,0.5);
            animation: toastSlide 0.3s;
            pointer-events: auto;
            min-width: 250px;
        }
        
        @keyframes toastSlide {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 14px;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .toast-message {
            color: #0ff;
            font-size: 12px;
        }

        /* --- ADVANCED HUD --- */
        #hud {
            position: fixed; 
            top: 15px; 
            left: 15px; 
            z-index: 10;
            background: linear-gradient(135deg, rgba(0,10,30,0.95) 0%, rgba(0,5,20,0.85) 100%);
            border: 2px solid #0ff;
            border-left: 5px solid #f0a;
            padding: 20px;
            width: 280px;
            box-shadow: 0 0 40px rgba(0,255,255,0.3), inset 0 0 30px rgba(0,0,0,0.5);
            border-radius: 5px;
        }
        
        .hud-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: #f0a;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #f0a;
        }

        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .stat-row:hover {
            background: rgba(0,255,255,0.1);
            border-left-color: #0ff;
        }

        .stat-val { 
            font-weight: bold; 
            font-size: 20px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .label { 
            color: #888; 
            font-size: 11px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        #combo-display {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,0,255,0.1);
            border: 1px solid #f0a;
            text-align: center;
            font-size: 14px;
            color: #f0a;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* --- LEVEL & XP BAR --- */
        #level-bar {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #0ff;
        }
        
        .level-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #0ff;
        }
        
        .xp-bar-bg {
            width: 100%;
            height: 8px;
            background: #111;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #f0a);
            width: 0%;
            transition: width 0.5s;
            box-shadow: 0 0 10px #0ff;
        }

        /* --- ENHANCED SLOT MACHINE --- */
        #ui-layer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            z-index: 10; 
            display: flex; 
            justify-content: center; 
            padding-bottom: 20px;
        }
        
        .machine-frame { 
            width: 600px; 
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 3px solid #0ff;
            border-top: 6px solid #f0a;
            padding: 20px;
            box-shadow: 0 0 60px rgba(0,255,255,0.5), inset 0 0 40px rgba(0,0,0,0.8);
            border-radius: 10px;
            position: relative;
            transition: transform 0.3s;
        }
        
        .machine-collapse-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            border: 2px solid #0ff;
            color: #0ff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            z-index: 11;
        }
        
        .machine-collapse-btn:hover {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 20px #0ff;
        }
        
        .machine-frame.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .machine-frame.collapsed .reels,
        .machine-frame.collapsed .controls,
        .machine-frame.collapsed .payout-info {
            display: none;
        }
        
        .machine-title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: #f0a;
            font-size: 18px;
            margin-bottom: 15px;
            letter-spacing: 4px;
            text-shadow: 0 0 15px #f0a;
        }

        .reels { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 5px;
            background: #000;
            height: 120px;
            margin-bottom: 15px;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
        }
        
        .reel-strip { 
            background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);
            border-right: 2px solid #222;
            position: relative;
            overflow: hidden;
        }
        
        .reel-strip:last-child {
            border-right: none;
        }
        
        .symbol { 
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            position: relative;
            transition: transform 0.3s;
        }
        
        .symbol:hover {
            transform: scale(1.1);
        }
        
        .symbol.win {
            animation: symbolWin 0.5s infinite;
        }
        
        @keyframes symbolWin {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(2); }
        }

        .controls { 
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .btn { 
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            color: #0ff;
            border: 2px solid #0ff;
            padding: 15px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,255,255,0.3);
        }
        
        .btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #0ff 0%, #08a 100%);
            color: #000;
            box-shadow: 0 0 20px rgba(0,255,255,0.8);
            transform: translateY(-2px);
        }
        
        .btn.active { 
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border-color: #f0a;
            box-shadow: 0 0 20px rgba(255,0,255,0.6);
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        #btn-spin { 
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border-color: #f0a;
            font-size: 14px;
            box-shadow: 0 0 20px rgba(255,0,255,0.5);
        }
        
        #btn-spin:hover:not(:disabled) {
            background: linear-gradient(135deg, #fff 0%, #f0a 100%);
            box-shadow: 0 0 30px rgba(255,0,255,0.9);
        }

        /* Payout Table */
        .payout-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 10px;
            color: #666;
            margin-top: 10px;
        }
        
        .payout-item {
            padding: 5px;
            background: rgba(0,0,0,0.5);
            border-left: 2px solid #333;
            display: flex;
            justify-content: space-between;
        }

        /* --- CAMERA CONTROLS --- */
        #camera-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .cam-btn {
            width: 50px;
            height: 50px;
            background: rgba(0,20,40,0.9);
            border: 2px solid #0ff;
            color: #0ff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        .cam-btn:hover {
            background: rgba(0,255,255,0.3);
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }

        /* --- OVERLAY --- */
        #overlay { 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background: linear-gradient(135deg, #000 0%, #0a0a20 50%, #000 100%);
            z-index:200; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            justify-content:center;
        }
        
        #overlay h1 { 
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem; 
            color: #f0a;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 10px;
            text-shadow: 0 0 30px #f0a, 0 0 60px #f0a;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { text-shadow: 0 0 30px #f0a; }
            50% { text-shadow: 0 0 60px #f0a, 0 0 90px #f0a; }
        }
        
        #overlay p { 
            color: #0ff;
            margin-bottom: 20px;
            font-size: 18px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
        }
        
        #overlay button { 
            padding: 20px 60px;
            font-size: 22px;
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border: 3px solid #f0a;
            font-weight: 900;
            cursor: pointer;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 40px #f0a;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        #overlay button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px #f0a;
        }

        /* --- NOTIFICATIONS --- */
        .float-text { 
            position: absolute;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            font-size: 24px;
            z-index: 100;
        }
        
        @keyframes floatUp { 
            0% { opacity: 1; transform: translateY(0) scale(0.5); } 
            50% { transform: translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); } 
        }

        /* --- BUILDING INFO PANEL --- */
        #build-info {
            position: fixed;
            top: 50%;
            right: -350px;
            transform: translateY(-50%);
            width: 300px;
            background: rgba(0,10,30,0.95);
            border: 2px solid #0ff;
            border-right: none;
            padding: 20px;
            z-index: 15;
            transition: right 0.3s;
            border-radius: 5px 0 0 5px;
        }
        
        #build-info.visible {
            right: 0;
        }
        
        .info-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 16px;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }
        
        .info-row {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .info-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .info-value {
            color: #0ff;
            font-size: 16px;
            font-weight: bold;
        }
        
        #upgrade-btn {
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1>SKYFORGE</h1>
    <p>
        Command the Architect Drone. Spin the Tarot Forge for resources.<br>
        Click the drone to deploy structures. Match 5 symbols for legendary powers.<br>
        40+ Tarot combinations await. Build your eternal metropolis.
    </p>
    <button onclick="initSim()">âš¡ INITIALIZE SKYFORGE âš¡</button>
</div>

<div id="viewport"></div>

<!-- Custom Dialog System -->
<div class="dialog-overlay" id="dialog-overlay">
    <div class="dialog-box">
        <div class="dialog-icon" id="dialog-icon"></div>
        <div class="dialog-title" id="dialog-title"></div>
        <div class="dialog-message" id="dialog-message"></div>
        <div class="dialog-buttons" id="dialog-buttons"></div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container" id="toast-container"></div>

<div id="hud">
    <div class="hud-title">âš¡ SKYFORGE CONTROL âš¡</div>
    
    <div class="stat-row">
        <span class="label">âš¡ Energy</span>
        <span id="ui-energy" class="stat-val" style="color:#0ff">150</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ”§ Materials</span>
        <span id="ui-materials" class="stat-val" style="color:#ffaa00">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ’ Credits</span>
        <span id="ui-credits" class="stat-val" style="color:#f0f">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ§¬ Population</span>
        <span id="ui-pop" class="stat-val" style="color:#0f0">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ—ï¸ Structures</span>
        <span id="ui-builds" class="stat-val" style="color:#ff0">0</span>
    </div>
    
    <div id="combo-display">NO COMBO</div>
    
    <div id="level-bar">
        <div class="level-title">
            <span>ARCHITECT LVL <span id="level-num">1</span></span>
            <span id="xp-text">0 / 100 XP</span>
        </div>
        <div class="xp-bar-bg">
            <div class="xp-bar-fill" id="xp-bar"></div>
        </div>
    </div>
</div>

<div id="ui-layer">
    <div class="machine-frame">
        <button class="machine-collapse-btn" onclick="toggleMachineCollapse()">â–¼</button>
        <div class="machine-title">ğŸ° TAROT FORGE ğŸ°</div>
        <div class="reels" id="reels-container"></div>
        <div class="controls">
            <button class="btn" id="btn-turbo" onclick="toggleTurbo()">âš¡ TURBO</button>
            <button class="btn" id="btn-auto" onclick="toggleAuto()">ğŸ”„ AUTO</button>
            <button class="btn" id="btn-spin" onclick="spin()">SPIN (15 E)</button>
        </div>
        <div class="payout-info" id="payout-info">
            <div style="grid-column: 1/-1; text-align: center; color: #0ff; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px;">LEGENDARY TAROT CARDS</div>
        </div>
    </div>
</div>

<div id="camera-controls">
    <button class="cam-btn" onclick="Sim.adjustCamera('in')">+</button>
    <button class="cam-btn" onclick="Sim.adjustCamera('out')">âˆ’</button>
    <button class="cam-btn" onclick="Sim.adjustCamera('reset')">âŒ‚</button>
</div>

<div id="build-info">
    <div class="info-title">STRUCTURE DATA</div>
    <div class="info-row">
        <div class="info-label">Type</div>
        <div class="info-value" id="info-type">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Level</div>
        <div class="info-value" id="info-level">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Production</div>
        <div class="info-value" id="info-production">-</div>
    </div>
    <button class="btn" id="upgrade-btn" onclick="upgradeSelected()">UPGRADE (50 CR)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* ================= CUSTOM UI SYSTEM ================= */
const UI = {
    showDialog: function(icon, title, message, buttons = [{text: 'OK', primary: true}]) {
        const overlay = document.getElementById('dialog-overlay');
        document.getElementById('dialog-icon').innerText = icon;
        document.getElementById('dialog-title').innerText = title;
        document.getElementById('dialog-message').innerText = message;
        
        const btnContainer = document.getElementById('dialog-buttons');
        btnContainer.innerHTML = '';
        
        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = btn.primary ? 'dialog-btn' : 'dialog-btn secondary';
            button.innerText = btn.text;
            button.onclick = () => {
                overlay.classList.remove('active');
                if(btn.callback) btn.callback();
            };
            btnContainer.appendChild(button);
        });
        
        overlay.classList.add('active');
    },
    
    showToast: function(title, message, duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        `;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'toastSlide 0.3s reverse';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    },
    
    showMilestone: function(icon, title, message) {
        this.showDialog(icon, title, message, [
            {text: 'CONTINUE', primary: true}
        ]);
    }
};

/* ================= TAROT CARD EMOJI DATA ================= */
const TAROT_DATA = `emoji1,emoji2,emoji3,emoji4,emoji5,card_name,effect,rarity
ğŸŒŸ,ğŸŒŸ,ğŸŒŸ,ğŸŒŸ,ğŸŒŸ,The Universe,All resources maxed,legendary
ğŸ‘‘,ğŸ‘‘,ğŸ‘‘,ğŸ‘‘,ğŸ‘‘,The Emperor,+500 Credits,legendary
âš¡,âš¡,âš¡,âš¡,âš¡,The Tower,+200 Energy,epic
ğŸ”®,ğŸ”®,ğŸ”®,ğŸ”®,ğŸ”®,The High Priestess,+100 All Resources,epic
ğŸŒ™,ğŸŒ™,ğŸŒ™,ğŸŒ™,ğŸŒ™,The Moon,+50 Population,epic
â˜€ï¸,â˜€ï¸,â˜€ï¸,â˜€ï¸,â˜€ï¸,The Sun,+150 Energy +75 Materials,epic
ğŸ’€,ğŸ’€,ğŸ’€,ğŸ’€,ğŸ’€,Death Transform,Reset & Double XP Rate,epic
ğŸ­,ğŸ­,ğŸ­,ğŸ­,ğŸ­,The Magician,5x Combo Multiplier,epic
ğŸ—¡ï¸,ğŸ—¡ï¸,ğŸ—¡ï¸,ğŸ—¡ï¸,ğŸ—¡ï¸,Strength,Free Upgrades (10),epic
ğŸŒ¹,ğŸŒ¹,ğŸŒ¹,ğŸŒ¹,ğŸŒ¹,The Lovers,+200 Population,rare
ğŸ’,ğŸ’,ğŸ’,ğŸ’,ğŸ’,Temperance,+150 Credits,rare
ğŸ”¥,ğŸ”¥,ğŸ”¥,ğŸ”¥,ğŸ”¥,The Chariot,+100 Energy,rare
ğŸ’§,ğŸ’§,ğŸ’§,ğŸ’§,ğŸ’§,The Hermit,+50 Materials,rare
ğŸŒ¿,ğŸŒ¿,ğŸŒ¿,ğŸŒ¿,ğŸŒ¿,The World,+75 All Resources,rare
âš–ï¸,âš–ï¸,âš–ï¸,âš–ï¸,âš–ï¸,Justice,+100 Credits,rare
ğŸª,ğŸª,ğŸª,ğŸª,ğŸª,The Fool,Random Mega Bonus,rare
ğŸ†,ğŸ†,ğŸ†,ğŸ†,ğŸ†,The Star,+50 Credits +25 Materials,rare
ğŸ¦…,ğŸ¦…,ğŸ¦…,ğŸ¦…,ğŸ¦…,Wheel of Fortune,Spin Again Free,rare
ğŸ””,ğŸ””,ğŸ””,ğŸ””,ğŸ””,Judgment,+100 XP,rare
ğŸ§¬,ğŸ§¬,ğŸ§¬,ğŸ§¬,ğŸ§¬,The Hanged Man,+30 Population,uncommon
ğŸ”§,ğŸ”§,ğŸ”§,ğŸ”§,ğŸ”§,The Builder,+30 Materials,uncommon
ğŸ¯,ğŸ¯,ğŸ¯,ğŸ¯,ğŸ¯,The Archer,+40 Credits,uncommon
ğŸ›¡ï¸,ğŸ›¡ï¸,ğŸ›¡ï¸,ğŸ›¡ï¸,ğŸ›¡ï¸,The Guardian,+40 Energy,uncommon
ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,The Tide,+20 Materials,uncommon
ğŸƒ,ğŸƒ,ğŸƒ,ğŸƒ,ğŸƒ,The Breeze,+15 Energy,uncommon
ğŸ”‘,ğŸ”‘,ğŸ”‘,ğŸ”‘,ğŸ”‘,The Key,Unlock Random Building,uncommon
ğŸ“¿,ğŸ“¿,ğŸ“¿,ğŸ“¿,ğŸ“¿,The Chain,2x Next Spin,uncommon
ğŸ¨,ğŸ¨,ğŸ¨,ğŸ¨,ğŸ¨,The Artist,+25 Credits,uncommon
ğŸµ,ğŸµ,ğŸµ,ğŸµ,ğŸµ,The Muse,+20 Population,uncommon
ğŸŒ¸,ğŸŒ¸,ğŸŒ¸,ğŸŒ¸,ğŸŒ¸,The Blossom,+15 All Resources,common
â­,â­,â­,â­,â­,The Spark,+25 Energy,common
ğŸ’«,ğŸ’«,ğŸ’«,ğŸ’«,ğŸ’«,The Comet,+20 Materials,common
ğŸ,ğŸ,ğŸ,ğŸ,ğŸ,The Gift,+15 Credits,common
ğŸ¹,ğŸ¹,ğŸ¹,ğŸ¹,ğŸ¹,The Hunt,+10 Population,common
ğŸŒº,ğŸŒº,ğŸŒº,ğŸŒº,ğŸŒº,The Flower,+10 Energy,common
ğŸ”®,ğŸŒ™,âš¡,ğŸŒŸ,ğŸ’,Cosmic Alignment,+200 All Resources,mythic
ğŸ‘‘,ğŸ—¡ï¸,ğŸ›¡ï¸,ğŸ†,âš–ï¸,The Kingdom,Instant Level Up,mythic
ğŸŒŸ,ğŸ’,âš¡,ğŸ”¥,â˜€ï¸,Divine Power,Triple All Production,mythic`;

const TarotCards = {
    cards: [],
    symbolPool: [],
    rarityWeights: {
        'legendary': 1,
        'mythic': 2,
        'epic': 5,
        'rare': 15,
        'uncommon': 30,
        'common': 47
    },
    
    init: function() {
        const lines = TAROT_DATA.trim().split('\n');
        
        for(let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const card = {
                emojis: [values[0], values[1], values[2], values[3], values[4]],
                name: values[5],
                effect: values[6],
                rarity: values[7]
            };
            this.cards.push(card);
        }
        
        // Build weighted symbol pool
        this.cards.forEach(card => {
            const weight = this.rarityWeights[card.rarity] || 10;
            for(let i = 0; i < weight; i++) {
                card.emojis.forEach(emoji => {
                    this.symbolPool.push(emoji);
                });
            }
        });
        
        console.log(`âœ¨ Loaded ${this.cards.length} tarot cards`);
    },
    
    getRandomSymbol: function() {
        return this.symbolPool[Math.floor(Math.random() * this.symbolPool.length)];
    },
    
    checkCombination: function(symbols) {
        // Check for exact matches
        for(let card of this.cards) {
            if(this.arraysEqual(symbols, card.emojis)) {
                return card;
            }
        }
        
        // Check for counts
        const counts = {};
        symbols.forEach(s => counts[s] = (counts[s] || 0) + 1);
        const maxCount = Math.max(...Object.values(counts));
        
        if(maxCount === 5) {
            const symbol = Object.keys(counts).find(k => counts[k] === 5);
            const card = this.cards.find(c => c.emojis[0] === symbol && c.emojis.every(e => e === symbol));
            if(card) return card;
        }
        
        if(maxCount === 4) return {name: 'Four of a Kind', effect: 'quad_bonus', rarity: 'rare'};
        if(maxCount === 3) return {name: 'Three of a Kind', effect: 'triple_bonus', rarity: 'uncommon'};
        
        if(maxCount === 2) {
            const pairs = Object.keys(counts).filter(k => counts[k] === 2);
            if(pairs.length === 2) return {name: 'Two Pairs', effect: 'double_pair', rarity: 'common'};
            return {name: 'Pair', effect: 'pair_bonus', rarity: 'common'};
        }
        
        return null;
    },
    
    arraysEqual: function(a, b) {
        if(a.length !== b.length) return false;
        for(let i = 0; i < a.length; i++) {
            if(a[i] !== b[i]) return false;
        }
        return true;
    }
};

/* ================= ENHANCED AUDIO ================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    play: function(freq, type, dur, vol=0.1, slide=false) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) o.frequency.exponentialRampToValueAtTime(freq/2, this.ctx.currentTime+dur);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        o.connect(g);
        g.connect(this.ctx.destination);
        o.start();
        o.stop(this.ctx.currentTime + dur);
    },
    chord: function(freqs, type='sine', dur=0.3, vol=0.05) {
        freqs.forEach(f => this.play(f, type, dur, vol));
    },
    born: () => SFX.chord([400, 500, 600], 'sine', 0.15, 0.04),
    droneHit: () => {
        SFX.play(200, 'square', 0.15, 0.15);
        setTimeout(()=>SFX.chord([150, 180, 220], 'sawtooth', 0.25, 0.12, true), 50);
    },
    build: () => SFX.chord([80, 120, 160], 'square', 0.4, 0.2),
    spin: () => SFX.play(300, 'sawtooth', 0.08, 0.08),
    win: () => SFX.chord([500, 625, 750, 1000], 'sine', 0.5, 0.15),
    jackpot: () => {
        for(let i=0; i<5; i++) {
            setTimeout(()=>SFX.chord([400+i*100, 500+i*100, 600+i*100], 'sine', 0.3, 0.1), i*100);
        }
    },
    upgrade: () => SFX.chord([600, 800, 1000], 'triangle', 0.3, 0.1),
    levelUp: () => {
        SFX.chord([400, 500, 600, 800], 'sine', 0.5, 0.15);
        setTimeout(()=>SFX.chord([800, 1000, 1200, 1600], 'sine', 0.5, 0.15), 200);
    }
};

/* ================= 3D SIMULATION ================= */
const Sim = {
    scene: null,
    camera: null,
    renderer: null,
    raycaster: null,
    mouse: null,
    
    entities: [],
    buildings: [],
    selectedBuilding: null,
    
    drone: null,
    droneSpeed: 1,
    
    cameraDistance: 100,
    cameraAngle: 0,
    
    init: function() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x0a0a15, 0.008);
        
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
        this.updateCameraPosition();

        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('viewport').appendChild(this.renderer.domElement);

        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        window.addEventListener('pointerdown', this.onMouseClick.bind(this));

        // Enhanced Lighting
        const amb = new THREE.AmbientLight(0x303050, 0.6);
        this.scene.add(amb);
        
        const sun = new THREE.DirectionalLight(0xffaa00, 1.5);
        sun.position.set(80, 150, 80);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 4096;
        sun.shadow.mapSize.height = 4096;
        sun.shadow.camera.left = -100;
        sun.shadow.camera.right = 100;
        sun.shadow.camera.top = 100;
        sun.shadow.camera.bottom = -100;
        this.scene.add(sun);
        
        const accent = new THREE.PointLight(0xff00ff, 2, 100);
        accent.position.set(0, 50, 0);
        this.scene.add(accent);

        // Ground
        const grid = new THREE.GridHelper(300, 60, 0x0ff, 0x0aa);
        this.scene.add(grid);
        
        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(300, 300),
            new THREE.MeshStandardMaterial({
                color: 0x0a0a20,
                roughness: 0.8,
                metalness: 0.2,
                emissive: 0x00ffff,
                emissiveIntensity: 0.1
            })
        );
        plane.rotation.x = -Math.PI/2;
        plane.receiveShadow = true;
        this.scene.add(plane);

        this.createDrone();
        this.animate();
        
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    },

    updateCameraPosition: function() {
        this.camera.position.set(
            Math.cos(this.cameraAngle) * this.cameraDistance,
            this.cameraDistance * 0.6,
            Math.sin(this.cameraAngle) * this.cameraDistance
        );
        this.camera.lookAt(0, 0, 0);
    },

    adjustCamera: function(dir) {
        if(dir === 'in') this.cameraDistance = Math.max(50, this.cameraDistance - 20);
        else if(dir === 'out') this.cameraDistance = Math.min(200, this.cameraDistance + 20);
        else if(dir === 'reset') { this.cameraDistance = 100; this.cameraAngle = 0; }
        this.updateCameraPosition();
    },

    createDrone: function() {
        const group = new THREE.Group();
        
        const core = new THREE.Mesh(
            new THREE.IcosahedronGeometry(2, 1),
            new THREE.MeshStandardMaterial({
                color: 0xffffff,
                emissive: 0xffaa00,
                emissiveIntensity: 1,
                roughness: 0.2,
                metalness: 0.8
            })
        );
        group.add(core);
        
        const ring = new THREE.Mesh(
            new THREE.TorusGeometry(4, 0.3, 8, 32),
            new THREE.MeshStandardMaterial({
                color: 0x00ffff,
                emissive: 0x00ffff,
                emissiveIntensity: 0.5,
                wireframe: true
            })
        );
        group.add(ring);
        
        const hitbox = new THREE.Mesh(
            new THREE.SphereGeometry(7),
            new THREE.MeshBasicMaterial({visible:false})
        );
        hitbox.userData = { isDrone: true };
        group.add(hitbox);

        const light = new THREE.PointLight(0xffaa00, 2, 40);
        group.add(light);

        group.position.set(0, 40, 0);
        this.scene.add(group);
        this.drone = group;
    },

    updateDrone: function(time) {
        if(!this.drone) return;
        
        const speed = this.droneSpeed * 0.0005;
        this.drone.position.x = Math.sin(time * speed) * 50;
        this.drone.position.z = Math.cos(time * speed * 0.7) * 50;
        this.drone.position.y = 40 + Math.sin(time * 0.003) * 8;
        
        this.drone.rotation.x += 0.01;
        this.drone.rotation.y += 0.02;
        
        const scale = 1 + Math.sin(time * 0.005) * 0.1;
        this.drone.children[0].scale.setScalar(scale);
    },

    onMouseClick: function(event) {
        this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersects = this.raycaster.intersectObjects(this.scene.children, true);
        
        for (let hit of intersects) {
            if (hit.object.userData.isDrone) {
                this.deployDrone();
                this.spawnFloatText(event.clientX, event.clientY, "+5 MAT", '#ffaa00');
                break;
            } else if (hit.object.userData.isBuilding) {
                this.selectBuilding(hit.object.userData.building);
                break;
            }
        }
    },

    deployDrone: function() {
        if(Game.materials < 5) {
            UI.showDialog('âš ï¸', 'INSUFFICIENT MATERIALS', 'Need 5 materials to deploy a structure!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        SFX.droneHit();
        Game.materials -= 5;
        
        this.spawnParticles(this.drone.position.x, this.drone.position.y, this.drone.position.z, 0xffaa00, 20);
        
        const crateGeo = new THREE.BoxGeometry(3, 3, 3);
        const crateMat = new THREE.MeshStandardMaterial({
            color: 0x00ffcc,
            emissive: 0x00ffcc,
            emissiveIntensity: 0.5,
            wireframe: true
        });
        const crate = new THREE.Mesh(crateGeo, crateMat);
        crate.position.copy(this.drone.position);
        this.scene.add(crate);
        
        const glowLight = new THREE.PointLight(0x00ffcc, 3, 20);
        crate.add(glowLight);
        
        new TWEEN.Tween(crate.position)
            .to({ y: 0 }, 1200)
            .easing(TWEEN.Easing.Bounce.Out)
            .onComplete(() => {
                this.scene.remove(crate);
                this.buildStructure(crate.position.x, crate.position.z);
            })
            .start();
            
        new TWEEN.Tween(crate.rotation)
            .to({x: Math.PI*3, y: Math.PI*3}, 1200)
            .start();
    },

    buildStructure: function(x, z) {
        SFX.build();
        
        const types = [
            {name: 'Tower', height: 15, geo: 'box', color: 0x0099ff, production: 'energy', value: 2},
            {name: 'Dome', height: 8, geo: 'dodeca', color: 0xffaa00, production: 'materials', value: 1},
            {name: 'Pyramid', height: 12, geo: 'cone', color: 0xff00ff, production: 'credits', value: 3},
            {name: 'Cube', height: 6, geo: 'box', color: 0x00ff00, production: 'population', value: 5}
        ];
        
        const type = types[Math.floor(Math.random() * types.length)];
        
        let geo;
        if(type.geo === 'box') geo = new THREE.BoxGeometry(4, type.height, 4);
        else if(type.geo === 'dodeca') geo = new THREE.DodecahedronGeometry(5);
        else if(type.geo === 'cone') geo = new THREE.ConeGeometry(4, type.height, 4);
        
        const mat = new THREE.MeshStandardMaterial({
            color: type.color,
            emissive: type.color,
            emissiveIntensity: 0.3,
            roughness: 0.4,
            metalness: 0.6
        });
        
        const building = new THREE.Mesh(geo, mat);
        building.position.set(x, type.height/2, z);
        building.castShadow = true;
        building.receiveShadow = true;
        
        building.userData = {
            isBuilding: true,
            building: {
                type: type.name,
                level: 1,
                production: type.production,
                value: type.value,
                mesh: building,
                baseColor: type.color
            }
        };
        
        const light = new THREE.PointLight(type.color, 1, 20);
        light.position.y = type.height/2;
        building.add(light);
        
        this.scene.add(building);
        this.buildings.push(building.userData.building);
        
        Game.buildingsBuilt++;
        Game.addXP(10);
        
        this.spawnParticles(x, 0, z, 0xaaaaaa, 15);
    },

    selectBuilding: function(building) {
        if(this.selectedBuilding) {
            this.selectedBuilding.mesh.material.emissiveIntensity = 0.3;
        }
        
        this.selectedBuilding = building;
        building.mesh.material.emissiveIntensity = 0.8;
        
        document.getElementById('info-type').innerText = building.type;
        document.getElementById('info-level').innerText = building.level;
        document.getElementById('info-production').innerText = 
            `+${building.value} ${building.production}/tick`;
        document.getElementById('build-info').classList.add('visible');
        
        SFX.play(400, 'sine', 0.1, 0.05);
    },

    upgradeBuilding: function(building) {
        if(Game.credits < 50) {
            UI.showDialog('âš ï¸', 'INSUFFICIENT CREDITS', 'Need 50 credits to upgrade this structure!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        Game.credits -= 50;
        building.level++;
        building.value = Math.floor(building.value * 1.5);
        
        building.mesh.scale.multiplyScalar(1.1);
        const newColor = building.baseColor + 0x111111;
        building.mesh.material.color.setHex(newColor);
        building.mesh.material.emissiveIntensity = 1;
        
        SFX.upgrade();
        this.spawnParticles(building.mesh.position.x, building.mesh.position.y, building.mesh.position.z, 0xff00ff, 10);
        
        this.selectBuilding(building);
        Game.addXP(25);
        Game.updateHUD();
        
        UI.showToast('UPGRADE COMPLETE', `${building.type} now level ${building.level}!`);
    },

    spawnAgent: function() {
        if(this.entities.length > 100) return;
        
        const colors = [0x00ffcc, 0xff00ff, 0xffaa00, 0x00ff00];
        const mesh = new THREE.Mesh(
            new THREE.TetrahedronGeometry(0.6),
            new THREE.MeshStandardMaterial({
                color: colors[Math.floor(Math.random()*colors.length)],
                emissive: 0xffffff,
                emissiveIntensity: 0.5
            })
        );
        mesh.position.set(0, 0.6, 0);
        mesh.castShadow = true;
        this.scene.add(mesh);
        
        this.entities.push({
            mesh: mesh,
            target: new THREE.Vector3(0, 0.6, 0),
            speed: 0.05 + Math.random() * 0.1
        });
        
        SFX.born();
    },

    spawnParticles: function(x, y, z, color, count=10) {
        for(let i=0; i<count; i++) {
            const m = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.5, 0.5),
                new THREE.MeshBasicMaterial({color: color})
            );
            m.position.set(x, y, z);
            this.scene.add(m);
            
            new TWEEN.Tween(m.position)
                .to({
                    x: x + (Math.random()-0.5)*8,
                    y: y + Math.random()*8,
                    z: z + (Math.random()-0.5)*8
                }, 600 + Math.random()*400)
                .onComplete(() => this.scene.remove(m))
                .start();
                
            new TWEEN.Tween(m.rotation)
                .to({x: Math.PI*2, y: Math.PI*2}, 800)
                .start();
        }
    },

    spawnFloatText: function(x, y, text, color='#fff') {
        const div = document.createElement('div');
        div.className = 'float-text';
        div.innerText = text;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.color = color;
        div.style.textShadow = `0 0 10px ${color}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    },

    animate: function(time) {
        requestAnimationFrame((t) => Sim.animate(t));
        TWEEN.update(time);
        
        this.updateDrone(time);
        
        this.cameraAngle += 0.0002;
        this.updateCameraPosition();
        
        for(let a of this.entities) {
            if(a.mesh.position.distanceTo(a.target) < 1) {
                if(this.buildings.length > 0) {
                    const b = this.buildings[Math.floor(Math.random() * this.buildings.length)];
                    a.target.set(
                        b.mesh.position.x + (Math.random()-0.5)*8,
                        0.6,
                        b.mesh.position.z + (Math.random()-0.5)*8
                    );
                } else {
                    a.target.set((Math.random()-0.5)*60, 0.6, (Math.random()-0.5)*60);
                }
            }
            
            const dir = new THREE.Vector3().subVectors(a.target, a.mesh.position).normalize();
            a.mesh.position.add(dir.multiplyScalar(a.speed));
            a.mesh.lookAt(a.target);
            a.mesh.rotation.x += 0.05;
        }
        
        if(time % 100 < 1) {
            Game.produceResources();
        }

        this.renderer.render(this.scene, this.camera);
    }
};

/* ================= GAME LOGIC WITH TAROT SYSTEM ================= */
const Game = {
    energy: 150,
    materials: 0,
    credits: 0,
    spinning: false,
    auto: false,
    turbo: false,
    buildingsBuilt: 0,
    
    level: 1,
    xp: 0,
    xpNeeded: 100,
    
    comboMultiplier: 1,
    spinsSinceWin: 0,
    machineCollapsed: false,

    init: function() {
        TarotCards.init();
        this.createReels();
        this.updateHUD();
        this.populatePayoutInfo();
        
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#build-info') && !e.target.closest('#viewport')) {
                document.getElementById('build-info').classList.remove('visible');
                if(Sim.selectedBuilding) {
                    Sim.selectedBuilding.mesh.material.emissiveIntensity = 0.3;
                    Sim.selectedBuilding = null;
                }
            }
        });
    },
    
    populatePayoutInfo: function() {
        const container = document.getElementById('payout-info');
        const topCards = TarotCards.cards.filter(c => c.rarity === 'legendary' || c.rarity === 'mythic').slice(0, 6);
        
        topCards.forEach(card => {
            const item = document.createElement('div');
            item.className = 'payout-item';
            item.style.fontSize = '9px';
            item.innerHTML = `<span>${card.emojis.join('')}</span> <span>${card.name}</span>`;
            container.appendChild(item);
        });
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<5; i++) {
            const s = document.createElement('div');
            s.className = 'reel-strip';
            s.id = `reel-${i}`;
            s.innerHTML = `<div class="symbol">${TarotCards.getRandomSymbol()}</div>`;
            c.appendChild(s);
        }
    },

    toggleAuto: function() {
        this.auto = !this.auto;
        document.getElementById('btn-auto').classList.toggle('active');
        if(this.auto && !this.spinning) this.spin();
    },
    
    toggleTurbo: function() {
        this.turbo = !this.turbo;
        Sim.droneSpeed = this.turbo ? 3 : 1;
        document.getElementById('btn-turbo').classList.toggle('active');
        UI.showToast('TURBO MODE', this.turbo ? 'Activated âš¡' : 'Deactivated');
    },
    
    toggleMachineCollapse: function() {
        this.machineCollapsed = !this.machineCollapsed;
        const frame = document.querySelector('.machine-frame');
        const btn = document.querySelector('.machine-collapse-btn');
        frame.classList.toggle('collapsed');
        btn.innerText = this.machineCollapsed ? 'â–²' : 'â–¼';
    },

    spin: async function() {
        if(this.spinning) return;
        if(this.energy < 15) {
            this.auto = false;
            document.getElementById('btn-auto').classList.remove('active');
            UI.showDialog('âš ï¸', 'INSUFFICIENT ENERGY', 'Need 15 Energy to spin the Tarot Forge!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        this.spinning = true;
        this.energy -= 15;
        this.spinsSinceWin++;
        this.updateHUD();
        SFX.spin();

        const results = [];
        const spinDuration = this.turbo ? 80 : 150;
        
        for(let i=0; i<5; i++) {
            const el = document.getElementById(`reel-${i}`);
            el.style.transform = 'translateY(30px)';
            el.style.opacity = '0.5';
            
            await new Promise(r => setTimeout(r, spinDuration));
            
            const sym = TarotCards.getRandomSymbol();
            results.push(sym);
            el.children[0].innerText = sym;
            el.style.transform = 'translateY(0)';
            el.style.opacity = '1';
        }
        
        await this.evaluateResults(results);
        
        this.spinning = false;
        this.updateHUD();
        
        if(this.auto) setTimeout(() => this.spin(), this.turbo ? 300 : 700);
    },

    evaluateResults: async function(results) {
        document.querySelectorAll('.symbol').forEach(s => s.classList.remove('win'));
        
        const match = TarotCards.checkCombination(results);
        
        if(!match) {
            this.comboMultiplier = 1;
            if(this.spinsSinceWin > 10) {
                this.energy += 5;
                UI.showToast('PITY BONUS', '+5 Energy');
            }
            document.getElementById('combo-display').innerText = 'NO COMBO';
            return;
        }
        
        document.querySelectorAll('.symbol').forEach(s => s.classList.add('win'));
        this.spinsSinceWin = 0;
        
        document.getElementById('combo-display').innerText = `âœ¨ ${match.name} âœ¨`;
        
        await this.applyEffect(match);
        
        this.comboMultiplier = Math.min(3, this.comboMultiplier + 0.1);
        this.updateHUD();
    },
    
    applyEffect: async function(match) {
        const mult = this.comboMultiplier;
        
        switch(match.effect) {
            case 'All resources maxed':
                this.energy = 999;
                this.materials = 999;
                this.credits = 999;
                UI.showMilestone('ğŸŒŸ', 'THE UNIVERSE', 'All resources maximized by cosmic forces!');
                SFX.jackpot();
                this.addXP(500);
                break;
                
            case '+500 Credits':
                this.credits += Math.floor(500 * mult);
                UI.showToast('ğŸ‘‘ THE EMPEROR', `+${Math.floor(500*mult)} Credits`);
                SFX.win();
                this.addXP(200);
                break;
                
            case '+200 Energy':
                this.energy += Math.floor(200 * mult);
                UI.showToast('âš¡ THE TOWER', `+${Math.floor(200*mult)} Energy`);
                SFX.win();
                this.addXP(100);
                break;
                
            case '+100 All Resources':
                this.energy += Math.floor(100 * mult);
                this.materials += Math.floor(100 * mult);
                this.credits += Math.floor(100 * mult);
                UI.showMilestone('ğŸ”®', 'THE HIGH PRIESTESS', 'Divine balance achieved!');
                SFX.jackpot();
                this.addXP(150);
                break;
                
            case '+50 Population':
                const popCount = Math.floor(50 * mult);
                for(let i=0; i<popCount; i++) Sim.spawnAgent();
                UI.showToast('ğŸŒ™ THE MOON', `+${popCount} Population`);
                SFX.win();
                this.addXP(80);
                break;
                
            case 'Instant Level Up':
                this.xp = this.xpNeeded;
                this.levelUp();
                UI.showMilestone('ğŸ‘‘', 'THE KINGDOM', 'The kingdom grants instant mastery!');
                SFX.jackpot();
                break;
                
            case 'Triple All Production':
                Sim.buildings.forEach(b => b.value *= 3);
                UI.showMilestone('ğŸŒŸ', 'DIVINE POWER', 'All production tripled permanently!');
                SFX.jackpot();
                this.addXP(300);
                break;
                
            case '+200 All Resources':
                this.energy += Math.floor(200 * mult);
                this.materials += Math.floor(200 * mult);
                this.credits += Math.floor(200 * mult);
                UI.showMilestone('ğŸ”®', 'COSMIC ALIGNMENT', 'The stars align in your favor!');
                SFX.jackpot();
                this.addXP(250);
                break;
                
            case 'quad_bonus':
                this.energy += Math.floor(100 * mult);
                this.materials += Math.floor(50 * mult);
                this.credits += Math.floor(75 * mult);
                UI.showToast('ğŸ° FOUR OF A KIND', 'Major bonus!');
                SFX.win();
                this.addXP(80);
                break;
                
            case 'triple_bonus':
                this.energy += Math.floor(50 * mult);
                this.materials += Math.floor(25 * mult);
                this.credits += Math.floor(40 * mult);
                UI.showToast('ğŸ° THREE OF A KIND', 'Good combo!');
                SFX.play(500, 'sine', 0.3, 0.1);
                this.addXP(40);
                break;
                
            case 'double_pair':
                this.energy += Math.floor(30 * mult);
                this.materials += Math.floor(15 * mult);
                UI.showToast('ğŸ° TWO PAIRS', 'Nice match!');
                SFX.play(400, 'sine', 0.2, 0.08);
                this.addXP(20);
                break;
                
            case 'pair_bonus':
                this.energy += Math.floor(15 * mult);
                this.materials += Math.floor(10 * mult);
                UI.showToast('ğŸ° PAIR', 'Small bonus');
                SFX.play(300, 'sine', 0.15, 0.06);
                this.addXP(10);
                break;
                
            default:
                // Generic parsing
                const effectText = match.effect;
                const numbers = effectText.match(/\d+/g);
                
                if(effectText.includes('Energy') && numbers) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.energy += amt;
                    UI.showToast(match.name, `+${amt} Energy`);
                    this.addXP(20);
                } else if(effectText.includes('Materials') && numbers) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.materials += amt;
                    UI.showToast(match.name, `+${amt} Materials`);
                    this.addXP(20);
                } else if(effectText.includes('Credits') && numbers) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.credits += amt;
                    UI.showToast(match.name, `+${amt} Credits`);
                    this.addXP(20);
                } else if(effectText.includes('Population') && numbers) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    for(let i=0; i<amt; i++) Sim.spawnAgent();
                    UI.showToast(match.name, `+${amt} Population`);
                    this.addXP(20);
                } else if(effectText.includes('All Resources') && numbers) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.energy += amt;
                    this.materials += amt;
                    this.credits += amt;
                    UI.showToast(match.name, `+${amt} All Resources`);
                    this.addXP(30);
                    SFX.win();
                } else if(effectText.includes('XP') && numbers) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.addXP(amt);
                    UI.showToast(match.name, `+${amt} XP`);
                }
                
                if(!numbers) {
                    if(effectText.includes('Free Upgrades')) {
                        let upgraded = 0;
                        for(let b of Sim.buildings.slice(0, 10)) {
                            b.level++;
                            b.value = Math.floor(b.value * 1.5);
                            b.mesh.scale.multiplyScalar(1.05);
                            upgraded++;
                        }
                        UI.showMilestone('ğŸ—¡ï¸', 'STRENGTH', `${upgraded} buildings upgraded!`);
                        SFX.jackpot();
                        this.addXP(200);
                    } else if(effectText.includes('Random Mega Bonus')) {
                        this.energy += Math.floor(Math.random() * 100 + 50);
                        this.materials += Math.floor(Math.random() * 50 + 25);
                        this.credits += Math.floor(Math.random() * 75 + 40);
                        UI.showToast('ğŸª THE FOOL', 'Random fortune!');
                        this.addXP(60);
                        SFX.win();
                    } else if(effectText.includes('Spin Again Free')) {
                        this.energy += 15;
                        UI.showToast('ğŸ¦… WHEEL OF FORTUNE', 'Free spin!');
                        this.addXP(30);
                    } else if(effectText.includes('5x Combo Multiplier')) {
                        this.comboMultiplier = 5;
                        UI.showMilestone('ğŸ­', 'THE MAGICIAN', 'Combo multiplier 5x!');
                        SFX.jackpot();
                        this.addXP(100);
                    } else if(effectText.includes('Double XP')) {
                        this.xpNeeded = Math.floor(this.xpNeeded * 0.8);
                        UI.showMilestone('ğŸ’€', 'DEATH (TRANSFORM)', 'XP requirement lowered!');
                        SFX.jackpot();
                        this.addXP(50);
                    }
                }
                
                SFX.play(450, 'sine', 0.25, 0.08);
        }
    },

    produceResources: function() {
        for(let b of Sim.buildings) {
            if(b.production === 'energy') this.energy += b.value;
            else if(b.production === 'materials') this.materials += b.value;
            else if(b.production === 'credits') this.credits += b.value;
            else if(b.production === 'population' && Sim.entities.length < 100) {
                for(let i=0; i<Math.min(b.value, 2); i++) Sim.spawnAgent();
            }
        }
        this.updateHUD();
    },

    addXP: function(amount) {
        this.xp += amount;
        if(this.xp >= this.xpNeeded) {
            this.levelUp();
        }
        this.updateXPBar();
    },

    levelUp: function() {
        this.level++;
        this.xp = 0;
        this.xpNeeded = Math.floor(this.xpNeeded * 1.5);
        
        SFX.levelUp();
        UI.showMilestone('â¬†ï¸', `ARCHITECT LEVEL ${this.level}`, 'Your mastery deepens!');
        
        this.energy += 50;
        this.materials += 20;
        this.credits += 30;
        
        this.updateXPBar();
    },

    updateXPBar: function() {
        const percent = (this.xp / this.xpNeeded) * 100;
        document.getElementById('xp-bar').style.width = percent + '%';
        document.getElementById('level-num').innerText = this.level;
        document.getElementById('xp-text').innerText = `${this.xp} / ${this.xpNeeded} XP`;
    },

    updateHUD: function() {
        document.getElementById('ui-energy').innerText = this.energy;
        document.getElementById('ui-materials').innerText = this.materials;
        document.getElementById('ui-credits').innerText = this.credits;
        document.getElementById('ui-pop').innerText = Sim.entities.length;
        document.getElementById('ui-builds').innerText = this.buildingsBuilt;
        
        document.getElementById('btn-spin').disabled = this.energy < 15;
        
        if(this.buildingsBuilt === 10 && !this.milestones?.buildings10) {
            this.milestones = this.milestones || {};
            this.milestones.buildings10 = true;
            UI.showMilestone('ğŸ—ï¸', 'CITY FOUNDER', 'Built 10 structures!');
            this.addXP(100);
        }
        
        if(Sim.entities.length >= 50 && !this.milestones?.pop50) {
            this.milestones = this.milestones || {};
            this.milestones.pop50 = true;
            UI.showMilestone('ğŸ§¬', 'POPULATION BOOM', 'Reached 50 citizens!');
            this.addXP(150);
        }
        
        if(this.buildingsBuilt >= 50 && !this.milestones?.buildings50) {
            this.milestones = this.milestones || {};
            this.milestones.buildings50 = true;
            UI.showMilestone('ğŸŒ†', 'METROPOLIS', '50 structures!');
            this.addXP(300);
        }
        
        if(this.level >= 10 && !this.milestones?.level10) {
            this.milestones = this.milestones || {};
            this.milestones.level10 = true;
            UI.showMilestone('â­', 'MASTER ARCHITECT', 'Level 10 reached!');
            this.credits += 500;
        }
    }
};

window.initSim = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init();
    Sim.init();
    Game.init();
};

window.toggleAuto = () => Game.toggleAuto();
window.toggleTurbo = () => Game.toggleTurbo();
window.toggleMachineCollapse = () => Game.toggleMachineCollapse();
window.spin = () => Game.spin();
window.upgradeSelected = () => {
    if(Sim.selectedBuilding) {
        Sim.upgradeBuilding(Sim.selectedBuilding);
    }
};

</script>
</body>
</html>
