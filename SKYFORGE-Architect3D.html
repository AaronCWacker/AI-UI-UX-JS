<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SKYFORGE: Embodied Intelligence</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;600;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: 'Exo 2', sans-serif; 
            color: #0ff; 
        }

        #viewport { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            cursor: crosshair; 
        }

        /* Dialog System */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .dialog-overlay.active {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        .dialog-overlay.dismissing {
            animation: fadeOut 0.3s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .dialog-box {
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 3px solid #0ff;
            border-top: 6px solid #f0a;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border-radius: 10px;
            box-shadow: 0 0 60px rgba(0,255,255,0.5);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .dialog-icon {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .dialog-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-shadow: 0 0 20px #f0a;
        }
        
        .dialog-message {
            color: #0ff;
            font-size: 16px;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border: 2px solid #f0a;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,0,255,0.5);
            transition: all 0.3s;
        }
        
        .dialog-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,0,255,0.8);
        }

        .dialog-progress {
            width: 100%;
            height: 3px;
            background: rgba(0,255,255,0.2);
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .dialog-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #f0a);
            width: 100%;
            animation: progressShrink 3s linear forwards;
            box-shadow: 0 0 10px #0ff;
        }
        
        .dialog-hint {
            text-align: center;
            color: #666;
            font-size: 11px;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        @keyframes progressShrink {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 160;
            pointer-events: none;
        }
        
        .toast {
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 2px solid #0ff;
            border-left: 5px solid #f0a;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(0,255,255,0.5);
            animation: toastSlide 0.3s;
            pointer-events: auto;
            min-width: 250px;
        }
        
        @keyframes toastSlide {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 14px;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .toast-message {
            color: #0ff;
            font-size: 12px;
        }

        /* Main HUD - Left Side */
        #hud {
            position: fixed; 
            top: 15px; 
            left: 15px; 
            z-index: 10;
            background: linear-gradient(135deg, rgba(0,10,30,0.95) 0%, rgba(0,5,20,0.85) 100%);
            border: 2px solid #0ff;
            border-left: 5px solid #f0a;
            padding: 20px;
            width: 280px;
            box-shadow: 0 0 40px rgba(0,255,255,0.3);
            border-radius: 5px;
        }
        
        .hud-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: #f0a;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #f0a;
        }

        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .stat-row:hover {
            background: rgba(0,255,255,0.1);
            border-left-color: #0ff;
        }

        .stat-val { 
            font-weight: bold; 
            font-size: 20px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .label { 
            color: #888; 
            font-size: 11px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        #combo-display {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,0,255,0.1);
            border: 1px solid #f0a;
            text-align: center;
            font-size: 14px;
            color: #f0a;
            font-weight: bold;
            letter-spacing: 2px;
        }

        #level-bar {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #0ff;
        }
        
        .level-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #0ff;
        }
        
        .xp-bar-bg {
            width: 100%;
            height: 8px;
            background: #111;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #f0a);
            width: 0%;
            transition: width 0.5s;
            box-shadow: 0 0 10px #0ff;
        }

        /* Cognition Panel - Right Side */
        #cognition-panel {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 10;
            background: linear-gradient(135deg, rgba(10,0,30,0.95) 0%, rgba(5,0,20,0.85) 100%);
            border: 2px solid #f0a;
            border-right: 5px solid #0ff;
            padding: 20px;
            width: 300px;
            box-shadow: 0 0 40px rgba(255,0,255,0.3);
            border-radius: 5px;
        }

        .cognition-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: #0ff;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #0ff;
        }

        .cognition-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border-left: 3px solid #0ff;
        }

        .cognition-label {
            color: #0ff;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cognition-value {
            color: #f0a;
            font-weight: bold;
            font-size: 16px;
            font-family: 'Orbitron', sans-serif;
        }

        .cognition-bar {
            width: 100%;
            height: 6px;
            background: #111;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .cognition-bar-fill {
            height: 100%;
            transition: width 0.5s;
            box-shadow: 0 0 8px;
        }

        .bar-cellular { background: #0f0; box-shadow: 0 0 8px #0f0; }
        .bar-tissue { background: #0ff; box-shadow: 0 0 8px #0ff; }
        .bar-organ { background: #f0a; box-shadow: 0 0 8px #f0a; }
        .bar-swarm { background: #fa0; box-shadow: 0 0 8px #fa0; }

        .mode-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            border: 2px solid #f0a;
            color: #f0a;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 11px;
            letter-spacing: 1px;
            transition: all 0.3s;
            border-radius: 5px;
        }

        .mode-btn:hover {
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            color: #fff;
            box-shadow: 0 0 20px rgba(255,0,255,0.6);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            color: #fff;
            box-shadow: 0 0 20px rgba(255,0,255,0.8);
        }

        /* Slot Machine */
        #ui-layer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            z-index: 10; 
            display: flex; 
            justify-content: center; 
            padding-bottom: 20px;
        }
        
        .machine-frame { 
            width: 600px; 
            background: linear-gradient(135deg, #0a0a20 0%, #050510 100%);
            border: 3px solid #0ff;
            border-top: 6px solid #f0a;
            padding: 20px;
            box-shadow: 0 0 60px rgba(0,255,255,0.5);
            border-radius: 10px;
            position: relative;
            transition: transform 0.3s;
        }
        
        .machine-collapse-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            border: 2px solid #0ff;
            color: #0ff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            z-index: 11;
        }
        
        .machine-collapse-btn:hover {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 20px #0ff;
        }
        
        .machine-frame.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .machine-frame.collapsed .reels,
        .machine-frame.collapsed .controls,
        .machine-frame.collapsed .payout-info {
            display: none;
        }
        
        .machine-title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: #f0a;
            font-size: 18px;
            margin-bottom: 15px;
            letter-spacing: 4px;
            text-shadow: 0 0 15px #f0a;
        }

        .reels { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 5px;
            background: #000;
            height: 120px;
            margin-bottom: 15px;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
        }
        
        .reel-strip { 
            background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);
            border-right: 2px solid #222;
            position: relative;
            overflow: hidden;
        }
        
        .reel-strip:last-child {
            border-right: none;
        }
        
        .symbol { 
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            position: relative;
            transition: transform 0.3s;
        }
        
        .symbol:hover {
            transform: scale(1.1);
        }
        
        .symbol.win {
            animation: symbolWin 0.5s infinite;
        }
        
        @keyframes symbolWin {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(2); }
        }

        .controls { 
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .btn { 
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
            color: #0ff;
            border: 2px solid #0ff;
            padding: 15px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,255,255,0.3);
        }
        
        .btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #0ff 0%, #08a 100%);
            color: #000;
            box-shadow: 0 0 20px rgba(0,255,255,0.8);
            transform: translateY(-2px);
        }
        
        .btn.active { 
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border-color: #f0a;
            box-shadow: 0 0 20px rgba(255,0,255,0.6);
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        #btn-spin { 
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border-color: #f0a;
            font-size: 14px;
            box-shadow: 0 0 20px rgba(255,0,255,0.5);
        }
        
        #btn-spin:hover:not(:disabled) {
            background: linear-gradient(135deg, #fff 0%, #f0a 100%);
            box-shadow: 0 0 30px rgba(255,0,255,0.9);
        }

        .payout-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 10px;
            color: #666;
            margin-top: 10px;
        }
        
        .payout-item {
            padding: 5px;
            background: rgba(0,0,0,0.5);
            border-left: 2px solid #333;
            display: flex;
            justify-content: space-between;
        }

        /* Camera Controls */
        #camera-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .cam-btn {
            width: 50px;
            height: 50px;
            background: rgba(0,20,40,0.9);
            border: 2px solid #0ff;
            color: #0ff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        .cam-btn:hover {
            background: rgba(0,255,255,0.3);
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }

        /* Overlay */
        #overlay { 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background: linear-gradient(135deg, #000 0%, #0a0a20 50%, #000 100%);
            z-index:200; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            justify-content:center;
        }
        
        #overlay h1 { 
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem; 
            color: #f0a;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 10px;
            text-shadow: 0 0 30px #f0a, 0 0 60px #f0a;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { text-shadow: 0 0 30px #f0a; }
            50% { text-shadow: 0 0 60px #f0a, 0 0 90px #f0a; }
        }
        
        #overlay h2 {
            font-family: 'Exo 2', sans-serif;
            font-size: 1.8rem;
            color: #0ff;
            margin-bottom: 20px;
            letter-spacing: 4px;
            text-shadow: 0 0 20px #0ff;
        }
        
        #overlay p { 
            color: #0ff;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
            max-width: 700px;
            line-height: 1.6;
        }
        
        #overlay button { 
            padding: 20px 60px;
            font-size: 22px;
            background: linear-gradient(135deg, #f0a 0%, #a05 100%);
            border: 3px solid #f0a;
            font-weight: 900;
            cursor: pointer;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 40px #f0a;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.3s;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        #overlay button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px #f0a;
        }

        .float-text { 
            position: absolute;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            font-size: 24px;
            z-index: 100;
        }
        
        @keyframes floatUp { 
            0% { opacity: 1; transform: translateY(0) scale(0.5); } 
            50% { transform: translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); } 
        }

        /* Building Info Panel */
        #build-info {
            position: fixed;
            top: 50%;
            right: -350px;
            transform: translateY(-50%);
            width: 300px;
            background: rgba(0,10,30,0.95);
            border: 2px solid #0ff;
            border-right: none;
            padding: 20px;
            z-index: 15;
            transition: right 0.3s;
            border-radius: 5px 0 0 5px;
        }
        
        #build-info.visible {
            right: 0;
        }
        
        .info-title {
            font-family: 'Orbitron', sans-serif;
            color: #f0a;
            font-size: 16px;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }
        
        .info-row {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .info-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .info-value {
            color: #0ff;
            font-size: 16px;
            font-weight: bold;
        }
        
        #upgrade-btn {
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1>SKYFORGE</h1>
    <h2>Embodied Intelligence</h2>
    <p>
        <strong>Discover Multi-Scale Cognition:</strong><br>
        From cellular networks to swarm consciousness.<br>
        Harness bioelectric patterns. Trigger morphogenesis. Create synthetic life.<br>
        <br>
        <strong>40+ Tarot Combinations:</strong><br>
        ğŸ§¬ Cellular â€¢ âš¡ Bioelectric â€¢ ğŸ”„ Morphogenesis â€¢ ğŸŒŠ Swarm â€¢ ğŸ§ª Xenobots
    </p>
    <button onclick="initSim()">âš¡ INITIALIZE SKYFORGE âš¡</button>
</div>

<div id="viewport"></div>

<div class="dialog-overlay" id="dialog-overlay">
    <div class="dialog-box">
        <div class="dialog-icon" id="dialog-icon"></div>
        <div class="dialog-title" id="dialog-title"></div>
        <div class="dialog-message" id="dialog-message"></div>
        <div class="dialog-buttons" id="dialog-buttons"></div>
        <div class="dialog-progress" id="dialog-progress" style="display:none;">
            <div class="dialog-progress-bar" id="dialog-progress-bar"></div>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<div id="hud">
    <div class="hud-title">âš¡ RESOURCES âš¡</div>
    
    <div class="stat-row">
        <span class="label">âš¡ Energy</span>
        <span id="ui-energy" class="stat-val" style="color:#0ff">150</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ”§ Materials</span>
        <span id="ui-materials" class="stat-val" style="color:#ffaa00">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ’ Credits</span>
        <span id="ui-credits" class="stat-val" style="color:#f0f">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ§¬ Population</span>
        <span id="ui-pop" class="stat-val" style="color:#0f0">0</span>
    </div>
    
    <div class="stat-row">
        <span class="label">ğŸ—ï¸ Structures</span>
        <span id="ui-builds" class="stat-val" style="color:#ff0">0</span>
    </div>
    
    <div id="combo-display">NO COMBO</div>
    
    <div id="level-bar">
        <div class="level-title">
            <span>ARCHITECT LVL <span id="level-num">1</span></span>
            <span id="xp-text">0 / 100 XP</span>
        </div>
        <div class="xp-bar-bg">
            <div class="xp-bar-fill" id="xp-bar"></div>
        </div>
    </div>
</div>

<div id="cognition-panel">
    <div class="cognition-title">ğŸ§  EMBODIED COGNITION ğŸ§ </div>
    
    <div class="cognition-stat">
        <span class="cognition-label">Cellular Intelligence</span>
        <span class="cognition-value" id="cellular-intel">0</span>
    </div>
    <div class="cognition-bar">
        <div class="cognition-bar-fill bar-cellular" id="cellular-bar" style="width:0%"></div>
    </div>
    
    <div class="cognition-stat">
        <span class="cognition-label">Tissue Networks</span>
        <span class="cognition-value" id="tissue-intel">0</span>
    </div>
    <div class="cognition-bar">
        <div class="cognition-bar-fill bar-tissue" id="tissue-bar" style="width:0%"></div>
    </div>
    
    <div class="cognition-stat">
        <span class="cognition-label">Organ Systems</span>
        <span class="cognition-value" id="organ-intel">0</span>
    </div>
    <div class="cognition-bar">
        <div class="cognition-bar-fill bar-organ" id="organ-bar" style="width:0%"></div>
    </div>
    
    <div class="cognition-stat">
        <span class="cognition-label">Swarm Mind</span>
        <span class="cognition-value" id="swarm-intel">0</span>
    </div>
    <div class="cognition-bar">
        <div class="cognition-bar-fill bar-swarm" id="swarm-bar" style="width:0%"></div>
    </div>
    
    <button class="mode-btn" id="bioelectric-btn" onclick="toggleBioelectricView()">
        âš¡ BIOELECTRIC NETWORK
    </button>
    
    <button class="mode-btn" id="morpho-btn" onclick="triggerMorphogenesis()">
        ğŸ”„ TRIGGER MORPHOGENESIS
    </button>
    
    <button class="mode-btn" id="xenobot-btn" onclick="spawnXenobot()">
        ğŸ§ª CREATE XENOBOT (50 CR)
    </button>
</div>

<div id="ui-layer">
    <div class="machine-frame">
        <button class="machine-collapse-btn" onclick="toggleMachineCollapse()">â–¼</button>
        <div class="machine-title">ğŸ° COGNITION FORGE ğŸ°</div>
        <div class="reels" id="reels-container"></div>
        <div class="controls">
            <button class="btn" id="btn-turbo" onclick="toggleTurbo()">âš¡ TURBO</button>
            <button class="btn" id="btn-auto" onclick="toggleAuto()">ğŸ”„ AUTO</button>
            <button class="btn" id="btn-spin" onclick="spin()">SPIN (15 E)</button>
        </div>
        <div class="payout-info" id="payout-info">
            <div style="grid-column: 1/-1; text-align: center; color: #0ff; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px;">EMBODIED INTELLIGENCE CARDS</div>
        </div>
    </div>
</div>

<div id="camera-controls">
    <button class="cam-btn" onclick="Sim.adjustCamera('in')">+</button>
    <button class="cam-btn" onclick="Sim.adjustCamera('out')">âˆ’</button>
    <button class="cam-btn" onclick="Sim.adjustCamera('reset')">âŒ‚</button>
</div>

<div id="build-info">
    <div class="info-title">STRUCTURE DATA</div>
    <div class="info-row">
        <div class="info-label">Type</div>
        <div class="info-value" id="info-type">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Level</div>
        <div class="info-value" id="info-level">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Production</div>
        <div class="info-value" id="info-production">-</div>
    </div>
    <div class="info-row">
        <div class="info-label">Cognition Type</div>
        <div class="info-value" id="info-cognition">-</div>
    </div>
    <button class="btn" id="upgrade-btn" onclick="upgradeSelected()">UPGRADE (50 CR)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* ================= UI SYSTEM ================= */
const UI = {
    showDialog: function(icon, title, message, buttons = [{text: 'OK', primary: true}]) {
        const overlay = document.getElementById('dialog-overlay');
        document.getElementById('dialog-icon').innerText = icon;
        document.getElementById('dialog-title').innerText = title;
        document.getElementById('dialog-message').innerText = message;
        document.getElementById('dialog-progress').style.display = 'none';
        
        const btnContainer = document.getElementById('dialog-buttons');
        btnContainer.innerHTML = '';
        
        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = btn.primary ? 'dialog-btn' : 'dialog-btn secondary';
            button.innerText = btn.text;
            button.onclick = () => {
                overlay.classList.remove('active');
                if(btn.callback) btn.callback();
            };
            btnContainer.appendChild(button);
        });
        
        overlay.classList.add('active');
    },
    
    showToast: function(title, message, duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        `;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'toastSlide 0.3s reverse';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    },
    
    showMilestone: function(icon, title, message, duration = 3000) {
        const overlay = document.getElementById('dialog-overlay');
        const progressBar = document.getElementById('dialog-progress');
        
        document.getElementById('dialog-icon').innerText = icon;
        document.getElementById('dialog-title').innerText = title;
        document.getElementById('dialog-message').innerText = message;
        document.getElementById('dialog-buttons').innerHTML = '';
        
        progressBar.style.display = 'block';
        progressBar.innerHTML = `
            <div class="dialog-progress-bar" id="dialog-progress-bar"></div>
            <div class="dialog-hint">Click anywhere to continue</div>
        `;
        
        const newProgressBarFill = document.getElementById('dialog-progress-bar');
        newProgressBarFill.style.animation = `progressShrink ${duration/1000}s linear forwards`;
        
        overlay.classList.remove('dismissing');
        overlay.classList.add('active');
        
        const timeoutId = setTimeout(() => {
            this.dismissMilestone(overlay, progressBar);
        }, duration);
        
        const earlyDismiss = () => {
            clearTimeout(timeoutId);
            this.dismissMilestone(overlay, progressBar);
            overlay.removeEventListener('click', earlyDismiss);
        };
        overlay.addEventListener('click', earlyDismiss);
    },
    
    dismissMilestone: function(overlay, progressBar) {
        overlay.classList.add('dismissing');
        setTimeout(() => {
            overlay.classList.remove('active', 'dismissing');
            progressBar.style.display = 'none';
        }, 300);
    }
};

/* ================= TAROT CARD DATA ================= */
const TAROT_DATA = `emoji1,emoji2,emoji3,emoji4,emoji5,card_name,effect,rarity
ğŸ§¬,ğŸ§¬,ğŸ§¬,ğŸ§¬,ğŸ§¬,Cellular Genesis,+500 Cellular Intel,legendary
ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,Swarm Consciousness,+500 Swarm Intel,legendary
âš¡,âš¡,âš¡,âš¡,âš¡,Bioelectric Surge,+200 Energy +Network Boost,epic
ğŸ”®,ğŸ”®,ğŸ”®,ğŸ”®,ğŸ”®,Proto-Cognition,+100 All Intel Types,epic
ğŸŒ™,ğŸŒ™,ğŸŒ™,ğŸŒ™,ğŸŒ™,Morphogenetic Field,Trigger Morphogenesis,epic
ğŸ§ª,ğŸ§ª,ğŸ§ª,ğŸ§ª,ğŸ§ª,Synthetic Life,Create 3 Xenobots,epic
ğŸ’«,ğŸ’«,ğŸ’«,ğŸ’«,ğŸ’«,Emergent Mind,All Systems Level Up,epic
ğŸ”¬,ğŸ”¬,ğŸ”¬,ğŸ”¬,ğŸ”¬,Developmental Bio,+150 Tissue Networks,rare
ğŸŒ€,ğŸŒ€,ğŸŒ€,ğŸŒ€,ğŸŒ€,Self-Organization,Buildings Auto-Connect,rare
ğŸ’,ğŸ’,ğŸ’,ğŸ’,ğŸ’,Crystallized Thought,+150 Credits,rare
ğŸ”¥,ğŸ”¥,ğŸ”¥,ğŸ”¥,ğŸ”¥,Metabolic Surge,+100 Energy,rare
ğŸŒ¿,ğŸŒ¿,ğŸŒ¿,ğŸŒ¿,ğŸŒ¿,Adaptive Growth,+75 All Resources,rare
ğŸ¯,ğŸ¯,ğŸ¯,ğŸ¯,ğŸ¯,Target Morphology,+100 Organ Systems,rare
ğŸ›¡ï¸,ğŸ›¡ï¸,ğŸ›¡ï¸,ğŸ›¡ï¸,ğŸ›¡ï¸,Somatic Protection,+40 Energy,uncommon
ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,ğŸŒŠ,Collective Flow,+30 Swarm Intel,uncommon
ğŸ”§,ğŸ”§,ğŸ”§,ğŸ”§,ğŸ”§,Morpho-Engineer,+30 Materials,uncommon
ğŸ§¬,ğŸ§¬,ğŸ§¬,ğŸ§¬,ğŸ§¬,Cell Collective,+30 Cellular Intel,uncommon
ğŸŒŸ,ğŸŒŸ,ğŸŒŸ,ğŸŒŸ,ğŸŒŸ,The Universe,All resources maxed,legendary
ğŸ‘‘,ğŸ‘‘,ğŸ‘‘,ğŸ‘‘,ğŸ‘‘,The Emperor,+500 Credits,legendary
ğŸ§¬,âš¡,ğŸ”®,ğŸŒŠ,ğŸ’«,Scale-Free Mind,All Cognition +200,mythic
ğŸ”¬,ğŸ§ª,ğŸŒ€,ğŸ”¥,ğŸŒ¿,Life As It Can Be,Triple Production,mythic
âš¡,ğŸ§¬,ğŸŒŠ,ğŸ”®,ğŸ¯,Embodied Intelligence,Instant Evolution,mythic`;

const TarotCards = {
    cards: [],
    symbolPool: [],
    rarityWeights: {'legendary': 1, 'mythic': 2, 'epic': 5, 'rare': 15, 'uncommon': 30, 'common': 47},
    
    init: function() {
        const lines = TAROT_DATA.trim().split('\n');
        for(let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            this.cards.push({
                emojis: [values[0], values[1], values[2], values[3], values[4]],
                name: values[5],
                effect: values[6],
                rarity: values[7]
            });
        }
        
        this.cards.forEach(card => {
            const weight = this.rarityWeights[card.rarity] || 10;
            for(let i = 0; i < weight; i++) {
                card.emojis.forEach(emoji => this.symbolPool.push(emoji));
            }
        });
        
        console.log(`âœ¨ Loaded ${this.cards.length} embodied cognition cards`);
    },
    
    getRandomSymbol: function() {
        if(this.symbolPool.length === 0) return ['ğŸ§¬', 'âš¡', 'ğŸ”®', 'ğŸŒŠ', 'ğŸ’«'][Math.floor(Math.random() * 5)];
        return this.symbolPool[Math.floor(Math.random() * this.symbolPool.length)];
    },
    
    checkCombination: function(symbols) {
        for(let card of this.cards) {
            if(this.arraysEqual(symbols, card.emojis)) return card;
        }
        
        const counts = {};
        symbols.forEach(s => counts[s] = (counts[s] || 0) + 1);
        const maxCount = Math.max(...Object.values(counts));
        
        if(maxCount === 5) {
            const symbol = Object.keys(counts).find(k => counts[k] === 5);
            const card = this.cards.find(c => c.emojis[0] === symbol && c.emojis.every(e => e === symbol));
            if(card) return card;
        }
        
        if(maxCount === 4) return {name: 'Four of a Kind', effect: 'quad_bonus', rarity: 'rare'};
        if(maxCount === 3) return {name: 'Three of a Kind', effect: 'triple_bonus', rarity: 'uncommon'};
        
        if(maxCount === 2) {
            const pairs = Object.keys(counts).filter(k => counts[k] === 2);
            if(pairs.length === 2) return {name: 'Two Pairs', effect: 'double_pair', rarity: 'common'};
            return {name: 'Pair', effect: 'pair_bonus', rarity: 'common'};
        }
        
        return null;
    },
    
    arraysEqual: function(a, b) {
        if(a.length !== b.length) return false;
        for(let i = 0; i < a.length; i++) {
            if(a[i] !== b[i]) return false;
        }
        return true;
    }
};

/* ================= AUDIO ================= */
const SFX = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    play: function(freq, type, dur, vol=0.1, slide=false) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) o.frequency.exponentialRampToValueAtTime(freq/2, this.ctx.currentTime+dur);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        o.connect(g);
        g.connect(this.ctx.destination);
        o.start();
        o.stop(this.ctx.currentTime + dur);
    },
    chord: function(freqs, type='sine', dur=0.3, vol=0.05) {
        freqs.forEach(f => this.play(f, type, dur, vol));
    },
    born: () => SFX.chord([400, 500, 600], 'sine', 0.15, 0.04),
    droneHit: () => {
        SFX.play(200, 'square', 0.15, 0.15);
        setTimeout(()=>SFX.chord([150, 180, 220], 'sawtooth', 0.25, 0.12, true), 50);
    },
    build: () => SFX.chord([80, 120, 160], 'square', 0.4, 0.2),
    spin: () => SFX.play(300, 'sawtooth', 0.08, 0.08),
    win: () => SFX.chord([500, 625, 750, 1000], 'sine', 0.5, 0.15),
    jackpot: () => {
        for(let i=0; i<5; i++) {
            setTimeout(()=>SFX.chord([400+i*100, 500+i*100, 600+i*100], 'sine', 0.3, 0.1), i*100);
        }
    },
    upgrade: () => SFX.chord([600, 800, 1000], 'triangle', 0.3, 0.1),
    levelUp: () => {
        SFX.chord([400, 500, 600, 800], 'sine', 0.5, 0.15);
        setTimeout(()=>SFX.chord([800, 1000, 1200, 1600], 'sine', 0.5, 0.15), 200);
    },
    bioelectric: () => SFX.play(800, 'sine', 0.5, 0.08, true),
    morpho: () => {
        for(let i=0; i<3; i++) {
            setTimeout(()=>SFX.chord([300+i*50, 400+i*50, 500+i*50], 'triangle', 0.4, 0.1), i*150);
        }
    },
    xenobot: () => SFX.chord([350, 450, 550, 650], 'square', 0.4, 0.12)
};

/* ================= COGNITION SYSTEM ================= */
const CognitionSystem = {
    cellular: 0,
    tissue: 0,
    organ: 0,
    swarm: 0,
    bioelectricView: false,
    bioelectricLines: [],
    xenobots: [],
    
    update: function() {
        this.cellular = Math.floor(Sim.entities.length / 2);
        this.tissue = Math.floor(Sim.buildings.length * 5);
        this.organ = Math.floor(Sim.buildings.filter(b => b.level >= 3).length * 10);
        this.swarm = Math.floor(Math.sqrt(Sim.entities.length) * 10);
        this.updateUI();
    },
    
    updateUI: function() {
        document.getElementById('cellular-intel').innerText = this.cellular;
        document.getElementById('tissue-intel').innerText = this.tissue;
        document.getElementById('organ-intel').innerText = this.organ;
        document.getElementById('swarm-intel').innerText = this.swarm;
        
        document.getElementById('cellular-bar').style.width = Math.min(100, (this.cellular / 1000) * 100) + '%';
        document.getElementById('tissue-bar').style.width = Math.min(100, (this.tissue / 1000) * 100) + '%';
        document.getElementById('organ-bar').style.width = Math.min(100, (this.organ / 1000) * 100) + '%';
        document.getElementById('swarm-bar').style.width = Math.min(100, (this.swarm / 1000) * 100) + '%';
    },
    
    toggleBioelectric: function() {
        this.bioelectricView = !this.bioelectricView;
        const btn = document.getElementById('bioelectric-btn');
        btn.classList.toggle('active');
        
        if(this.bioelectricView) {
            UI.showToast('âš¡ BIOELECTRIC NETWORK', 'Visualizing cellular information flows');
            SFX.bioelectric();
            this.createBioelectricNetwork();
        } else {
            UI.showToast('âš¡ BIOELECTRIC NETWORK', 'Standard view restored');
            this.clearBioelectricNetwork();
        }
    },
    
    createBioelectricNetwork: function() {
        for(let i = 0; i < Sim.buildings.length; i++) {
            for(let j = i + 1; j < Sim.buildings.length; j++) {
                const b1 = Sim.buildings[i];
                const b2 = Sim.buildings[j];
                const dist = b1.mesh.position.distanceTo(b2.mesh.position);
                
                if(dist < 30) {
                    const geometry = new THREE.BufferGeometry().setFromPoints([
                        b1.mesh.position,
                        b2.mesh.position
                    ]);
                    const material = new THREE.LineBasicMaterial({
                        color: 0x00ffff,
                        transparent: true,
                        opacity: 0.3,
                        linewidth: 2
                    });
                    const line = new THREE.Line(geometry, material);
                    Sim.scene.add(line);
                    this.bioelectricLines.push(line);
                }
            }
        }
    },
    
    clearBioelectricNetwork: function() {
        this.bioelectricLines.forEach(line => Sim.scene.remove(line));
        this.bioelectricLines = [];
    },
    
    triggerMorphogenesis: function() {
        if(Sim.buildings.length < 3) {
            UI.showDialog('âš ï¸', 'INSUFFICIENT STRUCTURES', 'Need at least 3 buildings to trigger morphogenesis!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        SFX.morpho();
        UI.showMilestone('ğŸŒ€', 'MORPHOGENESIS ACTIVATED', 'Structures are self-organizing and adapting!');
        
        const numAffected = Math.min(3, Sim.buildings.length);
        for(let i = 0; i < numAffected; i++) {
            const building = Sim.buildings[Math.floor(Math.random() * Sim.buildings.length)];
            
            building.level++;
            building.value = Math.floor(building.value * 1.3);
            
            new TWEEN.Tween(building.mesh.scale)
                .to({x: building.mesh.scale.x * 1.2, y: building.mesh.scale.y * 1.2, z: building.mesh.scale.z * 1.2}, 500)
                .easing(TWEEN.Easing.Elastic.Out)
                .start();
                
            Sim.spawnParticles(building.mesh.position.x, building.mesh.position.y, building.mesh.position.z, 0x00ffff, 15);
        }
        
        Game.addXP(100);
        this.tissue += 50;
        this.organ += 25;
        this.update();
    },
    
    spawnXenobot: function() {
        if(Game.credits < 50) {
            UI.showDialog('âš ï¸', 'INSUFFICIENT CREDITS', 'Need 50 credits to create a xenobot!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        Game.credits -= 50;
        SFX.xenobot();
        
        const colors = [0xff00ff, 0x00ffff, 0xffff00];
        const geo = new THREE.OctahedronGeometry(1.5);
        const mat = new THREE.MeshStandardMaterial({
            color: colors[Math.floor(Math.random()*colors.length)],
            emissive: 0xffffff,
            emissiveIntensity: 0.8,
            metalness: 0.7,
            roughness: 0.3,
            wireframe: true
        });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set((Math.random()-0.5)*40, 1, (Math.random()-0.5)*40);
        mesh.castShadow = true;
        Sim.scene.add(mesh);
        
        const light = new THREE.PointLight(mat.color, 2, 15);
        mesh.add(light);
        
        this.xenobots.push({
            mesh: mesh,
            target: new THREE.Vector3(0, 1, 0),
            resourceBonus: 0.5
        });
        
        UI.showToast('ğŸ§ª XENOBOT CREATED', 'Synthetic organism deployed!');
        this.cellular += 20;
        this.update();
        Game.updateHUD();
    },
    
    updateXenobots: function() {
        for(let xeno of this.xenobots) {
            if(xeno.mesh.position.distanceTo(xeno.target) < 2) {
                xeno.target.set((Math.random()-0.5)*50, 1, (Math.random()-0.5)*50);
            }
            
            const dir = new THREE.Vector3().subVectors(xeno.target, xeno.mesh.position).normalize();
            xeno.mesh.position.add(dir.multiplyScalar(0.15));
            
            xeno.mesh.rotation.x += 0.03;
            xeno.mesh.rotation.y += 0.03;
        }
    }
};

/* ================= 3D SIMULATION ================= */
const Sim = {
    scene: null, camera: null, renderer: null, raycaster: null, mouse: null,
    entities: [], buildings: [], selectedBuilding: null,
    drone: null, droneSpeed: 1,
    cameraDistance: 100, cameraAngle: 0,
    
    init: function() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x0a0a15, 0.008);
        
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
        this.updateCameraPosition();

        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('viewport').appendChild(this.renderer.domElement);

        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        window.addEventListener('pointerdown', this.onMouseClick.bind(this));

        const amb = new THREE.AmbientLight(0x303050, 0.6);
        this.scene.add(amb);
        
        const sun = new THREE.DirectionalLight(0xffaa00, 1.5);
        sun.position.set(80, 150, 80);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 4096;
        sun.shadow.mapSize.height = 4096;
        sun.shadow.camera.left = -100;
        sun.shadow.camera.right = 100;
        sun.shadow.camera.top = 100;
        sun.shadow.camera.bottom = -100;
        this.scene.add(sun);
        
        const accent = new THREE.PointLight(0xff00ff, 2, 100);
        accent.position.set(0, 50, 0);
        this.scene.add(accent);

        const grid = new THREE.GridHelper(300, 60, 0x0ff, 0x0aa);
        this.scene.add(grid);
        
        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(300, 300),
            new THREE.MeshStandardMaterial({
                color: 0x0a0a20,
                roughness: 0.8,
                metalness: 0.2,
                emissive: 0x00ffff,
                emissiveIntensity: 0.1
            })
        );
        plane.rotation.x = -Math.PI/2;
        plane.receiveShadow = true;
        this.scene.add(plane);

        this.createDrone();
        this.animate();
        
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    },

    updateCameraPosition: function() {
        this.camera.position.set(
            Math.cos(this.cameraAngle) * this.cameraDistance,
            this.cameraDistance * 0.6,
            Math.sin(this.cameraAngle) * this.cameraDistance
        );
        this.camera.lookAt(0, 0, 0);
    },

    adjustCamera: function(dir) {
        if(dir === 'in') this.cameraDistance = Math.max(50, this.cameraDistance - 20);
        else if(dir === 'out') this.cameraDistance = Math.min(200, this.cameraDistance + 20);
        else if(dir === 'reset') { this.cameraDistance = 100; this.cameraAngle = 0; }
        this.updateCameraPosition();
    },

    createDrone: function() {
        const group = new THREE.Group();
        
        const core = new THREE.Mesh(
            new THREE.IcosahedronGeometry(2, 1),
            new THREE.MeshStandardMaterial({
                color: 0xffffff,
                emissive: 0xffaa00,
                emissiveIntensity: 1,
                roughness: 0.2,
                metalness: 0.8
            })
        );
        group.add(core);
        
        const ring = new THREE.Mesh(
            new THREE.TorusGeometry(4, 0.3, 8, 32),
            new THREE.MeshStandardMaterial({
                color: 0x00ffff,
                emissive: 0x00ffff,
                emissiveIntensity: 0.5,
                wireframe: true
            })
        );
        group.add(ring);
        
        const hitbox = new THREE.Mesh(
            new THREE.SphereGeometry(7),
            new THREE.MeshBasicMaterial({visible:false})
        );
        hitbox.userData = { isDrone: true };
        group.add(hitbox);

        const light = new THREE.PointLight(0xffaa00, 2, 40);
        group.add(light);

        group.position.set(0, 40, 0);
        this.scene.add(group);
        this.drone = group;
    },

    updateDrone: function(time) {
        if(!this.drone) return;
        
        const speed = this.droneSpeed * 0.0005;
        this.drone.position.x = Math.sin(time * speed) * 50;
        this.drone.position.z = Math.cos(time * speed * 0.7) * 50;
        this.drone.position.y = 40 + Math.sin(time * 0.003) * 8;
        
        this.drone.rotation.x += 0.01;
        this.drone.rotation.y += 0.02;
        
        const scale = 1 + Math.sin(time * 0.005) * 0.1;
        this.drone.children[0].scale.setScalar(scale);
    },

    onMouseClick: function(event) {
        this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersects = this.raycaster.intersectObjects(this.scene.children, true);
        
        for (let hit of intersects) {
            if (hit.object.userData.isDrone) {
                this.deployDrone();
                this.spawnFloatText(event.clientX, event.clientY, "+5 MAT", '#ffaa00');
                break;
            } else if (hit.object.userData.isBuilding) {
                this.selectBuilding(hit.object.userData.building);
                break;
            }
        }
    },

    deployDrone: function() {
        if(Game.materials < 5) {
            UI.showDialog('âš ï¸', 'INSUFFICIENT MATERIALS', 'Need 5 materials to deploy!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        SFX.droneHit();
        Game.materials -= 5;
        
        this.spawnParticles(this.drone.position.x, this.drone.position.y, this.drone.position.z, 0xffaa00, 20);
        
        const crateGeo = new THREE.BoxGeometry(3, 3, 3);
        const crateMat = new THREE.MeshStandardMaterial({
            color: 0x00ffcc,
            emissive: 0x00ffcc,
            emissiveIntensity: 0.5,
            wireframe: true
        });
        const crate = new THREE.Mesh(crateGeo, crateMat);
        crate.position.copy(this.drone.position);
        this.scene.add(crate);
        
        const glowLight = new THREE.PointLight(0x00ffcc, 3, 20);
        crate.add(glowLight);
        
        new TWEEN.Tween(crate.position)
            .to({ y: 0 }, 1200)
            .easing(TWEEN.Easing.Bounce.Out)
            .onComplete(() => {
                this.scene.remove(crate);
                this.buildStructure(crate.position.x, crate.position.z);
            })
            .start();
            
        new TWEEN.Tween(crate.rotation)
            .to({x: Math.PI*3, y: Math.PI*3}, 1200)
            .start();
    },

    buildStructure: function(x, z) {
        SFX.build();
        
        const types = [
            {name: 'Neural Tower', height: 15, geo: 'box', color: 0x0099ff, production: 'energy', value: 2, cognition: 'cellular'},
            {name: 'Tissue Dome', height: 8, geo: 'dodeca', color: 0xffaa00, production: 'materials', value: 1, cognition: 'tissue'},
            {name: 'Organ Spire', height: 12, geo: 'cone', color: 0xff00ff, production: 'credits', value: 3, cognition: 'organ'},
            {name: 'Swarm Nexus', height: 6, geo: 'box', color: 0x00ff00, production: 'population', value: 5, cognition: 'swarm'}
        ];
        
        const type = types[Math.floor(Math.random() * types.length)];
        
        let geo;
        if(type.geo === 'box') geo = new THREE.BoxGeometry(4, type.height, 4);
        else if(type.geo === 'dodeca') geo = new THREE.DodecahedronGeometry(5);
        else if(type.geo === 'cone') geo = new THREE.ConeGeometry(4, type.height, 4);
        
        const mat = new THREE.MeshStandardMaterial({
            color: type.color,
            emissive: type.color,
            emissiveIntensity: 0.3,
            roughness: 0.4,
            metalness: 0.6
        });
        
        const building = new THREE.Mesh(geo, mat);
        building.position.set(x, type.height/2, z);
        building.castShadow = true;
        building.receiveShadow = true;
        
        building.userData = {
            isBuilding: true,
            building: {
                type: type.name,
                level: 1,
                production: type.production,
                value: type.value,
                mesh: building,
                baseColor: type.color,
                cognitionType: type.cognition
            }
        };
        
        const light = new THREE.PointLight(type.color, 1, 20);
        light.position.y = type.height/2;
        building.add(light);
        
        this.scene.add(building);
        this.buildings.push(building.userData.building);
        
        Game.buildingsBuilt++;
        Game.addXP(10);
        CognitionSystem.update();
        
        this.spawnParticles(x, 0, z, 0xaaaaaa, 15);
        
        if(CognitionSystem.bioelectricView) {
            CognitionSystem.clearBioelectricNetwork();
            CognitionSystem.createBioelectricNetwork();
        }
    },

    selectBuilding: function(building) {
        if(this.selectedBuilding) {
            this.selectedBuilding.mesh.material.emissiveIntensity = 0.3;
        }
        
        this.selectedBuilding = building;
        building.mesh.material.emissiveIntensity = 0.8;
        
        document.getElementById('info-type').innerText = building.type;
        document.getElementById('info-level').innerText = building.level;
        document.getElementById('info-production').innerText = 
            `+${building.value} ${building.production}/tick`;
        document.getElementById('info-cognition').innerText = building.cognitionType.toUpperCase();
        document.getElementById('build-info').classList.add('visible');
        
        SFX.play(400, 'sine', 0.1, 0.05);
    },

    upgradeBuilding: function(building) {
        if(Game.credits < 50) {
            UI.showDialog('âš ï¸', 'INSUFFICIENT CREDITS', 'Need 50 credits to upgrade!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        Game.credits -= 50;
        building.level++;
        building.value = Math.floor(building.value * 1.5);
        
        building.mesh.scale.multiplyScalar(1.1);
        const newColor = building.baseColor + 0x111111;
        building.mesh.material.color.setHex(newColor);
        building.mesh.material.emissiveIntensity = 1;
        
        SFX.upgrade();
        this.spawnParticles(building.mesh.position.x, building.mesh.position.y, building.mesh.position.z, 0xff00ff, 10);
        
        this.selectBuilding(building);
        Game.addXP(25);
        Game.updateHUD();
        CognitionSystem.update();
        
        UI.showToast('UPGRADE COMPLETE', `${building.type} level ${building.level}!`);
    },

    spawnAgent: function() {
        if(this.entities.length > 100) return;
        
        const colors = [0x00ffcc, 0xff00ff, 0xffaa00, 0x00ff00];
        const mesh = new THREE.Mesh(
            new THREE.TetrahedronGeometry(0.6),
            new THREE.MeshStandardMaterial({
                color: colors[Math.floor(Math.random()*colors.length)],
                emissive: 0xffffff,
                emissiveIntensity: 0.5
            })
        );
        mesh.position.set(0, 0.6, 0);
        mesh.castShadow = true;
        this.scene.add(mesh);
        
        this.entities.push({
            mesh: mesh,
            target: new THREE.Vector3(0, 0.6, 0),
            speed: 0.05 + Math.random() * 0.1
        });
        
        SFX.born();
        CognitionSystem.update();
    },

    spawnParticles: function(x, y, z, color, count=10) {
        for(let i=0; i<count; i++) {
            const m = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.5, 0.5),
                new THREE.MeshBasicMaterial({color: color})
            );
            m.position.set(x, y, z);
            this.scene.add(m);
            
            new TWEEN.Tween(m.position)
                .to({
                    x: x + (Math.random()-0.5)*8,
                    y: y + Math.random()*8,
                    z: z + (Math.random()-0.5)*8
                }, 600 + Math.random()*400)
                .onComplete(() => this.scene.remove(m))
                .start();
                
            new TWEEN.Tween(m.rotation)
                .to({x: Math.PI*2, y: Math.PI*2}, 800)
                .start();
        }
    },

    spawnFloatText: function(x, y, text, color='#fff') {
        const div = document.createElement('div');
        div.className = 'float-text';
        div.innerText = text;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.color = color;
        div.style.textShadow = `0 0 10px ${color}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    },

    animate: function(time) {
        requestAnimationFrame((t) => Sim.animate(t));
        TWEEN.update(time);
        
        this.updateDrone(time);
        this.cameraAngle += 0.0002;
        this.updateCameraPosition();
        
        for(let a of this.entities) {
            if(a.mesh.position.distanceTo(a.target) < 1) {
                if(this.buildings.length > 0) {
                    const b = this.buildings[Math.floor(Math.random() * this.buildings.length)];
                    a.target.set(
                        b.mesh.position.x + (Math.random()-0.5)*8,
                        0.6,
                        b.mesh.position.z + (Math.random()-0.5)*8
                    );
                } else {
                    a.target.set((Math.random()-0.5)*60, 0.6, (Math.random()-0.5)*60);
                }
            }
            
            const dir = new THREE.Vector3().subVectors(a.target, a.mesh.position).normalize();
            a.mesh.position.add(dir.multiplyScalar(a.speed));
            a.mesh.lookAt(a.target);
            a.mesh.rotation.x += 0.05;
        }
        
        CognitionSystem.updateXenobots();
        
        if(time % 100 < 1) {
            Game.produceResources();
        }

        this.renderer.render(this.scene, this.camera);
    }
};

/* ================= GAME LOGIC ================= */
const Game = {
    energy: 150, materials: 0, credits: 0,
    spinning: false, auto: false, turbo: false, buildingsBuilt: 0,
    level: 1, xp: 0, xpNeeded: 100,
    comboMultiplier: 1, spinsSinceWin: 0, machineCollapsed: false,

    init: function() {
        TarotCards.init();
        this.createReels();
        this.updateHUD();
        this.populatePayoutInfo();
        CognitionSystem.update();
        
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#build-info') && !e.target.closest('#viewport')) {
                document.getElementById('build-info').classList.remove('visible');
                if(Sim.selectedBuilding) {
                    Sim.selectedBuilding.mesh.material.emissiveIntensity = 0.3;
                    Sim.selectedBuilding = null;
                }
            }
        });
    },
    
    populatePayoutInfo: function() {
        const container = document.getElementById('payout-info');
        const topCards = TarotCards.cards.filter(c => c.rarity === 'legendary' || c.rarity === 'mythic').slice(0, 6);
        
        topCards.forEach(card => {
            const item = document.createElement('div');
            item.className = 'payout-item';
            item.style.fontSize = '9px';
            item.innerHTML = `<span>${card.emojis.join('')}</span> <span>${card.name}</span>`;
            container.appendChild(item);
        });
    },

    createReels: function() {
        const c = document.getElementById('reels-container');
        c.innerHTML = '';
        for(let i=0; i<5; i++) {
            const s = document.createElement('div');
            s.className = 'reel-strip';
            s.id = `reel-${i}`;
            s.innerHTML = `<div class="symbol">${TarotCards.getRandomSymbol()}</div>`;
            c.appendChild(s);
        }
    },

    toggleAuto: function() {
        this.auto = !this.auto;
        document.getElementById('btn-auto').classList.toggle('active');
        if(this.auto && !this.spinning) this.spin();
    },
    
    toggleTurbo: function() {
        this.turbo = !this.turbo;
        Sim.droneSpeed = this.turbo ? 3 : 1;
        document.getElementById('btn-turbo').classList.toggle('active');
        UI.showToast('TURBO MODE', this.turbo ? 'Activated âš¡' : 'Deactivated');
    },
    
    toggleMachineCollapse: function() {
        this.machineCollapsed = !this.machineCollapsed;
        const frame = document.querySelector('.machine-frame');
        const btn = document.querySelector('.machine-collapse-btn');
        frame.classList.toggle('collapsed');
        btn.innerText = this.machineCollapsed ? 'â–²' : 'â–¼';
    },

    spin: async function() {
        if(this.spinning) return;
        if(this.energy < 15) {
            this.auto = false;
            document.getElementById('btn-auto').classList.remove('active');
            UI.showDialog('âš ï¸', 'INSUFFICIENT ENERGY', 'Need 15 Energy to spin!', [
                {text: 'OK', primary: true}
            ]);
            return;
        }
        
        this.spinning = true;
        this.energy -= 15;
        this.spinsSinceWin++;
        this.updateHUD();
        SFX.spin();

        const results = [];
        const spinDuration = this.turbo ? 80 : 150;
        
        for(let i=0; i<5; i++) {
            const el = document.getElementById(`reel-${i}`);
            if(!el) continue;
            el.style.transform = 'translateY(30px)';
            el.style.opacity = '0.5';
            
            await new Promise(r => setTimeout(r, spinDuration));
            
            const sym = TarotCards.getRandomSymbol();
            results.push(sym);
            el.children[0].innerText = sym;
            el.style.transform = 'translateY(0)';
            el.style.opacity = '1';
        }
        
        await this.evaluateResults(results);
        
        this.spinning = false;
        this.updateHUD();
        
        if(this.auto) setTimeout(() => this.spin(), this.turbo ? 300 : 700);
    },

    evaluateResults: async function(results) {
        document.querySelectorAll('.symbol').forEach(s => s.classList.remove('win'));
        
        const match = TarotCards.checkCombination(results);
        
        if(!match) {
            this.comboMultiplier = 1;
            if(this.spinsSinceWin > 10) {
                this.energy += 5;
                UI.showToast('PITY BONUS', '+5 Energy');
            }
            document.getElementById('combo-display').innerText = 'NO COMBO';
            return;
        }
        
        document.querySelectorAll('.symbol').forEach(s => s.classList.add('win'));
        this.spinsSinceWin = 0;
        
        document.getElementById('combo-display').innerText = `âœ¨ ${match.name} âœ¨`;
        
        await this.applyEffect(match);
        
        this.comboMultiplier = Math.min(3, this.comboMultiplier + 0.1);
        this.updateHUD();
    },
    
    applyEffect: async function(match) {
        const mult = this.comboMultiplier;
        
        // Cognition effects
        if(match.effect.includes('Cellular Intel')) {
            const amt = parseInt(match.effect.match(/\d+/)[0]) * mult;
            CognitionSystem.cellular += amt;
            UI.showToast('ğŸ§¬ ' + match.name, `+${amt} Cellular Intelligence`);
            SFX.win();
            this.addXP(150);
        } else if(match.effect.includes('Swarm Intel')) {
            const amt = parseInt(match.effect.match(/\d+/)[0]) * mult;
            CognitionSystem.swarm += amt;
            UI.showToast('ğŸŒŠ ' + match.name, `+${amt} Swarm Cognition`);
            SFX.win();
            this.addXP(150);
        } else if(match.effect.includes('Network Boost')) {
            this.energy += Math.floor(200 * mult);
            CognitionSystem.tissue += 100;
            UI.showMilestone('âš¡', 'BIOELECTRIC SURGE', 'Information network amplified!');
            SFX.jackpot();
            this.addXP(120);
        } else if(match.effect.includes('All Intel Types')) {
            const amt = Math.floor(100 * mult);
            CognitionSystem.cellular += amt;
            CognitionSystem.tissue += amt;
            CognitionSystem.organ += amt;
            CognitionSystem.swarm += amt;
            UI.showMilestone('ğŸ”®', 'PROTO-COGNITION', 'All intelligence scales boosted!');
            SFX.jackpot();
            this.addXP(200);
        } else if(match.effect.includes('Trigger Morphogenesis')) {
            CognitionSystem.triggerMorphogenesis();
        } else if(match.effect.includes('Create 3 Xenobots')) {
            for(let i=0; i<3; i++) {
                setTimeout(()=>CognitionSystem.spawnXenobot(), i*300);
            }
            UI.showMilestone('ğŸ§ª', 'SYNTHETIC LIFE', '3 Xenobots created!');
            SFX.jackpot();
            this.addXP(180);
        } else if(match.effect.includes('All Systems Level Up')) {
            Sim.buildings.forEach(b => {
                b.level++;
                b.value = Math.floor(b.value * 1.3);
            });
            UI.showMilestone('ğŸ’«', 'EMERGENT MIND', 'All structures evolved!');
            SFX.jackpot();
            this.addXP(250);
        } else if(match.effect.includes('Tissue Networks')) {
            CognitionSystem.tissue += Math.floor(150 * mult);
            UI.showToast('ğŸ”¬ ' + match.name, 'Tissue networks strengthened');
            SFX.win();
            this.addXP(80);
        } else if(match.effect.includes('Auto-Connect')) {
            CognitionSystem.bioelectricView = true;
            CognitionSystem.createBioelectricNetwork();
            document.getElementById('bioelectric-btn').classList.add('active');
            UI.showMilestone('ğŸŒ€', 'SELF-ORGANIZATION', 'Bioelectric network auto-formed!');
            SFX.bioelectric();
            this.addXP(100);
        } else if(match.effect.includes('Organ Systems')) {
            CognitionSystem.organ += Math.floor(100 * mult);
            UI.showToast('ğŸ¯ ' + match.name, 'Organ-level intelligence increased');
            SFX.win();
            this.addXP(90);
        } else if(match.effect.includes('All Cognition')) {
            const amt = Math.floor(200 * mult);
            CognitionSystem.cellular += amt;
            CognitionSystem.tissue += amt;
            CognitionSystem.organ += amt;
            CognitionSystem.swarm += amt;
            UI.showMilestone('ğŸ§¬', 'SCALE-FREE MIND', 'Cognition amplified across all scales!');
            SFX.jackpot();
            this.addXP(300);
        } else if(match.effect.includes('Triple Production')) {
            Sim.buildings.forEach(b => b.value *= 3);
            UI.showMilestone('ğŸ”¬', 'LIFE AS IT CAN BE', 'Production tripled!');
            SFX.jackpot();
            this.addXP(300);
        } else if(match.effect.includes('Instant Evolution')) {
            this.level++;
            CognitionSystem.cellular += 200;
            CognitionSystem.tissue += 200;
            CognitionSystem.organ += 200;
            CognitionSystem.swarm += 200;
            UI.showMilestone('âš¡', 'EMBODIED INTELLIGENCE', 'Instant evolution achieved!');
            SFX.jackpot();
            this.addXP(500);
        } else if(match.effect === 'All resources maxed') {
            this.energy = 999;
            this.materials = 999;
            this.credits = 999;
            UI.showMilestone('ğŸŒŸ', 'THE UNIVERSE', 'All resources maximized!');
            SFX.jackpot();
            this.addXP(500);
        } else if(match.effect === 'quad_bonus') {
            this.energy += Math.floor(100 * mult);
            this.materials += Math.floor(50 * mult);
            this.credits += Math.floor(75 * mult);
            UI.showToast('ğŸ° FOUR OF A KIND', 'Major bonus!');
            SFX.win();
            this.addXP(80);
        } else if(match.effect === 'triple_bonus') {
            this.energy += Math.floor(50 * mult);
            this.materials += Math.floor(25 * mult);
            this.credits += Math.floor(40 * mult);
            UI.showToast('ğŸ° THREE OF A KIND', 'Good combo!');
            SFX.play(500, 'sine', 0.3, 0.1);
            this.addXP(40);
        } else if(match.effect === 'double_pair') {
            this.energy += Math.floor(30 * mult);
            this.materials += Math.floor(15 * mult);
            UI.showToast('ğŸ° TWO PAIRS', 'Nice!');
            SFX.play(400, 'sine', 0.2, 0.08);
            this.addXP(20);
        } else if(match.effect === 'pair_bonus') {
            this.energy += Math.floor(15 * mult);
            this.materials += Math.floor(10 * mult);
            UI.showToast('ğŸ° PAIR', 'Small bonus');
            SFX.play(300, 'sine', 0.15, 0.06);
            this.addXP(10);
        } else {
            // Generic parsing
            const numbers = match.effect.match(/\d+/g);
            if(numbers) {
                if(match.effect.includes('Energy')) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.energy += amt;
                    UI.showToast(match.name, `+${amt} Energy`);
                    this.addXP(20);
                } else if(match.effect.includes('Materials')) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.materials += amt;
                    UI.showToast(match.name, `+${amt} Materials`);
                    this.addXP(20);
                } else if(match.effect.includes('Credits')) {
                    const amt = Math.floor(parseInt(numbers[0]) * mult);
                    this.credits += amt;
                    UI.showToast(match.name, `+${amt} Credits`);
                    this.addXP(20);
                }
            }
            SFX.play(450, 'sine', 0.25, 0.08);
        }
        
        CognitionSystem.update();
    },

    produceResources: function() {
        for(let b of Sim.buildings) {
            let bonus = 1;
            CognitionSystem.xenobots.forEach(xeno => {
                if(xeno.mesh.position.distanceTo(b.mesh.position) < 15) {
                    bonus += xeno.resourceBonus;
                }
            });
            
            const value = Math.floor(b.value * bonus);
            
            if(b.production === 'energy') this.energy += value;
            else if(b.production === 'materials') this.materials += value;
            else if(b.production === 'credits') this.credits += value;
            else if(b.production === 'population' && Sim.entities.length < 100) {
                for(let i=0; i<Math.min(value, 2); i++) Sim.spawnAgent();
            }
        }
        this.updateHUD();
    },

    addXP: function(amount) {
        this.xp += amount;
        if(this.xp >= this.xpNeeded) {
            this.levelUp();
        }
        this.updateXPBar();
    },

    levelUp: function() {
        this.level++;
        this.xp = 0;
        this.xpNeeded = Math.floor(this.xpNeeded * 1.5);
        
        SFX.levelUp();
        UI.showMilestone('â¬†ï¸', `ARCHITECT LEVEL ${this.level}`, 'Your mastery deepens!');
        
        this.energy += 50;
        this.materials += 20;
        this.credits += 30;
        
        this.updateXPBar();
    },

    updateXPBar: function() {
        const percent = (this.xp / this.xpNeeded) * 100;
        document.getElementById('xp-bar').style.width = percent + '%';
        document.getElementById('level-num').innerText = this.level;
        document.getElementById('xp-text').innerText = `${this.xp} / ${this.xpNeeded} XP`;
    },

    updateHUD: function() {
        document.getElementById('ui-energy').innerText = this.energy;
        document.getElementById('ui-materials').innerText = this.materials;
        document.getElementById('ui-credits').innerText = this.credits;
        document.getElementById('ui-pop').innerText = Sim.entities.length;
        document.getElementById('ui-builds').innerText = this.buildingsBuilt;
        
        document.getElementById('btn-spin').disabled = this.energy < 15;
        
        if(this.buildingsBuilt === 10 && !this.milestones?.buildings10) {
            this.milestones = this.milestones || {};
            this.milestones.buildings10 = true;
            UI.showMilestone('ğŸ—ï¸', 'TISSUE FORMATION', 'Built 10 structures!');
            this.addXP(100);
        }
        
        if(Sim.entities.length >= 50 && !this.milestones?.pop50) {
            this.milestones = this.milestones || {};
            this.milestones.pop50 = true;
            UI.showMilestone('ğŸ§¬', 'CELL COLLECTIVE', 'Reached 50 agents!');
            this.addXP(150);
        }
        
        if(CognitionSystem.cellular >= 500 && !this.milestones?.cognitive) {
            this.milestones = this.milestones || {};
            this.milestones.cognitive = true;
            UI.showMilestone('ğŸ§ ', 'COGNITIVE EMERGENCE', 'High cellular intelligence!');
            this.addXP(200);
        }
    }
};

/* ================= GLOBAL FUNCTIONS ================= */
window.initSim = function() {
    document.getElementById('overlay').style.display = 'none';
    SFX.init();
    Sim.init();
    Game.init();
};

window.toggleAuto = () => Game.toggleAuto && Game.toggleAuto();
window.toggleTurbo = () => Game.toggleTurbo && Game.toggleTurbo();
window.toggleMachineCollapse = () => Game.toggleMachineCollapse && Game.toggleMachineCollapse();
window.spin = () => Game.spin && Game.spin();
window.upgradeSelected = () => {
    if(Sim.selectedBuilding) {
        Sim.upgradeBuilding(Sim.selectedBuilding);
    }
};

window.toggleBioelectricView = () => CognitionSystem.toggleBioelectric && CognitionSystem.toggleBioelectric();
window.triggerMorphogenesis = () => CognitionSystem.triggerMorphogenesis && CognitionSystem.triggerMorphogenesis();
window.spawnXenobot = () => CognitionSystem.spawnXenobot && CognitionSystem.spawnXenobot();

</script>
</body>
</html>
